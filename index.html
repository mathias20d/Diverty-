<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- SEO optimized title: Includes main keywords and location to improve search engine visibility. -->
    <title>Diverty Eventos | Fiestas Infantiles en PanamÃ¡</title>
    <!-- SEO optimized meta description: Provides a concise and attractive summary of the content, with relevant keywords and a call to action. -->
    <meta name="description" content="Organizamos las mejores fiestas infantiles en PanamÃ¡ Centro, ArraijÃ¡n, La Chorrera, Pacora y PanamÃ¡ Norte. Expertos en animaciÃ³n, shows de burbujas, pintacaritas, globoflexia y paquetes de diversiÃ³n. Â¡Haz que la fiesta de tus hijos sea inolvidable con Diverty Eventos en todo PanamÃ¡!">
    
    <!-- Open Graph Tags for social media and messaging apps (Facebook, WhatsApp, etc.). -->
    <meta property="og:title" content="Diverty Eventos | Fiestas Infantiles en PanamÃ¡">
    <meta property="og:description" content="Organizamos las mejores fiestas infantiles en PanamÃ¡. AnimaciÃ³n, shows de burbujas, pintacaritas y mÃ¡s. Â¡Haz la fiesta soÃ±ada de tus hijos con Diverty Eventos!">
    <!-- IMPORTANT! Corrected image URL for Netlify. -->
    <meta property="og:image" content="https://divertypanama.netlify.app/android-chrome-512x512.png"> 
    <meta property="og:image:width" content="512"> 
    <meta property="og:image:height" content="512"> 
    <meta property="og:image:alt" content="Logo de Diverty Eventos, para fiestas infantiles en PanamÃ¡">
    <meta property="og:url" content="https://divertypanama.netlify.app/"> <!-- Your actual website URL. -->
    <meta property="og:type" content="website">

    <!-- Google tag (gtag.js) for Google Analytics: Allows tracking of user visits and behavior. -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-R3G3Y0FLVN"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-R3G3Y0FLVN');
    </script>

    <!-- Schema Markup (Structured Data) for LocalBusiness and Organization - SEO: Helps search engines understand your business content. -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": ["LocalBusiness", "Organization"],
      "name": "Diverty Eventos",
      "image": "https://divertypanama.netlify.app/android-chrome-512x512.png", <!-- Main image URL for Schema Markup corrected. -->
      "url": "https://divertypanama.netlify.app/", <!-- Your actual site URL. -->
      "telephone": "+50766677965",
      "address": {
        "@type": "PostalAddress",
        "streetAddress": "Tu DirecciÃ³n Exacta AquÃ­ (Ej: Calle 50, Edificio XYZ)", <!-- IMPORTANT! Replace with your physical address. -->
        "addressLocality": "PanamÃ¡ Centro",
        "addressRegion": "PanamÃ¡",
        "postalCode": "Tu CÃ³digo Postal AquÃ­", <!-- Optional, but recommended if you have it. -->
        "addressCountry": "PA"
      },
      "priceRange": "$$",
      "openingHoursSpecification": [
        {
          "@type": "OpeningHoursSpecification",
          "dayOfWeek": [
            "Monday",
            "Tuesday",
            "Wednesday",
            "Thursday",
            "Friday"
          ],
          "opens": "09:00",
          "closes": "18:00"
        },
        {
          "@type": "OpeningHoursSpecification",
          "dayOfWeek": [
            "Saturday",
            "Sunday"
          ],
          "opens": "10:00",
          "closes": "17:00"
        }
      ],
      "hasOfferCatalog": {
        "@type": "OfferCatalog",
        "name": "CatÃ¡logo de Servicios y Paquetes de Fiestas Infantiles en PanamÃ¡",
        "itemListElement": [
          {
            "@type": "Offer",
            "itemOffered": {
              "@type": "Service",
              "name": "Pintacaritas para fiestas infantiles",
              "description": "Transforma a los niÃ±os en sus personajes favoritos con pinturas hipoalergÃ©nicas, un servicio ideal para fiestas infantiles en PanamÃ¡."
            }
          },
          {
            "@type": "Offer",
            "itemOffered": {
              "@type": "Service",
              "name": "Globoflexia para cumpleaÃ±os y eventos infantiles",
              "description": "Figuras divertidas y creativas hechas con globos para cada invitado, perfectas para cumpleaÃ±os y eventos infantiles en PanamÃ¡."
            }
          },
          {
            "@type": "Offer",
            "itemOffered": {
              "@type": "Service",
              "name": "Show de Burbujas Gigantes en PanamÃ¡",
              "description": "Â¡Burbujas enormes que los niÃ±os pueden atrapar y explotar! Un sÃºper show Ãºnico en PanamÃ¡ para cualquier fiesta infantil."
            }
          },
          {
            "@type": "Offer",
            "itemOffered": {
              "@type": "Service",
              "name": "Paquete Fiesta MÃ¡gica Express para fiestas infantiles en PanamÃ¡",
              "description": "DiversiÃ³n con animador, juegos, globos y piÃ±ata. Ideal para fiestas rÃ¡pidas y cumpleaÃ±os en PanamÃ¡."
            }
          },
          {
            "@type": "Offer",
            "itemOffered": {
              "@type": "Service",
              "name": "Paquete Aventura de EnsueÃ±o para fiestas infantiles en PanamÃ¡",
              "description": "Servicio completo con payaso, pintacaritas, animaciÃ³n, juegos y piÃ±ata para una celebraciÃ³n inolvidable en PanamÃ¡."
            }
          },
          {
            "@type": "Offer",
            "itemOffered": {
              "@type": "Service",
              "name": "Paquete CelebraciÃ³n Personalizada para eventos infantiles en PanamÃ¡",
            "description": "Servicio premium con payaso, animaciÃ³n, pintacaritas, show de magia cÃ³mica y asistencia para piÃ±ata, diseÃ±ado para tu fiesta perfecta en PanamÃ¡."
          }
        }
        ]
      },
      "slogan": "Â¡Hacemos magia en tu fiesta infantil en PanamÃ¡!",
      "description": "Diverty Eventos ofrece la mejor animaciÃ³n y shows para fiestas infantiles en PanamÃ¡ Centro, ArraijÃ¡n, La Chorrera, Pacora y PanamÃ¡ Norte. Especialistas en shows de burbujas, pintacaritas y paquetes de diversiÃ³n inolvidable. Â¡Organiza la fiesta soÃ±ada de tus hijos!"
    }
    </script>
    <!-- Tailwind CSS CDN for styles: Allows fast development and responsive design. -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Inter for typography: Provides a modern and readable font. -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* Base styles for the page body */
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
        }
        /* Custom styles for button hover for visual consistency. */
        .hover\:bg-purple-600:hover { background-color: #7c3aed; }
        .hover\:bg-pink-600:hover { background-color: #db2777; }
        .hover\:bg-blue-600:hover { background-color: #2563eb; } /* This will be overridden by JS for nav buttons */
        .hover\:bg-green-600:hover { background-color: #16a34a; } /* This will be overridden by JS for nav buttons */
        .hover\:bg-indigo-600:hover { background-color: #4f46e5; }
        /* Style for strikethrough text (previous prices), useful for showing discounts. */
        .line-through { text-decoration: line-through; }

        /* Style for the floating WhatsApp button: Allows quick access to contact. */
        .whatsapp-float-button {
            position: fixed;
            bottom: 80px; /* Adjusts the vertical position of the button. */
            right: 20px;
            z-index: 1000; /* Ensures the button is above other elements. */
            width: 56px; /* Adjustment for the button to be square. */
            height: 56px;
            display: flex; /* Use flexbox to center content. */
            justify-content: center; /* Centers the icon horizontally. */
            align-items: center; /* Centers the icon vertically. */
            border-radius: 9999px; /* Fully round. */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); /* More pronounced shadow. */
            transition: all 0.3s ease; /* Smooth transitions for hover. */
            background-color: #25D366; /* WhatsApp background color. */
            cursor: pointer; /* Add cursor pointer */
        }
        .whatsapp-float-button:hover {
            transform: scale(1.1); /* Slight increase in size on hover. */
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); /* Even more pronounced shadow on hover. */
        }

        /* Style for inline validation error messages */
        .error-message {
            color: #ef4444; /* red-500 */
            font-size: 0.875rem; /* text-sm */
            margin-top: 0.25rem;
        }
        .input-error {
            border-color: #ef4444 !important; /* red-500 */
        }
    </style>
</head>
<body class="min-h-screen bg-gray-50 text-gray-800 flex flex-col">

    <!-- General Info Modal: Used for user messages (e.g., success, error). -->
    <div id="infoModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 p-4 hidden" role="dialog" aria-modal="true" aria-labelledby="modalMessage">
        <div class="bg-gradient-to-br from-purple-600 to-purple-800 text-white rounded-xl shadow-2xl p-6 max-w-sm w-full text-center border-4 border-purple-500 transform transition-all duration-300 scale-95 opacity-0" id="infoModalContent">
            <p id="modalMessage" class="text-xl font-bold mb-4 text-white"></p>
            <button id="closeModalButton" class="bg-gradient-to-br from-purple-600 via-purple-400 to-purple-700 hover:from-purple-700 hover:to-purple-800 text-white font-bold py-2 px-5 rounded-full shadow-xl transition duration-300 border-2 border-white cursor-pointer">
                Â¡Entendido! ğŸ‰
            </button>
        </div>
    </div>

    <!-- Promotion Modal: Used to announce special offers. -->
    <div id="promoModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 p-4 hidden" role="dialog" aria-modal="true" aria-labelledby="promoMessage">
        <div class="bg-gradient-to-br from-pink-600 to-pink-800 text-white rounded-xl shadow-2xl p-6 max-w-md w-full text-center border-4 border-pink-500 transform transition-all duration-300 scale-95 opacity-0" id="promoModalContent">
            <h2 class="text-3xl font-extrabold text-white mb-4">Â¡PromociÃ³n del Mes! ğŸŒŸ</h2>
            <p id="promoMessage" class="text-lg text-gray-100 mb-4"></p>
            <button id="closePromoModalButton" class="bg-gradient-to-br from-pink-600 via-pink-400 to-pink-700 hover:from-pink-700 hover:to-pink-800 text-white font-bold py-2 px-5 rounded-full shadow-xl transition duration-300 border-2 border-white cursor-pointer">
                Â¡Genial! ğŸ‰
            </button>
        </div>
    </div>

    <!-- New Booking Warning Modal: Shown before filling out the booking form. -->
    <div id="bookingWarningModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 p-4 hidden" role="dialog" aria-modal="true" aria-labelledby="bookingWarningTitle">
        <div class="bg-gradient-to-br from-purple-600 to-purple-800 text-white rounded-xl shadow-2xl p-6 max-w-md w-full text-center border-4 border-purple-500 transform transition-all duration-300 scale-95 opacity-0" id="bookingWarningModalContent">
            <h2 id="bookingWarningTitle" class="text-3xl font-extrabold text-white mb-4">Â¡Importante antes de Reservar! ğŸš¨</h2>
            <p class="text-lg text-gray-100 mb-6">
                Para asegurar la disponibilidad de la fecha y hora de tu evento, te recomendamos
                <span class="font-bold text-purple-200">verificar primero con nosotros vÃ­a WhatsApp</span>.
                Â¡AsÃ­ garantizamos la magia de tu dÃ­a! âœ¨
            </p>
            <div class="flex flex-col sm:flex-row justify-center space-y-4 sm:space-y-0 sm:space-x-4">
                <a href="https://wa.me/50766677965?text=Â¡Hola! Quiero consultar la disponibilidad de una fecha para un evento."
                   target="_blank"
                   class="bg-gradient-to-br from-green-500 via-green-400 to-green-600 hover:from-green-600 hover:to-green-700 text-white font-bold py-3 px-6 rounded-full shadow-xl transition duration-300 flex items-center justify-center border-2 border-white cursor-pointer">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/6/6b/WhatsApp.svg/1200px-WhatsApp.svg.png" alt="WhatsApp Icon" class="w-6 h-6 mr-2">
                    Contactar por WhatsApp
                </a>
                <button id="closeBookingWarningModalButton" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-3 px-6 rounded-full shadow-md transition duration-300 cursor-pointer">
                    Continuar con el Formulario
                </button>
            </div>
        </div>
    </div>

    <!-- Mini-Cart Modal (Reverted to its original state) -->
    <div id="miniCartModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 p-4 hidden" role="dialog" aria-modal="true" aria-labelledby="miniCartTitle">
        <div class="bg-gradient-to-br from-purple-600 to-purple-800 text-white rounded-xl shadow-2xl p-6 max-w-sm w-full text-center border-4 border-purple-500 transform transition-all duration-300 scale-95 opacity-0" id="miniCartModalContent">
            <h2 id="miniCartTitle" class="text-2xl font-extrabold text-white mb-4">Tu Carrito de DiversiÃ³n ğŸ›’</h2>
            <div id="miniCartItems" class="max-h-60 overflow-y-auto text-left mb-4 p-2 bg-purple-100 rounded-lg border border-purple-200 text-gray-800">
                <!-- Cart items will be loaded here dynamically -->
            </div>
            <div class="text-right font-bold text-white mb-4">
                <!-- Transport surcharge is no longer displayed here -->
                <p class="text-xl text-pink-200">Total: <span id="miniCartTotalPrice">$0.00</span></p>
            </div>
            <div class="flex flex-col sm:flex-row justify-center space-y-3 sm:space-y-0 sm:space-x-3">
                <button id="closeMiniCartModalButton" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-5 rounded-full shadow-md transition duration-300 cursor-pointer">
                    Cerrar
                </button>
                <button id="miniCartProceedToBookButton" class="bg-gradient-to-br from-purple-600 via-purple-400 to-purple-700 hover:from-purple-700 hover:to-purple-800 text-white font-bold py-2 px-5 rounded-full shadow-xl transition duration-300 border-2 border-white cursor-pointer">
                    Reservar Ahora âœ¨
                </button>
            </div>
        </div>
    </div>

    <!-- Image Modal: Displays a larger version of an image when clicked. -->
    <div id="imageModal" class="fixed inset-0 bg-gray-900 bg-opacity-80 flex items-center justify-center z-50 p-4 hidden" role="dialog" aria-modal="true" aria-labelledby="imageModalTitle">
        <div class="relative bg-white rounded-lg shadow-2xl p-2 max-w-full max-h-full overflow-hidden flex flex-col items-center justify-center transform transition-all duration-300 scale-95 opacity-0" id="imageModalContent">
            <button id="closeImageModalButton" class="absolute top-2 right-2 bg-red-500 hover:bg-red-700 text-white rounded-full p-2 text-lg font-bold transition duration-300 z-10 w-8 h-8 flex items-center justify-center" aria-label="Cerrar imagen">
                &times;
            </button>
            <img id="modalImage" src="" alt="Imagen ampliada del servicio" class="max-w-full max-h-[80vh] object-contain rounded-lg">
        </div>
    </div>


    <!-- Header (Main Navigation Menu): Contains the logo, title, and navigation buttons. -->
    <header class="bg-gradient-to-br from-purple-100 to-purple-200 text-purple-800 py-3 px-4 w-full rounded-b-3xl shadow-xl sticky top-0 z-40 border-b-4 border-purple-300">
        <nav class="container mx-auto flex flex-col sm:flex-row justify-between items-center" aria-label="NavegaciÃ³n Principal">
            <!-- Container for logo and title -->
            <div class="flex items-center mb-4 sm:mb-0">
                <!-- DIVERTY EVENTOS LOGO -->
                <img src="https://divertypanama.netlify.app/android-chrome-512x512.png" alt="Logo de Diverty Eventos" class="w-16 h-16 mr-4 rounded-full object-cover border-2 border-pink-400 shadow-md">
                
                <!-- Main title -->
                <h1 class="text-3xl sm:text-4xl font-extrabold text-purple-900 text-center sm:text-left">
                    Diverty Eventos 
                </h1>
            </div>

            <!-- Mobile menu toggle button (Hamburger) -->
            <button id="mobileMenuToggle" class="sm:hidden p-2 rounded-md text-purple-800 hover:bg-purple-300 focus:outline-none focus:ring-2 focus:ring-purple-500 cursor-pointer" aria-controls="mobileMenu" aria-expanded="false">
                <svg class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                </svg>
            </button>

            <!-- Navigation list (hidden on mobile by default, shown on larger screens) -->
            <div id="mobileMenu" class="hidden sm:flex flex-col sm:flex-row flex-grow justify-center sm:justify-end items-center mt-4 sm:mt-0 space-y-2 sm:space-y-0 sm:space-x-4 w-full sm:w-auto">
                <ul class="flex flex-col sm:flex-row justify-center sm:space-x-4 space-y-2 sm:space-y-0" role="menubar">
                    <li role="none"><button id="navHome" role="menuitem" class="text-base font-extrabold py-2 px-5 rounded-full text-purple-900 bg-purple-200 hover:bg-purple-300 transition duration-300 transform hover:scale-105 shadow-md cursor-pointer">Inicio ğŸ </button></li>
                    <li role="none"><button id="navServices" role="menuitem" class="text-base font-extrabold py-2 px-5 rounded-full text-purple-900 bg-purple-200 hover:bg-purple-300 transition duration-300 transform hover:scale-105 shadow-md cursor-pointer">Servicios ğŸ“‹</button></li>
                    <li role="none"><button id="navPackages" role="menuitem" class="text-base font-extrabold py-2 px-5 rounded-full text-purple-900 bg-purple-200 hover:bg-purple-300 transition duration-300 transform hover:scale-105 shadow-md cursor-pointer">Planes de CumpleaÃ±os ğŸ‚</button></li>
                    <li role="none"><button id="navBubblePackages" role="menuitem" class="text-base font-extrabold py-2 px-5 rounded-full text-purple-900 bg-purple-200 hover:bg-purple-300 transition duration-300 transform hover:scale-105 shadow-md cursor-pointer">Paquetes de Burbujas ğŸ«§</button></li>
                    <li role="none"><button id="navBooking" role="menuitem" class="text-base font-extrabold py-2 px-5 rounded-full text-purple-900 bg-purple-200 hover:bg-purple-300 transition duration-300 transform hover:scale-105 shadow-md cursor-pointer">Reservar ğŸ—“ï¸</button></li>
                </ul>
            </div>
        </nav>
    </header>

    <!-- Shopping Cart Summary (Floating Bar): Displays the number of items and the selected total. -->
    <div id="cartSummary" class="bg-gradient-to-br from-purple-200 to-purple-300 text-purple-800 font-extrabold p-4 text-center rounded-b-3xl shadow-xl border-b-4 border-purple-400 hidden sticky top-[88px] z-30 transition-all duration-300 ease-in-out flex flex-col sm:flex-row justify-between items-center">
        <p class="text-xl sm:text-2xl mb-2 sm:mb-0">
            ğŸ›’ Ãtems: <span id="selectedItemsCount" class="text-purple-700">0</span> | Total: <span id="totalPriceDisplay" class="text-pink-700">$0.00</span>
        </p>
        <div class="flex space-x-3">
            <button id="viewCartDetailsButton" class="bg-gradient-to-br from-purple-500 via-purple-400 to-purple-600 hover:from-purple-600 hover:to-purple-700 text-white font-bold py-2 px-4 rounded-full shadow-md text-sm transition duration-300 border-2 border-white cursor-pointer">
                Ver Detalles ğŸ›’
            </button>
            <button id="proceedToBookButton" class="bg-gradient-to-br from-pink-600 via-pink-400 to-pink-700 hover:from-pink-700 hover:to-pink-800 text-white font-bold py-2 px-4 rounded-full shadow-xl text-sm transition duration-300 border-2 border-white cursor-pointer">
                Reservar âœ¨
            </button>
        </div>
    </div>

    <!-- Main Content Area: Section content (Home, Services, etc.) will be dynamically loaded here. -->
    <main id="mainContent" class="container mx-auto p-4 flex-grow">
        <!-- Section content (Home, Services, etc.) will be injected here by JavaScript. -->
    </main>

    <!-- Floating WhatsApp Button: Quick access to contact via WhatsApp. -->
    <a href="https://wa.me/50766677965?text=Â¡Hola! Tengo una consulta sobre Diverty Eventos." class="whatsapp-float-button" target="_blank" aria-label="Contactar por WhatsApp">
        <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/6/6b/WhatsApp.svg/1200px-WhatsApp.svg.png" alt="WhatsApp Icon" class="w-6 h-6">
    </a>

    <!-- Footer: Copyright information and slogan. -->
    <footer class="bg-purple-700 text-white py-8 px-4 text-center mt-8 rounded-t-xl shadow-inner w-full">
        <p class="text-lg font-semibold">&copy; 2023 Diverty Eventos. Â¡Hacemos magia en cada fiesta infantil en PanamÃ¡! âœ¨</p>
        <p class="text-sm">Todos los derechos reservados. Servicios de <strong>animaciÃ³n infantil</strong> y <strong>shows para fiestas</strong> en todo PanamÃ¡.</p>
    </footer>

    <!-- JavaScript script for page functionality. -->
    <script>
        // --- Global Application State Management ---
        // 'appState' contains all state variables that control application behavior.
        let appState = {
            activeSection: 'home', // Currently visible section ('home', 'services', 'packages', 'bubblePackages', 'booking').
            userId: 'guest_user_' + Math.random().toString(36).substring(2, 9), // Unique ID for the guest user.
            selectedItems: [], // Array to store selected services/packages in the cart.
            promotedPackages: [], // Array to store the names of packages on promotion.
            selectedLocation: 'PanamÃ¡ Centro', // Selected location for calculating transport surcharge.
            hasShownBookingWarning: false, // Indicates if the booking warning modal has already been shown in the session.
            infoModalCallback: null, // Callback to execute a function when the info modal closes.
            bookingFormData: { // Object to store booking form data, useful for persistence.
                bookingDate: '',
                bookingTime: '',
                customerName: '',
                customerEmail: '',
                customerPhone: '',
                eventType: '',
                numKids: '',
                exactLocation: '',
                selectedLocation: 'PanamÃ¡ Centro' 
            },
        };

        // --- Data Definition (Services and Packages) ---
        // Arrays of objects defining available services and packages, including prices and descriptions.
        const servicesData = [
            { id: '2', name: 'Pintacaritas ğŸ¨ğŸ‘§ğŸ‘¦', price: 45, description: 'Transforma a los niÃ±os en sus personajes favoritos con pinturas hipoalergÃ©nicas. Servicio por 1 hora, incluye mesa de maquillaje y silla profesional.', color: 'bg-gradient-to-br from-purple-100 to-purple-200 border-purple-300 text-purple-800', imageUrl: 'https://i.ibb.co/gLbjzL5n/3eb6eb2f-a6fb-4e9e-b8e4-2849b948ca7e-20250629-221512-0000.jpg' },
            { id: '3', name: 'Globoflexia ğŸˆğŸ’«', price: 40, description: 'Figuras divertidas y creativas hechas con globos para cada invitado. Servicio por 1 hora.', color: 'bg-gradient-to-br from-pink-100 to-pink-200 border-pink-300 text-pink-800', imageUrl: 'https://i.ibb.co/21gCBMm3/IMG-20230423-173048-1.jpg' },
            { 
                id: '7', 
                name: 'Decoraciones TemÃ¡ticas', 
                price: 100, // Price updated to 100
                description: 'Transforma cualquier espacio en un mundo mÃ¡gico con nuestras decoraciones personalizadas. Â¡Elige tu temÃ¡tica favorita!', 
                color: 'bg-gradient-to-br from-pink-200 to-pink-300 border-pink-400 text-pink-800',
                type: 'theme_selection', // New type to handle theme selection
                imageUrl: 'https://i.ibb.co/p61CY7CW/IMG-20250624-WA0000.jpg', // Updated image URL here
                themes: {
                    ninas: [
                        'Barbie', 'Sirenita', 'Cenicienta', 'Moana grande', 'Moana bebÃ©', 'Abejita',
                        'Luly Pampin', 'Stitch', 'Stitch y Ãngela', 'Capivara', 'Minnie roja',
                        'Plim Plim rosa', 'Sirenita otro modelo nuevo', 'Rosita fresita', 'Masha y el oso',
                        'Unicornio', 'Frozen', 'Monster In', 'Granja rosa', 'Skay', 'Princesas bebÃ©',
                        'Princesa grande', 'Bluey', 'Minnie bebÃ©', 'Mariposas', 'BebÃ© Llorones',
                        'Minnie rosada', 'Gatita Marie', 'Pebells', 'Pollo Party', 'Abeja Maya',
                        'Bely y Beto', 'La Bella y la Bestia', 'Hello Kitty', 'Peppa', 'Harley Kuin',
                        'Merlina', 'Minnie Poll Party', 'Princesa Pich'
                    ],
                    ninos: [
                        'Real Madrid', 'Plaza SÃ©samo', 'Hot Wheels', 'Bebe Fin', 'Sonic', 'Bomberos',
                        'Legos', 'Dinosaurios', 'Dinosaurios animados', 'Plim Plim Safary',
                        'Inter de Miami', 'Batman', 'Granja', 'FÃºtbol', 'Mickey Safary', 'Chuchugua',
                        'Blippi', 'Minicraft', 'Plim Plim', 'Cars', 'Spiderman', 'Paw Patrol',
                        'Jefes en PaÃ±ales', 'Bam Bam', 'Safary', 'La Granja de ZenÃ³n', 'Mario Bros',
                        'Mickey Principe', 'Avengers', 'Cristiano', 'Coco MelÃ³n', 'Messi',
                        'Plim Plim piscina', 'Carritos', 'Aeroman', 'Constructor', 'Free Fires',
                        'Caballito', 'Rugrats', 'Barca'
                    ]
                }
            },
            // Thematic characters service (price updated to 65)
            {
                id: '9',
                name: 'Personajes TemÃ¡ticos',
                price: 65, // Base price for one character, updated to $65
                description: 'Â¡Sorprende a todos con la visita de tu personaje favorito! Elige entre Mickey, Minnie y Mario Bros. Servicio por 1 hora.',
                color: 'bg-gradient-to-br from-indigo-200 to-indigo-300 border-indigo-400 text-indigo-800',
                type: 'character_selection', // Special type to handle character selection
                imageUrl: 'https://i.ibb.co/nqvDyb7Y/IMG-20250623-WA0019.jpg', 
                characters: [
                    { id: 'mickey', name: 'Mickey Mouse ğŸ­' },
                    { id: 'minnie', name: 'Minnie Mouse ğŸ€' },
                    { id: 'mario', name: 'Mario Bros. ğŸ„' }
                ]
            },
            { 
                id: '10', 
                name: 'Mini Taller de Manualidades ğŸ¨âœ‚ï¸', 
                price: 12.50, // Price per child, updated to $12.50
                description: 'Taller creativo con 2 manualidades, mobiliario (mesas y sillas), 1 recreadora encargada del taller, materiales, mÃºsica y figuras con globos. Â¡DiversiÃ³n garantizada por niÃ±o!', 
                color: 'bg-gradient-to-br from-yellow-100 to-yellow-200 border-yellow-300 text-yellow-800',
                type: 'manualidades_workshop', // New type for this specific service
                imageUrl: 'https://i.ibb.co/ynXVt81f/IMG-20250709-164447.jpg' 
            },
            { id: '8', name: 'MÃ¡quinas de Snack AlgodÃ³n y Pop Corn ğŸ¿ğŸ­', price: 100, description: 'MÃ¡quinas de algodÃ³n de azÃºcar y palomitas de maÃ­z para endulzar tu evento. Servicio por 3 horas.', color: 'bg-gradient-to-br from-purple-100 to-purple-200 border-purple-300 text-purple-800', imageUrl: '' }
        ];

        const packagesData = [
            { id: 'P1', name: 'Plan BÃ¡sico ğŸš€', price: 80, services: [ // Precio cambiado a 80
                'Payas@ o animad@r ğŸ¤¡ğŸ¤',
                'AnimaciÃ³n infantil ğŸ¥³ğŸ’ƒ',
                'Juegos y concursos ğŸ²ğŸ†',
                'Figuras con globos ğŸˆğŸ¶',
                'Romper la piÃ±ata ğŸ¬ğŸ‰'
            ], description: '1.5h de diversiÃ³n: Animador, juegos, globos, piÃ±ata. Â¡RÃ¡pido y alegre!', color: 'bg-gradient-to-br from-pink-200 to-pink-300 border-pink-400 text-pink-800', imageUrl: '' },
            { id: 'P2', name: 'Plan Recreativo ğŸŒˆ', price: 100, services: [
                'Payas@ o animad@r ğŸ¤¡ğŸ¤',
                'Pintacaritas (1 hora) ğŸ¨ğŸ‘§ğŸ‘¦', // Updated to specify 1 hour
                'AnimaciÃ³n infantil (1 hora) ğŸ¥³ğŸ’ƒ', // Updated to specify 1 hour
                'Juegos y concursos ğŸ²ğŸ†',
                'Figuras con globos ğŸˆğŸ¶',
                'Romper la piÃ±ata ğŸ¬ğŸ‰'
            ], description: '2h de aventura: Payaso/animador, pintacaritas, animaciÃ³n, juegos, globos, piÃ±ata. Â¡Inolvidable!', color: 'bg-gradient-to-br from-indigo-200 to-indigo-300 border-indigo-400 text-indigo-800', imageUrl: '' },
            { id: 'P3', name: 'Plan Magic âœ¨', price: 135, services: [
                'Payasit@ o animad@r ğŸ¤¡ğŸ¤',
                'AnimaciÃ³n, juegos y concursos (1.5 horas) ğŸ¥³ğŸ²', // Updated to 1.5 hours
                'Pintacaritas (1 hora) ğŸ¨ğŸ‘§ğŸ‘¦', // Updated to 1 hour
                'Show de magia cÃ³mica âœ¨ğŸ¤£',
                'Asistencia para la piÃ±ata ğŸ¬ğŸ‰'
            ], description: '2.5h premium: Payaso/animador, juegos, pintacaritas, magia cÃ³mica, asistencia de piÃ±ata. Â¡Tu fiesta perfecta!', color: 'bg-gradient-to-br from-purple-200 to-purple-300 border-purple-400 text-purple-800', imageUrl: '' },
            { 
                id: 'P4', 
                name: 'Plan Diverty ğŸ¥³', 
                price: 210, 
                services: [
                    'Payasito o Animador ğŸ¤¡ğŸ¤',
                    'Juegos y concursos ğŸ²ğŸ†',
                    'Pintacaritas ğŸ¨ğŸ‘§ğŸ‘¦',
                    'Globoflexia ğŸˆğŸ¶',
                    'Show de Burbujas o Magia CÃ³mica ğŸ«§âœ¨',
                    'Asistencia en la piÃ±ata ğŸ¬ğŸ‰'
                ], 
                description: '3h de diversiÃ³n completa: Payaso/animador, juegos, pintacaritas, globoflexia, show de burbujas o magia, y asistencia piÃ±ata. Â¡La magia garantizada!', 
                color: 'bg-gradient-to-br from-green-200 to-green-300 border-green-400 text-green-800', imageUrl: ''
            }
        ];

        // New array for Bubble Packages
        const bubblePackagesData = [
            {
                id: 'B2',
                name: 'Paquete Fiesta Burbuja Completa âœ¨',
                price: 190, 
                services: [
                    'AnimaciÃ³n infantil ğŸ¥³ğŸ’ƒ',
                    'Juegos y concursos ğŸ²ğŸ†',
                    'Payasito o Animador ğŸ¤¡ğŸ¤',
                    'Show de Burbujas Gigantes ğŸ«§',
                    'Romper la piÃ±ata ğŸ¬ğŸ‰'
                ],
                description: '2 horas de diversiÃ³n completa con animaciÃ³n, juegos, payasito, show de burbujas gigantes y asistencia en la piÃ±ata. Â¡La fiesta burbuja soÃ±ada!',
                color: 'bg-gradient-to-br from-indigo-200 to-indigo-300 border-indigo-400 text-indigo-900', imageUrl: ''
            },
            {
                id: 'BS1',
                name: 'Show de Burbujas Premium ğŸ«§', // Renamed from "Show BÃ¡sico ğŸ«§"
                price: 150,
                services: [
                    'Burbujas gigantes',
                    'Humo',
                    'Burbujas LED',
                    'InteracciÃ³n con el pÃºblico',
                    'Fotos dentro de la burbuja gigante', // New service
                    'Trucos con burbujas', // New service
                    'Burbujas de espuma' // New service
                ],
                description: '1 hora de show con burbujas gigantes, humo, burbujas LED, interacciÃ³n con el pÃºblico, fotos dentro de la burbuja gigante, trucos con burbujas y burbujas de espuma.', // Updated description
                color: 'bg-gradient-to-br from-green-100 to-green-200 border-green-300 text-green-800', imageUrl: ''
            },
            {
                id: 'BS3',
                name: 'Show Corporativo/Especial ğŸ¢',
                price: 220, // "Desde $220" implies a base price, using 220 as the base.
                services: [
                    'Show personalizado para centros comerciales, colegios o eventos grandes',
                    'Luces especiales'
                ],
                description: '1 hora de show personalizable (ajustable) para eventos corporativos, centros comerciales, colegios o eventos grandes, con luces especiales.',
                color: 'bg-gradient-to-br from-red-100 to-red-200 border-red-300 text-red-800', imageUrl: ''
            }
        ];


        // Transport surcharges by event location.
        const transportFeesByLocation = {
            'PanamÃ¡ Centro': 0,
            'ArraijÃ¡n': 10,
            'La Chorrera': 15,
            'Pacora': 10,
            'PanamÃ¡ Norte': 10,
        };

        // --- Helper Functions ---

        /**
         * Injects the HTML of a section into the main content area.
         * @param {string} sectionHtml - The HTML of the section to render.
         */
        function renderSection(sectionHtml) {
            document.getElementById('mainContent').innerHTML = sectionHtml;
        }

        /**
         * Calculates the total cost for a given item's quantity, applying special pricing logic.
         * For 'Pintacaritas', the first hour is $45, subsequent hours are $40.
         * @param {object} item - The item object (service or package) with properties like name, price, quantity.
         * @returns {number} The total cost of the item for the given quantity.
         */
        function getAdjustedItemPrice(item) {
            if (item.quantity <= 0) {
                return 0; // If quantity is 0 or less, the total cost for this item is 0.
            }

            if (item.name === 'Pintacaritas ğŸ¨ğŸ‘§ğŸ‘¦') {
                if (item.quantity === 1) {
                    return 45; // First hour is $45.
                } else {
                    // Calculate total cost: first hour at $45, subsequent hours at $40.
                    return 45 + (item.quantity - 1) * 40;
                }
            }
            // Monthly discount logic for promoted packages.
            else if (appState.promotedPackages.includes(item.name)) {
                return item.price * item.quantity * 0.90; // 10% discount on total.
            }
            // For all other services/packages, calculate total based on unit price * quantity.
            return item.price * item.quantity;
        }

        /**
         * Updates the floating cart summary with the number of items and total price.
         * Applies discount logic if active.
         */
        function updateCartSummary() {
            const cartSummaryDiv = document.getElementById('cartSummary');
            // If the active section is 'booking', ensure the cart is hidden and do nothing else.
            if (appState.activeSection === 'booking') {
                if (cartSummaryDiv) cartSummaryDiv.classList.add('hidden');
                return; 
            }

            let currentTotalPrice = appState.selectedItems.reduce((sum, item) => {
                // Sum the total price of each item (calculated by getAdjustedItemPrice).
                return sum + getAdjustedItemPrice(item);
            }, 0);

            // Add transport surcharge based on the selected location.
            currentTotalPrice += transportFeesByLocation[appState.selectedLocation] || 0;

            const selectedItemsCountSpan = document.getElementById('selectedItemsCount');
            const totalPriceDisplaySpan = document.getElementById('totalPriceDisplay');

            const totalItemsInCart = appState.selectedItems.reduce((total, item) => total + item.quantity, 0);

            if (selectedItemsCountSpan && totalPriceDisplaySpan && cartSummaryDiv) {
                if (totalItemsInCart > 0 || currentTotalPrice > 0) {
                    cartSummaryDiv.classList.remove('hidden');
                    selectedItemsCountSpan.textContent = totalItemsInCart;
                    totalPriceDisplaySpan.textContent = `$${currentTotalPrice.toFixed(2)}`;
                } else {
                    cartSummaryDiv.classList.add('hidden');
                }
            }
        }

        /**
         * Handles adding/removing/decrementing items in the cart.
         * @param {object} item - The service/package object to add/remove. Must contain { name, price }.
         * @param {string} actionType - 'add' to add/increment, 'remove_all' to remove all units, 'toggle' to toggle (used for non-repeatable items).
         * @param {number} [quantity=1] - The quantity to add or set.
         */
        function handleCartAction(item, actionType, quantity = 1) {
            const existingItemIndex = appState.selectedItems.findIndex(selected => selected.name === item.name);

            if (actionType === 'add') {
                if (existingItemIndex > -1) {
                    appState.selectedItems[existingItemIndex].quantity += quantity;
                } else {
                    appState.selectedItems.push({ ...item, quantity: quantity });
                }
            } else if (actionType === 'set_quantity') { // New action type for direct quantity setting
                if (quantity <= 0) { // If quantity is 0 or less, remove item
                    appState.selectedItems = appState.selectedItems.filter(selected => selected.name !== item.name);
                } else if (existingItemIndex > -1) {
                    appState.selectedItems[existingItemIndex].quantity = quantity;
                } else {
                    appState.selectedItems.push({ ...item, quantity: quantity });
                }
            } else if (actionType === 'remove_all') {
                // Filter out the item to remove all its units.
                appState.selectedItems = appState.selectedItems.filter(selected => selected.name !== item.name);
            } else if (actionType === 'toggle') { // For non-repeatable services (e.g., packages).
                if (existingItemIndex > -1) {
                    // If already selected, remove it.
                    appState.selectedItems = appState.selectedItems.filter(selected => selected.name !== item.name);
                } else {
                    // If not selected, add it with quantity 1.
                    appState.selectedItems.push({ ...item, quantity: 1 });
                }
            }

            // Re-render the active section to update buttons and prices.
            if (appState.activeSection === 'services') {
                renderServicesSection();
            } else if (appState.activeSection === 'packages') {
                renderPackagesSection();
            } else if (appState.activeSection === 'bubblePackages') { // New section
                renderBubblePackagesSection();
            } else if (appState.activeSection === 'booking') {
                renderBookingSection();
            }
            updateCartSummary(); // Update the floating cart bar.
            saveBookingFormData(); // Save cart state after each action.
        }

        /**
         * Handles adding or changing a thematic character in the cart.
         * Allows adding multiple characters, incrementing the quantity if already in the cart.
         * @param {object} service - The "Thematic Characters" service object (base).
         * @param {object} character - The selected character object ({ id, name }).
         * @param {string} action - 'add' to add or 'remove_all' to remove.
         */
        function updateCharacterInCart(service, character, action) {
            const fullCharacterName = `${service.name}: ${character.name}`;
            const existingItemIndex = appState.selectedItems.findIndex(selected => selected.name === fullCharacterName);

            if (action === 'add') {
                if (existingItemIndex > -1) {
                    // If the character already exists, increment its quantity
                    appState.selectedItems[existingItemIndex].quantity++;
                } else {
                    // Add a new character with the base price of the service
                    appState.selectedItems.push({
                        id: `${service.id}-${character.id}`,
                        name: fullCharacterName,
                        price: service.price, // Use the base price of the character service
                        quantity: 1
                    });
                }
            } else if (action === 'remove_all') {
                // Remove all instances of a specific character from the cart
                appState.selectedItems = appState.selectedItems.filter(item => item.name !== fullCharacterName);
            }
            // Re-render the services section and update the cart summary
            renderServicesSection();
            updateCartSummary();
            saveBookingFormData(); // Save cart state after each action.
        }

        /**
         * Handles adding or changing a theme in the cart.
         * Allows adding multiple themes, incrementing the quantity if already in the cart.
         * @param {object} service - The "Thematic Decorations" service object (base).
         * @param {string} themeName - The name of the selected theme.
         * @param {string} action - 'add' to add or 'remove_all' to remove.
         */
        function updateThemeInCart(service, themeName, action) {
            const fullThemeName = `${service.name}: ${themeName}`;
            const existingItemIndex = appState.selectedItems.findIndex(selected => selected.name === fullThemeName);

            if (action === 'add') {
                if (existingItemIndex > -1) {
                    appState.selectedItems[existingItemIndex].quantity++;
                } else {
                    appState.selectedItems.push({
                        id: `${service.id}-${themeName.replace(/\s+/g, '-')}`, // Generate a simple ID
                        name: fullThemeName,
                        price: service.price, // Use the base price of the decoration service
                        quantity: 1
                    });
                }
            } else if (action === 'remove_all') {
                appState.selectedItems = appState.selectedItems.filter(item => item.name !== fullThemeName);
            }
            renderServicesSection();
            updateCartSummary();
            saveBookingFormData(); // Save cart state after each action.
        }


        // --- Modal Functions (Pop-up Windows) ---
        /**
         * Displays a generic information modal.
         * @param {string} message - The message to display in the modal.
         * @param {function} [callback] - Function to execute when the modal closes.
         */
        function showInfoModal(message, callback = null) {
            const modal = document.getElementById('infoModal');
            const modalContent = document.getElementById('infoModalContent');
            const modalMessage = document.getElementById('modalMessage');

            if (modal && modalContent && modalMessage) {
                modalMessage.textContent = message;
                modal.classList.remove('hidden');
                // Animate the modal to appear smoothly
                setTimeout(() => {
                    modalContent.classList.remove('scale-95', 'opacity-0');
                    modalContent.classList.add('scale-100', 'opacity-100');
                }, 10); // Small delay to allow 'hidden' class to be removed first
                appState.infoModalCallback = callback; // Store the callback in the global state.
            } else {
                console.error("Error: Info modal elements not found.");
            }
        }

        /**
         * Hides the generic information modal and executes the callback if it exists.
         */
        function closeModal() {
            const modal = document.getElementById('infoModal');
            const modalContent = document.getElementById('infoModalContent');
            const modalMessage = document.getElementById('modalMessage');

            if (modal && modalContent && modalMessage) {
                modalContent.classList.remove('scale-100', 'opacity-100');
                modalContent.classList.add('scale-95', 'opacity-0');
                // Wait for the animation to finish before completely hiding
                setTimeout(() => {
                    modal.classList.add('hidden');
                    modalMessage.textContent = '';
                    if (appState.infoModalCallback) {
                        appState.infoModalCallback(); // Execute the callback.
                        appState.infoModalCallback = null; // Clear the callback after use.
                    }
                }, 300); // Duration of the CSS transition
            }
        }

        /**
         * Displays the promotion modal and activates the monthly discount.
         * @param {string} message - The promotion message.
         */
        function showPromoInfoModal(message) {
            const promoModal = document.getElementById('promoModal');
            const promoModalContent = document.getElementById('promoModalContent');
            const promoMessage = document.getElementById('promoMessage');

            if (promoModal && promoModalContent && promoMessage) {
                promoMessage.textContent = message;
                promoModal.classList.remove('hidden');
                setTimeout(() => {
                    promoModalContent.classList.remove('scale-95', 'opacity-0');
                    promoModalContent.classList.add('scale-100', 'opacity-100');
                }, 10);
                
                // Set all bubble packages for promotion
                appState.promotedPackages = bubblePackagesData.map(pkg => pkg.name);

                updateCartSummary();
                // Re-render sections if active to show the discount.
                if (appState.activeSection === 'services') renderServicesSection();
                if (appState.activeSection === 'packages') renderPackagesSection();
                if (appState.activeSection === 'bubblePackages') renderBubblePackagesSection(); // New section
                if (appState.activeSection === 'booking') renderBookingSection();
            } else {
                console.error("Error: Promotion modal elements not found.");
            }
        }

        /**
         * Hides the promotion modal.
         */
        function closePromoModal() {
            const modal = document.getElementById('promoModal');
            const modalContent = document.getElementById('promoModalContent');
            const promoMessage = document.getElementById('promoMessage');

            if (modal && modalContent && promoMessage) {
                modalContent.classList.remove('scale-100', 'opacity-100');
                modalContent.classList.add('scale-95', 'opacity-0');
                setTimeout(() => {
                    modal.classList.add('hidden');
                    promoMessage.textContent = '';
                    // Promoted packages are not cleared so the discount persists during the session.
                    updateCartSummary();
                    if (appState.activeSection === 'packages') renderPackagesSection(); // Refresh to ensure discount display.
                    if (appState.activeSection === 'bubblePackages') renderBubblePackagesSection(); // New section
                }, 300);
            }
        }

        /**
         * Displays the booking warning modal.
         */
        function showBookingWarningModal() {
            const modal = document.getElementById('bookingWarningModal');
            const modalContent = document.getElementById('bookingWarningModalContent');
            if (modal && modalContent) {
                modal.classList.remove('hidden');
                setTimeout(() => {
                    modalContent.classList.remove('scale-95', 'opacity-0');
                    modalContent.classList.add('scale-100', 'opacity-100');
                }, 10);
            } else {
                console.error("Error: Booking warning modal elements not found.");
            }
        }

        /**
         * Hides the booking warning modal.
         */
        function closeBookingWarningModal() {
            const modal = document.getElementById('bookingWarningModal');
            const modalContent = document.getElementById('bookingWarningModalContent');
            if (modal && modalContent) {
                modalContent.classList.remove('scale-100', 'opacity-100');
                modalContent.classList.add('scale-95', 'opacity-0');
                setTimeout(() => {
                    modal.classList.add('hidden');
                }, 300);
            }
        }

        /**
         * Displays the mini-cart modal with details of selected items.
         */
        function showMiniCartModal() {
            const miniCartModal = document.getElementById('miniCartModal');
            const miniCartModalContent = document.getElementById('miniCartModalContent');
            const miniCartItemsDiv = document.getElementById('miniCartItems');
            const miniCartTotalPriceSpan = document.getElementById('miniCartTotalPrice');
            // The miniCartTransportFeeSpan and its parent are no longer used for display in this modal,
            // but keeping the reference for completeness if needed elsewhere.
            const miniCartTransportFeeSpan = document.getElementById('miniCartTransportFee'); 
            const miniCartTransportFeeParent = miniCartTransportFeeSpan ? miniCartTransportFeeSpan.parentElement : null;

            // Add element existence checks for robustness
            if (!miniCartModal || !miniCartModalContent || !miniCartItemsDiv || !miniCartTotalPriceSpan) {
                console.error("Error: One or more essential mini-cart modal elements not found. Cannot display modal.");
                return; // Exit function if elements do not exist
            }

            if (appState.selectedItems.length === 0) {
                miniCartItemsDiv.innerHTML = '<p class="text-gray-600 text-center">Tu carrito estÃ¡ vacÃ­o. Â¡AÃ±ade algo de magia!</p>';
            } else {
                miniCartItemsDiv.innerHTML = appState.selectedItems.map(item => {
                    const itemTotalPrice = getAdjustedItemPrice(item); // Get total price for this item
                    
                    // Determine if a strikethrough price should be shown in the mini-cart.
                    // For Pintacaritas, if quantity > 1, show $45 strikethrough as the "original" single-hour price.
                    // For other items, show strikethrough if a promotion applies.
                    let strikethroughHtml = '';
                    if (item.name === 'Pintacaritas ğŸ¨ğŸ‘§ğŸ‘¦' && item.quantity > 1) {
                        strikethroughHtml = `<span class="line-through text-gray-500 text-xs">$${item.price.toFixed(2)}</span> `;
                    } else if (item.name !== 'Pintacaritas ğŸ¨ğŸ‘§ğŸ‘¦' && appState.promotedPackages.includes(item.name)) {
                        strikethroughHtml = `<span class="line-through text-gray-500 text-xs">$${item.price.toFixed(2)}</span> `;
                    }

                    return `
                        <div class="flex justify-between items-center py-1 border-b border-gray-100 last:border-b-0">
                            <span class="text-gray-700 text-sm">${item.name} ${item.quantity > 1 ? `(x${item.quantity})` : ''}</span>
                            <span class="font-semibold text-pink-600 text-sm">
                                ${strikethroughHtml}
                                $${itemTotalPrice.toFixed(2)}
                            </span>
                        </div>
                    `;
                }).join('');
            }

            // Transport surcharge is not shown in this modal, so calculate total without it.
            const totalItemsPrice = appState.selectedItems.reduce((sum, item) => {
                return sum + getAdjustedItemPrice(item);
            }, 0);
            
            miniCartTotalPriceSpan.textContent = `$${totalItemsPrice.toFixed(2)}`;

            // Ensure the transport surcharge line is hidden in the mini-cart
            if (miniCartTransportFeeParent) {
                miniCartTransportFeeParent.classList.add('hidden');
            }

            // Remove 'hidden' class and then start the transition
            miniCartModal.classList.remove('hidden');
            
            setTimeout(() => {
                miniCartModalContent.classList.remove('scale-95', 'opacity-0');
                miniCartModalContent.classList.add('scale-100', 'opacity-100');
            }, 50); // Slightly increased delay to ensure DOM has time to register 'hidden' removal
        }

        /**
         * Hides the mini-cart modal.
         */
        function closeMiniCartModal() {
            const modal = document.getElementById('miniCartModal');
            const modalContent = document.getElementById('miniCartModalContent');
            if (modal && modalContent) { // Add existence check
                modalContent.classList.remove('scale-100', 'opacity-100');
                modalContent.classList.add('scale-95', 'opacity-0');
                setTimeout(() => {
                    modal.classList.add('hidden');
                }, 300);
            }
        }

        /**
         * Displays the image modal with a specific image.
         * @param {string} imageUrl - The URL of the image to display.
         * @param {string} altText - The alt text for the image.
         */
        function showImageModal(imageUrl, altText) {
            const imageModal = document.getElementById('imageModal');
            const modalImage = document.getElementById('modalImage');
            const imageModalContent = document.getElementById('imageModalContent');

            if (imageModal && modalImage && imageModalContent) {
                modalImage.src = imageUrl;
                modalImage.alt = altText;
                imageModal.classList.remove('hidden');
                setTimeout(() => {
                    imageModalContent.classList.remove('scale-95', 'opacity-0');
                    imageModalContent.classList.add('scale-100', 'opacity-100');
                }, 10);
            } else {
                console.error("Error: Image modal elements not found.");
            }
        }

        /**
         * Hides the image modal.
         */
        function closeImageModal() {
            const imageModal = document.getElementById('imageModal');
            const imageModalContent = document.getElementById('imageModalContent'); // Added this line
            if (imageModal && imageModalContent) {
                imageModalContent.classList.remove('scale-100', 'opacity-100');
                imageModalContent.classList.add('scale-95', 'opacity-0');
                setTimeout(() => {
                    imageModal.classList.add('hidden');
                    document.getElementById('modalImage').src = ''; // Clear image source
                }, 300);
            }
        }


        // --- Section Rendering Functions ---

        /**
         * Renders the Home section.
         */
        function renderHomeSection() {
            const html = `
                <section class="bg-gradient-to-br from-white to-gray-50 rounded-3xl shadow-2xl p-4 sm:p-8 my-8 border-4 border-purple-400 flex items-center justify-center min-h-[60vh] animate-fade-in">
                    <div class="bg-gradient-to-br from-purple-100 to-pink-100 p-6 sm:p-10 rounded-2xl shadow-xl border-4 border-purple-300 max-w-3xl mx-auto text-center">
                        
                        <h2 class="text-3xl sm:text-4xl lg:text-5xl font-extrabold text-purple-800 mb-4 leading-tight text-center">
                            Â¡La Magia Comienza AquÃ­! âœ¨
                        </h2>
                        <p class="text-base sm:text-lg lg:text-xl text-gray-700 mb-8 px-2">
                            Diverty Eventos: <strong>fiestas infantiles inolvidables en PanamÃ¡</strong>. AnimaciÃ³n, shows de burbujas, pintacaritas, globoflexia. Â¡Hacemos tu fiesta soÃ±ada realidad!
                        </p>
                        <div class="flex flex-col sm:flex-row justify-center space-y-4 sm:space-y-0 sm:space-x-4 mt-8">
                            <button id="homeExploreServices" class="text-white font-bold py-3 px-8 rounded-full shadow-xl text-base sm:text-lg transition duration-300 transform hover:scale-105 bg-gradient-to-br from-pink-600 via-pink-400 to-pink-700 border-2 border-white cursor-pointer">
                                Â¡Explora Nuestros Servicios! ğŸ‰
                            </button>
                            <button id="homeExplorePackages" class="text-white font-bold py-3 px-8 rounded-full shadow-xl text-base sm:text-lg transition duration-300 transform hover:scale-105 bg-gradient-to-br from-purple-600 via-purple-400 to-purple-700 border-2 border-white cursor-pointer">
                                Â¡Explora Nuestros Planes de CumpleaÃ±os! ğŸ‚
                            </button>
                        </div>
                        <div class="flex flex-col sm:flex-row justify-center space-y-4 sm:space-y-0 sm:space-x-4 mt-8">
                            <button id="homeExploreBubblePackages" class="text-white font-bold py-3 px-8 rounded-full shadow-xl text-base sm:text-lg transition duration-300 transform hover:scale-105 bg-gradient-to-br from-blue-600 via-blue-400 to-blue-700 border-2 border-white cursor-pointer">
                                Â¡Paquetes de Burbujas! ğŸ«§
                            </button>
                            <button id="homePromoButton" class="text-white font-bold py-3 px-8 rounded-full shadow-xl text-base sm:text-lg transition duration-300 transform hover:scale-105 bg-gradient-to-br from-pink-500 via-purple-400 to-purple-600 border-2 border-white cursor-pointer">
                                ğŸ‰ PromociÃ³n del Mes ğŸ‰
                            </button>
                        </div>
                    </div>
                </section>
            `;
            renderSection(html);

            // Assign event listeners to the Home section buttons.
            const homeExploreServicesBtn = document.getElementById('homeExploreServices');
            if (homeExploreServicesBtn) homeExploreServicesBtn.onclick = () => { setActiveSection('services'); };
            
            const homeExplorePackagesBtn = document.getElementById('homeExplorePackages');
            if (homeExplorePackagesBtn) homeExplorePackagesBtn.onclick = () => { setActiveSection('packages'); };
            
            // New: Assign event listener for the "Paquetes de Burbujas" button
            const homeExploreBubblePackagesBtn = document.getElementById('homeExploreBubblePackages');
            if (homeExploreBubblePackagesBtn) homeExploreBubblePackagesBtn.onclick = () => { setActiveSection('bubblePackages'); };

            const homePromoButton = document.getElementById('homePromoButton');
            if (homePromoButton) homePromoButton.onclick = () => {
                showPromoInfoModal('Â¡Este mes, disfruta de un 10% de descuento EXCLUSIVO en todos nuestros paquetes de burbujas! ğŸ«§');
            };
        }

        /**
         * Renders the Individual Services section.
         */
        function renderServicesSection() {
            // Services that can have multiple quantities and, therefore, "Add" and "Remove All" buttons.
            const repeatableServices = ['Pintacaritas ğŸ¨ğŸ‘§ğŸ‘¦', 'Globoflexia ğŸˆğŸ’«', 'MÃ¡quinas de Snack AlgodÃ³n y Pop Corn ğŸ¿ğŸ­'];
            
            const cardsHtml = servicesData.map(service => {
                // Image for the service card
                // If imageUrl is empty, it will not render the <img> tag.
                // Added 'service-image' class for click event.
                const serviceImageHtml = service.imageUrl ? `<img src="${service.imageUrl}" alt="Imagen de ${service.name}" class="w-full h-40 object-cover rounded-t-lg mb-4 border-b-2 border-gray-300 shadow-sm cursor-pointer service-image">` : '';

                // Specific logic for the character selection service
                if (service.type === 'character_selection') {
                    // Find the currently selected character in the cart (if any of this type)
                    const selectedCharacterItems = appState.selectedItems.filter(item => item.name.startsWith(service.name + ':'));

                    const optionsHtml = service.characters.map(char => {
                        const fullCharName = `${service.name}: ${char.name}`;
                        const isCharacterAlreadyAdded = selectedCharacterItems.some(item => item.name === fullCharName);
                        // Disable the option in the select if already in the cart
                        return `<option value="${char.id}" ${isCharacterAlreadyAdded ? 'disabled' : ''}>${char.name} ${isCharacterAlreadyAdded ? '(AÃ±adido)' : ''}</option>`;
                    }).join('');

                    return `
                        <div class="${service.color} rounded-2xl shadow-xl flex flex-col justify-between border-4 border-dashed border-opacity50 transition duration-300 hover:scale-[1.02] hover:shadow-2xl">
                            ${serviceImageHtml}
                            <div class="p-4 sm:p-6 flex flex-col flex-grow">
                                <h2 class="text-xl sm:text-2xl font-bold mb-2 sm:mb-3 text-indigo-700">${service.name}</h2>
                                <p class="text-sm sm:text-base text-gray-700 mb-3 sm:mb-4">${service.description}</p>
                                <p class="text-3xl sm:text-4xl font-extrabold text-pink-600 mb-3 sm:mb-4">
                                    $${service.price.toFixed(2)}
                                </p>
                                <div class="mb-4">
                                    <label for="characterSelect-${service.id}" class="block text-gray-700 font-bold mb-2">Elige tu personaje: âœ¨</label>
                                    <select id="characterSelect-${service.id}" class="w-full p-2 border-2 border-gray-300 rounded-lg focus:ring-purple-500 focus:border-purple-500 text-sm sm:text-base cursor-pointer">
                                        <option value="">Selecciona un personaje</option>
                                        ${optionsHtml}
                                    </select>
                                </div>
                                <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2 mt-auto">
                                    <button
                                        data-service-id="${service.id}"
                                        data-action="add_character"
                                        class="character-action-button flex-grow bg-gradient-to-br from-indigo-600 via-indigo-400 to-indigo-700 text-white font-bold py-2 px-4 rounded-full shadow-xl text-sm transition duration-300 disabled:opacity-50 disabled:cursor-not-allowed border-2 border-white cursor-pointer"
                                        disabled
                                    >
                                        AÃ±adir Seleccionado â•
                                    </button>
                                </div>
                                <div id="selectedCharactersList-${service.id}" class="mt-4">
                                    ${selectedCharacterItems.length > 0 ? `<p class="font-semibold text-gray-700 mb-2">Personajes en tu carrito:</p>` : ''}
                                    ${selectedCharacterItems.map(item => `
                                        <div class="flex justify-between items-center bg-purple-100 p-2 rounded-lg mb-2 shadow-sm border border-purple-200">
                                            <span>${item.name.replace(service.name + ': ', '')} (x${item.quantity})</span>
                                            <button class="remove-specific-character-button text-red-500 hover:text-red-700 font-bold ml-2 transition duration-200 cursor-pointer"
                                                    data-full-name="${item.name}" aria-label="Quitar ${item.name}">ğŸ—‘ï¸</button>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    `;
                } else if (service.type === 'theme_selection') {
                    const selectedThemeItems = appState.selectedItems.filter(item => item.name.startsWith(service.name + ':'));

                    let themeOptionsHtml = '<option value="">Selecciona una temÃ¡tica</option>';
                    themeOptionsHtml += '<optgroup label="NiÃ±a">';
                    service.themes.ninas.forEach(theme => {
                        const fullThemeName = `${service.name}: ${theme}`;
                        const isThemeAlreadyAdded = selectedThemeItems.some(item => item.name === fullThemeName);
                        themeOptionsHtml += `<option value="${theme}" ${isThemeAlreadyAdded ? 'disabled' : ''}>${theme} ${isThemeAlreadyAdded ? '(AÃ±adida)' : ''}</option>`;
                    });
                    themeOptionsHtml += '</optgroup>';
                    themeOptionsHtml += '<optgroup label="NiÃ±o">';
                    service.themes.ninos.forEach(theme => {
                        const fullThemeName = `${service.name}: ${theme}`;
                        const isThemeAlreadyAdded = selectedThemeItems.some(item => item.name === fullThemeName);
                        themeOptionsHtml += `<option value="${theme}" ${isThemeAlreadyAdded ? 'disabled' : ''}>${theme} ${isThemeAlreadyAdded ? '(AÃ±adida)' : ''}</option>`;
                    });
                    themeOptionsHtml += '</optgroup>';

                    return `
                        <div class="${service.color} rounded-2xl shadow-xl flex flex-col justify-between border-4 border-dashed border-opacity-50 transition duration-300 hover:scale-[1.02] hover:shadow-2xl">
                            ${serviceImageHtml}
                            <div class="p-4 sm:p-6 flex flex-col flex-grow">
                                <h2 class="text-xl sm:text-2xl font-bold mb-2 sm:mb-3 text-pink-700">${service.name}</h2>
                                <p class="text-sm sm:text-base text-gray-700 mb-3 sm:mb-4">${service.description}</p>
                                <p class="text-3xl sm:text-4xl font-extrabold text-pink-600 mb-3 sm:mb-4">
                                    $${service.price.toFixed(2)}
                                </p>
                                <div class="mb-4">
                                    <label for="themeSelect-${service.id}" class="block text-gray-700 font-bold mb-2">Elige tu temÃ¡tica: ğŸ¨</label>
                                    <select id="themeSelect-${service.id}" class="w-full p-2 border-2 border-gray-300 rounded-lg focus:ring-pink-500 focus:border-pink-500 text-sm sm:text-base cursor-pointer">
                                        ${themeOptionsHtml}
                                    </select>
                                </div>
                                <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2 mt-auto">
                                    <button
                                        data-service-id="${service.id}"
                                        data-action="add_theme"
                                        class="theme-action-button flex-grow bg-gradient-to-br from-pink-600 via-pink-400 to-pink-700 text-white font-bold py-2 px-4 rounded-full shadow-xl text-sm transition duration-300 disabled:opacity-50 disabled:cursor-not-allowed border-2 border-white cursor-pointer"
                                        disabled
                                    >
                                        AÃ±adir Seleccionado â•
                                    </button>
                                </div>
                                <div id="selectedThemesList-${service.id}" class="mt-4">
                                    ${selectedThemeItems.length > 0 ? `<p class="font-semibold text-gray-700 mb-2">TemÃ¡ticas en tu carrito:</p>` : ''}
                                    ${selectedThemeItems.map(item => `
                                        <div class="flex justify-between items-center bg-pink-100 p-2 rounded-lg mb-2 shadow-sm border border-pink-200">
                                            <span>${item.name.replace(service.name + ': ', '')} (x${item.quantity})</span>
                                            <button class="remove-specific-theme-button text-red-500 hover:text-red-700 font-bold ml-2 transition duration-200 cursor-pointer"
                                                    data-full-name="${item.name}" aria-label="Quitar ${item.name}">ğŸ—‘ï¸</button>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    `;
                } else if (service.type === 'manualidades_workshop') {
                    const selectedItemInCart = appState.selectedItems.find(selected => selected.name === service.name);
                    // If the item is in the cart, use its quantity, otherwise default to 10 (minimum)
                    const currentQuantity = selectedItemInCart ? selectedItemInCart.quantity : 10; 

                    return `
                        <div class="${service.color} rounded-2xl shadow-xl flex flex-col justify-between border-4 border-dashed border-opacity-50 transition duration-300 hover:scale-[1.02] hover:hover:shadow-2xl">
                            ${serviceImageHtml}
                            <div class="p-4 sm:p-6 flex flex-col flex-grow">
                                <h2 class="text-xl sm:text-2xl font-bold mb-2 sm:mb-3 text-yellow-700">${service.name}</h2>
                                <p class="text-sm sm:text-base text-gray-700 mb-3 sm:mb-4">${service.description}</p>
                                <p class="text-3xl sm:text-4xl font-extrabold text-pink-600 mb-3 sm:mb-4">
                                    $${service.price.toFixed(2)} <span class="text-lg text-gray-600">/ niÃ±o</span>
                                </p>
                                <div class="mb-4">
                                    <label for="manualidadesQuantity-${service.id}" class="block text-gray-700 font-bold mb-2">Cantidad de NiÃ±os (MÃ­n. 10):</label>
                                    <input
                                        type="number"
                                        id="manualidadesQuantity-${service.id}"
                                        class="w-full p-2 border-2 border-gray-300 rounded-lg focus:ring-yellow-500 focus:border-yellow-500 text-sm sm:text-base"
                                        value="${currentQuantity}"
                                        min="10"
                                    />
                                </div>
                                <p class="text-lg font-semibold text-gray-700">Subtotal: <span id="manualidadesSubtotal-${service.id}">$${(service.price * currentQuantity).toFixed(2)}</span></p>
                                <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2 mt-auto">
                                    <button
                                        data-service-id="${service.id}"
                                        data-service-name="${service.name}"
                                        data-service-price="${service.price}"
                                        class="update-manualidades-quantity-button flex-grow bg-gradient-to-br from-yellow-600 via-yellow-400 to-yellow-700 text-white font-bold py-2 px-4 rounded-full shadow-xl text-sm transition duration-300 transform hover:scale-105 border-2 border-white cursor-pointer">
                                        Actualizar Cantidad ğŸ”„
                                    </button>
                                    ${selectedItemInCart ? `
                                    <button
                                        data-service-id="${service.id}"
                                        data-service-name="${service.name}"
                                        data-action-type="remove_all"
                                        class="add-remove-button flex-grow bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-full shadow-md text-sm transition duration-300 transform hover:scale-105 cursor-pointer">
                                        Quitar Taller ğŸ—‘ï¸
                                    </button>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    const isRepeatableService = repeatableServices.includes(service.name);
                    const selectedItemInCart = appState.selectedItems.find(selected => selected.name === service.name);
                    const currentQuantity = selectedItemInCart ? selectedItemInCart.quantity : 0;
                    
                    let displayPriceHtml;
                    if (service.name === 'Pintacaritas ğŸ¨ğŸ‘§ğŸ‘¦') {
                        // Special display for Pintacaritas on the card
                        displayPriceHtml = `<p class="text-3xl sm:text-4xl font-extrabold text-pink-600 mb-3 sm:mb-4">
                            $${service.price.toFixed(2)} <span class="text-lg text-gray-600">x 1 Hora</span><br>
                            <span class="text-xl text-gray-700">Horas adicionales: $40</span>
                        </p>`;
                    } else {
                        let displayPriceForCard = service.price; // Base price for display
                        let originalPriceHtmlForCard = '';

                        // If there's a promotion on this service
                        if (appState.promotedPackages.includes(service.name)) {
                            originalPriceHtmlForCard = `<span class="line-through text-gray-500 text-2xl">$${service.price.toFixed(2)}</span> `;
                            displayPriceForCard = service.price * 0.90; // Show discounted price on card
                        }

                        displayPriceHtml = `<p class="text-3xl sm:text-4xl font-extrabold text-pink-600 mb-3 sm:mb-4">
                            ${originalPriceHtmlForCard}$${displayPriceForCard.toFixed(2)}
                        </p>`;
                    }

                    let buttonsHtml;
                    if (isRepeatableService) {
                        // Buttons for services that can be added multiple times.
                        buttonsHtml = `
                            <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2 mt-auto">
                                <button
                                    data-item-name="${service.name}"
                                    data-item-price="${service.price}"
                                    data-action-type="add"
                                    class="add-remove-button flex-grow bg-gradient-to-br from-purple-600 via-purple-400 to-purple-700 text-white font-bold py-2 px-4 rounded-full shadow-xl text-sm transition duration-300 transform hover:scale-105 border-2 border-white cursor-pointer">
                                    AÃ±adir â• ${currentQuantity > 0 ? `(x${currentQuantity})` : ''}
                                </button>
                                ${currentQuantity > 0 ? `
                                <button
                                    data-item-name="${service.name}"
                                    data-item-price="${service.price}"
                                    data-action-type="remove_all"
                                    class="add-remove-button flex-grow bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-full shadow-md text-sm transition duration-300 transform hover:scale-105 cursor-pointer">
                                    Quitar Todo ğŸ—‘ï¸
                                </button>
                                ` : ''}
                            </div>
                        `;
                    } else {
                        // Button for non-repeatable services (add/remove).
                        const isSelected = selectedItemInCart ? true : false;
                        const buttonClassColor = isSelected ? 'bg-red-500 hover:bg-red-600' : 'bg-gradient-to-br from-purple-600 via-purple-400 to-purple-700 text-white border-2 border-white';
                        const buttonShadow = isSelected ? 'shadow-md' : 'shadow-xl';
                        buttonsHtml = `
                            <button
                                data-item-name="${service.name}"
                                data-item-price="${service.price}"
                                data-action-type="toggle"
                                class="add-remove-button mt-auto font-bold py-2 px-4 rounded-full ${buttonShadow} text-sm sm:text-base transition duration-300 ${buttonClassColor} text-white transform hover:scale-105 cursor-pointer">
                                ${isSelected ? 'Quitar del Carrito â–' : 'AÃ±adir al Carrito â•'}
                            </button>
                        `;
                    }

                    return `
                        <div class="${service.color} rounded-2xl shadow-xl flex flex-col justify-between border-4 border-dashed border-opacity-50 transition duration-300 hover:scale-[1.02] hover:shadow-2xl">
                            ${serviceImageHtml}
                            <div class="p-4 sm:p-6 flex flex-col flex-grow">
                                <h2 class="text-xl sm:text-2xl font-bold mb-2 sm:mb-3 text-purple-700">${service.name}</h2>
                                <p class="text-sm sm:text-base text-gray-700 mb-3 sm:mb-4">${service.description}</p>
                                ${displayPriceHtml}
                            </div>
                            ${buttonsHtml}
                        </div>
                    `;
                }
            }).join('');

            const html = `
                <section class="bg-gradient-to-br from-white to-gray-50 rounded-3xl shadow-2xl p-4 sm:p-8 my-8 border-4 border-purple-400 animate-fade-in">
                    <h2 class="text-3xl sm:text-4xl font-extrabold text-purple-700 text-center mb-8 sm:mb-10">Nuestros Servicios ğŸ‰</h2>
                    <p class="text-lg text-gray-700 text-center mb-8">
                        Servicios de animaciÃ³n para fiestas infantiles en PanamÃ¡. Â¡Hacemos tu evento mÃ¡gico e inolvidable!
                    </p>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-8">
                        ${cardsHtml}
                    </div>
                </section>
            `;
            renderSection(html);

            // Assign event listeners to all add/remove buttons for regular services.
            document.querySelectorAll('#mainContent .add-remove-button').forEach(button => {
                button.onclick = (event) => {
                    const itemName = event.target.dataset.itemName;
                    const itemPrice = parseFloat(event.target.dataset.itemPrice);
                    const actionType = event.target.dataset.actionType;
                    handleCartAction({ name: itemName, price: itemPrice }, actionType);
                };
            });

            // Assign event listeners for the add/change character button
            document.querySelectorAll('#mainContent .character-action-button').forEach(button => {
                button.onclick = (event) => {
                    const serviceId = event.target.dataset.serviceId;
                    const selectElement = document.getElementById(`characterSelect-${serviceId}`);
                    const selectedCharacterId = selectElement.value;

                    if (selectedCharacterId) {
                        const characterService = servicesData.find(s => s.id === serviceId);
                        const selectedChar = characterService.characters.find(c => c.id === selectedCharacterId);
                        if (selectedChar) {
                            updateCharacterInCart(characterService, selectedChar, 'add');
                            selectElement.value = ""; // Reset the select after adding
                        }
                    } else {
                        showInfoModal('Por favor, selecciona un personaje antes de aÃ±adirlo.');
                    }
                };
            });

            // Assign event listeners for the remove specific character buttons
            document.querySelectorAll('#mainContent .remove-specific-character-button').forEach(button => {
                button.onclick = (event) => {
                    const fullCharacterName = event.target.dataset.fullName;
                    // Find the base character service
                    const characterService = servicesData.find(s => s.type === 'character_selection');
                    // Extract only the character name to find it in the original list
                    const charNameOnly = fullCharacterName.replace(characterService.name + ': ', '');
                    const characterToRemove = characterService.characters.find(c => c.name === charNameOnly);

                    if (characterService && characterToRemove) {
                        updateCharacterInCart(characterService, characterToRemove, 'remove_all');
                    }
                };
            });

            // Logic to enable/disable the "Add Selected" button and update its text (for characters)
            document.querySelectorAll('#mainContent select[id^="characterSelect-"]').forEach(select => {
                select.onchange = (event) => {
                    const serviceId = event.target.id.split('-')[1];
                    const selectedCharacterId = event.target.value;
                    const addButton = document.querySelector(`.character-action-button[data-service-id="${serviceId}"]`);
                    
                    if (selectedCharacterId) {
                        const characterService = servicesData.find(s => s.id === serviceId);
                        const selectedChar = characterService.characters.find(c => c.id === selectedCharacterId);
                        const fullCharName = `${characterService.name}: ${selectedChar.name}`;
                        const existingInCart = appState.selectedItems.find(item => item.name === fullCharName);

                        if (existingInCart) {
                            addButton.textContent = `AÃ±adir uno mÃ¡s de ${selectedChar.name} (x${existingInCart.quantity + 1})`;
                            addButton.disabled = false;
                        } else {
                            addButton.textContent = `AÃ±adir ${selectedChar.name} al Carrito â•`;
                            addButton.disabled = false;
                        }
                    } else {
                        addButton.textContent = `AÃ±adir Seleccionado â•`;
                        addButton.disabled = true;
                    }
                };
            });

            // Assign event listeners for the add theme button
            document.querySelectorAll('#mainContent .theme-action-button').forEach(button => {
                button.onclick = (event) => {
                    const serviceId = event.target.dataset.serviceId;
                    const selectElement = document.getElementById(`themeSelect-${serviceId}`);
                    const selectedThemeName = selectElement.value;

                    if (selectedThemeName) {
                        const themeService = servicesData.find(s => s.id === serviceId);
                        updateThemeInCart(themeService, selectedThemeName, 'add');
                        selectElement.value = ""; // Reset the select after adding
                    } else {
                        showInfoModal('Por favor, selecciona una temÃ¡tica antes de aÃ±adirla.');
                    }
                };
            });

            // Assign event listeners for the remove specific theme buttons
            document.querySelectorAll('#mainContent .remove-specific-theme-button').forEach(button => {
                button.onclick = (event) => {
                    const fullThemeName = event.target.dataset.fullName;
                    const themeService = servicesData.find(s => s.type === 'theme_selection');
                    // Extract only the theme name
                    const themeNameOnly = fullThemeName.replace(themeService.name + ': ', '');
                    updateThemeInCart(themeService, themeNameOnly, 'remove_all');
                };
            });

            // Logic to enable/disable the "Add Selected" button and update its text (for themes)
            document.querySelectorAll('#mainContent select[id^="themeSelect-"]').forEach(select => {
                select.onchange = (event) => {
                    const serviceId = event.target.id.split('-')[1];
                    const selectedThemeName = event.target.value;
                    const addButton = document.querySelector(`.theme-action-button[data-service-id="${serviceId}"]`);
                    
                    if (selectedThemeName) {
                        const themeService = servicesData.find(s => s.id === serviceId);
                        const fullThemeName = `${themeService.name}: ${selectedThemeName}`;
                        const existingInCart = appState.selectedItems.find(item => item.name === fullThemeName);

                        if (existingInCart) {
                            addButton.textContent = `AÃ±adir una mÃ¡s de ${selectedThemeName} (x${existingInCart.quantity + 1})`;
                            addButton.disabled = false;
                        } else {
                            addButton.textContent = `AÃ±adir ${selectedThemeName} al Carrito â•`;
                            addButton.disabled = false;
                        }
                    } else {
                        addButton.textContent = `AÃ±adir Seleccionado â•`;
                        addButton.disabled = true;
                    }
                };
            });

            // Event listeners for Mini Taller de Manualidades quantity input and button
            document.querySelectorAll('#mainContent .update-manualidades-quantity-button').forEach(button => {
                button.onclick = (event) => {
                    const serviceId = event.target.dataset.serviceId;
                    const serviceName = event.target.dataset.serviceName;
                    const servicePrice = parseFloat(event.target.dataset.servicePrice);
                    const quantityInput = document.getElementById(`manualidadesQuantity-${serviceId}`);
                    let quantity = parseInt(quantityInput.value, 10);

                    if (isNaN(quantity) || quantity < 10) {
                        showInfoModal('La cantidad mÃ­nima para el Mini Taller de Manualidades es 10 niÃ±os.');
                        quantityInput.value = 10; // Reset to minimum
                        quantity = 10;
                    }

                    handleCartAction({ id: serviceId, name: serviceName, price: servicePrice }, 'set_quantity', quantity);
                };
            });

            document.querySelectorAll('#mainContent input[id^="manualidadesQuantity-"]').forEach(input => {
                input.oninput = (event) => {
                    const serviceId = event.target.id.split('-')[1];
                    const service = servicesData.find(s => s.id === serviceId);
                    if (!service) return; // Guard clause if service not found
                    
                    const servicePrice = service.price;
                    const quantity = parseInt(event.target.value, 10);
                    const subtotalSpan = document.getElementById(`manualidadesSubtotal-${serviceId}`);
                    if (subtotalSpan && !isNaN(quantity) && quantity >= 0) {
                        subtotalSpan.textContent = `$${(servicePrice * quantity).toFixed(2)}`;
                    }
                };
            });

            // Add event listeners for image clicks
            document.querySelectorAll('.service-image').forEach(img => {
                img.onclick = (event) => {
                    showImageModal(event.target.src, event.target.alt);
                };
            });
        }

        /**
         * Renders the Packages section.
         */
        function renderPackagesSection() {
            const cardsHtml = packagesData.map(pkg => {
                const selectedItemInCart = appState.selectedItems.find(item => item.name === pkg.name);
                const isSelected = selectedItemInCart ? true : false;

                let buttonText;
                let buttonClassColor;
                let buttonShadow;
                let buttonBorder;

                if (isSelected) {
                    buttonText = 'Quitar del Carrito â–';
                    buttonClassColor = 'bg-red-500 hover:bg-red-600';
                    buttonShadow = 'shadow-md';
                    buttonBorder = ''; // No border for remove state
                } else {
                    buttonText = 'AÃ±adir al Carrito â•';
                    buttonClassColor = 'bg-gradient-to-br from-purple-600 via-purple-400 to-purple-700 text-white';
                    buttonShadow = 'shadow-xl';
                    buttonBorder = 'border-2 border-white';
                }

                let displayPrice = getAdjustedItemPrice({ ...pkg, quantity: 1 }); // Packages always have quantity 1 for price calculation on card.
                let originalPriceHtml = '';
                
                // If the adjusted price is different from the original price, show the original price strikethrough.
                if (Math.abs(displayPrice - pkg.price) > 0.001) { // Use epsilon for float comparison
                    originalPriceHtml = `<span class="line-through text-gray-500 text-2xl">$${pkg.price.toFixed(2)}</span> `;
                }

                // Image for the package card - now empty
                // Added 'service-image' class for click event.
                const packageImageHtml = pkg.imageUrl ? `<img src="${pkg.imageUrl}" alt="Imagen de ${pkg.name}" class="w-full h-40 object-cover rounded-t-lg mb-4 border-b-2 border-gray-300 shadow-sm cursor-pointer service-image">` : '';

                return `
                    <div class="${pkg.color} rounded-2xl shadow-xl flex flex-col justify-between border-4 border-dashed border-opacity-50 transition duration-300 hover:scale-[1.02] hover:shadow-2xl">
                        ${packageImageHtml}
                        <div class="p-4 sm:p-6 flex flex-col flex-grow">
                            <h2 class="text-xl sm:text-2xl font-bold mb-2 sm:mb-3 text-indigo-700">${pkg.name}</h2>
                            <p class="text-sm sm:text-base text-gray-700 mb-3 sm:mb-4">${pkg.description}</p>
                            <ul class="list-disc list-inside text-gray-600 mb-3 sm:mb-4 text-sm sm:text-base">
                                ${pkg.services.map(service => `<li>${service}</li>`).join('')}
                            </ul>
                            <p class="text-3xl sm:text-4xl font-extrabold text-pink-600 mb-3 sm:mb-4">
                                ${originalPriceHtml}$${displayPrice.toFixed(2)}
                            </p>
                            <button
                                data-item-name="${pkg.name}"
                                data-item-price="${pkg.price}"
                                data-action-type="toggle"
                                class="add-remove-button mt-auto font-bold py-2 px-4 rounded-full ${buttonShadow} text-sm sm:text-base transition duration-300 ${buttonClassColor} text-white transform hover:scale-105 ${buttonBorder} cursor-pointer">
                                ${buttonText}
                            </button>
                        </div>
                    </div>
                `;
            }).join('');

            const html = `
                <section class="bg-gradient-to-br from-white to-gray-50 rounded-3xl shadow-2xl p-4 sm:p-8 my-8 border-4 border-pink-400 animate-fade-in">
                    <h2 class="text-3xl sm:text-4xl font-extrabold text-purple-700 text-center mb-8 sm:mb-10">Nuestros Planes de CumpleaÃ±os ğŸ‚</h2>
                    <p class="text-lg text-gray-700 text-center mb-8">
                        Descubre nuestros planes de <strong>cumpleaÃ±os para eventos infantiles en PanamÃ¡</strong>. Â¡La opciÃ³n perfecta para tu celebraciÃ³n!
                    </p>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-8">
                        ${cardsHtml}
                    </div>
                </section>
            `;
            renderSection(html);

            // Assign event listeners to all add/remove buttons in the packages section.
            document.querySelectorAll('#mainContent .add-remove-button').forEach(button => {
                button.onclick = (event) => {
                    const itemName = event.target.dataset.itemName;
                    const itemPrice = parseFloat(event.target.dataset.itemPrice);
                    const actionType = event.target.dataset.actionType;
                    handleCartAction({ name: itemName, price: itemPrice }, actionType);
                };
            });

            // Add event listeners for image clicks
            document.querySelectorAll('.service-image').forEach(img => {
                img.onclick = (event) => {
                    showImageModal(event.target.src, event.target.alt);
                };
            });
        }

        /**
         * Renders the Bubble Packages section.
         */
        function renderBubblePackagesSection() {
            const cardsHtml = bubblePackagesData.map(pkg => {
                const selectedItemInCart = appState.selectedItems.find(item => item.name === pkg.name);
                const isSelected = selectedItemInCart ? true : false;

                let buttonText;
                let buttonClassColor;
                let buttonShadow;
                let buttonBorder;

                if (isSelected) {
                    buttonText = 'Quitar del Carrito â–';
                    buttonClassColor = 'bg-red-500 hover:bg-red-600';
                    buttonShadow = 'shadow-md';
                    buttonBorder = ''; // No border for remove state
                } else {
                    buttonText = 'AÃ±adir al Carrito â•';
                    buttonClassColor = 'bg-gradient-to-br from-blue-600 via-blue-400 to-blue-700 text-white';
                    buttonShadow = 'shadow-xl';
                    buttonBorder = 'border-2 border-white';
                }

                let displayPrice = getAdjustedItemPrice({ ...pkg, quantity: 1 }); // Packages always have quantity 1 for price calculation on card.
                let originalPriceHtml = '';
                
                // If the adjusted price is different from the original price, show the original price strikethrough.
                if (Math.abs(displayPrice - pkg.price) > 0.001) { // Use epsilon for float comparison
                    originalPriceHtml = `<span class="line-through text-gray-500 text-2xl">$${pkg.price.toFixed(2)}</span> `;
                }

                // Image for the bubble package card - now empty
                // Added 'service-image' class for click event.
                const bubblePackageImageHtml = pkg.imageUrl ? `<img src="${pkg.imageUrl}" alt="Imagen de ${pkg.name}" class="w-full h-40 object-cover rounded-t-lg mb-4 border-b-2 border-gray-300 shadow-sm cursor-pointer service-image">` : '';


                return `
                    <div class="${pkg.color} rounded-2xl shadow-xl flex flex-col justify-between border-4 border-dashed border-opacity-50 transition duration-300 hover:scale-[1.02] hover:shadow-2xl">
                        ${bubblePackageImageHtml}
                        <div class="p-4 sm:p-6 flex flex-col flex-grow">
                            <h2 class="text-xl sm:text-2xl font-bold mb-2 sm:mb-3 text-blue-700">${pkg.name}</h2>
                            <p class="text-sm sm:text-base text-gray-700 mb-3 sm:mb-4">${pkg.description}</p>
                            <ul class="list-disc list-inside text-gray-600 mb-3 sm:mb-4 text-sm sm:text-base">
                                ${pkg.services.map(service => `<li>${service}</li>`).join('')}
                            </ul>
                            <p class="text-3xl sm:text-4xl font-extrabold text-pink-600 mb-3 sm:mb-4">
                                ${originalPriceHtml}$${displayPrice.toFixed(2)}
                            </p>
                            <button
                                data-item-name="${pkg.name}"
                                data-item-price="${pkg.price}"
                                data-action-type="toggle"
                                class="add-remove-button mt-auto font-bold py-2 px-4 rounded-full ${buttonShadow} text-sm sm:text-base transition duration-300 ${buttonClassColor} text-white transform hover:scale-105 ${buttonBorder} cursor-pointer">
                                ${buttonText}
                            </button>
                        </div>
                    </div>
                `;
            }).join('');

            const html = `
                <section class="bg-gradient-to-br from-white to-gray-50 rounded-3xl shadow-2xl p-4 sm:p-8 my-8 border-4 border-blue-400 animate-fade-in">
                    <h2 class="text-3xl sm:text-4xl font-extrabold text-blue-700 text-center mb-8 sm:mb-10">Nuestros Paquetes de Burbujas ğŸ«§</h2>
                    <p class="text-lg text-gray-700 text-center mb-8">
                        Â¡SumÃ©rgete en la diversiÃ³n con nuestros increÃ­bles paquetes de shows de burbujas gigantes en PanamÃ¡!
                    </p>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-8">
                        ${cardsHtml}
                    </div>
                </section>
            `;
            renderSection(html);

            // Assign event listeners to all add/remove buttons in the bubble packages section.
            document.querySelectorAll('#mainContent .add-remove-button').forEach(button => {
                button.onclick = (event) => {
                    const itemName = event.target.dataset.itemName;
                    const itemPrice = parseFloat(event.target.dataset.itemPrice);
                    const actionType = event.target.dataset.actionType;
                    handleCartAction({ name: itemName, price: itemPrice }, actionType);
                };
            });

            // Add event listeners for image clicks
            document.querySelectorAll('.service-image').forEach(img => {
                img.onclick = (event) => {
                    showImageModal(event.target.src, event.target.alt);
                };
            });
        }


        /**
         * Renders the Booking section, displaying selected items and the form.
         * Calculates and displays the total price, including discounts and transport surcharges.
         */
        function renderBookingSection() {
            // Generate the list of selected items to display in the booking section.
            const selectedItemsListHtml = appState.selectedItems.length === 0
                ? `<p class="text-red-600 text-sm sm:text-base">No has seleccionado ningÃºn servicio. Por favor, vuelve a la secciÃ³n de Servicios o Paquetes.</p>`
                : `<div class="space-y-2">
                    ${appState.selectedItems.map((item) => {
                        const itemTotalPrice = getAdjustedItemPrice(item); // Get total price for this item

                        // Determine if a strikethrough price should be shown in the booking summary.
                        // For Pintacaritas, if quantity > 1, show $45 strikethrough as the "original" single-hour price.
                        // For other items, show strikethrough if a promotion applies.
                        let strikethroughHtml = '';
                        if (item.name === 'Pintacaritas ğŸ¨ğŸ‘§ğŸ‘¦' && item.quantity > 1) {
                            strikethroughHtml = `<span class="line-through text-gray-500 text-xs">$${item.price.toFixed(2)}</span> `;
                        } else if (item.name !== 'Pintacaritas ğŸ¨ğŸ‘§ğŸ‘¦' && appState.promotedPackages.includes(item.name)) {
                            strikethroughHtml = `<span class="line-through text-gray-500 text-xs">$${item.price.toFixed(2)}</span> `;
                        }
                        
                        return `
                            <div class="flex justify-between items-center bg-white p-3 rounded-lg shadow-sm border border-gray-200">
                                <span class="font-semibold text-gray-800 text-sm">${item.name} ${item.quantity > 1 ? `(x${item.quantity})` : ''}</span>
                                <div class="flex items-center space-x-2">
                                    ${strikethroughHtml}
                                    <span class="font-bold text-pink-600 text-base">$${itemTotalPrice.toFixed(2)}</span>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>`;

            // Calculate and display the transport surcharge.
            const currentTransportFee = transportFeesByLocation[appState.selectedLocation] || 0;
            const transportFeeDisplayHtml = currentTransportFee > 0
                ? `<p class="text-lg font-bold text-gray-700 mt-2">Recargo por Transporte (${appState.selectedLocation}): <span class="text-orange-600">$${currentTransportFee.toFixed(2)}</span></p>`
                : `<p class="text-lg font-bold text-gray-700 mt-2">Recargo por Transporte: <span class="text-green-600">Â¡Gratis en PanamÃ¡ Centro!</span></p>`;

            // Calculate the final total price including discounts and surcharges.
            const totalItemsPrice = appState.selectedItems.reduce((sum, item) => {
                return sum + getAdjustedItemPrice(item);
            }, 0);
            const finalTotalPrice = totalItemsPrice + currentTransportFee;

            const html = `
                <section class="bg-gradient-to-br from-white to-gray-50 rounded-3xl shadow-2xl p-4 sm:p-8 my-8 border-4 border-purple-400 animate-fade-in">
                    <h2 class="text-3xl sm:text-4xl font-extrabold text-purple-700 text-center mb-8 sm:mb-10">Reserva tu Evento ğŸ—“ï¸</h2>
                    <p class="text-lg text-gray-700 text-center mb-8">
                        Â¡Reserva tu <strong>fiesta infantil en PanamÃ¡</strong>! Completa este formulario para asegurar la magia de tu evento.
                    </p>
                    <div class="grid grid-cols-1 lg:grid-cols-1 gap-4 sm:gap-12">
                        <h3 class="text-xl sm:text-2xl font-bold text-purple-700 mb-4 sm:mb-6">Completa los Detalles de Tu Reserva ğŸ“</h3>
                        <div class="bg-gradient-to-br from-purple-100 to-purple-200 p-4 sm:p-8 rounded-3xl shadow-2xl border-4 border-purple-400">
                            <form id="bookingForm" class="space-y-4">
                                <div class="bg-gradient-to-br from-pink-50 to-pink-100 p-4 rounded-2xl shadow-xl border-4 border-pink-300 mb-4">
                                    <h4 class="text-lg font-bold text-pink-700 mb-3">Tu SelecciÃ³n:</h4>
                                    ${selectedItemsListHtml}
                                    ${transportFeeDisplayHtml}
                                    <p class="text-lg font-bold text-purple-700 mt-3">Total a Pagar: <span class="text-pink-600">$${finalTotalPrice.toFixed(2)}</span></p>
                                </div>
                                
                                <div>
                                    <label for="locationSelect" class="block text-gray-700 font-bold mb-1 sm:mb-2 text-sm sm:text-base">UbicaciÃ³n del Evento (Provincia/Zona):ğŸ“</label>
                                    <select
                                        id="locationSelect"
                                        name="ubicacionEvento"
                                        class="w-full p-2 sm:p-3 border-2 border-gray-300 rounded-lg focus:ring-purple-500 focus:border-purple-500 text-sm sm:text-base cursor-pointer"
                                    >
                                        <option value="PanamÃ¡ Centro" ${appState.bookingFormData.selectedLocation === 'PanamÃ¡ Centro' ? 'selected' : ''}>PanamÃ¡ Centro</option>
                                        <option value="ArraijÃ¡n" ${appState.bookingFormData.selectedLocation === 'ArraijÃ¡n' ? 'selected' : ''}>ArraijÃ¡n ($10 adicional)</option>
                                        <option value="La Chorrera" ${appState.bookingFormData.selectedLocation === 'La Chorrera' ? 'selected' : ''}>La Chorrera ($15 adicional)</option>
                                        <option value="Pacora" ${appState.bookingFormData.selectedLocation === 'Pacora' ? 'selected' : ''}>Pacora ($10 adicional)</option>
                                        <option value="PanamÃ¡ Norte" ${appState.bookingFormData.selectedLocation === 'PanamÃ¡ Norte' ? 'selected' : ''}>PanamÃ¡ Norte ($10 adicional)</option>
                                    </select>
                                </div>

                                <div>
                                    <label for="exactLocation" class="block text-gray-700 font-bold mb-1 sm:mb-2 text-sm sm:text-base">DirecciÃ³n Exacta del Evento: ğŸ—ºï¸</label>
                                    <input
                                        type="text"
                                        id="exactLocation"
                                        name="direccionExacta"
                                        class="w-full p-2 sm:p-3 border-2 border-gray-300 rounded-lg focus:ring-purple-500 focus:border-purple-500 text-sm sm:text-base"
                                        placeholder="Ej: Calle Principal, Casa #15, Cerca de la escuela..."
                                        value="${appState.bookingFormData.exactLocation || ''}"
                                        required
                                    />
                                    <span id="error-exactLocation" class="error-message hidden">Este campo es obligatorio.</span>
                                </div>

                                <div>
                                    <label for="bookingDate" class="block text-gray-700 font-bold mb-1 sm:mb-2 text-sm sm:text-base">Fecha del Evento: ğŸ“†</label>
                                    <input
                                        type="date"
                                        id="bookingDate"
                                        name="fechaEvento"
                                        class="w-full p-2 sm:p-3 border-2 border-gray-300 rounded-lg focus:ring-purple-500 focus:border-purple-500 text-sm sm:text-base"
                                        min="${new Date().toISOString().split('T')[0]}"
                                        value="${appState.bookingFormData.bookingDate || ''}"
                                        required
                                    />
                                    <span id="error-bookingDate" class="error-message hidden">Este campo es obligatorio.</span>
                                </div>
                                <div>
                                    <label for="bookingTime" class="block text-gray-700 font-bold mb-1 sm:mb-2 text-sm sm:text-base">Hora del Evento: â°</label>
                                    <input
                                        type="time"
                                        id="bookingTime"
                                        name="horaEvento"
                                        class="w-full p-2 sm:p-3 border-2 border-gray-300 rounded-lg focus:ring-purple-500 focus:border-purple-500 text-sm sm:text-base"
                                        value="${appState.bookingFormData.bookingTime || ''}"
                                        required
                                    />
                                    <span id="error-bookingTime" class="error-message hidden">Este campo es obligatorio.</span>
                                </div>
                                <div>
                                    <label for="customerName" class="block text-gray-700 font-bold mb-1 sm:mb-2 text-sm sm:text-base">Tu Nombre: ğŸ‘¤</label>
                                    <input
                                        type="text"
                                        id="customerName"
                                        name="nombreCliente"
                                        class="w-full p-2 sm:p-3 border-2 border-gray-300 rounded-lg focus:ring-purple-500 focus:border-purple-500 text-sm sm:text-base"
                                        placeholder="Ej: Juan PÃ©rez"
                                        value="${appState.bookingFormData.customerName || ''}"
                                        required
                                    />
                                    <span id="error-customerName" class="error-message hidden">Este campo es obligatorio.</span>
                                </div>
                                <div>
                                    <label for="customerEmail" class="block text-gray-700 font-bold mb-1 sm:mb-2 text-sm sm:text-base">Tu Email: ğŸ“§</label>
                                    <input
                                        type="email"
                                        id="customerEmail"
                                        name="emailCliente"
                                        class="w-full p-2 sm:p-3 border-2 border-gray-300 rounded-lg focus:ring-purple-500 focus:border-purple-500 text-sm sm:text-base"
                                        placeholder="Ej: tu.email@example.com"
                                        value="${appState.bookingFormData.customerEmail || ''}"
                                        required
                                    />
                                    <span id="error-customerEmail" class="error-message hidden">Este campo es obligatorio.</span>
                                </div>
                                <div>
                                    <label for="customerPhone" class="block text-gray-700 font-bold mb-1 sm:mb-2 text-sm sm:text-base">Tu TelÃ©fono:ğŸ“</label>
                                    <input
                                        type="tel"
                                        id="customerPhone"
                                        name="telefonoCliente"
                                        class="w-full p-2 sm:p-3 border-2 border-gray-300 rounded-lg focus:ring-purple-500 focus:border-purple-500 text-sm sm:text-base"
                                        placeholder="Ej: 555-1234567"
                                        value="${appState.bookingFormData.customerPhone || ''}"
                                        required
                                    />
                                    <span id="error-customerPhone" class="error-message hidden">Este campo es obligatorio.</span>
                                </div>
                                <div>
                                    <label for="eventType" class="block text-gray-700 font-bold mb-1 sm:mb-2 text-sm sm:text-base">Tipo de Evento: ğŸ‰</label>
                                    <input
                                        type="text"
                                        id="eventType"
                                        name="tipoEvento"
                                        class="w-full p-2 sm:p-3 border-2 border-gray-300 rounded-lg focus:ring-purple-500 focus:border-purple-500 text-sm sm:text-base"
                                        placeholder="Ej: CumpleaÃ±os, GraduaciÃ³n"
                                        value="${appState.bookingFormData.eventType || ''}"
                                        required
                                    />
                                    <span id="error-eventType" class="error-message hidden">Este campo es obligatorio.</span>
                                </div>
                                <div>
                                    <label for="numKids" class="block text-gray-700 font-bold mb-1 sm:mb-2 text-sm sm:text-base">NÃºmero Estimado de NiÃ±os: ğŸ‘§ğŸ‘¦</label>
                                    <input
                                        type="number"
                                        id="numKids"
                                        name="numeroNinos"
                                        class="w-full p-2 sm:p-3 border-2 border-gray-300 rounded-lg focus:ring-purple-500 focus:border-purple-500 text-sm sm:text-base"
                                        placeholder="Ej: 20"
                                        min="1"
                                        value="${appState.bookingFormData.numKids || ''}"
                                        required
                                    />
                                    <span id="error-numKids" class="error-message hidden">Este campo es obligatorio.</span>
                                </div>
                                <button type="submit" class="w-full bg-gradient-to-br from-purple-600 via-purple-400 to-purple-700 hover:from-purple-700 hover:to-purple-800 text-white font-bold py-2 sm:py-3 px-4 sm:px-6 rounded-full shadow-xl text-base sm:text-lg mt-4 transition duration-300 transform hover:scale-105 border-2 border-white cursor-pointer">
                                    Â¡Confirmar Reserva MÃ¡gica! âœ¨
                                </button>
                            </form>
                        </div>
                    </div>
                </section>
            `;
            renderSection(html);

            const bookingForm = document.getElementById('bookingForm');
            if (bookingForm) {
                bookingForm.onsubmit = handleBookingSubmit;
                // Change handler for location selection, updates state and cart summary.
                const locationSelect = document.getElementById('locationSelect');
                if (locationSelect) {
                    locationSelect.onchange = (e) => {
                        appState.bookingFormData.selectedLocation = e.target.value; // Update state when location changes.
                        appState.selectedLocation = e.target.value; // Also update general location state.
                        updateCartSummary(); 
                        renderBookingSection(); // Re-render the section to display the updated surcharge.
                    };
                }
            }
        }

        // --- Functions to save and load booking form data ---
        /**
         * Saves current booking form data and selected items to localStorage.
         */
        function saveBookingFormData() {
            const bookingForm = document.getElementById('bookingForm');
            if (bookingForm) {
                appState.bookingFormData.bookingDate = bookingForm.elements.bookingDate ? bookingForm.elements.bookingDate.value : '';
                appState.bookingFormData.bookingTime = bookingForm.elements.bookingTime ? bookingForm.elements.bookingTime.value : '';
                appState.bookingFormData.customerName = bookingForm.elements.customerName ? bookingForm.elements.customerName.value : '';
                appState.bookingFormData.customerEmail = bookingForm.elements.customerEmail ? bookingForm.elements.customerEmail.value : '';
                appState.bookingFormData.customerPhone = bookingForm.elements.customerPhone ? bookingForm.elements.customerPhone.value : '';
                appState.bookingFormData.eventType = bookingForm.elements.eventType ? bookingForm.elements.eventType.value : '';
                appState.bookingFormData.numKids = bookingForm.elements.numKids ? bookingForm.elements.numKids.value : '';
                appState.bookingFormData.exactLocation = bookingForm.elements.exactLocation ? bookingForm.elements.exactLocation.value : '';
                appState.bookingFormData.selectedLocation = bookingForm.elements.locationSelect ? bookingForm.elements.locationSelect.value : 'PanamÃ¡ Centro';
                
                // Save form data and selected items to localStorage.
                localStorage.setItem('bookingFormData', JSON.stringify(appState.bookingFormData));
                localStorage.setItem('selectedItems', JSON.stringify(appState.selectedItems));
                console.log('Form data and cart saved:', appState.bookingFormData, appState.selectedItems); // For debugging.
            }
        }

        /**
         * Loads booking form data and selected items from localStorage to appState.
         */
        function loadBookingFormData() {
            try {
                const savedFormData = localStorage.getItem('bookingFormData');
                if (savedFormData) {
                    appState.bookingFormData = JSON.parse(savedFormData);
                    // Ensure selectedLocation is also updated in the general state if data is loaded.
                    appState.selectedLocation = appState.bookingFormData.selectedLocation;
                    console.log('Form data loaded:', appState.bookingFormData); // For debugging.
                }
                const savedSelectedItems = localStorage.getItem('selectedItems');
                if (savedSelectedItems) {
                    appState.selectedItems = JSON.parse(savedSelectedItems);
                    console.log('Cart items loaded:', appState.selectedItems); // For debugging.
                }
            } catch (e) {
                console.error("Error loading data from localStorage:", e);
                // Clear localStorage if there's a parsing error to avoid loops
                localStorage.removeItem('bookingFormData');
                localStorage.removeItem('selectedItems');
            }
        }


        // --- Main Application Logic ---

        /**
         * Sets the active section and updates navigation, sending a page_view to Google Analytics.
         * @param {string} sectionName - The name of the section to activate ('home', 'services', 'packages', 'bubblePackages', 'booking').
         */
        function setActiveSection(sectionName) {
            // If the current section is 'booking' and we are going to another section, save the data.
            if (appState.activeSection === 'booking') {
                saveBookingFormData();
            }

            appState.activeSection = sectionName;
            // Update navigation button styles to indicate the active section.
            document.querySelectorAll('header nav button').forEach(button => {
                const buttonId = button.id;
                // First, reset all buttons to their default inactive state
                button.classList.remove('bg-gradient-to-br', 'from-purple-600', 'via-purple-400', 'to-purple-700', 'from-blue-600', 'via-blue-400', 'to-blue-700', 'from-pink-600', 'via-pink-400', 'to-pink-700', 'from-green-600', 'via-green-400', 'to-green-700', 'text-white', 'shadow-xl', 'border-2', 'border-white', 'scale-105');
                // Ensure inactive buttons have more highlighted text
                button.classList.add('bg-purple-200', 'text-purple-900', 'hover:bg-purple-300', 'shadow-md');

                // Then, apply active style to the button of the current section
                if (buttonId === 'navHome' && sectionName === 'home') {
                    button.classList.add('bg-gradient-to-br', 'from-purple-600', 'via-purple-400', 'to-purple-700', 'text-white', 'shadow-xl', 'border-2', 'border-white', 'scale-105');
                    button.classList.remove('bg-purple-200', 'text-purple-900', 'hover:bg-purple-300', 'shadow-md');
                } else if (buttonId === 'navServices' && sectionName === 'services') {
                    button.classList.add('bg-gradient-to-br', 'from-pink-600', 'via-pink-400', 'to-pink-700', 'text-white', 'shadow-xl', 'border-2', 'border-white', 'scale-105');
                    button.classList.remove('bg-purple-200', 'text-purple-900', 'hover:bg-purple-300', 'shadow-md');
                } else if (buttonId === 'navPackages' && sectionName === 'packages') {
                    button.classList.add('bg-gradient-to-br', 'from-purple-600', 'via-purple-400', 'to-purple-700', 'text-white', 'shadow-xl', 'border-2', 'border-white', 'scale-105');
                    button.classList.remove('bg-purple-200', 'text-purple-900', 'hover:bg-purple-300', 'shadow-md');
                } else if (buttonId === 'navBubblePackages' && sectionName === 'bubblePackages') { // New section
                    button.classList.add('bg-gradient-to-br', 'from-blue-600', 'via-blue-400', 'to-blue-700', 'text-white', 'shadow-xl', 'border-2', 'border-white', 'scale-105');
                    button.classList.remove('bg-purple-200', 'text-purple-900', 'hover:bg-purple-300', 'shadow-md');
                }
                else if (buttonId === 'navBooking' && sectionName === 'booking') {
                    button.classList.add('bg-gradient-to-br', 'from-pink-600', 'via-pink-400', 'to-pink-700', 'text-white', 'shadow-xl', 'border-2', 'border-white', 'scale-105');
                    button.classList.remove('bg-purple-200', 'text-purple-900', 'hover:bg-purple-300', 'shadow-md');
                }
            });

            let pagePath = '/'; // Default path for the home page.
            let pageTitle = 'Diverty Eventos'; // Default title (modified).

            // Determine the virtual page path and title for Google Analytics.
            switch (sectionName) {
                case 'home':
                    pagePath = '/inicio';
                    pageTitle = 'Diverty Eventos | Inicio'; 
                    break;
                case 'services':
                    pagePath = '/servicios';
                    pageTitle = 'Diverty Eventos | Servicios'; 
                    break;
                case 'packages':
                    pagePath = '/planes-cumpleanos';
                    pageTitle = 'Diverty Eventos | Planes de CumpleaÃ±os'; // Updated page title
                    break;
                case 'bubblePackages': // New section
                    pagePath = '/paquetes-burbujas';
                    pageTitle = 'Diverty Eventos | Paquetes de Burbujas';
                    break;
                case 'booking':
                    pagePath = '/reservar';
                    pageTitle = 'Diverty Eventos | Reservar'; 
                    // Hide the cart summary bar when entering the booking section.
                    const cartSummaryDiv = document.getElementById('cartSummary');
                    if (cartSummaryDiv) cartSummaryDiv.classList.add('hidden');
                    // Show the booking warning modal only if it's the first time in the session.
                    if (!appState.hasShownBookingWarning) {
                        showBookingWarningModal();
                        appState.hasShownBookingWarning = true;
                    }
                    break;
            }

            // Send the virtual page view event to Google Analytics.
            if (typeof gtag === 'function') {
                gtag('event', 'page_view', {
                    page_path: pagePath,
                    page_title: pageTitle
                });
            } else {
                console.warn('gtag is not defined. Google Analytics might not be loaded.');
            }

            // Render the corresponding section.
            switch (sectionName) {
                case 'home':
                    renderHomeSection();
                    break;
                case 'services':
                    renderServicesSection();
                    break;
                case 'packages':
                    renderPackagesSection();
                    break;
                case 'bubblePackages': // New section
                    renderBubblePackagesSection();
                    break;
                case 'booking':
                    renderBookingSection();
                    break;
                default:
                    renderHomeSection(); // Default fallback.
            }
            // The cart summary update is handled within each renderSection
            // or skipped if the section is 'booking' to keep it hidden.
            if (sectionName !== 'booking') {
                updateCartSummary(); 
            }

            // Close the mobile menu after a selection
            const mobileMenu = document.getElementById('mobileMenu');
            const mobileMenuToggle = document.getElementById('mobileMenuToggle');
            if (mobileMenu && !mobileMenu.classList.contains('hidden')) { // Check if menu is open
                mobileMenu.classList.add('hidden');
                mobileMenuToggle.setAttribute('aria-expanded', 'false');
                mobileMenuToggle.innerHTML = `
                            <svg class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                            </svg>
                        `;
            }
        }

        // --- Event for warning when trying to leave the page ---
        // This message is usually generic in modern browsers for security reasons.
        window.onbeforeunload = function() {
            // Save cart and form state before the user leaves the page.
            saveBookingFormData();
            // Do not return a string to avoid intrusive confirmation message in modern browsers.
        };

        /**
         * Clears error messages and input styles from the form fields.
         */
        function clearFormErrors() {
            const errorMessages = document.querySelectorAll('.error-message');
            errorMessages.forEach(span => {
                span.classList.add('hidden');
                span.textContent = ''; // Clear error text
            });
            const errorInputs = document.querySelectorAll('.input-error');
            errorInputs.forEach(input => {
                input.classList.remove('input-error');
            });
        }

        /**
         * Displays an error message for a specific field.
         * @param {string} fieldId - The ID of the field with the error.
         * @param {string} message - The error message to display.
         */
        function showFieldError(fieldId, message) {
            const errorSpan = document.getElementById(`error-${fieldId}`);
            const inputElement = document.getElementById(fieldId);
            if (errorSpan && inputElement) {
                errorSpan.textContent = message;
                errorSpan.classList.remove('hidden');
                inputElement.classList.add('input-error');
            }
        }


        // --- Form Submission to JotForm ---
        /**
         * Handles the submission of the booking form.
         * Performs basic validations and then redirects to JotForm with pre-filled data.
         * @param {Event} event - The form submission event.
         */
        async function handleBookingSubmit(event) {
            event.preventDefault(); // Prevents default form submission.

            clearFormErrors(); // Clear any previous errors.

            // *** Validations are performed first ***
            if (appState.selectedItems.length === 0) {
                showInfoModal('Â¡Por favor, aÃ±ade al menos un servicio o paquete a tu reserva! ğŸ›’');
                return;
            }

            // Validate minimum quantity for "Mini Taller de Manualidades"
            const miniTallerItem = appState.selectedItems.find(item => item.name === 'Mini Taller de Manualidades ğŸ¨âœ‚ï¸');
            if (miniTallerItem && miniTallerItem.quantity < 10) {
                showInfoModal('El "Mini Taller de Manualidades" requiere un mÃ­nimo de 10 niÃ±os. Por favor, ajusta la cantidad. ğŸ§‘â€ğŸ¨');
                return;
            }

            const requiredFields = [
                'bookingDate', 'bookingTime', 'customerName', 'customerEmail',
                'customerPhone', 'eventType', 'numKids', 'exactLocation'
            ];
            let formIsValid = true;
            for (const fieldId of requiredFields) {
                const inputElement = document.getElementById(fieldId);
                // Trim to remove whitespace and ensure it's not just spaces
                if (inputElement && !inputElement.value.trim()) { // Added check for inputElement
                    showFieldError(fieldId, 'Este campo es obligatorio.');
                    formIsValid = false;
                }
            }

            // Specific validation for email format
            const emailInput = document.getElementById('customerEmail');
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (emailInput && !emailRegex.test(emailInput.value.trim())) {
                showFieldError('customerEmail', 'Por favor, introduce un email vÃ¡lido.');
                formIsValid = false;
            }

            if (!formIsValid) {
                showInfoModal('Â¡Oops! Por favor, completa todos los campos requeridos correctamente para realizar la reserva. ğŸ“');
                return;
            }

            // If all validations pass, save the form and show the modal.
            saveBookingFormData(); // Save data before redirection.
            showInfoModal('Â¡Redirigiendo a JotForm para finalizar tu reserva! ğŸ‰ Haz clic en "Â¡Entendido!" para continuar.', () => {
                // This is what will execute when the user clicks "Â¡Entendido!" in the modal.

                // --- Data Collection for JotForm (re-obtained to ensure latest values) ---
                const bookingDate = document.getElementById('bookingDate') ? document.getElementById('bookingDate').value : ''; 
                const bookingTime = document.getElementById('bookingTime') ? document.getElementById('bookingTime').value : ''; 

                const [year, month, day] = bookingDate.split('-'); 

                const customerName = document.getElementById('customerName') ? document.getElementById('customerName').value : '';
                const customerEmail = document.getElementById('customerEmail') ? document.getElementById('customerEmail').value : '';
                const customerPhone = document.getElementById('customerPhone') ? document.getElementById('customerPhone').value : '';
                const eventType = document.getElementById('eventType') ? document.getElementById('eventType').value : '';
                const numKids = document.getElementById('numKids') ? document.getElementById('numKids').value : '';
                const exactLocation = document.getElementById('exactLocation') ? document.getElementById('exactLocation').value : '';
                const selectedLocationName = appState.selectedLocation;
                const currentTransportFee = transportFeesByLocation[selectedLocationName] || 0;

                const selectedItemsString = appState.selectedItems.map(item => {
                    const itemTotalForJotForm = getAdjustedItemPrice(item); // This now returns the total for the item
                    return `${item.name} ${item.quantity > 0 ? `(x${item.quantity})` : ''} ($${itemTotalForJotForm.toFixed(2)})`; 
                }).join(', ');
                
                const totalItemsPrice = appState.selectedItems.reduce((sum, item) => {
                    return sum + getAdjustedItemPrice(item);
                }, 0);
                const finalTotalPrice = totalItemsPrice + currentTransportFee;

                // --- Construction of JotForm URL with Parameters ---
                // Parameters are encoded in the URL to pre-fill the JotForm form.
                const jotformBaseUrl = 'https://form.jotform.com/251611549526054'; 
                const params = new URLSearchParams();

                params.append('fechaDelEvento[year]', year);   
                params.append('fechaDelEvento[month]', month); 
                params.append('fechaDelEvento[day]', day);     
                
                params.append('horaDelEvento', bookingTime); 
                params.append('nombreDelCliente', customerName);
                params.append('emailDelCliente', customerEmail);
                params.append('telefonoDelCliente', customerPhone);
                params.append('tipoDeEvento', eventType);
                params.append('numeroEstimadoDeNinos', numKids);
                params.append('ubicacionSeleccionada', selectedLocationName);
                params.append('recargoPorTransporte', `$${currentTransportFee.toFixed(2)}`);
                params.append('direccionExactaDelEvento', exactLocation);
                params.append('serviciosPaquetesSeleccionados', selectedItemsString);
                params.append('precioTotalEstimado', `$${finalTotalPrice.toFixed(2)}`);
                params.append('idDeSesionVisitante', appState.userId);

                const jotformUrl = `${jotformBaseUrl}?${params.toString()}`;

                // Open in a new tab when the user clicks "Â¡Entendido!".
                // Includes a fallback for redirection in the same tab if the new window is blocked.
                const newWindow = window.open(jotformUrl, '_blank');
                if (newWindow) {
                    newWindow.focus(); 
                } else {
                    console.warn('The new window could not be opened (pop-up blocker). Attempting redirection in the same tab as fallback.');
                    window.location.href = jotformUrl; 
                }
            });
        }

        // --- Application Initialization ---
        // Executes when the DOM is fully loaded.
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM Content Loaded. Initializing app.'); // Debug log

            // Load form data and cart when the page loads.
            loadBookingFormData(); 

            // Assign event listeners for closing modals.
            const closeModalBtn = document.getElementById('closeModalButton');
            if (closeModalBtn) closeModalBtn.onclick = closeModal;

            const closePromoModalBtn = document.getElementById('closePromoModalButton');
            if (closePromoModalBtn) closePromoModalBtn.onclick = closePromoModal;

            const closeBookingWarningModalBtn = document.getElementById('closeBookingWarningModalButton');
            if (closeBookingWarningModalBtn) closeBookingWarningModalBtn.onclick = closeBookingWarningModal;
            
            // Assign event listeners for mini-cart modal buttons.
            const closeMiniCartModalBtn = document.getElementById('closeMiniCartModalButton');
            if (closeMiniCartModalBtn) closeMiniCartModalBtn.onclick = closeMiniCartModal;

            // Assign event listeners for image modal.
            const closeImageModalBtn = document.getElementById('closeImageModalButton');
            if (closeImageModalBtn) closeImageModalBtn.onclick = closeImageModal;


            // Assign event listeners for mobile menu toggle.
            const mobileMenuToggle = document.getElementById('mobileMenuToggle');
            const mobileMenu = document.getElementById('mobileMenu');
            if (mobileMenuToggle && mobileMenu) {
                mobileMenuToggle.onclick = () => {
                    const isHidden = mobileMenu.classList.toggle('hidden');
                    mobileMenuToggle.setAttribute('aria-expanded', !isHidden);
                    // Change hamburger icon to close icon and vice versa
                    if (isHidden) {
                        mobileMenuToggle.innerHTML = `
                            <svg class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                            </svg>
                        `;
                    } else {
                        mobileMenuToggle.innerHTML = `
                            <svg class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        `;
                    }
                }; 
            }

            // Assign event listeners for main navigation buttons.
            const navHomeBtn = document.getElementById('navHome');
            if (navHomeBtn) navHomeBtn.onclick = () => setActiveSection('home');
            
            const navServicesBtn = document.getElementById('navServices');
            if (navServicesBtn) navServicesBtn.onclick = () => setActiveSection('services');
            
            const navPackagesBtn = document.getElementById('navPackages');
            if (navPackagesBtn) navPackagesBtn.onclick = () => setActiveSection('packages');
            
            const navBubblePackagesBtn = document.getElementById('navBubblePackages'); // New button
            if (navBubblePackagesBtn) navBubblePackagesBtn.onclick = () => setActiveSection('bubblePackages'); // New section
            
            const navBookingBtn = document.getElementById('navBooking');
            if (navBookingBtn) navBookingBtn.onclick = () => setActiveSection('booking');
            
            const proceedToBookBtn = document.getElementById('proceedToBookButton');
            if (proceedToBookBtn) proceedToBookBtn.onclick = () => setActiveSection('booking');
            
            const miniCartProceedToBookBtn = document.getElementById('miniCartProceedToBookButton');
            if (miniCartProceedToBookBtn) miniCartProceedToBookBtn.onclick = () => {
                closeMiniCartModal(); // Close modal before going to booking
                setActiveSection('booking');
            };
            
            const viewCartDetailsBtn = document.getElementById('viewCartDetailsButton');
            if (viewCartDetailsBtn) {
                viewCartDetailsBtn.onclick = () => {
                    showMiniCartModal();
                };
            }

            console.log('Calling setActiveSection("home")'); // Debug log
            // Set home section as default when page loads.
            setActiveSection('home');
            updateCartSummary(); // Ensure cart summary is displayed correctly on startup.
        });
    </script>
</body>
</html>

