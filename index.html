<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- SEO optimized title: Includes main keywords and location to improve search engine visibility. -->
    <title>Diverty Eventos | Fiestas Infantiles en Panamá</title>
    <meta name="description" content="Organizamos las mejores fiestas infantiles en Panamá Centro, Arraiján, La Chorrera, Pacora y Panamá Norte. Expertos en animación, shows de burbujas, pintacaritas, globoflexia y paquetes de diversión. ¡Haz que la fiesta de tus hijos sea inolvidable con Diverty Eventos en todo Panamá!">
    
    <!-- Open Graph Tags for social media and messaging apps (Facebook, WhatsApp, etc.). -->
    <meta property="og:title" content="Diverty Eventos | Fiestas Infantiles en Panamá">
    <meta property="og:description" content="Organizamos las mejores fiestas infantiles en Panamá. Animación, shows de burbujas, pintacaritas y más. ¡Haz la fiesta soñada de tus hijos con Diverty Eventos!">
    <!-- IMPORTANT! Corrected image URL for Netlify. -->
    <meta property="og:image" content="https://divertypanama.netlify.app/android-chrome-512x512.png"> 
    <meta property="og:image:width" content="512"> 
    <meta property="og:image:height" content="512"> 
    <meta property="og:image:alt" content="Logo de Diverty Eventos, para fiestas infantiles en Panamá">
    <meta property="og:url" content="https://divertypanama.netlify.app/"> <!-- Your actual website URL. -->
    <meta property="og:type" content="website">

    <!-- Google tag (gtag.js) for Google Analytics: Allows tracking of user visits and behavior. -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-R3G3Y0FLVN"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-R3G3Y0FLVN');
    </script>

    <!-- Schema Markup (Structured Data) for LocalBusiness and Organization - SEO: Helps search engines understand your business content. -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": ["LocalBusiness", "Organization"],
      "name": "Diverty Eventos",
      "image": "https://divertypanama.netlify.app/android-chrome-512x512.png", <!-- Main image URL for Schema Markup corrected. -->
      "url": "https://divertypanama.netlify.app/", <!-- Your actual site URL. -->
      "telephone": "+50766677965",
      "address": {
        "@type": "PostalAddress",
        "streetAddress": "Tu Dirección Exacta Aquí (Ej: Calle 50, Edificio XYZ)", <!-- IMPORTANT! Replace with your physical address. -->
        "addressLocality": "Panamá Centro",
        "addressRegion": "Panamá",
        "postalCode": "Tu Código Postal Aquí", <!-- Optional, but recommended if you have it. -->
        "addressCountry": "PA"
      },
      "priceRange": "$$",
      "openingHoursSpecification": [
        {
          "@type": "OpeningHoursSpecification",
          "dayOfWeek": [
            "Monday",
            "Tuesday",
            "Wednesday",
            "Thursday",
            "Friday"
          ],
          "opens": "09:00",
          "closes": "18:00"
        },
        {
          "@type": "OpeningHoursSpecification",
          "dayOfWeek": [
            "Saturday",
            "Sunday"
          ],
          "opens": "10:00",
          "closes": "17:00"
        }
      ],
      "hasOfferCatalog": {
        "@type": "OfferCatalog",
        "name": "Catálogo de Servicios y Paquetes de Fiestas Infantiles en Panamá",
        "itemListElement": [
          {
            "@type": "Offer",
            "itemOffered": {
              "@type": "Service",
              "name": "Pintacaritas para fiestas infantiles",
              "description": "Transforma a los niños en sus personajes favoritos con pinturas hipoalergénicas, un servicio ideal para fiestas infantiles en Panamá."
            }
          },
          {
            "@type": "Offer",
            "itemOffered": {
              "@type": "Service",
              "name": "Globoflexia para cumpleaños y eventos infantiles",
              "description": "Figuras divertidas y creativas hechas con globos para cada invitado, perfectas para cumpleaños y eventos infantiles en Panamá."
            }
          },
          {
            "@type": "Offer",
            "itemOffered": {
              "@type": "Service",
              "name": "Show de Burbujas Gigantes en Panamá",
              "description": "¡Burbujas enormes que los niños pueden atrapar y explotar! Un súper show único en Panamá para cualquier fiesta infantil."
            }
          },
          {
            "@type": "Offer",
            "itemOffered": {
              "@type": "Service",
              "name": "Paquete Fiesta Mágica Express para fiestas infantiles en Panamá",
              "description": "Diversión con animador, juegos, globos y piñata. Ideal para fiestas rápidas y cumpleaños en Panamá."
            }
          },
          {
            "@type": "Offer",
            "itemOffered": {
              "@type": "Service",
              "name": "Paquete Aventura de Ensueño para fiestas infantiles en Panamá",
              "description": "Servicio completo con payaso, pintacaritas, animación, juegos y piñata para una celebración inolvidable en Panamá."
            }
          },
          {
            "@type": "Offer",
            "itemOffered": {
              "@type": "Service",
              "name": "Paquete Celebración Personalizada para eventos infantiles en Panamá",
            "description": "Servicio premium con payaso, animación, pintacaritas, show de magia cómica y asistencia para piñata, diseñado para tu fiesta perfecta en Panamá."
          }
        }
        ]
      },
      "slogan": "¡Hacemos magia en tu fiesta infantil en Panamá!",
      "description": "Diverty Eventos ofrece la mejor animación y shows para fiestas infantiles en Panamá Centro, Arraiján, La Chorrera, Pacora y Panamá Norte. Especialistas en shows de burbujas, pintacaritas y paquetes de diversión inolvidable. ¡Organiza la fiesta soñada de tus hijos!"
    }
    </script>
    <!-- Tailwind CSS CDN for styles: Allows fast development and responsive design. -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Inter for typography: Provides a modern and readable font. -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <!-- Google Fonts - Montserrat for headings: Provides a strong, geometric sans-serif font. -->
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700;800;900&display=swap" rel="stylesheet">
    <!-- Lucide Icons CDN for professional SVG icons -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <style>
        /* Base styles for the page body */
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            /* Subtle background pattern for aesthetic appeal */
            background-image: url("data:image/svg+xml,%3Csvg width='6' height='6' viewBox='0 0 6 6' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%239C92AC' fill-opacity='0.1' fill-rule='evenodd'%3E%3Cpath d='M0 0h3v3H0V0zm3 3h3v3H3V3z'/%3E%3C/g%3E%3C/svg%3E");
            background-repeat: repeat;
            background-size: 6px 6px;
            background-attachment: fixed; /* Optional: for a subtle parallax effect */
        }
        /* Headings using Montserrat for a professional touch */
        h1, h2, h3 {
            font-family: 'Montserrat', sans-serif;
            font-weight: 800; /* Extra bold for impact */
            letter-spacing: -0.02em; /* Slightly tighter letter spacing for headings */
        }
        /* Custom styles for button hover for visual consistency. */
        .hover\:bg-purple-600:hover { background-color: #7c3aed; }
        .hover\:bg-pink-600:hover { background-color: #db2777; }
        .hover\:bg-blue-600:hover { background-color: #2563eb; } /* This will be overridden by JS for nav buttons */
        .hover\:bg-green-600:hover { background-color: #16a34a; } /* This will be overridden by JS for nav buttons */
        .hover\:bg-indigo-600:hover { background-color: #4f46e5; }
        /* Style for strikethrough text (previous prices), useful for showing discounts. */
        .line-through { text-decoration: line-through; }

        /* Style for the floating WhatsApp button: Allows quick access to contact. */
        .whatsapp-float-button {
            position: fixed;
            bottom: 80px; /* Adjusts the vertical position of the button. */
            right: 20px;
            z-index: 1000; /* Ensures the button is above other elements. */
            width: 56px; /* Adjustment for the button to be square. */
            height: 56px;
            display: flex; /* Use flexbox to center content. */
            justify-content: center; /* Centers the icon horizontally. */
            align-items: center; /* Centers the icon vertically. */
            border-radius: 9999px; /* Fully round. */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); /* More pronounced shadow. */
            transition: all 0.3s ease; /* Smooth transitions for hover. */
            background-color: #25D366; /* WhatsApp background color. */
            cursor: pointer; /* Add cursor pointer */
        }
        .whatsapp-float-button:hover {
            transform: scale(1.1); /* Slight increase in size on hover. */
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); /* Even more pronounced shadow on hover. */
        }

        /* Style for inline validation error messages */
        .error-message {
            color: #ef4444; /* red-500 */
            font-size: 0.875rem; /* text-sm */
            margin-top: 0.25rem;
        }
        .input-error {
            border-color: #ef4444 !important; /* red-500 */
        }
        /* Style for Lucide icons to ensure consistent sizing and alignment */
        .lucide {
            width: 1.25em; /* Adjust as needed */
            height: 1.25em;
            vertical-align: middle; /* Align with text */
            margin-right: 0.5em; /* Space between icon and text */
            flex-shrink: 0; /* Prevent icon from shrinking */
        }
        /* Specific adjustments for icons within buttons for better alignment */
        button .lucide {
            margin-right: 0.5rem; /* Consistent spacing */
        }
        .whatsapp-float-button img {
            width: 1.5rem; /* Larger icon for float button */
            height: 1.5rem;
        }

        /* General principle: Use ample white space to improve readability and perceived professionalism. */
        /* This means generous padding within elements and margins between them. */

        /* Animations for elements appearing on screen */
        @keyframes slideUpFadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .animate-slide-up-fade-in {
            animation: slideUpFadeIn 0.6s ease-out forwards;
            opacity: 0; /* Start hidden for animation */
        }

        /* Toast Notification Styles */
        #toastNotification {
            position: fixed;
            top: 20px; /* Position from the top */
            left: 50%;
            transform: translateX(-50%);
            z-index: 10000; /* Ensure it's on top of everything */
            padding: 12px 20px;
            border-radius: 9999px; /* Fully rounded */
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            color: white;
            font-weight: 600;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease-in-out, visibility 0.3s ease-in-out, transform 0.3s ease-in-out;
            display: flex;
            align-items: center;
            gap: 8px; /* Space between icon and text */
        }

        #toastNotification.show {
            opacity: 1;
            visibility: visible;
            transform: translateX(-50%) translateY(0); /* Ensure it slides in if needed */
        }

        /* Toast types */
        #toastNotification.success {
            background-color: #10B981; /* Green-500 */
        }
        #toastNotification.info {
            background-color: #3B82F6; /* Blue-500 */
        }
        #toastNotification.error {
            background-color: #EF4444; /* Red-500 */
        }

        #toastNotification .lucide {
            width: 1.2em; /* Smaller icon for toast */
            height: 1.2em;
            margin-right: 0; /* No margin here, gap handles it */
        }
    </style>
</head>
<body class="min-h-screen bg-gray-50 text-gray-800 flex flex-col">

    <!-- General Info Modal: Used for user messages (e.g., success, error). -->
    <div id="infoModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 p-4 hidden" role="dialog" aria-modal="true" aria-labelledby="modalMessage">
        <div id="infoModalContent" tabindex="-1" class="bg-gradient-to-br from-purple-600 to-purple-800 text-white rounded-xl shadow-2xl p-6 max-w-sm w-full text-center border-4 border-purple-500 transform transition-all duration-300 scale-95 opacity-0">
            <p id="modalMessage" class="text-xl font-bold mb-4 text-white"></p>
            <button id="closeModalButton" class="bg-gradient-to-br from-purple-600 via-purple-400 to-purple-700 hover:from-purple-700 hover:to-purple-800 text-white font-bold py-2 px-5 rounded-full shadow-xl transition duration-300 border-2 border-white cursor-pointer flex items-center justify-center mx-auto">
                ¡Entendido! <i data-lucide="check-circle" class="lucide"></i>
            </button>
        </div>
    </div>

    <!-- Promotion Modal: Used to announce special offers. -->
    <div id="promoModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 p-4 hidden" role="dialog" aria-modal="true" aria-labelledby="promoMessage">
        <div id="promoModalContent" tabindex="-1" class="bg-gradient-to-br from-pink-600 to-pink-800 text-white rounded-xl shadow-2xl p-6 max-w-md w-full text-center border-4 border-pink-500 transform transition-all duration-300 scale-95 opacity-0">
            <h2 class="text-3xl font-extrabold text-white mb-4">¡Promoción del Mes! <i data-lucide="star" class="lucide inline-block"></i></h2>
            <p id="promoMessage" class="text-lg text-gray-100 mb-4"></p>
            <button id="closePromoModalButton" class="bg-gradient-to-br from-pink-600 via-pink-400 to-pink-700 hover:from-pink-700 hover:to-pink-800 text-white font-bold py-2 px-5 rounded-full shadow-xl transition duration-300 border-2 border-white cursor-pointer flex items-center justify-center mx-auto">
                ¡Genial! <i data-lucide="party-popper" class="lucide"></i>
            </button>
        </div>
    </div>

    <!-- New Booking Warning Modal: Shown before filling out the booking form. -->
    <div id="bookingWarningModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 p-4 hidden" role="dialog" aria-modal="true" aria-labelledby="bookingWarningTitle">
        <div id="bookingWarningModalContent" tabindex="-1" class="bg-gradient-to-br from-purple-600 to-purple-800 text-white rounded-xl shadow-2xl p-6 max-w-md w-full text-center border-4 border-purple-500 transform transition-all duration-300 scale-95 opacity-0">
            <h2 id="bookingWarningTitle" class="text-3xl font-extrabold text-white mb-4">¡Importante antes de Reservar! <i data-lucide="alert-triangle" class="lucide inline-block"></i></h2>
            <p class="text-lg text-gray-100 mb-6">
                Para asegurar la disponibilidad de la fecha y hora de tu evento, te recomendamos
                <span class="font-bold text-purple-200">verificar primero con nosotros vía WhatsApp</span>.
                ¡Así garantizamos la magia de tu día! <i data-lucide="sparkles" class="lucide inline-block"></i>
            </p>
            <div class="flex flex-col sm:flex-row justify-center space-y-4 sm:space-y-0 sm:space-x-4">
                <a href="https://wa.me/50766677965?text=¡Hola! Quiero consultar la disponibilidad de una fecha para un evento."
                   target="_blank"
                   class="bg-gradient-to-br from-green-500 via-green-400 to-green-600 hover:from-green-600 hover:to-green-700 text-white font-bold py-3 px-6 rounded-full shadow-xl transition duration-300 flex items-center justify-center border-2 border-white cursor-pointer">
                    <Image of WhatsApp Icon>
                    Contactar por WhatsApp
                </a>
                <button id="closeBookingWarningModalButton" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-3 px-6 rounded-full shadow-md transition duration-300 cursor-pointer">
                    Continuar con el Formulario
                </button>
            </div>
        </div>
    </div>

    <!-- Mini-Cart Modal (Reverted to its original state) -->
    <div id="miniCartModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 p-4 hidden" role="dialog" aria-modal="true" aria-labelledby="miniCartTitle">
        <div id="miniCartModalContent" tabindex="-1" class="bg-gradient-to-br from-purple-600 to-purple-800 text-white rounded-xl shadow-2xl p-6 max-w-sm w-full text-center border-4 border-purple-500 transform transition-all duration-300 scale-95 opacity-0">
            <h2 id="miniCartTitle" class="text-2xl font-extrabold text-white mb-4">Tu Carrito de Diversión <Image of Shopping Cart Icon></h2>
            <div id="miniCartItems" class="max-h-60 overflow-y-auto text-left mb-4 p-2 bg-purple-100 rounded-lg border border-purple-200 text-gray-800">
                <!-- Cart items will be loaded here dynamically -->
            </div>
            <div class="text-right font-bold text-white mb-4">
                <!-- Transport surcharge is no longer displayed here -->
                <p class="text-xl text-pink-200">Total: <span id="miniCartTotalPrice">$0.00</span></p>
            </div>
            <div class="flex flex-col sm:flex-row justify-center space-y-3 sm:space-y-0 sm:space-x-3">
                <button id="closeMiniCartModalButton" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-5 rounded-full shadow-md transition duration-300 cursor-pointer flex items-center justify-center">
                    Cerrar
                </button>
                <button id="miniCartProceedToBookButton" class="bg-gradient-to-br from-purple-600 via-purple-400 to-purple-700 hover:from-purple-700 hover:to-purple-800 text-white font-bold py-2 px-5 rounded-full shadow-xl transition duration-300 border-2 border-white cursor-pointer flex items-center justify-center">
                    Reservar Ahora <Image of Sparkles Icon>
                </button>
            </div>
        </div>
    </div>

    <!-- Image Modal: Displays a larger version of an image when clicked. -->
    <div id="imageModal" class="fixed inset-0 bg-gray-900 bg-opacity-80 flex items-center justify-center z-50 p-4 hidden" role="dialog" aria-modal="true" aria-labelledby="imageModalTitle">
        <div id="imageModalContent" tabindex="-1" class="relative bg-white rounded-lg shadow-2xl p-2 max-w-full max-h-full overflow-hidden flex flex-col items-center justify-center transform transition-all duration-300 scale-95 opacity-0">
            <button id="closeImageModalButton" class="absolute top-2 right-2 bg-red-500 hover:bg-red-700 text-white rounded-full p-2 text-lg font-bold transition duration-300 z-10 w-8 h-8 flex items-center justify-center" aria-label="Cerrar imagen">
                &times;
            </button>
            <img id="modalImage" src="" alt="Imagen ampliada del servicio" class="max-w-full max-h-[80vh] object-contain rounded-lg">
        </div>
    </div>


    <!-- Header (Main Navigation Menu): Contains the logo, title, and navigation buttons. -->
    <header class="bg-gradient-to-br from-purple-100 to-purple-200 text-purple-800 py-3 px-4 w-full rounded-b-3xl shadow-xl sticky top-0 z-40 border-b-4 border-purple-300">
        <nav class="container mx-auto flex flex-col sm:flex-row justify-between items-center" aria-label="Navegación Principal">
            <!-- Container for logo and title -->
            <div class="flex items-center mb-4 sm:mb-0">
                <!-- DIVERTY EVENTOS LOGO -->
                <img src="https://divertypanama.netlify.app/android-chrome-512x512.png" alt="Logo de Diverty Eventos" class="w-16 h-16 mr-4 rounded-full object-cover border-2 border-pink-400 shadow-md">
                
                <!-- Main title -->
                <h1 class="text-3xl sm:text-4xl font-extrabold text-purple-900 text-center sm:text-left">
                    Diverty Eventos 
                </h1>
            </div>

            <!-- Mobile menu toggle button (Hamburger) -->
            <button id="mobileMenuToggle" class="sm:hidden p-2 rounded-md text-purple-800 hover:bg-purple-300 focus:outline-none focus:ring-2 focus:ring-purple-500 cursor-pointer" aria-controls="mobileMenu" aria-expanded="false">
                <svg class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                </svg>
            </button>

            <!-- Navigation list (hidden on mobile by default, shown on larger screens) -->
            <div id="mobileMenu" class="hidden sm:flex flex-col sm:flex-row flex-grow justify-center sm:justify-end items-center mt-4 sm:mt-0 space-y-2 sm:space-y-0 sm:space-x-4 w-full sm:w-auto">
                <ul class="flex flex-col sm:flex-row justify-center sm:space-x-4 space-y-2 sm:space-y-0" role="menubar">
                    <li role="none"><button id="navHome" role="menuitem" class="text-base font-extrabold py-2 px-5 rounded-full text-purple-900 bg-purple-200 hover:bg-purple-300 transition duration-300 transform hover:scale-105 shadow-md cursor-pointer flex items-center justify-center"><Image of Home Icon> Inicio</button></li>
                    <li role="none"><button id="navServices" role="menuitem" class="text-base font-extrabold py-2 px-5 rounded-full text-purple-900 bg-purple-200 hover:bg-purple-300 transition duration-300 transform hover:scale-105 shadow-md cursor-pointer flex items-center justify-center"><Image of Sparkles Icon> Servicios</button></li>
                    <li role="none"><button id="navPackages" role="menuitem" class="text-base font-extrabold py-2 px-5 rounded-full text-purple-900 bg-purple-200 hover:bg-purple-300 transition duration-300 transform hover:scale-105 shadow-md cursor-pointer flex items-center justify-center"><Image of Cake Icon> Planes de Cumpleaños</button></li>
                    <li role="none"><button id="navBubblePackages" role="menuitem" class="text-base font-extrabold py-2 px-5 rounded-full text-purple-900 bg-purple-200 hover:bg-purple-300 transition duration-300 transform hover:scale-105 shadow-md cursor-pointer flex items-center justify-center"><Image of Cloud Rain Icon> Paquetes de Burbujas</button></li>
                    <li role="none"><button id="navBooking" role="menuitem" class="text-base font-extrabold py-2 px-5 rounded-full text-purple-900 bg-purple-200 hover:bg-purple-300 transition duration-300 transform hover:scale-105 shadow-md cursor-pointer flex items-center justify-center"><Image of Calendar Check Icon> Reservar</button></li>
                </ul>
            </div>
        </nav>
    </header>

    <!-- Shopping Cart Summary (Floating Bar): Displays the number of items and the selected total. -->
    <div id="cartSummary" class="bg-gradient-to-br from-purple-200 to-purple-300 text-purple-800 font-extrabold p-4 text-center rounded-b-3xl shadow-xl border-b-4 border-purple-400 hidden sticky top-[88px] z-30 transition-all duration-300 ease-in-out flex flex-col sm:flex-row justify-between items-center">
        <p class="text-xl sm:text-2xl mb-2 sm:mb-0 flex items-center">
            <Image of Shopping Cart Icon> Ítems: <span id="selectedItemsCount" class="text-purple-700">0</span> | Total: <span id="totalPriceDisplay" class="text-pink-700">$0.00</span>
        </p>
        <div class="flex space-x-3">
            <button id="viewCartDetailsButton" class="bg-gradient-to-br from-purple-500 via-purple-400 to-purple-600 hover:from-purple-600 hover:to-purple-700 text-white font-bold py-2 px-4 rounded-full shadow-md text-sm transition duration-300 border-2 border-white cursor-pointer flex items-center justify-center">
                Ver Detalles <Image of Shopping Cart Icon>
            </button>
            <button id="proceedToBookButton" class="bg-gradient-to-br from-pink-600 via-pink-400 to-pink-700 hover:from-pink-700 hover:to-pink-800 text-white font-bold py-2 px-4 rounded-full shadow-xl text-sm transition duration-300 border-2 border-white cursor-pointer flex items-center justify-center">
                Reservar <Image of Sparkles Icon>
            </button>
        </div>
    </div>

    <!-- Main Content Area: Section content (Home, Services, etc.) will be dynamically loaded here. -->
    <main id="mainContent" class="container mx-auto p-4 flex-grow">
        <!-- Section content (Home, Services, etc.) will be injected here by JavaScript. -->
    </main>

    <!-- Floating WhatsApp Button: Quick access to contact via WhatsApp. -->
    <a href="https://wa.me/50766677965?text=¡Hola! Tengo una consulta sobre Diverty Eventos." class="whatsapp-float-button" target="_blank" aria-label="Contactar por WhatsApp">
        <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/6/6b/WhatsApp.svg/1200px-WhatsApp.svg.png" alt="WhatsApp Icon" class="w-6 h-6">
    </a>

    <!-- Footer: Copyright information and slogan. -->
    <footer class="bg-purple-700 text-white py-8 px-4 text-center mt-8 rounded-t-xl shadow-inner w-full">
        <p class="text-lg font-semibold">&copy; 2023 Diverty Eventos. ¡Hacemos magia en cada fiesta infantil en Panamá! <Image of Sparkles Icon></p>
        <p class="text-sm">Todos los derechos reservados. Servicios de <strong>animación infantil</strong> y <strong>shows para fiestas</strong> en todo Panamá.</p>
    </footer>

    <!-- Toast Notification Container -->
    <div id="toastNotification" role="status" aria-live="polite"></div>

    <!-- JavaScript script for page functionality. -->
    <script>
        // --- Global Application State Management ---
        // 'appState' contains all state variables that control application behavior.
        let appState = {
            activeSection: 'home', // Currently visible section ('home', 'services', 'packages', 'bubblePackages', 'booking').
            userId: 'guest_user_' + Math.random().toString(36).substring(2, 9), // Unique ID for the guest user.
            selectedItems: [], // Array to store selected services/packages in the cart.
            promotedPackages: [], // Array to store the names of packages on promotion.
            selectedLocation: 'Panamá Centro', // Selected location for calculating transport surcharge.
            hasShownBookingWarning: false, // Indicates if the booking warning modal has already been shown in the session.
            infoModalCallback: null, // Callback to execute a function when the info modal closes.
            bookingFormData: { // Object to store booking form data, useful for persistence.
                bookingDate: '',
                bookingTime: '',
                customerName: '',
                customerEmail: '',
                customerPhone: '',
                eventType: '',
                numKids: '',
                exactLocation: '',
                selectedLocation: 'Panamá Centro' 
            },
            lastFocusedElement: null // To store the element that had focus before a modal opened.
        };

        // --- Data Definition (Services and Packages) ---
        // Arrays of objects defining available services and packages, including prices and descriptions.
        const servicesData = [
            { id: '2', name: 'Pintacaritas', price: 45, description: 'Transforma a los niños en sus personajes favoritos con pinturas hipoalergénicas. Servicio por 1 hora, incluye mesa de maquillaje y silla profesional.', color: 'bg-gradient-to-br from-purple-100 to-purple-200 border-purple-300 text-purple-800', imageUrl: 'https://i.ibb.co/Kj8pkBJP/IMG-20250711-211956.jpg', icon: 'palette' },
            { id: '3', name: 'Globoflexia', price: 40, description: 'Figuras divertidas y creativas hechas con globos para cada invitado. Servicio por 1 hora.', color: 'bg-gradient-to-br from-pink-100 to-pink-200 border-pink-300 text-pink-800', imageUrl: 'https://i.ibb.co/21gCBMm3/IMG-20230423-173048-1.jpg', icon: 'balloon' },
            { 
                id: '7', 
                name: 'Decoraciones Temáticas', 
                price: 100, // Price updated to 100
                description: 'Transforma cualquier espacio en un mundo mágico con nuestras decoraciones personalizadas. ¡Elige tu temática favorita!', 
                color: 'bg-gradient-to-br from-pink-200 to-pink-300 border-pink-400 text-pink-800',
                type: 'theme_selection', // New type to handle theme selection
                imageUrl: 'https://i.ibb.co/p61CY7CW/IMG-20250624-WA0000.jpg', // Updated image URL here
                icon: 'sparkles',
                themes: {
                    ninas: [
                        'Barbie', 'Sirenita', 'Cenicienta', 'Moana grande', 'Moana bebé', 'Abejita',
                        'Luly Pampin', 'Stitch', 'Stitch y Ángela', 'Capivara', 'Minnie roja',
                        'Plim Plim rosa', 'Sirenita otro modelo nuevo', 'Rosita fresita', 'Masha y el oso',
                        'Unicornio', 'Frozen', 'Monster In', 'Granja rosa', 'Skay', 'Princesas bebé',
                        'Princesa grande', 'Bluey', 'Minnie bebé', 'Mariposas', 'Bebé Llorones',
                        'Minnie rosada', 'Gatita Marie', 'Pebells', 'Pollo Party', 'Abeja Maya',
                        'Bely y Beto', 'La Bella y la Bestia', 'Hello Kitty', 'Peppa', 'Harley Kuin',
                        'Merlina', 'Minnie Poll Party', 'Princesa Pich'
                    ],
                    ninos: [
                        'Real Madrid', 'Plaza Sésamo', 'Hot Wheels', 'Bebe Fin', 'Sonic', 'Bomberos',
                        'Legos', 'Dinosaurios', 'Dinosaurios animados', 'Plim Plim Safary',
                        'Inter de Miami', 'Batman', 'Granja', 'Fútbol', 'Mickey Safary', 'Chuchugua',
                        'Blippi', 'Minicraft', 'Plim Plim', 'Cars', 'Spiderman', 'Paw Patrol',
                        'Jefes en Pañales', 'Bam Bam', 'Safary', 'La Granja de Zenón', 'Mario Bros',
                        'Mickey Principe', 'Avengers', 'Cristiano', 'Coco Melón', 'Messi',
                        'Plim Plim piscina', 'Carritos', 'Aeroman', 'Constructor', 'Free Fires',
                        'Caballito', 'Rugrats', 'Barca'
                    ]
                }
            },
            // Thematic characters service (price updated to 65)
            {
                id: '9',
                name: 'Personajes Temáticos',
                price: 65, // Base price for one character, updated to $65
                description: '¡Sorprende a todos con la visita de tu personaje favorito! Elige entre Mickey, Minnie y Mario Bros. Servicio por 1 hora.',
                color: 'bg-gradient-to-br from-indigo-200 to-indigo-300 border-indigo-400 text-indigo-800',
                type: 'character_selection', // Special type to handle character selection
                imageUrl: 'https://i.ibb.co/nqvDyb7Y/IMG-20250623-WA0019.jpg', 
                icon: 'users',
                characters: [
                    { id: 'mickey', name: 'Mickey Mouse' },
                    { id: 'minnie', name: 'Minnie Mouse' },
                    { id: 'mario', name: 'Mario Bros.' }
                ]
            },
            { 
                id: '10', 
                name: 'Mini Taller de Manualidades', 
                price: 12.50, // Price per child, updated to $12.50
                description: 'Taller creativo con 2 manualidades, mobiliario (mesas y sillas), 1 recreadora encargada del taller, materiales, música y figuras con globos. ¡Diversión garantizada por niño!', 
                color: 'bg-gradient-to-br from-yellow-100 to-yellow-200 border-yellow-300 text-yellow-800',
                type: 'manualidades_workshop', // New type for this specific service
                imageUrl: 'https://i.ibb.co/ynXVt81f/IMG-20250709-164447.jpg',
                icon: 'scissors'
            },
            { id: '8', name: 'Máquinas de Snack Algodón y Pop Corn', price: 100, description: 'Máquinas de algodón de azúcar y palomitas de maíz para endulzar tu evento. Servicio por 3 horas.', color: 'bg-gradient-to-br from-purple-100 to-purple-200 border-purple-300 text-purple-800', imageUrl: '', icon: 'popcorn' }
        ];

        const packagesData = [
            { id: 'P1', name: 'Plan Básico', price: 80, services: [ // Precio cambiado a 80
                'Payas@ o animad@r',
                'Animación infantil',
                'Juegos y concursos',
                'Figuras con globos',
                'Romper la piñata'
            ], description: '1.5h de diversión: Animador, juegos, globos, piñata. ¡Rápido y alegre!', color: 'bg-gradient-to-br from-pink-200 to-pink-300 border-pink-400 text-pink-800', imageUrl: '', icon: 'rocket' },
            { id: 'P2', name: 'Plan Recreativo', price: 100, services: [
                'Payas@ o animad@r',
                'Pintacaritas (1 hora)', // Updated to specify 1 hour
                'Animación infantil (1 hora)', // Updated to specify 1 hour
                'Juegos y concursos',
                'Figuras con globos',
                'Romper la piñata'
            ], description: '2h de aventura: Payaso/animador, pintacaritas, animación, juegos, globos, piñata. ¡Inolvidable!', color: 'bg-gradient-to-br from-indigo-200 to-indigo-300 border-indigo-400 text-indigo-800', imageUrl: '', icon: 'rainbow' },
            { id: 'P3', name: 'Plan Magic', price: 135, services: [
                'Payasit@ o animad@r',
                'Animación, juegos y concursos (1.5 horas)', // Updated to 1.5 hours
                'Pintacaritas (1 hora)', // Updated to 1 hour
                'Show de magia cómica',
                'Asistencia para la piñata'
            ], description: '2.5h premium: Payaso/animador, juegos, pintacaritas, magia cómica, asistencia de piñata. ¡Tu fiesta perfecta!', color: 'bg-gradient-to-br from-purple-200 to-purple-300 border-purple-400 text-purple-800', imageUrl: '', icon: 'magic-wand' },
            { 
                id: 'P4', 
                name: 'Plan Diverty', 
                price: 210, 
                services: [
                    'Payasito o Animador',
                    'Juegos y concursos',
                    'Pintacaritas',
                    'Globoflexia',
                    'Show de Burbujas o Magia Cómica',
                    'Asistencia en la piñata'
                ], 
                description: '3h de diversión completa: Payaso/animador, juegos, pintacaritas, globoflexia, show de burbujas o magia, y asistencia piñata. ¡La magia garantizada!', 
                color: 'bg-gradient-to-br from-green-200 to-green-300 border-green-400 text-green-800', imageUrl: '', icon: 'party-popper'
            }
        ];

        // New array for Bubble Packages
        const bubblePackagesData = [
            {
                id: 'B2',
                name: 'Paquete Fiesta Burbuja Completa',
                price: 190, 
                services: [
                    'Animación infantil',
                    'Juegos y concursos',
                    'Payasito o Animador',
                    'Show de Burbujas Gigantes',
                    'Romper la piñata'
                ],
                description: '2 horas de diversión completa con animación, juegos, payasito, show de burbujas gigantes y asistencia en la piñata. ¡La fiesta burbuja soñada!',
                color: 'bg-gradient-to-br from-indigo-200 to-indigo-300 border-indigo-400 text-indigo-900', 
                imageUrl: 'https://i.ibb.co/p6gZT5JD/d8f8cf5e-4117-4f65-990e-43730827aa41-20250412-012526-0000.jpg',
                icon: 'sparkles'
            },
            {
                id: 'BS1',
                name: 'Show de Burbujas Premium', // Renamed from "Show Básico 🫧"
                price: 150,
                services: [
                    'Burbujas gigantes',
                    'Humo',
                    'Burbujas LED',
                    'Interacción con el público',
                    'Fotos dentro de la burbuja gigante', // New service
                    'Trucos con burbujas', // New service
                    'Burbujas de espuma' // New service
                ],
                description: '1 hora de show con burbujas gigantes, humo, burbujas LED, interacción con el público, fotos dentro de la burbuja gigante, trucos con burbujas y burbujas de espuma.', // Updated description
                color: 'bg-gradient-to-br from-green-100 to-green-200 border-green-300 text-green-800', 
                imageUrl: 'https://i.ibb.co/MJQgpHx/IMG-20250706-172005.jpg',
                icon: 'droplets'
            },
            {
                id: 'BS3',
                name: 'Show Corporativo/Especial',
                price: 220, // "Desde $220" implies a base price, using 220 as the base.
                services: [
                    'Show personalizado para centros comerciales, colegios o eventos grandes',
                    'Luces especiales'
                ],
                description: '1 hora de show personalizable (ajustable) para eventos corporativos, centros comerciales, colegios o eventos grandes, con luces especiales.',
                color: 'bg-gradient-to-br from-red-100 to-red-200 border-red-300 text-red-800', 
                imageUrl: 'https://i.ibb.co/qLdys8KJ/IMG-20250711-195845.jpg',
                icon: 'building'
            }
        ];

        // New data for company references
        const companyReferencesData = [
            { name: 'Royal Decameron', imageUrl: 'https://i.ibb.co/dFHJR2p/Burbujas-gigantes-en-el-royal-decameron-fyp-espect-culos-showdeburbujas-burbujas-parati-payasitos-an.jpg' },
            { name: 'Hotel Westin Playa Bonita', imageUrl: 'https://i.ibb.co/BHwfMchP/IMG-20250710-125312-157.jpg' },
            { name: 'Feria del Bebé 2025', imageUrl: 'https://i.ibb.co/qLdys8KJ/IMG-20250711-195845.jpg' },
            { name: 'Canal de Panamá', imageUrl: 'https://i.ibb.co/5g1gk7jM/Show-de-burbujas-gigantes-en-el-canal-de-panama-JPG.jpg' },
            { name: 'Santa María', imageUrl: 'https://i.ibb.co/8gFr1NqL/smcountryclub-3604355087222851995-JPG.jpg' }
        ];


        // Transport surcharges by event location.
        const transportFeesByLocation = {
            'Panamá Centro': 0,
            'Arraiján': 10,
            'La Chorrera': 15,
            'Pacora': 10,
            'Panamá Norte': 10,
        };

        // --- Helper Functions ---

        /**
         * Injects the HTML of a section into the main content area.
         * @param {string} sectionHtml - The HTML of the section to render.
         */
        function renderSection(sectionHtml) {
            document.getElementById('mainContent').innerHTML = sectionHtml;
            // After rendering, ensure Lucide icons are created
            lucide.createIcons();
        }

        /**
         * Calculates the total cost for a given item's quantity, applying special pricing logic.
         * For 'Pintacaritas', the first hour is $45, subsequent hours are $40.
         * @param {object} item - The item object (service or package) with properties like name, price, quantity.
         * @returns {number} The total cost of the item for the given quantity.
         */
        function getAdjustedItemPrice(item) {
            if (item.quantity <= 0) {
                return 0; // If quantity is 0 or less, the total cost for this item is 0.
            }

            if (item.name === 'Pintacaritas') { // Changed name to match data
                if (item.quantity === 1) {
                    return 45; // First hour is $45.
                } else {
                    // Calculate total cost: first hour at $45, subsequent hours at $40.
                    return 45 + (item.quantity - 1) * 40;
                }
            }
            // Monthly discount logic for promoted packages.
            else if (appState.promotedPackages.includes(item.name)) {
                return item.price * item.quantity * 0.90; // 10% discount on total.
            }
            // For all other services/packages, calculate total based on unit price * quantity.
            return item.price * item.quantity;
        }

        /**
         * Updates the floating cart summary with the number of items and total price.
         * Applies discount logic if active.
         */
        function updateCartSummary() {
            const cartSummaryDiv = document.getElementById('cartSummary');
            // If the active section is 'booking', ensure the cart is hidden and do nothing else.
            if (appState.activeSection === 'booking') {
                if (cartSummaryDiv) cartSummaryDiv.classList.add('hidden');
                return; 
            }

            let currentTotalPrice = appState.selectedItems.reduce((sum, item) => {
                // Sum the total price of each item (calculated by getAdjustedItemPrice).
                return sum + getAdjustedItemPrice(item);
            }, 0);

            // Add transport surcharge based on the selected location.
            currentTotalPrice += transportFeesByLocation[appState.selectedLocation] || 0;

            const selectedItemsCountSpan = document.getElementById('selectedItemsCount');
            const totalPriceDisplaySpan = document.getElementById('totalPriceDisplay');

            const totalItemsInCart = appState.selectedItems.reduce((total, item) => total + item.quantity, 0);

            if (selectedItemsCountSpan && totalPriceDisplaySpan && cartSummaryDiv) {
                if (totalItemsInCart > 0 || currentTotalPrice > 0) {
                    cartSummaryDiv.classList.remove('hidden');
                    selectedItemsCountSpan.textContent = totalItemsInCart;
                    totalPriceDisplaySpan.textContent = `$${currentTotalPrice.toFixed(2)}`;
                } else {
                    cartSummaryDiv.classList.add('hidden');
                }
            }
        }

        /**
         * Handles adding/removing/decrementing items in the cart.
         * @param {object} item - The service/package object to add/remove. Must contain { name, price }.
         * @param {string} actionType - 'add' to add/increment, 'remove_all' to remove all units, 'toggle' to toggle (used for non-repeatable items).
         * @param {number} [quantity=1] - The quantity to add or set.
         */
        function handleCartAction(item, actionType, quantity = 1) {
            console.log(`handleCartAction called: item=${item.name}, actionType=${actionType}, quantity=${quantity}`);
            console.log('appState.selectedItems BEFORE:', JSON.stringify(appState.selectedItems));

            const existingItemIndex = appState.selectedItems.findIndex(selected => selected.name === item.name);
            let message = '';
            let toastType = 'info';

            if (actionType === 'add') {
                if (existingItemIndex > -1) {
                    appState.selectedItems[existingItemIndex].quantity += quantity;
                    message = `Se añadió 1 unidad más de "${item.name}".`;
                } else {
                    appState.selectedItems.push({ ...item, quantity: quantity });
                    message = `"${item.name}" añadido al carrito.`;
                }
                toastType = 'success';
            } else if (actionType === 'set_quantity') { // New action type for direct quantity setting
                if (quantity <= 0) { // If quantity is 0 or less, remove item
                    appState.selectedItems = appState.selectedItems.filter(selected => selected.name !== item.name);
                    message = `"${item.name}" eliminado del carrito.`;
                    toastType = 'info';
                } else if (existingItemIndex > -1) {
                    appState.selectedItems[existingItemIndex].quantity = quantity;
                    message = `Cantidad de "${item.name}" actualizada a ${quantity}.`;
                    toastType = 'success';
                } else {
                    appState.selectedItems.push({ ...item, quantity: quantity });
                    message = `"${item.name}" añadido al carrito (x${quantity}).`;
                    toastType = 'success';
                }
            } else if (actionType === 'remove_all') {
                // Filter out the item to remove all its units.
                appState.selectedItems = appState.selectedItems.filter(selected => selected.name !== item.name);
                message = `"${item.name}" eliminado del carrito.`;
                toastType = 'info';
            } else if (actionType === 'toggle') { // For non-repeatable services (e.g., packages).
                if (existingItemIndex > -1) {
                    // If already selected, remove it.
                    appState.selectedItems = appState.selectedItems.filter(selected => selected.name !== item.name);
                    message = `"${item.name}" eliminado del carrito.`;
                    toastType = 'info';
                } else {
                    // If not selected, add it with quantity 1.
                    appState.selectedItems.push({ ...item, quantity: 1 });
                    message = `"${item.name}" añadido al carrito.`;
                    toastType = 'success';
                }
            }
            console.log('appState.selectedItems AFTER:', JSON.stringify(appState.selectedItems));

            // Re-render the active section to update buttons and prices.
            if (appState.activeSection === 'services') {
                renderServicesSection();
            } else if (appState.activeSection === 'packages') {
                renderPackagesSection();
            } else if (appState.activeSection === 'bubblePackages') { // New section
                renderBubblePackagesSection();
            } else if (appState.activeSection === 'booking') {
                renderBookingSection();
            }
            updateCartSummary(); // Update the floating cart bar.
            saveBookingFormData(); // Save cart state after each action.

            // Show toast notification
            showToast(message, toastType);
        }

        /**
         * Handles adding or changing a thematic character in the cart.
         * Allows adding multiple characters, incrementing the quantity if already in the cart.
         * @param {object} service - The "Thematic Characters" service object (base).
         * @param {object} character - The selected character object ({ id, name }).
         * @param {string} action - 'add' to add or 'remove_all' to remove.
         */
        function updateCharacterInCart(service, character, action) {
            const fullCharacterName = `${service.name}: ${character.name}`;
            const existingItemIndex = appState.selectedItems.findIndex(selected => selected.name === fullCharacterName);
            let message = '';
            let toastType = 'info';

            if (action === 'add') {
                if (existingItemIndex > -1) {
                    // If the character already exists, increment its quantity
                    appState.selectedItems[existingItemIndex].quantity++;
                    message = `Se añadió 1 unidad más de "${character.name}".`;
                } else {
                    // Add a new character with the base price of the service
                    appState.selectedItems.push({
                        id: `${service.id}-${character.id}`,
                        name: fullCharacterName,
                        price: service.price, // Use the base price of the character service
                        quantity: 1
                    });
                    message = `"${character.name}" añadido al carrito.`;
                }
                toastType = 'success';
            } else if (action === 'remove_all') {
                // Remove all instances of a specific character from the cart
                appState.selectedItems = appState.selectedItems.filter(item => item.name !== fullCharacterName);
                message = `"${character.name}" eliminado del carrito.`;
                toastType = 'info';
            }
            // Re-render the services section and update the cart summary
            renderServicesSection();
            updateCartSummary();
            saveBookingFormData(); // Save cart state after each action.
            showToast(message, toastType);
        }

        /**
         * Handles adding or changing a theme in the cart.
         * Allows adding multiple themes, incrementing the quantity if already in the cart.
         * @param {object} service - The "Thematic Decorations" service object (base).
         * @param {string} themeName - The name of the selected theme.
         * @param {string} action - 'add' to add or 'remove_all' to remove.
         */
        function updateThemeInCart(service, themeName, action) {
            const fullThemeName = `${service.name}: ${themeName}`;
            const existingItemIndex = appState.selectedItems.findIndex(selected => selected.name === fullThemeName);
            let message = '';
            let toastType = 'info';

            if (action === 'add') {
                if (existingItemIndex > -1) {
                    appState.selectedItems[existingItemIndex].quantity++;
                    message = `Se añadió 1 unidad más de "${themeName}".`;
                } else {
                    appState.selectedItems.push({
                        id: `${service.id}-${themeName.replace(/\s+/g, '-')}`, // Generate a simple ID
                        name: fullThemeName,
                        price: service.price, // Use the base price of the decoration service
                        quantity: 1
                    });
                    message = `"${themeName}" añadido al carrito.`;
                }
                toastType = 'success';
            } else if (action === 'remove_all') {
                appState.selectedItems = appState.selectedItems.filter(item => item.name !== fullThemeName);
                message = `"${themeName}" eliminado del carrito.`;
                toastType = 'info';
            }
            renderServicesSection();
            updateCartSummary();
            saveBookingFormData(); // Save cart state after each action.
            showToast(message, toastType);
        }


        // --- Modal Functions (Pop-up Windows) ---
        /**
         * Manages modal visibility and accessibility.
         * @param {HTMLElement} modalElement - The main modal container element.
         * @param {HTMLElement} modalContentElement - The modal content element (with tabindex="-1").
         * @param {boolean} show - True to show, false to hide.
         * @param {function} [callback] - Optional callback for when the modal closes.
         */
        function toggleModal(modalElement, modalContentElement, show, callback = null) {
            if (!modalElement || !modalContentElement) {
                console.error("Error: Modal elements not found.");
                return;
            }

            if (show) {
                appState.lastFocusedElement = document.activeElement; // Store the currently focused element
                modalElement.classList.remove('hidden');
                modalElement.setAttribute('aria-hidden', 'false');
                document.body.style.overflow = 'hidden'; // Prevent scrolling background
                setTimeout(() => {
                    modalContentElement.classList.remove('scale-95', 'opacity-0');
                    modalContentElement.classList.add('scale-100', 'opacity-100');
                    modalContentElement.focus(); // Set focus to the modal content
                }, 10);
                // Add event listener for Escape key
                document.addEventListener('keydown', handleEscapeKey);
                appState.infoModalCallback = callback; // For infoModal specific callback
            } else {
                modalContentElement.classList.remove('scale-100', 'opacity-100');
                modalContentElement.classList.add('scale-95', 'opacity-0');
                setTimeout(() => {
                    modalElement.classList.add('hidden');
                    modalElement.setAttribute('aria-hidden', 'true');
                    document.body.style.overflow = ''; // Restore scrolling
                    if (appState.lastFocusedElement) {
                        appState.lastFocusedElement.focus(); // Return focus to the previously focused element
                        appState.lastFocusedElement = null;
                    }
                    document.removeEventListener('keydown', handleEscapeKey); // Remove Escape key listener
                    if (callback) { // For general modal callbacks
                        callback();
                    }
                    if (appState.infoModalCallback) { // For infoModal specific callback
                        appState.infoModalCallback();
                        appState.infoModalCallback = null;
                    }
                }, 300); // Duration of the CSS transition
            }
        }

        /**
         * Handles the Escape key press to close the active modal.
         * @param {KeyboardEvent} event - The keyboard event.
         */
        function handleEscapeKey(event) {
            if (event.key === 'Escape') {
                const infoModal = document.getElementById('infoModal');
                const promoModal = document.getElementById('promoModal');
                const bookingWarningModal = document.getElementById('bookingWarningModal');
                const miniCartModal = document.getElementById('miniCartModal');
                const imageModal = document.getElementById('imageModal');

                if (!infoModal.classList.contains('hidden')) {
                    closeModal();
                } else if (!promoModal.classList.contains('hidden')) {
                    closePromoModal();
                } else if (!bookingWarningModal.classList.contains('hidden')) {
                    closeBookingWarningModal();
                } else if (!miniCartModal.classList.contains('hidden')) {
                    closeMiniCartModal();
                } else if (!imageModal.classList.contains('hidden')) {
                    closeImageModal();
                }
            }
        }

        /**
         * Displays a generic information modal.
         * @param {string} message - The message to display in the modal.
         * @param {function} [callback] - Function to execute when the modal closes.
         */
        function showInfoModal(message, callback = null) {
            const modal = document.getElementById('infoModal');
            const modalContent = document.getElementById('infoModalContent');
            const modalMessage = document.getElementById('modalMessage');
            if (modalMessage) modalMessage.innerHTML = message; // Use innerHTML for icons
            toggleModal(modal, modalContent, true, callback);
        }

        /**
         * Hides the generic information modal.
         */
        function closeModal() {
            const modal = document.getElementById('infoModal');
            const modalContent = document.getElementById('infoModalContent');
            const modalMessage = document.getElementById('modalMessage');
            if (modalMessage) modalMessage.textContent = ''; // Clear message on close
            toggleModal(modal, modalContent, false);
        }

        /**
         * Displays the promotion modal and activates the monthly discount.
         * @param {string} message - The promotion message.
         */
        function showPromoInfoModal(message) {
            const promoModal = document.getElementById('promoModal');
            const promoModalContent = document.getElementById('promoModalContent');
            const promoMessage = document.getElementById('promoMessage');
            if (promoMessage) promoMessage.textContent = message;
            toggleModal(promoModal, promoModalContent, true);
            
            // Set all bubble packages for promotion
            appState.promotedPackages = bubblePackagesData.map(pkg => pkg.name);

            updateCartSummary();
            // Re-render sections if active to show the discount.
            if (appState.activeSection === 'services') renderServicesSection();
            if (appState.activeSection === 'packages') renderPackagesSection();
            if (appState.activeSection === 'bubblePackages') renderBubblePackagesSection(); // New section
            if (appState.activeSection === 'booking') renderBookingSection();
        }

        /**
         * Hides the promotion modal.
         */
        function closePromoModal() {
            const modal = document.getElementById('promoModal');
            const modalContent = document.getElementById('promoModalContent');
            const promoMessage = document.getElementById('promoMessage');
            if (promoMessage) promoMessage.textContent = ''; // Clear message on close
            toggleModal(modal, modalContent, false);
            // Promoted packages are not cleared so the discount persists during the session.
            updateCartSummary();
            if (appState.activeSection === 'packages') renderPackagesSection(); // Refresh to ensure discount display.
            if (appState.activeSection === 'bubblePackages') renderBubblePackagesSection(); // New section
        }

        /**
         * Displays the booking warning modal.
         */
        function showBookingWarningModal() {
            const modal = document.getElementById('bookingWarningModal');
            const modalContent = document.getElementById('bookingWarningModalContent');
            toggleModal(modal, modalContent, true);
        }

        /**
         * Hides the booking warning modal.
         */
        function closeBookingWarningModal() {
            const modal = document.getElementById('bookingWarningModal');
            const modalContent = document.getElementById('bookingWarningModalContent');
            toggleModal(modal, modalContent, false);
        }

        /**
         * Displays the mini-cart modal with details of selected items.
         */
        function showMiniCartModal() {
            const miniCartModal = document.getElementById('miniCartModal');
            const miniCartModalContent = document.getElementById('miniCartModalContent');
            const miniCartItemsDiv = document.getElementById('miniCartItems');
            const miniCartTotalPriceSpan = document.getElementById('miniCartTotalPrice');
            // The miniCartTransportFeeSpan and its parent are no longer used for display in this modal,
            // but keeping the reference for completeness if needed elsewhere.
            const miniCartTransportFeeSpan = document.getElementById('miniCartTransportFee'); 
            const miniCartTransportFeeParent = miniCartTransportFeeSpan ? miniCartTransportFeeSpan.parentElement : null;

            // Add element existence checks for robustness
            if (!miniCartModal || !miniCartModalContent || !miniCartItemsDiv || !miniCartTotalPriceSpan) {
                console.error("Error: One or more essential mini-cart modal elements not found. Cannot display modal.");
                return; // Exit function if elements do not exist
            }

            if (appState.selectedItems.length === 0) {
                miniCartItemsDiv.innerHTML = '<p class="text-gray-600 text-center">Tu carrito está vacío. ¡Añade algo de magia!</p>';
            } else {
                miniCartItemsDiv.innerHTML = appState.selectedItems.map(item => {
                    const itemTotalPrice = getAdjustedItemPrice(item); // Get total price for this item
                    
                    // Determine if a strikethrough price should be shown in the mini-cart.
                    // For Pintacaritas, if quantity > 1, show $45 strikethrough as the "original" single-hour price.
                    // For other items, show strikethrough if a promotion applies.
                    let strikethroughHtml = '';
                    if (item.name === 'Pintacaritas' && item.quantity > 1) { // Changed name to match data
                        strikethroughHtml = `<span class="line-through text-gray-500 text-xs">$${item.price.toFixed(2)}</span> `;
                    } else if (item.name !== 'Pintacaritas' && appState.promotedPackages.includes(item.name)) { // Changed name to match data
                        strikethroughHtml = `<span class="line-through text-gray-500 text-xs">$${item.price.toFixed(2)}</span> `;
                    }

                    return `
                        <div class="flex justify-between items-center py-1 border-b border-gray-100 last:border-b-0">
                            <span class="font-semibold text-gray-800 text-sm">${item.name} ${item.quantity > 1 ? `(x${item.quantity})` : ''}</span>
                            <div class="flex items-center space-x-2">
                                ${strikethroughHtml}
                                <span class="font-bold text-pink-600 text-base">$${itemTotalPrice.toFixed(2)}</span>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            // Transport surcharge is not shown in this modal, so calculate total without it.
            const totalItemsPrice = appState.selectedItems.reduce((sum, item) => {
                return sum + getAdjustedItemPrice(item);
            }, 0);
            
            miniCartTotalPriceSpan.textContent = `$${totalItemsPrice.toFixed(2)}`;

            // Ensure the transport surcharge line is hidden in the mini-cart
            if (miniCartTransportFeeParent) {
                miniCartTransportFeeParent.classList.add('hidden');
            }

            toggleModal(miniCartModal, miniCartModalContent, true);
        }

        /**
         * Hides the mini-cart modal.
         */
        function closeMiniCartModal() {
            const modal = document.getElementById('miniCartModal');
            const modalContent = document.getElementById('miniCartModalContent');
            toggleModal(modal, modalContent, false);
        }

        /**
         * Displays the image modal with a specific image.
         * @param {string} imageUrl - The URL of the image to display.
         * @param {string} altText - The alt text for the image.
         */
        function showImageModal(imageUrl, altText) {
            const imageModal = document.getElementById('imageModal');
            const modalImage = document.getElementById('modalImage');
            const imageModalContent = document.getElementById('imageModalContent');

            if (modalImage) {
                modalImage.src = imageUrl;
                modalImage.alt = altText;
            }
            toggleModal(imageModal, imageModalContent, true);
        }

        /**
         * Hides the image modal.
         */
        function closeImageModal() {
            const imageModal = document.getElementById('imageModal');
            const imageModalContent = document.getElementById('imageModalContent');
            toggleModal(imageModal, imageModalContent, false, () => {
                const modalImage = document.getElementById('modalImage');
                if (modalImage) modalImage.src = ''; // Clear image source after closing
            });
        }

        /**
         * Displays a toast notification.
         * @param {string} message - The message to display.
         * @param {'success'|'info'|'error'} type - The type of toast (for styling).
         */
        function showToast(message, type = 'info') {
            const toast = document.getElementById('toastNotification');
            if (!toast) return;

            // Clear previous classes and content
            toast.className = ''; // Reset all classes
            toast.classList.add(type); // Add type class
            toast.innerHTML = ''; // Clear previous content

            // Create icon element
            const iconElement = document.createElement('i');
            iconElement.classList.add('lucide');
            iconElement.setAttribute('data-lucide', type === 'success' ? 'check-circle' : (type === 'error' ? 'x-circle' : 'info'));
            toast.appendChild(iconElement);

            // Create text node for message
            const textNode = document.createTextNode(message);
            toast.appendChild(textNode);

            // Re-create lucide icons for the new icon
            lucide.createIcons();

            toast.classList.add('show');

            // Hide after 3 seconds
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }


        // --- Section Rendering Functions ---

        /**
         * Renders the Home section.
         */
        function renderHomeSection() {
            const html = `
                <section class="bg-gradient-to-br from-white to-gray-50 rounded-3xl shadow-2xl p-6 sm:p-10 my-8 border-4 border-purple-400 flex items-center justify-center min-h-[60vh] animate-fade-in">
                    <div class="bg-gradient-to-br from-purple-100 to-pink-100 p-8 sm:p-12 rounded-2xl shadow-xl border-4 border-purple-300 max-w-3xl mx-auto text-center">
                        
                        <h2 class="text-3xl sm:text-4xl lg:text-5xl font-extrabold text-purple-800 mb-6 leading-tight text-center">
                            ¡La Magia Comienza Aquí! <Image of Sparkles Icon>
                        </h2>
                        <p class="text-base sm:text-lg lg:text-xl text-gray-700 mb-10 px-2">
                            Diverty Eventos: <strong>fiestas infantiles inolvidables en Panamá</strong>. Animación, shows de burbujas, pintacaritas, globoflexia. ¡Hacemos tu fiesta soñada realidad!
                        </p>
                        <div class="flex flex-col sm:flex-row justify-center space-y-4 sm:space-y-0 sm:space-x-6 mt-10">
                            <button id="homeExploreServices" class="text-white font-bold py-3 px-8 rounded-full shadow-xl text-base sm:text-lg transition duration-300 transform hover:scale-105 bg-gradient-to-br from-pink-600 via-pink-400 to-pink-700 border-2 border-white cursor-pointer flex items-center justify-center">
                                ¡Explora Nuestros Servicios! <Image of Sparkles Icon>
                            </button>
                            <button id="homeExplorePackages" class="text-white font-bold py-3 px-8 rounded-full shadow-xl text-base sm:text-lg transition duration-300 transform hover:scale-105 bg-gradient-to-br from-purple-600 via-purple-400 to-purple-700 border-2 border-white cursor-pointer flex items-center justify-center">
                                ¡Explora Nuestros Planes de Cumpleaños! <Image of Cake Icon>
                            </button>
                        </div>
                        <div class="flex flex-col sm:flex-row justify-center space-y-4 sm:space-y-0 sm:space-x-6 mt-6">
                            <button id="homeExploreBubblePackages" class="text-white font-bold py-3 px-8 rounded-full shadow-xl text-base sm:text-lg transition duration-300 transform hover:scale-105 bg-gradient-to-br from-blue-600 via-blue-400 to-blue-700 border-2 border-white cursor-pointer flex items-center justify-center">
                                ¡Paquetes de Burbujas! <Image of Cloud Rain Icon>
                            </button>
                            <button id="homePromoButton" class="text-white font-bold py-3 px-8 rounded-full shadow-xl text-base sm:text-lg transition duration-300 transform hover:scale-105 bg-gradient-to-br from-pink-500 via-purple-400 to-purple-600 border-2 border-white cursor-pointer flex items-center justify-center">
                                <Image of Award Icon> Promoción del Mes <Image of Award Icon>
                            </button>
                        </div>
                    </div>
                </section>
            `;
            renderSection(html);

            // Assign event listeners to the Home section buttons.
            const homeExploreServicesBtn = document.getElementById('homeExploreServices');
            if (homeExploreServicesBtn) homeExploreServicesBtn.onclick = () => { setActiveSection('services'); };
            
            const homeExplorePackagesBtn = document.getElementById('homeExplorePackages');
            if (homeExplorePackagesBtn) homeExplorePackagesBtn.onclick = () => { setActiveSection('packages'); };
            
            // New: Assign event listener for the "Paquetes de Burbujas" button
            const homeExploreBubblePackagesBtn = document.getElementById('homeExploreBubblePackages');
            if (homeExploreBubblePackagesBtn) homeExploreBubblePackagesBtn.onclick = () => { setActiveSection('bubblePackages'); };

            const homePromoButton = document.getElementById('homePromoButton');
            if (homePromoButton) homePromoButton.onclick = () => {
                showPromoInfoModal('¡Este mes, disfruta de un 10% de descuento EXCLUSIVO en todos nuestros paquetes de burbujas! 🫧');
            };
        }

        /**
         * Renders the Individual Services section.
         */
        function renderServicesSection() {
            // Services that can have multiple quantities and, therefore, "Add" and "Remove All" buttons.
            const repeatableServices = ['Pintacaritas', 'Globoflexia', 'Máquinas de Snack Algodón y Pop Corn']; // Names adjusted
            
            const cardsHtml = servicesData.map((service, index) => {
                // Image for the service card
                // If imageUrl is empty, it will not render the <img> tag.
                // Added 'service-image' class for click event.
                const serviceImageHtml = service.imageUrl ? `<img src="${service.imageUrl}" alt="Imagen de ${service.name}" class="w-full h-40 object-cover rounded-t-lg mb-4 border-b-2 border-gray-300 shadow-sm cursor-pointer service-image">` : '';

                // Specific logic for the character selection service
                if (service.type === 'character_selection') {
                    // Find the currently selected character in the cart (if any of this type)
                    const selectedCharacterItems = appState.selectedItems.filter(item => item.name.startsWith(service.name + ':'));

                    const optionsHtml = service.characters.map(char => {
                        const fullCharName = `${service.name}: ${char.name}`;
                        const isCharacterAlreadyAdded = selectedCharacterItems.some(item => item.name === fullCharName);
                        // Disable the option in the select if already in the cart
                        return `<option value="${char.id}" ${isCharacterAlreadyAdded ? 'disabled' : ''}>${char.name} ${isCharacterAlreadyAdded ? '(Añadido)' : ''}</option>`;
                    }).join('');

                    return `
                        <div class="${service.color} rounded-2xl shadow-xl flex flex-col justify-between border-4 border-dashed border-opacity50 transition duration-300 hover:scale-[1.02] hover:shadow-2xl animate-slide-up-fade-in" style="animation-delay: ${index * 100}ms;">
                            ${serviceImageHtml}
                            <div class="p-6 sm:p-8 flex flex-col flex-grow">
                                <h2 class="text-xl sm:text-2xl font-bold mb-3 sm:mb-4 text-indigo-700">${service.name} <Image of Palette Icon></h2>
                                <p class="text-sm sm:text-base text-gray-700 mb-4 sm:mb-5">${service.description}</p>
                                <p class="text-3xl sm:text-4xl font-extrabold text-pink-600 mb-4 sm:mb-5">
                                    $${service.price.toFixed(2)}
                                </p>
                                <div class="mb-4">
                                    <label for="characterSelect-${service.id}" class="block text-gray-700 font-bold mb-2">Elige tu personaje: <Image of Sparkles Icon></label>
                                    <select id="characterSelect-${service.id}" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:ring-purple-500 focus:border-purple-500 text-sm sm:text-base cursor-pointer transition duration-150 ease-in-out">
                                        <option value="">Selecciona un personaje</option>
                                        ${optionsHtml}
                                    </select>
                                </div>
                                <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2 mt-auto">
                                    <button
                                        data-service-id="${service.id}"
                                        data-action="add_character"
                                        class="character-action-button flex-grow bg-gradient-to-br from-indigo-600 via-indigo-400 to-indigo-700 text-white font-bold py-2 px-4 rounded-full shadow-xl text-sm transition duration-300 disabled:opacity-50 disabled:cursor-not-allowed border-2 border-white cursor-pointer flex items-center justify-center"
                                        disabled
                                    >
                                        Añadir Seleccionado <Image of Plus Icon>
                                    </button>
                                </div>
                                <div id="selectedCharactersList-${service.id}" class="mt-4">
                                    ${selectedCharacterItems.length > 0 ? `<p class="font-semibold text-gray-700 mb-2">Personajes en tu carrito:</p>` : ''}
                                    ${selectedCharacterItems.map(item => `
                                        <div class="flex justify-between items-center bg-purple-100 p-2 rounded-lg mb-2 shadow-sm border border-purple-200">
                                            <span>${item.name.replace(service.name + ': ', '')} (x${item.quantity})</span>
                                            <button class="remove-specific-character-button text-red-500 hover:text-red-700 font-bold ml-2 transition duration-200 cursor-pointer"
                                                    data-full-name="${item.name}" aria-label="Quitar ${item.name}"><Image of Trash 2 Icon></button>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    `;
                } else if (service.type === 'theme_selection') {
                    const selectedThemeItems = appState.selectedItems.filter(item => item.name.startsWith(service.name + ':'));

                    let themeOptionsHtml = '<option value="">Selecciona una temática</option>';
                    themeOptionsHtml += '<optgroup label="Niña">';
                    service.themes.ninas.forEach(theme => {
                        const fullThemeName = `${service.name}: ${theme}`;
                        const isThemeAlreadyAdded = selectedThemeItems.some(item => item.name === fullThemeName);
                        themeOptionsHtml += `<option value="${theme}" ${isThemeAlreadyAdded ? 'disabled' : ''}>${theme} ${isThemeAlreadyAdded ? '(Añadida)' : ''}</option>`;
                    });
                    themeOptionsHtml += '</optgroup>';
                    themeOptionsHtml += '<optgroup label="Niño">';
                    service.themes.ninos.forEach(theme => {
                        const fullThemeName = `${service.name}: ${theme}`;
                        const isThemeAlreadyAdded = selectedThemeItems.some(item => item.name === fullThemeName);
                        themeOptionsHtml += `<option value="${theme}" ${isThemeAlreadyAdded ? 'disabled' : ''}>${theme} ${isThemeAlreadyAdded ? '(Añadida)' : ''}</option>`;
                    });
                    themeOptionsHtml += '</optgroup>';

                    return `
                        <div class="${service.color} rounded-2xl shadow-xl flex flex-col justify-between border-4 border-dashed border-opacity50 transition duration-300 hover:scale-[1.02] hover:shadow-2xl animate-slide-up-fade-in" style="animation-delay: ${index * 100}ms;">
                            ${serviceImageHtml}
                            <div class="p-6 sm:p-8 flex flex-col flex-grow">
                                <h2 class="text-xl sm:text-2xl font-bold mb-3 sm:mb-4 text-pink-700">${service.name} <Image of Palette Icon></h2>
                                <p class="text-sm sm:text-base text-gray-700 mb-4 sm:mb-5">${service.description}</p>
                                <p class="text-3xl sm:text-4xl font-extrabold text-pink-600 mb-4 sm:mb-5">
                                    $${service.price.toFixed(2)}
                                </p>
                                <div class="mb-4">
                                    <label for="themeSelect-${service.id}" class="block text-gray-700 font-bold mb-2">Elige tu temática: <Image of Palette Icon></label>
                                    <select id="themeSelect-${service.id}" class="w-full p-3 border-2 border-gray-300 rounded-lg focus:ring-pink-500 focus:border-pink-500 text-sm sm:text-base cursor-pointer transition duration-150 ease-in-out">
                                        ${themeOptionsHtml}
                                    </select>
                                </div>
                                <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2 mt-auto">
                                    <button
                                        data-service-id="${service.id}"
                                        data-action="add_theme"
                                        class="theme-action-button flex-grow bg-gradient-to-br from-pink-600 via-pink-400 to-pink-700 text-white font-bold py-2 px-4 rounded-full shadow-xl text-sm transition duration-300 disabled:opacity-50 disabled:cursor-not-allowed border-2 border-white cursor-pointer flex items-center justify-center"
                                        disabled
                                    >
                                        Añadir Seleccionado <Image of Plus Icon>
                                    </button>
                                </div>
                                <div id="selectedThemesList-${service.id}" class="mt-4">
                                    ${selectedThemeItems.length > 0 ? `<p class="font-semibold text-gray-700 mb-2">Temáticas en tu carrito:</p>` : ''}
                                    ${selectedThemeItems.map(item => `
                                        <div class="flex justify-between items-center bg-pink-100 p-2 rounded-lg mb-2 shadow-sm border border-pink-200">
                                            <span>${item.name.replace(service.name + ': ', '')} (x${item.quantity})</span>
                                            <button class="remove-specific-theme-button text-red-500 hover:text-red-700 font-bold ml-2 transition duration-200 cursor-pointer"
                                                    data-full-name="${item.name}" aria-label="Quitar ${item.name}"><Image of Trash 2 Icon></button>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    `;
                } else if (service.type === 'manualidades_workshop') {
                    const selectedItemInCart = appState.selectedItems.find(selected => selected.name === service.name);
                    // If the item is in the cart, use its quantity, otherwise default to 10 (minimum)
                    const currentQuantity = selectedItemInCart ? selectedItemInCart.quantity : 10; 

                    return `
                        <div class="${service.color} rounded-2xl shadow-xl flex flex-col justify-between border-4 border-dashed border-opacity50 transition duration-300 hover:scale-[1.02] hover:hover:shadow-2xl animate-slide-up-fade-in" style="animation-delay: ${index * 100}ms;">
                            ${serviceImageHtml}
                            <div class="p-6 sm:p-8 flex flex-col flex-grow">
                                <h2 class="text-xl sm:text-2xl font-bold mb-3 sm:mb-4 text-yellow-700">${service.name} <Image of Scissors Icon></h2>
                                <p class="text-sm sm:text-base text-gray-700 mb-4 sm:mb-5">${service.description}</p>
                                <p class="text-3xl sm:text-4xl font-extrabold text-pink-600 mb-4 sm:mb-5">
                                    $${service.price.toFixed(2)} <span class="text-lg text-gray-600">/ niño</span>
                                </p>
                                <div class="mb-4">
                                    <label for="manualidadesQuantity-${service.id}" class="block text-gray-700 font-bold mb-2">Cantidad de Niños (Mín. 10):</label>
                                    <input
                                        type="number"
                                        id="manualidadesQuantity-${service.id}"
                                        name="manualidadesQuantity-${service.id}"
                                        class="w-full p-3 border-2 border-gray-300 rounded-lg focus:ring-yellow-500 focus:border-yellow-500 text-sm sm:text-base transition duration-150 ease-in-out"
                                        value="${currentQuantity}"
                                        min="10"
                                    />
                                </div>
                                <p class="text-lg font-semibold text-gray-700">Subtotal: <span id="manualidadesSubtotal-${service.id}">$${(service.price * currentQuantity).toFixed(2)}</span></p>
                                <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2 mt-auto">
                                    <button
                                        data-service-id="${service.id}"
                                        data-service-name="${service.name}"
                                        data-service-price="${service.price}"
                                        class="update-manualidades-quantity-button flex-grow bg-gradient-to-br from-yellow-600 via-yellow-400 to-yellow-700 text-white font-bold py-2 px-4 rounded-full shadow-xl text-sm transition duration-300 transform hover:scale-105 border-2 border-white cursor-pointer flex items-center justify-center">
                                        Actualizar Cantidad <Image of Refresh Ccw Icon>
                                    </button>
                                    ${selectedItemInCart ? `
                                    <button
                                        data-service-id="${service.id}"
                                        data-service-name="${service.name}"
                                        data-action-type="remove_all"
                                        class="add-remove-button flex-grow bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-full shadow-md text-sm transition duration-300 transform hover:scale-105 cursor-pointer flex items-center justify-center">
                                        Quitar Taller <Image of Trash 2 Icon>
                                    </button>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                } else {
                    const isRepeatableService = repeatableServices.includes(service.name);
                    const selectedItemInCart = appState.selectedItems.find(selected => selected.name === service.name);
                    const currentQuantity = selectedItemInCart ? selectedItemInCart.quantity : 0;
                    
                    let displayPriceHtml;
                    if (service.name === 'Pintacaritas') { // Name adjusted
                        // Special display for Pintacaritas on the card
                        displayPriceHtml = `<p class="text-3xl sm:text-4xl font-extrabold text-pink-600 mb-4 sm:mb-5">
                            $${service.price.toFixed(2)} <span class="text-lg text-gray-600">x 1 Hora</span><br>
                            <span class="text-xl text-gray-700">Horas adicionales: $40</span>
                        </p>`;
                    } else {
                        let displayPriceForCard = service.price; // Base price for display
                        let originalPriceHtmlForCard = '';

                        // If there's a promotion on this service
                        if (appState.promotedPackages.includes(service.name)) {
                            originalPriceHtmlForCard = `<span class="line-through text-gray-500 text-2xl">$${service.price.toFixed(2)}</span> `;
                            displayPriceForCard = service.price * 0.90; // Show discounted price on card
                        }

                        displayPriceHtml = `<p class="text-3xl sm:text-4xl font-extrabold text-pink-600 mb-4 sm:mb-5">
                            ${originalPriceHtmlForCard}$${displayPriceForCard.toFixed(2)}
                        </p>`;
                    }

                    let buttonsHtml;
                    if (isRepeatableService) {
                        // Buttons for services that can be added multiple times.
                        buttonsHtml = `
                            <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2 mt-auto">
                                <button
                                    data-item-name="${service.name}"
                                    data-item-price="${service.price}"
                                    data-action-type="add"
                                    class="add-remove-button flex-grow bg-gradient-to-br from-purple-600 via-purple-400 to-purple-700 text-white font-bold py-2 px-4 rounded-full shadow-xl text-sm transition duration-300 transform hover:scale-105 border-2 border-white cursor-pointer flex items-center justify-center">
                                    Añadir <Image of Plus Icon> ${currentQuantity > 0 ? `(x${currentQuantity})` : ''}
                                </button>
                                ${currentQuantity > 0 ? `
                                <button
                                    data-item-name="${service.name}"
                                    data-item-price="${service.price}"
                                    data-action-type="remove_all"
                                    class="add-remove-button flex-grow bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-full shadow-md text-sm transition duration-300 transform hover:scale-105 cursor-pointer flex items-center justify-center">
                                    Quitar Todo <Image of Trash 2 Icon>
                                </button>
                                ` : ''}
                            </div>
                        `;
                    } else {
                        // Button for non-repeatable services (add/remove).
                        const isSelected = selectedItemInCart ? true : false;
                        const buttonClassColor = isSelected ? 'bg-red-500 hover:bg-red-600' : 'bg-gradient-to-br from-purple-600 via-purple-400 to-purple-700 text-white border-2 border-white';
                        const buttonShadow = isSelected ? 'shadow-md' : 'shadow-xl';
                        buttonsHtml = `
                            <button
                                data-item-name="${service.name}"
                                data-item-price="${service.price}"
                                data-action-type="toggle"
                                class="add-remove-button mt-auto font-bold py-2 px-4 rounded-full ${buttonShadow} text-sm sm:text-base transition duration-300 ${buttonClassColor} text-white transform hover:scale-105 cursor-pointer flex items-center justify-center">
                                ${isSelected ? 'Quitar del Carrito <Image of Minus Icon>' : 'Añadir al Carrito <Image of Plus Icon>'}
                            </button>
                        `;
                    }

                    return `
                        <div class="${service.color} rounded-2xl shadow-xl flex flex-col justify-between border-4 border-dashed border-opacity-50 transition duration-300 hover:scale-[1.02] hover:shadow-2xl animate-slide-up-fade-in" style="animation-delay: ${index * 100}ms;">
                            ${serviceImageHtml}
                            <div class="p-6 sm:p-8 flex flex-col flex-grow">
                                <h2 class="text-xl sm:text-2xl font-bold mb-3 sm:mb-4 text-purple-700">${service.name} <Image of Sparkles Icon></h2>
                                <p class="text-sm sm:text-base text-gray-700 mb-4 sm:mb-5">${service.description}</p>
                                ${displayPriceHtml}
                            </div>
                            ${buttonsHtml}
                        </div>
                    `;
                }
            }).join('');

            const html = `
                <section class="bg-gradient-to-br from-white to-gray-50 rounded-3xl shadow-2xl p-6 sm:p-10 my-8 border-4 border-purple-400 animate-fade-in">
                    <h2 class="text-3xl sm:text-4xl font-extrabold text-purple-700 text-center mb-10 sm:mb-12">Nuestros Servicios <Image of Sparkles Icon></h2>
                    <p class="text-lg text-gray-700 text-center mb-10">
                        Servicios de animación para fiestas infantiles en Panamá. ¡Hacemos tu evento mágico e inolvidable!
                    </p>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 sm:gap-10">
                        ${cardsHtml}
                    </div>
                </section>
            `;
            renderSection(html);

            // Assign event listeners to all add/remove buttons for regular services.
            document.querySelectorAll('#mainContent .add-remove-button').forEach(button => {
                button.onclick = () => { // Changed to directly use 'button' from forEach scope
                    const itemName = button.dataset.itemName;
                    const itemPrice = parseFloat(button.dataset.itemPrice);
                    const actionType = button.dataset.actionType;
                    handleCartAction({ name: itemName, price: itemPrice }, actionType);
                };
            });

            // Assign event listeners for the add/change character button
            document.querySelectorAll('#mainContent .character-action-button').forEach(button => {
                button.onclick = () => { // Changed to directly use 'button' from forEach scope
                    const serviceId = button.dataset.serviceId;
                    const selectElement = document.getElementById(`characterSelect-${serviceId}`);
                    const selectedCharacterId = selectElement.value;

                    if (selectedCharacterId) {
                        const characterService = servicesData.find(s => s.id === serviceId);
                        const selectedChar = characterService.characters.find(c => c.id === selectedCharacterId);
                        if (selectedChar) {
                            updateCharacterInCart(characterService, selectedChar, 'add');
                            selectElement.value = ""; // Reset the select after adding
                        }
                    } else {
                        showInfoModal('Por favor, selecciona un personaje antes de añadirlo.');
                    }
                };
            });

            // Assign event listeners for the remove specific character buttons
            document.querySelectorAll('#mainContent .remove-specific-character-button').forEach(button => {
                button.onclick = () => { // Changed to directly use 'button' from forEach scope
                    const fullCharacterName = button.dataset.fullName;
                    // Find the base character service
                    const characterService = servicesData.find(s => s.type === 'character_selection');
                    // Extract only the character name to find it in the original list
                    const charNameOnly = fullCharacterName.replace(characterService.name + ': ', '');
                    const characterToRemove = characterService.characters.find(c => c.name === charNameOnly);

                    if (characterService && characterToRemove) {
                        updateCharacterInCart(characterService, characterToRemove, 'remove_all');
                    }
                };
            });

            // Logic to enable/disable the "Add Selected" button and update its text (for characters)
            document.querySelectorAll('#mainContent select[id^="characterSelect-"]').forEach(select => {
                select.onchange = () => { // Changed to directly use 'select' from forEach scope
                    const serviceId = select.id.split('-')[1];
                    const selectedCharacterId = select.value;
                    const addButton = document.querySelector(`.character-action-button[data-service-id="${serviceId}"]`);
                    
                    if (selectedCharacterId) {
                        const characterService = servicesData.find(s => s.id === serviceId);
                        const selectedChar = characterService.characters.find(c => c.id === selectedCharacterId);
                        const fullCharName = `${characterService.name}: ${selectedChar.name}`;
                        const existingInCart = appState.selectedItems.find(item => item.name === fullCharName);

                        if (existingInCart) {
                            addButton.innerHTML = `Añadir uno más de ${selectedChar.name} <Image of Plus Icon> (x${existingInCart.quantity + 1})`;
                            addButton.disabled = false;
                        } else {
                            addButton.innerHTML = `Añadir ${selectedChar.name} al Carrito <Image of Plus Icon>`;
                            addButton.disabled = false;
                        }
                    } else {
                        addButton.innerHTML = `Añadir Seleccionado <Image of Plus Icon>`;
                        addButton.disabled = true;
                    }
                    lucide.createIcons(); // Re-create icons after updating innerHTML
                };
            });

            // Assign event listeners for the add theme button
            document.querySelectorAll('#mainContent .theme-action-button').forEach(button => {
                button.onclick = () => { // Changed to directly use 'button' from forEach scope
                    const serviceId = button.dataset.serviceId;
                    const selectElement = document.getElementById(`themeSelect-${serviceId}`);
                    const selectedThemeName = selectElement.value;

                    if (selectedThemeName) {
                        const themeService = servicesData.find(s => s.id === serviceId);
                        updateThemeInCart(themeService, selectedThemeName, 'add');
                        selectElement.value = ""; // Reset the select after adding
                    } else {
                        showInfoModal('Por favor, selecciona una temática antes de añadirla.');
                    }
                };
            });

            // Assign event listeners for the remove specific theme buttons
            document.querySelectorAll('#mainContent .remove-specific-theme-button').forEach(button => {
                button.onclick = () => { // Changed to directly use 'button' from forEach scope
                    const fullThemeName = button.dataset.fullName;
                    const themeService = servicesData.find(s => s.type === 'theme_selection');
                    // Extract only the theme name
                    const themeNameOnly = fullThemeName.replace(themeService.name + ': ', '');
                    updateThemeInCart(themeService, themeNameOnly, 'remove_all');
                };
            });

            // Logic to enable/disable the "Add Selected" button and update its text (for themes)
            document.querySelectorAll('#mainContent select[id^="themeSelect-"]').forEach(select => {
                select.onchange = () => { // Changed to directly use 'select' from forEach scope
                    const serviceId = select.id.split('-')[1];
                    const selectedThemeName = select.value;
                    const addButton = document.querySelector(`.theme-action-button[data-service-id="${serviceId}"]`);
                    
                    if (selectedThemeName) {
                        const themeService = servicesData.find(s => s.id === serviceId);
                        const fullThemeName = `${themeService.name}: ${selectedThemeName}`;
                        const existingInCart = appState.selectedItems.find(item => item.name === fullThemeName);

                        if (existingInCart) {
                            addButton.innerHTML = `Añadir una más de ${selectedThemeName} <Image of Plus Icon> (x${existingInCart.quantity + 1})`;
                            addButton.disabled = false;
                        } else {
                            addButton.innerHTML = `Añadir ${selectedThemeName} al Carrito <Image of Plus Icon>`;
                            addButton.disabled = false;
                        }
                    } else {
                        addButton.innerHTML = `Añadir Seleccionado <Image of Plus Icon>`;
                        addButton.disabled = true;
                    }
                    lucide.createIcons(); // Re-create icons after updating innerHTML
                };
            });

            // Event listeners for Mini Taller de Manualidades quantity input and button
            document.querySelectorAll('#mainContent .update-manualidades-quantity-button').forEach(button => {
                button.onclick = () => { // Changed to directly use 'button' from forEach scope
                    const serviceId = button.dataset.serviceId;
                    const serviceName = button.dataset.serviceName;
                    const servicePrice = parseFloat(button.dataset.servicePrice);
                    const quantityInput = document.getElementById(`manualidadesQuantity-${serviceId}`);
                    let quantity = parseInt(quantityInput.value, 10);

                    if (isNaN(quantity) || quantity < 10) {
                        showInfoModal('La cantidad mínima para el Mini Taller de Manualidades es 10 niños.');
                        quantityInput.value = 10; // Reset to minimum
                        quantity = 10;
                    }

                    handleCartAction({ id: serviceId, name: serviceName, price: servicePrice }, 'set_quantity', quantity);
                };
            });

            document.querySelectorAll('#mainContent input[id^="manualidadesQuantity-"]').forEach(input => {
                input.oninput = () => { // Changed to directly use 'input' from forEach scope
                    const serviceId = input.id.split('-')[1];
                    const service = servicesData.find(s => s.id === serviceId);
                    if (!service) return; // Guard clause if service not found
                    
                    const servicePrice = service.price;
                    const quantity = parseInt(input.value, 10);
                    const subtotalSpan = document.getElementById(`manualidadesSubtotal-${service.id}`);
                    if (subtotalSpan && !isNaN(quantity) && quantity >= 0) {
                        subtotalSpan.textContent = `$${(servicePrice * quantity).toFixed(2)}`;
                    }
                };
            });

            // Add event listeners for image clicks
            document.querySelectorAll('.service-image').forEach(img => {
                img.onclick = (event) => {
                    showImageModal(event.target.src, event.target.alt);
                };
            });
        }

        /**
         * Renders the Packages section.
         */
        function renderPackagesSection() {
            const cardsHtml = packagesData.map((pkg, index) => {
                const selectedItemInCart = appState.selectedItems.find(item => {
                    // console.log(`Checking if "${pkg.name}" matches selected item "${item.name}"`); // Debug log
                    return item.name === pkg.name;
                });
                const isSelected = selectedItemInCart ? true : false;
                // console.log(`Package: "${pkg.name}", isSelected: ${isSelected}`); // Debug log

                let buttonText;
                let buttonClassColor;
                let buttonShadow;
                let buttonBorder;

                if (isSelected) {
                    buttonText = 'Quitar del Carrito <Image of Minus Icon>';
                    buttonClassColor = 'bg-red-500 hover:bg-red-600';
                    buttonShadow = 'shadow-md';
                    buttonBorder = ''; // No border for remove state
                } else {
                    buttonText = 'Añadir al Carrito <Image of Plus Icon>';
                    buttonClassColor = 'bg-gradient-to-br from-purple-600 via-purple-400 to-purple-700 text-white';
                    buttonShadow = 'shadow-xl';
                    buttonBorder = 'border-2 border-white';
                }

                let displayPrice = getAdjustedItemPrice({ ...pkg, quantity: 1 }); // Packages always have quantity 1 for price calculation on card.
                let originalPriceHtml = '';
                
                // If the adjusted price is different from the original price, show the original price strikethrough.
                if (Math.abs(displayPrice - pkg.price) > 0.001) { // Use epsilon for float comparison
                    originalPriceHtml = `<span class="line-through text-gray-500 text-2xl">$${pkg.price.toFixed(2)}</span> `;
                }

                // Image for the package card - now empty
                // Added 'service-image' class for click event.
                const packageImageHtml = pkg.imageUrl ? `<img src="${pkg.imageUrl}" alt="Imagen de ${pkg.name}" class="w-full h-40 object-cover rounded-t-lg mb-4 border-b-2 border-gray-300 shadow-sm cursor-pointer service-image">` : '';

                return `
                    <div class="${pkg.color} rounded-2xl shadow-xl flex flex-col justify-between border-4 border-dashed border-opacity-50 transition duration-300 hover:scale-[1.02] hover:shadow-2xl animate-slide-up-fade-in" style="animation-delay: ${index * 100}ms;">
                        ${packageImageHtml}
                        <div class="p-6 sm:p-8 flex flex-col flex-grow">
                            <h2 class="text-xl sm:text-2xl font-bold mb-3 sm:mb-4 text-indigo-700">${pkg.name} <Image of Rocket Icon></h2>
                            <p class="text-sm sm:text-base text-gray-700 mb-4 sm:mb-5">${pkg.description}</p>
                            <ul class="list-disc list-inside text-gray-600 mb-4 sm:mb-5 text-sm sm:text-base">
                                ${pkg.services.map(service => `<li>${service}</li>`).join('')}
                            </ul>
                            <p class="text-3xl sm:text-4xl font-extrabold text-pink-600 mb-4 sm:mb-5">
                                ${originalPriceHtml}$${displayPrice.toFixed(2)}
                            </p>
                            <button
                                data-item-name="${pkg.name}"
                                data-item-price="${pkg.price}"
                                data-action-type="toggle"
                                class="add-remove-button mt-auto font-bold py-2 px-4 rounded-full ${buttonShadow} text-sm sm:text-base transition duration-300 ${buttonClassColor} text-white transform hover:scale-105 ${buttonBorder} cursor-pointer flex items-center justify-center">
                                ${buttonText}
                            </button>
                        </div>
                    </div>
                `;
            }).join('');

            const html = `
                <section class="bg-gradient-to-br from-white to-gray-50 rounded-3xl shadow-2xl p-6 sm:p-10 my-8 border-4 border-pink-400 animate-fade-in">
                    <h2 class="text-3xl sm:text-4xl font-extrabold text-purple-700 text-center mb-10 sm:mb-12">Nuestros Planes de Cumpleaños <Image of Cake Icon></h2>
                    <p class="text-lg text-gray-700 text-center mb-10">
                        Descubre nuestros planes de <strong>cumpleaños para eventos infantiles en Panamá</strong>. ¡La opción perfecta para tu celebración!
                    </p>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 sm:gap-10">
                        ${cardsHtml}
                    </div>
                </section>
            `;
            renderSection(html);

            // Assign event listeners to all add/remove buttons in the packages section.
            document.querySelectorAll('#mainContent .add-remove-button').forEach(button => {
                button.onclick = () => { // Changed to directly use 'button' from forEach scope
                    const itemName = button.dataset.itemName;
                    const itemPrice = parseFloat(button.dataset.itemPrice);
                    const actionType = button.dataset.actionType;
                    handleCartAction({ name: itemName, price: itemPrice }, actionType);
                };
            });

            // Add event listeners for image clicks
            document.querySelectorAll('.service-image').forEach(img => {
                img.onclick = (event) => {
                    showImageModal(event.target.src, event.target.alt);
                };
            });
        }

        /**
         * Renders the Bubble Packages section.
         */
        function renderBubblePackagesSection() {
            const cardsHtml = bubblePackagesData.map((pkg, index) => {
                const selectedItemInCart = appState.selectedItems.find(item => item.name === pkg.name);
                const isSelected = selectedItemInCart ? true : false;

                let buttonText;
                let buttonClassColor;
                let buttonShadow;
                let buttonBorder;

                if (isSelected) {
                    buttonText = 'Quitar del Carrito <Image of Minus Icon>';
                    buttonClassColor = 'bg-red-500 hover:bg-red-600';
                    buttonShadow = 'shadow-md';
                    buttonBorder = ''; // No border for remove state
                } else {
                    buttonText = 'Añadir al Carrito <Image of Plus Icon>';
                    buttonClassColor = 'bg-gradient-to-br from-blue-600 via-blue-400 to-blue-700 text-white';
                    buttonShadow = 'shadow-xl';
                    buttonBorder = 'border-2 border-white';
                }

                let displayPrice = getAdjustedItemPrice({ ...pkg, quantity: 1 }); // Packages always have quantity 1 for price calculation on card.
                let originalPriceHtml = '';
                
                // If the adjusted price is different from the original price, show the original price strikethrough.
                if (Math.abs(displayPrice - pkg.price) > 0.001) { // Use epsilon for float comparison
                    originalPriceHtml = `<span class="line-through text-gray-500 text-2xl">$${pkg.price.toFixed(2)}</span> `;
                }

                // Image for the bubble package card
                // Added 'service-image' class for click event.
                const bubblePackageImageHtml = pkg.imageUrl ? `<img src="${pkg.imageUrl}" alt="Imagen de ${pkg.name}" class="w-full h-40 object-cover rounded-lg mt-4 border-b-2 border-gray-300 shadow-sm cursor-pointer service-image">` : '';


                return `
                    <div class="${pkg.color} rounded-2xl shadow-xl flex flex-col justify-between border-4 border-dashed border-opacity-50 transition duration-300 hover:scale-[1.02] hover:shadow-2xl animate-slide-up-fade-in" style="animation-delay: ${index * 100}ms;">
                        ${bubblePackageImageHtml}
                        <div class="p-6 sm:p-8 flex flex-col flex-grow">
                            <h2 class="text-xl sm:text-2xl font-bold mb-3 sm:mb-4 text-blue-700">${pkg.name} <Image of Droplets Icon></h2>
                            <p class="text-sm sm:text-base text-gray-700 mb-4 sm:mb-5">${pkg.description}</p>
                            <ul class="list-disc list-inside text-gray-600 mb-4 sm:mb-5 text-sm sm:text-base">
                                ${pkg.services.map(service => `<li>${service}</li>`).join('')}
                            </ul>
                            <p class="text-3xl sm:text-4xl font-extrabold text-pink-600 mb-4 sm:mb-5">
                                ${originalPriceHtml}$${displayPrice.toFixed(2)}
                            </p>
                            <button
                                data-item-name="${pkg.name}"
                                data-item-price="${pkg.price}"
                                data-action-type="toggle"
                                class="add-remove-button mt-auto font-bold py-2 px-4 rounded-full ${buttonShadow} text-sm sm:text-base transition duration-300 ${buttonClassColor} text-white transform hover:scale-105 ${buttonBorder} cursor-pointer flex items-center justify-center">
                                ${buttonText}
                            </button>
                        </div>
                    </div>
                `;
            }).join('');

            const html = `
                <section class="bg-gradient-to-br from-white to-gray-50 rounded-3xl shadow-2xl p-6 sm:p-10 my-8 border-4 border-blue-400 animate-fade-in">
                    <h2 class="text-3xl sm:text-4xl font-extrabold text-blue-700 text-center mb-10 sm:mb-12">Nuestros Paquetes de Burbujas <Image of Cloud Rain Icon></h2>
                    <p class="text-lg text-gray-700 text-center mb-10">
                        ¡Sumérgete en la diversión con nuestros increíbles paquetes de shows de burbujas gigantes en Panamá!
                    </p>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 sm:gap-10">
                        ${cardsHtml}
                    </div>
                </section>
            `;
            renderSection(html);

            // Assign event listeners to all add/remove buttons in the bubble packages section.
            document.querySelectorAll('#mainContent .add-remove-button').forEach(button => {
                button.onclick = () => { // Changed to directly use 'button' from forEach scope
                    const itemName = button.dataset.itemName;
                    const itemPrice = parseFloat(button.dataset.itemPrice);
                    const actionType = button.dataset.actionType;
                    handleCartAction({ name: itemName, price: itemPrice }, actionType);
                };
            });

            // Add event listeners for image clicks
            document.querySelectorAll('.service-image').forEach(img => {
                img.onclick = (event) => {
                    showImageModal(event.target.src, event.target.alt);
                };
            });
        }

        /**
         * Renders the Company References section.
         */
        function renderCompanyReferencesSection() {
            const cardsHtml = companyReferencesData.map((company, index) => `
                <div class="bg-white rounded-2xl shadow-xl flex flex-col items-center justify-center p-6 border-4 border-gray-200 transition duration-300 hover:scale-[1.02] hover:shadow-2xl animate-slide-up-fade-in" style="animation-delay: ${index * 100}ms;">
                    <img src="${company.imageUrl}" alt="Logo de ${company.name}" class="w-full h-32 object-cover rounded-lg mb-4 border-b-2 border-gray-300 shadow-sm cursor-pointer service-image">
                    <h3 class="text-lg sm:text-xl font-bold text-gray-800 text-center">${company.name}</h3>
                </div>
            `).join('');

            const html = `
                <section class="bg-gradient-to-br from-white to-gray-50 rounded-3xl shadow-2xl p-6 sm:p-10 my-8 border-4 border-green-400 animate-fade-in">
                    <h2 class="text-3xl sm:text-4xl font-extrabold text-green-700 text-center mb-10 sm:mb-12">Nuestros Clientes Corporativos <Image of Building Icon></h2>
                    <p class="text-lg text-gray-700 text-center mb-10">
                        Hemos llevado la magia de las burbujas gigantes a eventos de grandes empresas y organizaciones en Panamá. ¡Confía en nuestra experiencia!
                    </p>
                    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6 sm:gap-10">
                        ${cardsHtml}
                    </div>
                </section>
            `;
            // Append the new section to the main content area, instead of overwriting it.
            // This is a temporary solution for demonstration. A more robust approach would be to manage sections better.
            const mainContent = document.getElementById('mainContent');
            if (mainContent) {
                mainContent.insertAdjacentHTML('beforeend', html);
            }

            // Add event listeners for image clicks in this new section
            document.querySelectorAll('#mainContent .service-image').forEach(img => {
                img.onclick = (event) => {
                    showImageModal(event.target.src, event.target.alt);
                };
            });
        }


        /**
         * Renders the Booking section, displaying selected items and the form.
         * Calculates and displays the total price, including discounts and transport surcharges.
         */
        function renderBookingSection() {
            // Generate the list of selected items to display in the booking section.
            const selectedItemsListHtml = appState.selectedItems.length === 0
                ? `<p class="text-red-600 text-sm sm:text-base">No has seleccionado ningún servicio. Por favor, vuelve a la sección de Servicios o Paquetes.</p>`
                : `<div class="space-y-3">
                    ${appState.selectedItems.map((item) => {
                        const itemTotalForJotForm = getAdjustedItemPrice(item); // This now returns the total for the item

                        // Determine if a strikethrough price should be shown in the booking summary.
                        // For Pintacaritas, if quantity > 1, show $45 strikethrough as the "original" single-hour price.
                        // For other items, show strikethrough if a promotion applies.
                        let strikethroughHtml = '';
                        if (item.name === 'Pintacaritas' && item.quantity > 1) { // Name adjusted
                            strikethroughHtml = `<span class="line-through text-gray-500 text-xs">$${item.price.toFixed(2)}</span> `;
                        } else if (item.name !== 'Pintacaritas' && appState.promotedPackages.includes(item.name)) { // Name adjusted
                            strikethroughHtml = `<span class="line-through text-gray-500 text-xs">$${item.price.toFixed(2)}</span> `;
                        }
                        
                        return `
                            <div class="flex justify-between items-center bg-white p-4 rounded-lg shadow-sm border border-gray-200">
                                <span class="font-semibold text-gray-800 text-base">${item.name} ${item.quantity > 1 ? `(x${item.quantity})` : ''}</span>
                                <div class="flex items-center space-x-2">
                                    ${strikethroughHtml}
                                    <span class="font-bold text-pink-600 text-lg">$${itemTotalForJotForm.toFixed(2)}</span>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>`;

            // Calculate and display the transport surcharge.
            const currentTransportFee = transportFeesByLocation[appState.selectedLocation] || 0;
            const transportFeeDisplayHtml = currentTransportFee > 0
                ? `<p class="text-lg font-bold text-gray-700 mt-4">Recargo por Transporte (${appState.selectedLocation}): <span class="text-orange-600">$${currentTransportFee.toFixed(2)}</span></p>`
                : `<p class="text-lg font-bold text-gray-700 mt-4">Recargo por Transporte: <span class="text-green-600">¡Gratis en Panamá Centro!</span></p>`;

            // Calculate the final total price including discounts and surcharges.
            const totalItemsPrice = appState.selectedItems.reduce((sum, item) => {
                return sum + getAdjustedItemPrice(item);
            }, 0);
            const finalTotalPrice = totalItemsPrice + currentTransportFee;

            const html = `
                <section class="bg-gradient-to-br from-white to-gray-50 rounded-3xl shadow-2xl p-6 sm:p-10 my-8 border-4 border-purple-400 animate-fade-in">
                    <h2 class="text-3xl sm:text-4xl font-extrabold text-purple-700 text-center mb-10 sm:mb-12">Reserva tu Evento <Image of Calendar Check Icon></h2>
                    <p class="text-lg text-gray-700 text-center mb-10">
                        ¡Reserva tu <strong>fiesta infantil en Panamá</strong>! Completa este formulario para asegurar la magia de tu evento.
                    </p>
                    <div class="grid grid-cols-1 lg:grid-cols-1 gap-6 sm:gap-16">
                        <h3 class="text-xl sm:text-2xl font-bold text-purple-700 mb-6 sm:mb-8">Completa los Detalles de Tu Reserva <Image of Clipboard List Icon></h3>
                        <div class="bg-gradient-to-br from-purple-100 to-purple-200 p-6 sm:p-10 rounded-3xl shadow-2xl border-4 border-purple-400">
                            <form id="bookingForm" class="space-y-6">
                                <div class="bg-gradient-to-br from-pink-50 to-pink-100 p-6 rounded-2xl shadow-xl border-4 border-pink-300 mb-6">
                                    <h4 class="text-lg font-bold text-pink-700 mb-4">Tu Selección:</h4>
                                    ${selectedItemsListHtml}
                                    ${transportFeeDisplayHtml}
                                    <p class="text-xl font-bold text-purple-700 mt-4">Total a Pagar: <span class="text-pink-600">$${finalTotalPrice.toFixed(2)}</span></p>
                                </div>
                                
                                <div>
                                    <label for="locationSelect" class="block text-gray-700 font-bold mb-2 sm:mb-3 text-sm sm:text-base">Ubicación del Evento (Provincia/Zona):<Image of Map Pin Icon></label>
                                    <select
                                        id="locationSelect"
                                        name="ubicacionEvento"
                                        class="w-full p-3 sm:p-4 border-2 border-gray-300 rounded-lg focus:ring-purple-500 focus:border-purple-500 text-sm sm:text-base cursor-pointer transition duration-150 ease-in-out"
                                    >
                                        <option value="Panamá Centro" ${appState.bookingFormData.selectedLocation === 'Panamá Centro' ? 'selected' : ''}>Panamá Centro</option>
                                        <option value="Arraiján" ${appState.bookingFormData.selectedLocation === 'Arraiján' ? 'selected' : ''}>Arraiján ($10 adicional)</option>
                                        <option value="La Chorrera" ${appState.bookingFormData.selectedLocation === 'La Chorrera' ? 'selected' : ''}>La Chorrera ($15 adicional)</option>
                                        <option value="Pacora" ${appState.bookingFormData.selectedLocation === 'Pacora' ? 'selected' : ''}>Pacora ($10 adicional)</option>
                                        <option value="Panamá Norte" ${appState.bookingFormData.selectedLocation === 'Panamá Norte' ? 'selected' : ''}>Panamá Norte ($10 adicional)</option>
                                    </select>
                                </div>

                                <div>
                                    <label for="exactLocation" class="block text-gray-700 font-bold mb-2 sm:mb-3 text-sm sm:text-base">Dirección Exacta del Evento: <Image of Map Icon></label>
                                    <input
                                        type="text"
                                        id="exactLocation"
                                        name="direccionExacta"
                                        class="w-full p-3 sm:p-4 border-2 border-gray-300 rounded-lg focus:ring-purple-500 focus:border-purple-500 text-sm sm:text-base transition duration-150 ease-in-out"
                                        placeholder="Ej: Calle Principal, Casa #15, Cerca de la escuela..."
                                        value="${appState.bookingFormData.exactLocation || ''}"
                                        required
                                    />
                                    <span id="error-exactLocation" class="error-message hidden">Este campo es obligatorio.</span>
                                </div>

                                <div>
                                    <label for="bookingDate" class="block text-gray-700 font-bold mb-2 sm:mb-3 text-sm sm:text-base">Fecha del Evento: <Image of Calendar Icon></label>
                                    <input
                                        type="date"
                                        id="bookingDate"
                                        name="fechaEvento"
                                        class="w-full p-3 sm:p-4 border-2 border-gray-300 rounded-lg focus:ring-purple-500 focus:border-purple-500 text-sm sm:text-base transition duration-150 ease-in-out"
                                        min="${new Date().toISOString().split('T')[0]}"
                                        value="${appState.bookingFormData.bookingDate || ''}"
                                        required
                                    />
                                    <span id="error-bookingDate" class="error-message hidden">Este campo es obligatorio.</span>
                                </div>
                                <div>
                                    <label for="bookingTime" class="block text-gray-700 font-bold mb-2 sm:mb-3 text-sm sm:text-base">Hora del Evento: <Image of Clock Icon></label>
                                    <input
                                        type="time"
                                        id="bookingTime"
                                        name="horaEvento"
                                        class="w-full p-3 sm:p-4 border-2 border-gray-300 rounded-lg focus:ring-purple-500 focus:border-purple-500 text-sm sm:text-base transition duration-150 ease-in-out"
                                        value="${appState.bookingFormData.bookingTime || ''}"
                                        required
                                    />
                                    <span id="error-bookingTime" class="error-message hidden">Este campo es obligatorio.</span>
                                </div>
                                <div>
                                    <label for="customerName" class="block text-gray-700 font-bold mb-2 sm:mb-3 text-sm sm:text-base">Tu Nombre: <Image of User Icon></label>
                                    <input
                                        type="text"
                                        id="customerName"
                                        name="nombreCliente"
                                        class="w-full p-3 sm:p-4 border-2 border-gray-300 rounded-lg focus:ring-purple-500 focus:border-purple-500 text-sm sm:text-base transition duration-150 ease-in-out"
                                        placeholder="Ej: Juan Pérez"
                                        value="${appState.bookingFormData.customerName || ''}"
                                        required
                                    />
                                    <span id="error-customerName" class="error-message hidden">Este campo es obligatorio.</span>
                                </div>
                                <div>
                                    <label for="customerEmail" class="block text-gray-700 font-bold mb-2 sm:mb-3 text-sm sm:text-base">Tu Email: <Image of Mail Icon></label>
                                    <input
                                        type="email"
                                        id="customerEmail"
                                        name="emailCliente"
                                        class="w-full p-3 sm:p-4 border-2 border-gray-300 rounded-lg focus:ring-purple-500 focus:border-purple-500 text-sm sm:text-base transition duration-150 ease-in-out"
                                        placeholder="Ej: tu.email@example.com"
                                        value="${appState.bookingFormData.customerEmail || ''}"
                                        required
                                    />
                                    <span id="error-customerEmail" class="error-message hidden">Este campo es obligatorio.</span>
                                </div>
                                <div>
                                    <label for="customerPhone" class="block text-gray-700 font-bold mb-2 sm:mb-3 text-sm sm:text-base">Tu Teléfono:<Image of Phone Icon></label>
                                    <input
                                        type="tel"
                                        id="customerPhone"
                                        name="telefonoCliente"
                                        class="w-full p-3 sm:p-4 border-2 border-gray-300 rounded-lg focus:ring-purple-500 focus:border-purple-500 text-sm sm:text-base transition duration-150 ease-in-out"
                                        placeholder="Ej: 555-1234567"
                                        value="${appState.bookingFormData.customerPhone || ''}"
                                        required
                                    />
                                    <span id="error-customerPhone" class="error-message hidden">Este campo es obligatorio.</span>
                                </div>
                                <div>
                                    <label for="eventType" class="block text-gray-700 font-bold mb-2 sm:mb-3 text-sm sm:text-base">Tipo de Evento: <Image of Party Popper Icon></label>
                                    <input
                                        type="text"
                                        id="eventType"
                                        name="tipoEvento"
                                        class="w-full p-3 sm:p-4 border-2 border-gray-300 rounded-lg focus:ring-purple-500 focus:border-purple-500 text-sm sm:text-base transition duration-150 ease-in-out"
                                        placeholder="Ej: Cumpleaños, Graduación"
                                        value="${appState.bookingFormData.eventType || ''}"
                                        required
                                    />
                                    <span id="error-eventType" class="error-message hidden">Este campo es obligatorio.</span>
                                </div>
                                <div>
                                    <label for="numKids" class="block text-gray-700 font-bold mb-2 sm:mb-3 text-sm sm:text-base">Número Estimado de Niños: <Image of Users Icon></label>
                                    <input
                                        type="number"
                                        id="numKids"
                                        name="numeroNinos"
                                        class="w-full p-3 sm:p-4 border-2 border-gray-300 rounded-lg focus:ring-purple-500 focus:border-purple-500 text-sm sm:text-base transition duration-150 ease-in-out"
                                        placeholder="Ej: 20"
                                        min="1"
                                        value="${appState.bookingFormData.numKids || ''}"
                                        required
                                    />
                                    <span id="error-numKids" class="error-message hidden">Este campo es obligatorio.</span>
                                </div>
                                <button type="submit" class="w-full bg-gradient-to-br from-purple-600 via-purple-400 to-purple-700 hover:from-purple-700 hover:to-purple-800 text-white font-bold py-3 sm:py-4 px-4 sm:px-6 rounded-full shadow-xl text-base sm:text-lg mt-6 transition duration-300 transform hover:scale-105 border-2 border-white cursor-pointer flex items-center justify-center">
                                    ¡Confirmar Reserva Mágica! <Image of Sparkles Icon>
                                </button>
                            </form>
                        </div>
                    </div>
                </section>
            `;
            renderSection(html);
            // After rendering the form, ensure Lucide icons are created for the newly injected HTML.
            lucide.createIcons();

            const bookingForm = document.getElementById('bookingForm');
            if (bookingForm) {
                bookingForm.onsubmit = handleBookingSubmit;
                // Change handler for location selection, updates state and cart summary.
                const locationSelect = document.getElementById('locationSelect');
                if (locationSelect) {
                    locationSelect.onchange = (e) => {
                        appState.bookingFormData.selectedLocation = e.target.value; // Update state when location changes.
                        appState.selectedLocation = e.target.value; // Also update general location state.
                        updateCartSummary(); 
                        renderBookingSection(); // Re-render the section to display the updated surcharge.
                    };
                }
            }
        }

        // --- Functions to save and load booking form data ---
        /**
         * Saves current booking form data and selected items to localStorage.
         */
        function saveBookingFormData() {
            const bookingForm = document.getElementById('bookingForm');
            if (bookingForm) {
                appState.bookingFormData.bookingDate = bookingForm.elements.bookingDate ? bookingForm.elements.bookingDate.value : '';
                appState.bookingFormData.bookingTime = bookingForm.elements.bookingTime ? bookingForm.elements.bookingTime.value : '';
                appState.bookingFormData.customerName = bookingForm.elements.customerName ? bookingForm.elements.customerName.value : '';
                appState.bookingFormData.customerEmail = bookingForm.elements.customerEmail ? bookingForm.elements.customerEmail.value : '';
                appState.bookingFormData.customerPhone = bookingForm.elements.customerPhone ? bookingForm.elements.customerPhone.value : '';
                appState.bookingFormData.eventType = bookingForm.elements.eventType ? bookingForm.elements.eventType.value : '';
                appState.bookingFormData.numKids = bookingForm.elements.numKids ? bookingForm.elements.numKids.value : '';
                appState.bookingFormData.exactLocation = bookingForm.elements.exactLocation ? bookingForm.elements.exactLocation.value : '';
                appState.bookingFormData.selectedLocation = bookingForm.elements.locationSelect ? bookingForm.elements.locationSelect.value : 'Panamá Centro';
                
                // Save form data and selected items to localStorage.
                localStorage.setItem('bookingFormData', JSON.stringify(appState.bookingFormData));
                localStorage.setItem('selectedItems', JSON.stringify(appState.selectedItems));
                console.log('Form data and cart saved:', appState.bookingFormData, appState.selectedItems); // For debugging.
            }
        }

        /**
         * Loads booking form data and selected items from localStorage to appState.
         */
        function loadBookingFormData() {
            try {
                const savedFormData = localStorage.getItem('bookingFormData');
                if (savedFormData) {
                    appState.bookingFormData = JSON.parse(savedFormData);
                    // Ensure selectedLocation is also updated in the general state if data is loaded.
                    appState.selectedLocation = appState.bookingFormData.selectedLocation;
                    console.log('Form data loaded:', appState.bookingFormData); // For debugging.
                }
                const savedSelectedItems = localStorage.getItem('selectedItems');
                if (savedSelectedItems) {
                    appState.selectedItems = JSON.parse(savedSelectedItems);
                    console.log('Cart items loaded:', appState.selectedItems); // For debugging.
                }
            } catch (e) {
                console.error("Error loading data from localStorage:", e);
                // Clear localStorage if there's a parsing error to avoid loops
                localStorage.removeItem('bookingFormData');
                localStorage.removeItem('selectedItems');
            }
        }


        // --- Main Application Logic ---

        /**
         * Sets the active section and updates navigation, sending a page_view to Google Analytics.
         * @param {string} sectionName - The name of the section to activate ('home', 'services', 'packages', 'bubblePackages', 'booking').
         */
        function setActiveSection(sectionName) {
            // If the current section is 'booking' and we are going to another section, save the data.
            if (appState.activeSection === 'booking') {
                saveBookingFormData();
            }

            appState.activeSection = sectionName;
            // Update navigation button styles to indicate the active section.
            document.querySelectorAll('header nav button').forEach(button => {
                const buttonId = button.id;
                // First, reset all buttons to their default inactive state
                button.classList.remove('bg-gradient-to-br', 'from-purple-600', 'via-purple-400', 'to-purple-700', 'from-blue-600', 'via-blue-400', 'to-blue-700', 'from-pink-600', 'via-pink-400', 'to-pink-700', 'from-green-600', 'via-green-400', 'to-green-700', 'text-white', 'shadow-xl', 'border-2', 'border-white', 'scale-105');
                // Ensure inactive buttons have more highlighted text
                button.classList.add('bg-purple-200', 'text-purple-900', 'hover:bg-purple-300', 'shadow-md');

                // Then, apply active style to the button of the current section
                if (buttonId === 'navHome' && sectionName === 'home') {
                    button.classList.add('bg-gradient-to-br', 'from-purple-600', 'via-purple-400', 'to-purple-700', 'text-white', 'shadow-xl', 'border-2', 'border-white', 'scale-105');
                    button.classList.remove('bg-purple-200', 'text-purple-900', 'hover:bg-purple-300', 'shadow-md');
                } else if (buttonId === 'navServices' && sectionName === 'services') {
                    button.classList.add('bg-gradient-to-br', 'from-pink-600', 'via-pink-400', 'to-pink-700', 'text-white', 'shadow-xl', 'border-2', 'border-white', 'scale-105');
                    button.classList.remove('bg-purple-200', 'text-purple-900', 'hover:bg-purple-300', 'shadow-md');
                } else if (buttonId === 'navPackages' && sectionName === 'packages') {
                    button.classList.add('bg-gradient-to-br', 'from-purple-600', 'via-purple-400', 'to-purple-700', 'text-white', 'shadow-xl', 'border-2', 'border-white', 'scale-105');
                    button.classList.remove('bg-purple-200', 'text-purple-900', 'hover:bg-purple-300', 'shadow-md');
                } else if (buttonId === 'navBubblePackages' && sectionName === 'bubblePackages') { // New section
                    button.classList.add('bg-gradient-to-br', 'from-blue-600', 'via-blue-400', 'to-blue-700', 'text-white', 'shadow-xl', 'border-2', 'border-white', 'scale-105');
                    button.classList.remove('bg-purple-200', 'text-purple-900', 'hover:bg-purple-300', 'shadow-md');
                }
                else if (buttonId === 'navBooking' && sectionName === 'booking') {
                    button.classList.add('bg-gradient-to-br', 'from-pink-600', 'via-pink-400', 'to-pink-700', 'text-white', 'shadow-xl', 'border-2', 'border-white', 'scale-105');
                    button.classList.remove('bg-purple-200', 'text-purple-900', 'hover:bg-purple-300', 'shadow-md');
                }
            });

            let pagePath = '/'; // Default path for the home page.
            let pageTitle = 'Diverty Eventos'; // Default title (modified).

            // Determine the virtual page path and title for Google Analytics.
            switch (sectionName) {
                case 'home':
                    pagePath = '/inicio';
                    pageTitle = 'Diverty Eventos | Inicio'; 
                    break;
                case 'services':
                    pagePath = '/servicios';
                    pageTitle = 'Diverty Eventos | Servicios'; 
                    break;
                case 'packages':
                    pagePath = '/planes-cumpleanos';
                    pageTitle = 'Diverty Eventos | Planes de Cumpleaños'; // Updated page title
                    break;
                case 'bubblePackages': // New section
                    pagePath = '/paquetes-burbujas';
                    pageTitle = 'Diverty Eventos | Paquetes de Burbujas';
                    break;
                case 'booking':
                    pagePath = '/reservar';
                    pageTitle = 'Diverty Eventos | Reservar'; 
                    // Hide the cart summary bar when entering the booking section.
                    const cartSummaryDiv = document.getElementById('cartSummary');
                    if (cartSummaryDiv) cartSummaryDiv.classList.add('hidden');
                    // Show the booking warning modal only if it's the first time in the session.
                    if (!appState.hasShownBookingWarning) {
                        showBookingWarningModal();
                        appState.hasShownBookingWarning = true;
                    }
                    break;
            }

            // Send the virtual page view event to Google Analytics.
            if (typeof gtag === 'function') {
                gtag('event', 'page_view', {
                    page_path: pagePath,
                    page_title: pageTitle
                });
            } else {
                console.warn('gtag is not defined. Google Analytics might not be loaded.');
            }

            // Render the corresponding section.
            // Clear mainContent first to ensure only the active section is visible.
            const mainContent = document.getElementById('mainContent');
            if (mainContent) {
                mainContent.innerHTML = ''; // Clear previous content
            }

            switch (sectionName) {
                case 'home':
                    renderHomeSection();
                    break;
                case 'services':
                    renderServicesSection();
                    break;
                case 'packages':
                    renderPackagesSection();
                    break;
                case 'bubblePackages': // New section
                    renderBubblePackagesSection();
                    renderCompanyReferencesSection(); // Call the new function here
                    break;
                case 'booking':
                    renderBookingSection();
                    break;
                default:
                    renderHomeSection(); // Default fallback.
            }
            // The cart summary update is handled within each renderSection
            // or skipped if the section is 'booking' to keep it hidden.
            if (sectionName !== 'booking') {
                updateCartSummary(); 
            }

            // Close the mobile menu after a selection
            const mobileMenu = document.getElementById('mobileMenu');
            const mobileMenuToggle = document.getElementById('mobileMenuToggle');
            if (mobileMenu && !mobileMenu.classList.contains('hidden')) { // Check if menu is open
                mobileMenu.classList.add('hidden');
                mobileMenuToggle.setAttribute('aria-expanded', 'false');
                mobileMenuToggle.innerHTML = `
                            <svg class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                            </svg>
                        `;
            }
        }

        // --- Event for warning when trying to leave the page ---
        // This message is usually generic in modern browsers for security reasons.
        window.onbeforeunload = function() {
            // Save cart and form state before the user leaves the page.
            saveBookingFormData();
            // Do not return a string to avoid intrusive confirmation message in modern browsers.
        };

        /**
         * Clears error messages and input styles from the form fields.
         */
        function clearFormErrors() {
            const errorMessages = document.querySelectorAll('.error-message');
            errorMessages.forEach(span => {
                span.classList.add('hidden');
                span.textContent = ''; // Clear error text
            });
            const errorInputs = document.querySelectorAll('.input-error');
            errorInputs.forEach(input => {
                input.classList.remove('input-error');
            });
        }

        /**
         * Displays an error message for a specific field.
         * @param {string} fieldId - The ID of the field with the error.
         * @param {string} message - The error message to display.
         */
        function showFieldError(fieldId, message) {
            const errorSpan = document.getElementById(`error-${fieldId}`);
            const inputElement = document.getElementById(fieldId);
            if (errorSpan && inputElement) {
                errorSpan.textContent = message;
                errorSpan.classList.remove('hidden');
                inputElement.classList.add('input-error');
            }
        }


        // --- Form Submission to JotForm ---
        /**
         * Handles the submission of the booking form.
         * Performs basic validations and then redirects to JotForm with pre-filled data.
         * @param {Event} event - The form submission event.
         */
        async function handleBookingSubmit(event) {
            event.preventDefault(); // Prevents default form submission.

            clearFormErrors(); // Clear any previous errors.

            // *** Validations are performed first ***
            if (appState.selectedItems.length === 0) {
                showInfoModal('¡Por favor, añade al menos un servicio o paquete a tu reserva! <Image of Shopping Cart Icon>');
                return;
            }

            // Validate minimum quantity for "Mini Taller de Manualidades"
            const miniTallerItem = appState.selectedItems.find(item => item.name === 'Mini Taller de Manualidades'); // Name adjusted
            if (miniTallerItem && miniTallerItem.quantity < 10) {
                showInfoModal('El "Mini Taller de Manualidades" requiere un mínimo de 10 niños. Por favor, ajusta la cantidad. <Image of Scissors Icon>');
                return;
            }

            const requiredFields = [
                'bookingDate', 'bookingTime', 'customerName', 'customerEmail',
                'customerPhone', 'eventType', 'numKids', 'exactLocation'
            ];
            let formIsValid = true;
            for (const fieldId of requiredFields) {
                const inputElement = document.getElementById(fieldId);
                // Trim to remove whitespace and ensure it's not just spaces
                if (inputElement && !inputElement.value.trim()) { // Added check for inputElement
                    showFieldError(fieldId, 'Este campo es obligatorio.');
                    formIsValid = false;
                }
            }

            // Specific validation for email format
            const emailInput = document.getElementById('customerEmail');
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (emailInput && !emailRegex.test(emailInput.value.trim())) {
                showFieldError('customerEmail', 'Por favor, introduce un email válido.');
                formIsValid = false;
            }

            if (!formIsValid) {
                showInfoModal('¡Oops! Por favor, completa todos los campos requeridos correctamente para realizar la reserva. <Image of Clipboard List Icon>');
                return;
            }

            // If all validations pass, save the form and show the modal.
            saveBookingFormData(); // Save data before redirection.
            showInfoModal('¡Redirigiendo a JotForm para finalizar tu reserva! <Image of Sparkles Icon> Haz clic en "¡Entendido!" para continuar.', () => {
                // This is what will execute when the user clicks "¡Entendido!" in the modal.

                // --- Data Collection for JotForm (re-obtained to ensure latest values) ---
                const bookingDate = document.getElementById('bookingDate') ? document.getElementById('bookingDate').value : ''; 
                const bookingTime = document.getElementById('bookingTime') ? document.getElementById('bookingTime').value : ''; 

                const [year, month, day] = bookingDate.split('-'); 

                const customerName = document.getElementById('customerName') ? document.getElementById('customerName').value : '';
                const customerEmail = document.getElementById('customerEmail') ? document.getElementById('customerEmail').value : '';
                const customerPhone = document.getElementById('customerPhone') ? document.getElementById('customerPhone').value : '';
                const eventType = document.getElementById('eventType') ? document.getElementById('eventType').value : '';
                const numKids = document.getElementById('numKids') ? document.getElementById('numKids').value : '';
                const exactLocation = document.getElementById('exactLocation') ? document.getElementById('exactLocation').value : '';
                const selectedLocationName = appState.selectedLocation;
                const currentTransportFee = transportFeesByLocation[selectedLocationName] || 0;

                const selectedItemsString = appState.selectedItems.map(item => {
                    const itemTotalForJotForm = getAdjustedItemPrice(item); // This now returns the total for the item
                    return `${item.name} ${item.quantity > 0 ? `(x${item.quantity})` : ''} ($${itemTotalForJotForm.toFixed(2)})`; 
                }).join(', ');
                
                const totalItemsPrice = appState.selectedItems.reduce((sum, item) => {
                    return sum + getAdjustedItemPrice(item);
                }, 0);
                const finalTotalPrice = totalItemsPrice + currentTransportFee;

                // --- Construction of JotForm URL with Parameters ---
                // Parameters are encoded in the URL to pre-fill the JotForm form.
                const jotformBaseUrl = 'https://form.jotform.com/251611549526054'; 
                const params = new URLSearchParams();

                params.append('fechaDelEvento[year]', year);   
                params.append('fechaDelEvento[month]', month); 
                params.append('fechaDelEvento[day]', day);     
                
                params.append('horaDelEvento', bookingTime); 
                params.append('nombreDelCliente', customerName);
                params.append('emailDelCliente', customerEmail);
                params.append('telefonoDelCliente', customerPhone);
                params.append('tipoDeEvento', eventType);
                params.append('numeroEstimadoDeNinos', numKids);
                params.append('ubicacionSeleccionada', selectedLocationName);
                params.append('recargoPorTransporte', `$${currentTransportFee.toFixed(2)}`);
                params.append('direccionExactaDelEvento', exactLocation);
                params.append('serviciosPaquetesSeleccionados', selectedItemsString);
                params.append('precioTotalEstimado', `$${finalTotalPrice.toFixed(2)}`);
                params.append('idDeSesionVisitante', appState.userId);

                const jotformUrl = `${jotformBaseUrl}?${params.toString()}`;

                // Open in a new tab when the user clicks "¡Entendido!".
                // Includes a fallback for redirection in the same tab if the new window is blocked.
                const newWindow = window.open(jotformUrl, '_blank');
                if (newWindow) {
                    newWindow.focus(); 
                } else {
                    console.warn('The new window could not be opened (pop-up blocker). Attempting redirection in the same tab as fallback.');
                    window.location.href = jotformUrl; 
                }
            });
        }

        // --- Application Initialization ---
        // Executes when the DOM is fully loaded.
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM Content Loaded. Initializing app.'); // Debug log

            // Load form data and cart when the page loads.
            loadBookingFormData(); 

            // Assign event listeners for closing modals.
            const closeModalBtn = document.getElementById('closeModalButton');
            if (closeModalBtn) closeModalBtn.onclick = closeModal;

            const closePromoModalBtn = document.getElementById('closePromoModalButton');
            if (closePromoModalBtn) closePromoModalBtn.onclick = closePromoModal;

            const closeBookingWarningModalBtn = document.getElementById('closeBookingWarningModalButton');
            if (closeBookingWarningModalBtn) closeBookingWarningModalBtn.onclick = closeBookingWarningModal;
            
            // Assign event listeners for mini-cart modal buttons.
            const closeMiniCartModalBtn = document.getElementById('closeMiniCartModalButton');
            if (closeMiniCartModalBtn) closeMiniCartModalBtn.onclick = closeMiniCartModal;

            // Assign event listeners for image modal.
            const closeImageModalBtn = document.getElementById('closeImageModalButton');
            if (closeImageModalBtn) closeImageModalBtn.onclick = closeImageModal;


            // Assign event listeners for mobile menu toggle.
            const mobileMenuToggle = document.getElementById('mobileMenuToggle');
            const mobileMenu = document.getElementById('mobileMenu');
            if (mobileMenuToggle && mobileMenu) {
                mobileMenuToggle.onclick = () => {
                    const isHidden = mobileMenu.classList.toggle('hidden');
                    mobileMenuToggle.setAttribute('aria-expanded', !isHidden);
                    // Change hamburger icon to close icon and vice versa
                    if (isHidden) {
                        mobileMenuToggle.innerHTML = `
                            <svg class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
                            </svg>
                        `;
                    } else {
                        mobileMenuToggle.innerHTML = `
                            <svg class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        `;
                    }
                }; 
            }

            // Assign event listeners for main navigation buttons.
            const navHomeBtn = document.getElementById('navHome');
            if (navHomeBtn) navHomeBtn.onclick = () => setActiveSection('home');
            
            const navServicesBtn = document.getElementById('navServices');
            if (navServicesBtn) navServicesBtn.onclick = () => setActiveSection('services');
            
            const navPackagesBtn = document.getElementById('navPackages');
            if (navPackagesBtn) navPackagesBtn.onclick = () => setActiveSection('packages');
            
            const navBubblePackagesBtn = document.getElementById('navBubblePackages'); // New button
            if (navBubblePackagesBtn) navBubblePackagesBtn.onclick = () => setActiveSection('bubblePackages'); // New section
            
            const navBookingBtn = document.getElementById('navBooking');
            if (navBookingBtn) navBookingBtn.onclick = () => setActiveSection('booking');
            
            const proceedToBookBtn = document.getElementById('proceedToBookButton');
            if (proceedToBookBtn) proceedToBookBtn.onclick = () => setActiveSection('booking');
            
            const miniCartProceedToBookBtn = document.getElementById('miniCartProceedToBookButton');
            if (miniCartProceedToBookBtn) miniCartProceedToBookBtn.onclick = () => {
                closeMiniCartModal(); // Close modal before going to booking
                setActiveSection('booking');
            };
            
            const viewCartDetailsBtn = document.getElementById('viewCartDetailsButton');
            if (viewCartDetailsBtn) {
                viewCartDetailsBtn.onclick = () => {
                    showMiniCartModal();
                };
            }

            console.log('Calling setActiveSection("home")'); // Debug log
            // Set home section as default when page loads.
            setActiveSection('home');
            updateCartSummary(); // Ensure cart summary is displayed correctly on startup.
        });
    </script>
</body>
</html>
