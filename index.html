<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- T√≠tulo optimizado para SEO: Incluye palabras clave principales y ubicaci√≥n para mejorar la visibilidad en buscadores. -->
    <title>Diverty Eventos | Fiestas Infantiles en Panam√°</title>
    <!-- Descripci√≥n meta optimizada para SEO: Proporciona un resumen conciso y atractivo del contenido, con palabras clave relevantes y una llamada de acci√≥n. -->
    <meta name="description" content="Organizamos las mejores fiestas infantiles en Panam√° Centro, Arraij√°n, La Chorrera, Pacora y Panam√° Norte. Expertos en animaci√≥n, shows de burbujas, pintacaritas, globoflexia y paquetes de diversi√≥n. ¬°Haz que la fiesta de tus hijos sea inolvidable con Diverty Eventos en todo Panam√°!">
    
    <!-- Open Graph Tags para compartir en redes sociales y apps de mensajer√≠a (Facebook, WhatsApp, etc.). -->
    <meta property="og:title" content="Diverty Eventos | Fiestas Infantiles en Panam√°">
    <meta property="og:description" content="Organizamos las mejores fiestas infantiles en Panam√°. Animaci√≥n, shows de burbujas, pintacaritas y m√°s. ¬°Haz la fiesta so√±ada de tus hijos con Diverty Eventos!">
    <!-- ¬°IMPORTANTE! URL de la imagen corregida para Netlify. -->
    <meta property="og:image" content="https://divertypanama.netlify.app/android-chrome-512x512.png"> 
    <meta property="og:image:width" content="512"> 
    <meta property="og:image:height" content="512"> 
    <meta property="og:image:alt" content="Logo de Diverty Eventos, para fiestas infantiles en Panam√°">
    <meta property="og:url" content="https://divertypanama.netlify.app/"> <!-- URL real de tu sitio web. -->
    <meta property="og:type" content="website">

    <!-- Google tag (gtag.js) para Google Analytics: Permite el seguimiento de visitas y comportamiento de los usuarios. -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-R3G3Y0FLVN"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-R3G3Y0FLVN');
    </script>

    <!-- Schema Markup (Datos Estructurados) para LocalBusiness y Organization - SEO: Ayuda a los motores de b√∫squeda a entender el contenido de tu negocio. -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": ["LocalBusiness", "Organization"],
      "name": "Diverty Eventos",
      "image": "https://divertypanama.netlify.app/android-chrome-512x512.png", <!-- URL de la imagen principal para Schema Markup corregida. -->
      "url": "https://divertypanama.netlify.app/", <!-- URL real de tu sitio. -->
      "telephone": "+50766677965",
      "address": {
        "@type": "PostalAddress",
        "streetAddress": "Tu Direcci√≥n Exacta Aqu√≠ (Ej: Calle 50, Edificio XYZ)", <!-- ¬°IMPORTANT! Reemplaza con tu direcci√≥n f√≠sica. -->
        "addressLocality": "Panam√° Centro",
        "addressRegion": "Panam√°",
        "postalCode": "Tu C√≥digo Postal Aqu√≠", <!-- Opcional, pero recomendado si lo tienes. -->
        "addressCountry": "PA"
      },
      "priceRange": "$$",
      "openingHoursSpecification": [
        {
          "@type": "OpeningHoursSpecification",
          "dayOfWeek": [
            "Monday",
            "Tuesday",
            "Wednesday",
            "Thursday",
            "Friday"
          ],
          "opens": "09:00",
          "closes": "18:00"
        },
        {
          "@type": "OpeningHoursSpecification",
          "dayOfWeek": [
            "Saturday",
            "Sunday"
          ],
          "opens": "10:00",
          "closes": "17:00"
        }
      ],
      "hasOfferCatalog": {
        "@type": "OfferCatalog",
        "name": "Cat√°logo de Servicios y Paquetes de Fiestas Infantiles en Panam√°",
        "itemListElement": [
          {
            "@type": "Offer",
            "itemOffered": {
              "@type": "Service",
              "name": "Pintacaritas para fiestas infantiles",
              "description": "Transforma a los ni√±os en sus personajes favoritos con pinturas hipoalerg√©nicas, un servicio ideal para fiestas infantiles en Panam√°."
            }
          },
          {
            "@type": "Offer",
            "itemOffered": {
              "@type": "Service",
              "name": "Globoflexia para cumplea√±os y eventos infantiles",
              "description": "Figuras divertidas y creativas hechas con globos para cada invitado, perfectas para cumplea√±os y eventos infantiles en Panam√°."
            }
          },
          {
            "@type": "Offer",
            "itemOffered": {
              "@type": "Service",
              "name": "Show de Burbujas Gigantes en Panam√°",
              "description": "¬°Burbujas enormes que los ni√±os pueden atrapar y explotar! Un s√∫per show √∫nico en Panam√° para cualquier fiesta infantil."
            }
          },
          {
            "@type": "Offer",
            "itemOffered": {
              "@type": "Service",
              "name": "Paquete Fiesta M√°gica Express para fiestas infantiles en Panam√°",
              "description": "Diversi√≥n con animador, juegos, globos y pi√±ata. Ideal para fiestas r√°pidas y cumplea√±os en Panam√°."
            }
          },
          {
            "@type": "Offer",
            "itemOffered": {
              "@type": "Service",
              "name": "Paquete Aventura de Ensue√±o para fiestas infantiles en Panam√°",
              "description": "Servicio completo con payaso, pintacaritas, animaci√≥n, juegos y pi√±ata para una celebraci√≥n inolvidable en Panam√°."
            }
          },
          {
            "@type": "Offer",
            "itemOffered": {
              "@type": "Service",
              "name": "Paquete Celebraci√≥n Personalizada para eventos infantiles en Panam√°",
              "description": "Servicio premium con payaso, animaci√≥n, pintacaritas, show de magia c√≥mica y asistencia para pi√±ata, dise√±ado para tu fiesta perfecta en Panam√°."
            }
          }
        ]
      },
      "slogan": "¬°Hacemos magia en tu fiesta infantil en Panam√°!",
      "description": "Diverty Eventos ofrece la mejor animaci√≥n y shows para fiestas infantiles en Panam√° Centro, Arraij√°n, La Chorrera, Pacora y Panam√° Norte. Especialistas en shows de burbujas, pintacaritas y paquetes de diversi√≥n inolvidable. ¬°Organiza la fiesta so√±ada de tus hijos!"
    }
    </script>
    <!-- Tailwind CSS CDN para estilos: Permite un desarrollo r√°pido y un dise√±o responsivo. -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Inter para la tipograf√≠a: Proporciona una fuente moderna y legible. -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* Estilos base para el cuerpo de la p√°gina */
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
        }
        /* Estilos personalizados para el hover de botones para consistencia visual. */
        .hover\:bg-purple-600:hover { background-color: #7c3aed; }
        .hover\:bg-pink-600:hover { background-color: #db2777; }
        .hover\:bg-blue-600:hover { background-color: #2563eb; }
        .hover\:bg-green-600:hover { background-color: #16a34a; }
        .hover\:bg-indigo-600:hover { background-color: #4f46e5; }
        /* Estilo para tachar texto (precios anteriores), √∫til para mostrar descuentos. */
        .line-through { text-decoration: line-through; }

        /* Estilo para el bot√≥n flotante de WhatsApp: Permite un acceso r√°pido al contacto. */
        .whatsapp-float-button {
            position: fixed;
            bottom: 80px; /* Ajusta la posici√≥n vertical del bot√≥n. */
            right: 20px;
            z-index: 1000; /* Asegura que el bot√≥n est√© por encima de otros elementos. */
            width: 56px; /* Ajuste para que el bot√≥n sea cuadrado. */
            height: 56px;
            display: flex; /* Usar flexbox para centrar contenido. */
            justify-content: center; /* Centra el icono horizontalmente. */
            align-items: center; /* Centra el icono verticalmente. */
            border-radius: 9999px; /* Redondo completo. */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); /* Sombra m√°s pronunciada. */
            transition: all 0.3s ease; /* Transiciones suaves para hover. */
            background-color: #25D366; /* Color de fondo de WhatsApp. */
        }
        .whatsapp-float-button:hover {
            transform: scale(1.1); /* Ligero aumento de tama√±o al pasar el rat√≥n. */
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); /* Sombra a√∫n m√°s pronunciada en hover. */
        }

        /* Estilo para mensajes de error de validaci√≥n en l√≠nea */
        .error-message {
            color: #ef4444; /* red-500 */
            font-size: 0.875rem; /* text-sm */
            margin-top: 0.25rem;
        }
        .input-error {
            border-color: #ef4444 !important; /* red-500 */
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-purple-200 via-pink-200 to-yellow-200 text-gray-800 flex flex-col">

    <!-- Modal de Informaci√≥n General: Se usa para mensajes al usuario (ej. √©xito, error). -->
    <div id="infoModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 p-4 hidden" role="dialog" aria-modal="true" aria-labelledby="modalMessage">
        <div class="bg-white rounded-xl shadow-2xl p-6 max-w-sm w-full text-center border-4 border-purple-400 transform transition-all duration-300 scale-95 opacity-0" id="infoModalContent">
            <p id="modalMessage" class="text-xl font-bold mb-4 text-purple-700"></p>
            <button id="closeModalButton" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-5 rounded-full shadow-lg transition duration-300">
                ¬°Entendido! üéâ
            </button>
        </div>
    </div>

    <!-- Modal de Promoci√≥n: Se usa para anunciar ofertas especiales. -->
    <div id="promoModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 p-4 hidden" role="dialog" aria-modal="true" aria-labelledby="promoMessage">
        <div class="bg-white rounded-xl shadow-2xl p-6 max-w-md w-full text-center border-4 border-green-400 transform transition-all duration-300 scale-95 opacity-0" id="promoModalContent">
            <h2 class="text-3xl font-extrabold text-green-700 mb-4">¬°Promoci√≥n del Mes! üåü</h2>
            <p id="promoMessage" class="text-lg text-gray-800 mb-4"></p>
            <button id="closePromoModalButton" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-5 rounded-full shadow-lg transition duration-300">
                ¬°Genial! üéâ
            </button>
        </div>
    </div>

    <!-- Nuevo Modal de Advertencia de Reserva: Se muestra antes de rellenar el formulario de reserva. -->
    <div id="bookingWarningModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 p-4 hidden" role="dialog" aria-modal="true" aria-labelledby="bookingWarningTitle">
        <div class="bg-white rounded-xl shadow-2xl p-6 max-w-md w-full text-center border-4 border-red-400 transform transition-all duration-300 scale-95 opacity-0" id="bookingWarningModalContent">
            <h2 id="bookingWarningTitle" class="text-3xl font-extrabold text-red-700 mb-4">¬°Importante antes de Reservar! üö®</h2>
            <p class="text-lg text-gray-800 mb-6">
                Para asegurar la disponibilidad de la fecha y hora de tu evento, te recomendamos
                <span class="font-bold text-red-600">verificar primero con nosotros v√≠a WhatsApp</span>.
                ¬°As√≠ garantizamos la magia de tu d√≠a! ‚ú®
            </p>
            <div class="flex flex-col sm:flex-row justify-center space-y-4 sm:space-y-0 sm:space-x-4">
                <a href="https://wa.me/50766677965?text=¬°Hola! Quiero consultar la disponibilidad de una fecha para un evento."
                   target="_blank"
                   class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-full shadow-lg transition duration-300 flex items-center justify-center">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/6/6b/WhatsApp.svg/1200px-WhatsApp.svg.png" alt="WhatsApp Icon" class="w-6 h-6 mr-2">
                    Contactar por WhatsApp
                </a>
                <button id="closeBookingWarningModalButton" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-3 px-6 rounded-full shadow-lg transition duration-300">
                    Continuar con el Formulario
                </button>
            </div>
        </div>
    </div>

    <!-- Encabezado (Men√∫ de Navegaci√≥n Principal): Contiene el logo, el t√≠tulo y los botones de navegaci√≥n. -->
    <header class="bg-white bg-opacity-95 shadow-xl p-4 w-full rounded-b-xl sticky top-0 z-40">
        <nav class="container mx-auto flex flex-col sm:flex-row justify-between items-center" aria-label="Navegaci√≥n Principal">
            <!-- Contenedor para el logo y el t√≠tulo en dispositivos m√≥viles y de escritorio. -->
            <div class="flex items-center mb-4 sm:mb-0">
                <!-- LOGO DE DIVERTY EVENTOS -->
                <!-- ¬°IMPORTANTE! La URL de la imagen ahora apunta a tu sitio de Netlify. -->
                <img src="https://divertypanama.netlify.app/android-chrome-512x512.png" alt="Logo de Diverty Eventos" class="w-16 h-16 mr-4 rounded-full object-cover border-2 border-pink-400 shadow-md">
                
                <!-- T√≠tulo principal simplificado: Muestra el nombre de la marca. -->
                <h1 class="text-3xl sm:text-4xl font-extrabold text-purple-700 text-center sm:text-left">
                    Diverty Eventos 
                </h1>
            </div>
            <ul class="flex flex-wrap justify-center sm:space-x-4 space-x-2" role="menubar">
                <li role="none"><button id="navHome" role="menuitem" class="text-base font-bold py-1 px-3 rounded-full text-gray-700 hover:bg-purple-100 transition duration-300">Inicio üè†</button></li>
                <li role="none"><button id="navServices" role="menuitem" class="text-base font-bold py-1 px-3 rounded-full text-gray-700 hover:bg-purple-100 transition duration-300">Servicios üìã</button></li>
                <li role="none"><button id="navPackages" role="menuitem" class="text-base font-bold py-1 px-3 rounded-full text-gray-700 hover:bg-purple-100 transition duration-300">Paquetes üì¶</button></li>
                <li role="none"><button id="navBooking" role="menuitem" class="text-base font-bold py-1 px-3 rounded-full text-gray-700 hover:bg-purple-100 transition duration-300">Reservar üóìÔ∏è</button></li>
            </ul>
        </nav>
    </header>

    <!-- Resumen del Carrito de Compra (Barra Flotante): Muestra la cantidad de √≠tems y el total seleccionado. -->
    <div id="cartSummary" class="bg-yellow-200 text-purple-800 font-extrabold p-6 text-center rounded-b-lg shadow-lg border-4 border-yellow-400 hidden sticky top-[100px] z-30 transition-all duration-300 ease-in-out">
        <p class="text-2xl sm:text-3xl mb-3">
            üõí √çtems seleccionados: <span id="selectedItemsCount" class="text-purple-700">0</span> | Total: <span id="totalPriceDisplay" class="text-pink-700">$0.00</span>
        </p>
        <button id="proceedToBookButton" class="mt-2 bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 px-8 rounded-full shadow-md text-base sm:text-lg transition duration-300">
            Proceder a Reservar Ahora! ‚ú®
        </button>
    </div>

    <!-- √Årea de Contenido Principal: Aqu√≠ se cargar√° din√°micamente el contenido de cada secci√≥n (Inicio, Servicios, etc.). -->
    <main id="mainContent" class="container mx-auto p-4 flex-grow">
        <!-- Mensaje de carga o fallback si JavaScript no funciona -->
        <noscript>
            <div class="text-center text-red-600 bg-red-100 p-4 rounded-lg shadow-md mt-8">
                <p class="font-bold text-xl">¬°Parece que JavaScript est√° deshabilitado o hay un problema!</p>
                <p>Por favor, aseg√∫rate de que JavaScript est√© habilitado en tu navegador para ver el contenido completo de esta p√°gina.</p>
            </div>
        </noscript>
        <div id="loadingMessage" class="text-center text-gray-500 text-lg mt-8">
            Cargando contenido... Si esto no desaparece, puede haber un problema.
        </div>
    </main>

    <!-- Bot√≥n Flotante de WhatsApp: Acceso r√°pido para contactar por WhatsApp. -->
    <a href="https://wa.me/50766677965?text=¬°Hola! Tengo una consulta sobre Diverty Eventos." class="whatsapp-float-button" target="_blank" aria-label="Contactar por WhatsApp">
        <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/6/6b/WhatsApp.svg/1200px-WhatsApp.svg.png" alt="WhatsApp Icon" class="w-6 h-6">
    </a>

    <!-- Pie de P√°gina: Informaci√≥n de derechos de autor y eslogan. -->
    <footer class="bg-purple-700 text-white py-8 px-4 text-center mt-8 rounded-t-xl shadow-inner w-full">
        <p class="text-lg font-semibold">&copy; 2023 Diverty Eventos. ¬°Hacemos magia en cada fiesta infantil en Panam√°! ‚ú®</p>
        <p class="text-sm">Todos los derechos reservados. Servicios de <strong>animaci√≥n infantil</strong> y <strong>shows para fiestas</strong> en todo Panam√°.</p>
    </footer>

    <!-- Script de JavaScript para la funcionalidad de la p√°gina. -->
    <script>
        // --- Gesti√≥n del Estado Global de la Aplicaci√≥n ---
        // 'appState' contiene todas las variables de estado que controlan el comportamiento de la aplicaci√≥n.
        let appState = {
            activeSection: 'home', // Secci√≥n actualmente visible ('home', 'services', 'packages', 'booking').
            userId: 'guest_user_' + Math.random().toString(36).substring(2, 9), // ID √∫nico para el usuario visitante.
            selectedItems: [], // Array para almacenar los servicios/paquetes seleccionados en el carrito.
            promotedPackages: [], // Array para almacenar los nombres de los paquetes en promoci√≥n.
            selectedLocation: 'Panam√° Centro', // Ubicaci√≥n seleccionada para calcular el recargo de transporte.
            hasShownBookingWarning: false, // Indica si el modal de advertencia de reserva ya se mostr√≥ en la sesi√≥n.
            infoModalCallback: null, // Callback para ejecutar una funci√≥n al cerrar el modal de info.
            bookingFormData: { // Objeto para almacenar los datos del formulario de reservas, √∫til para persistencia.
                bookingDate: '',
                bookingTime: '',
                customerName: '',
                customerEmail: '',
                customerPhone: '',
                eventType: '',
                numKids: '',
                exactLocation: '',
                selectedLocation: 'Panam√° Centro' 
            },
        };

        // --- Definici√≥n de Datos (Servicios y Paquetes) ---
        // Arrays de objetos que definen los servicios y paquetes disponibles, incluyendo precios y descripciones.
        const servicesData = [
            { id: '2', name: 'Pintacaritas üé®üëßüë¶', price: 40, description: 'Transforma a los ni√±os en sus personajes favoritos con pinturas hipoalerg√©nicas. Servicio por 1 hora.', color: 'bg-blue-100 border-blue-300 text-blue-800' },
            { id: '3', name: 'Globoflexia üéàüí´', price: 40, description: 'Figuras divertidas y creativas hechas con globos para cada invitado. Servicio por 1 hora.', color: 'bg-green-100 border-green-300 text-green-800' },
            { id: '6', name: 'Show de Burbujas Gigantes ü´ß', price: 100, description: '¬°Burbujas enormes que los ni√±os pueden atrapar y explotar! Servicio por 1 hora. ¬°Un s√∫per show √∫nico en Panam√°!', color: 'bg-teal-100 border-teal-300 text-teal-800' },
            { 
                id: '7', 
                name: 'Decoraciones Tem√°ticas', 
                price: 100, // Precio actualizado a 100
                description: 'Transforma cualquier espacio en un mundo m√°gico con nuestras decoraciones personalizadas. ¬°Elige tu tem√°tica favorita!', 
                color: 'bg-fuchsia-100 border-fuchsia-300 text-fuchsia-800',
                type: 'theme_selection', // Nuevo tipo para manejar la selecci√≥n de tem√°tica
                themes: {
                    ninas: [
                        'Barbie', 'Sirenita', 'Cenicienta', 'Moana grande', 'Moana beb√©', 'Abejita',
                        'Luly Pampin', 'Stitch', 'Stitch y √Ångela', 'Capivara', 'Minnie roja',
                        'Plim Plim rosa', 'Sirenita otro modelo nuevo', 'Rosita fresita', 'Masha y el oso',
                        'Unicornio', 'Frozen', 'Monster In', 'Granja rosa', 'Skay', 'Princesas beb√©',
                        'Princesa grande', 'Bluey', 'Minnie beb√©', 'Mariposas', 'Beb√© Llorones',
                        'Minnie rosada', 'Gatita Marie', 'Pebells', 'Pollo Party', 'Abeja Maya',
                        'Bely y Beto', 'La Bella y la Bestia', 'Hello Kitty', 'Peppa', 'Harley Kuin',
                        'Merlina', 'Minnie Poll Party', 'Princesa Pich'
                    ],
                    ninos: [
                        'Real Madrid', 'Plaza S√©samo', 'Hot Wheels', 'Bebe Fin', 'Sonic', 'Bomberos',
                        'Legos', 'Dinosaurios', 'Dinosaurios animados', 'Plim Plim Safary',
                        'Inter de Miami', 'Batman', 'Granja', 'F√∫tbol', 'Mickey Safary', 'Chuchugua',
                        'Blippi', 'Minicraft', 'Plim Plim', 'Cars', 'Spiderman', 'Paw Patrol',
                        'Jefes en Pa√±ales', 'Bam Bam', 'Safary', 'La Granja de Zen√≥n', 'Mario Bros',
                        'Mickey Principe', 'Avengers', 'Cristiano', 'Coco Mel√≥n', 'Messi',
                        'Plim Plim piscina', 'Carritos', 'Aeroman', 'Constructor', 'Free Fires',
                        'Caballito', 'Rugrats', 'Barca'
                    ]
                }
            },
            { id: '8', name: 'M√°quinas de Snack Algod√≥n y Pop Corn üçøüç≠', price: 100, description: 'M√°quinas de algod√≥n de az√∫car y palomitas de ma√≠z para endulzar tu evento. Servicio por 3 horas.', color: 'bg-lime-100 border-lime-300 text-lime-800' },
            // Servicio de personajes tem√°ticos (precio actualizado a 65)
            {
                id: '9',
                name: 'Personajes Tem√°ticos',
                price: 65, // Precio base para un personaje, actualizado a $65
                description: '¬°Sorprende a todos con la visita de tu personaje favorito! Elige entre Mickey, Minnie y Mario Bros. Servicio por 1 hora.',
                color: 'bg-indigo-100 border-indigo-300 text-indigo-800',
                type: 'character_selection', // Tipo especial para manejar la selecci√≥n de personaje
                characters: [
                    { id: 'mickey', name: 'Mickey Mouse üê≠' },
                    { id: 'minnie', name: 'Minnie Mouse üéÄ' },
                    { id: 'mario', name: 'Mario Bros. üçÑ' }
                ]
            }
        ];

        const packagesData = [
            { id: 'P1', name: 'Plan B√°sico üöÄ', price: 75, services: [ // Renombrado
                'Payas@ o animad@r ü§°üé§',
                'Animaci√≥n infantil ü•≥üíÉ',
                'Juegos y concursos üé≤üèÜ',
                'Figuras con globos üéàüê∂',
                'Romper la pi√±ata üç¨üéâ'
            ], description: '1.5h de diversi√≥n: Animador, juegos, globos, pi√±ata. ¬°R√°pido y alegre!', color: 'bg-pink-100 border-pink-300 text-pink-800' },
            { id: 'P2', name: 'Plan Recreativo üåà', price: 100, services: [ // Renombrado
                'Payas@ o animad@r ü§°üé§',
                'Pintacaritas üé®üëßüë¶',
                'Animaci√≥n infantil ü•≥üíÉ',
                'Juegos y concursos üé≤üèÜ',
                'Figuras con globos üéàüê∂',
                'Romper la pi√±ata üç¨üéâ'
            ], description: '2h de aventura: Payaso/animador, pintacaritas, animaci√≥n, juegos, globos, pi√±ata. ¬°Inolvidable!', color: 'bg-indigo-100 border-indigo-300 text-indigo-800' },
            { id: 'P3', name: 'Plan Magic ‚ú®', price: 135, services: [ // Renombrado
                'Payasit@ o animad@r ü§°üé§',
                'Animaci√≥n, juegos y concursos ü•≥üé≤',
                'Pintacaritas üé®üëßüë¶',
                'Show de magia c√≥mica ‚ú®ü§£',
                'Asistencia para la pi√±ata üç¨üéâ'
            ], description: '2.5h premium: Payaso/animador, juegos, pintacaritas, magia c√≥mica, asistencia de pi√±ata. ¬°Tu fiesta perfecta!', color: 'bg-orange-100 border-orange-300 text-orange-800' },
            { // Nuevo paquete "Plan Diverty"
                id: 'P4', 
                name: 'Plan Diverty ü•≥', 
                price: 165, 
                services: [
                    'Payasito o Animador ü§°üé§',
                    'Juegos y concursos üé≤üèÜ',
                    'Pintacaritas üé®üëßüë¶',
                    'Globoflexia üéàüê∂',
                    'Show de Burbujas o Magia C√≥mica ü´ß‚ú®',
                    'Asistencia en la pi√±ata üç¨üéâ'
                ], 
                description: '3h de diversi√≥n completa: Payaso/animador, juegos, pintacaritas, globoflexia, show de burbujas o magia, y asistencia pi√±ata. ¬°La magia garantizada!', 
                color: 'bg-purple-100 border-purple-300 text-purple-800' 
            },
            { // Nuevo paquete "Plan Bubble"
                id: 'P5',
                name: 'Plan Bubble ü´ß', // Nombre actualizado a "Plan Bubble"
                price: 120, 
                services: [
                    'Animaci√≥n infantil ü•≥üíÉ',
                    'Juegos y concursos üé≤üèÜ',
                    'Payasito o Animador ü§°üé§',
                    'Show de Burbujas Gigantes ü´ß',
                    'Romper la pi√±ata üç¨üéâ' // Agregado "Romper la pi√±ata"
                ],
                description: '2h de diversi√≥n con burbujas gigantes y pi√±ata para una fiesta inolvidable!', // Descripci√≥n actualizada a 2 horas
                color: 'bg-blue-200 border-blue-400 text-blue-900'
            }
        ];

        // Recargos por transporte seg√∫n la ubicaci√≥n del evento.
        const transportFeesByLocation = {
            'Panam√° Centro': 0,
            'Arraij√°n': 10,
            'La Chorrera': 15,
            'Pacora': 10,
            'Panam√° Norte': 10,
        };

        // --- Funciones de Ayuda ---

        /**
         * Baraja un array de forma aleatoria (Fisher-Yates shuffle).
         * @param {Array} array - El array a barajar.
         * @returns {Array} El array barajado.
         */
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        /**
         * Inyecta el HTML de una secci√≥n en el √°rea de contenido principal.
         * @param {string} sectionHtml - El HTML de la secci√≥n a renderizar.
         */
        function renderSection(sectionHtml) {
            document.getElementById('mainContent').innerHTML = sectionHtml;
        }

        /**
         * Calcula el precio ajustado de un √≠tem, aplicando descuentos si corresponden.
         * @param {object} item - El objeto del √≠tem (servicio o paquete) con propiedades como name, price, quantity.
         * @returns {number} El precio ajustado del √≠tem por unidad.
         */
        function getAdjustedItemPrice(item) {
            let adjustedPrice = item.price;
            // L√≥gica de descuento para "Pintacaritas" si se a√±aden m√°s de 1.
            if (item.name === 'Pintacaritas üé®üëßüë¶' && item.quantity > 1) {
                adjustedPrice = 35; // Precio con descuento por unidad.
            } 
            // L√≥gica de descuento mensual para el "Plan Magic".
            else if (item.name === 'Plan Magic ‚ú®' && appState.promotedPackages.includes(item.name)) {
                adjustedPrice = item.price * 0.90; // 10% de descuento.
            }
            return adjustedPrice;
        }

        /**
         * Actualiza el resumen del carrito flotante con el n√∫mero de √≠tems y el precio total.
         * Aplica l√≥gicas de descuento si est√°n activas.
         */
        function updateCartSummary() {
            let currentTotalPrice = appState.selectedItems.reduce((sum, item) => {
                return sum + (getAdjustedItemPrice(item) * item.quantity);
            }, 0);

            // A√±adir recargo por transporte basado en la ubicaci√≥n seleccionada.
            currentTotalPrice += transportFeesByLocation[appState.selectedLocation] || 0;

            const cartSummaryDiv = document.getElementById('cartSummary');
            const selectedItemsCountSpan = document.getElementById('selectedItemsCount');
            const totalPriceDisplaySpan = document.getElementById('totalPriceDisplay');

            const totalItemsInCart = appState.selectedItems.reduce((total, item) => total + item.quantity, 0);

            if (totalItemsInCart > 0 || currentTotalPrice > 0) {
                cartSummaryDiv.classList.remove('hidden');
                selectedItemsCountSpan.textContent = totalItemsInCart;
                totalPriceDisplaySpan.textContent = `$${currentTotalPrice.toFixed(2)}`;
            } else {
                cartSummaryDiv.classList.add('hidden');
            }
        }

        /**
         * Maneja la adici√≥n/eliminaci√≥n/decremento de √≠tems en el carrito.
         * @param {object} item - El objeto del servicio/paquete a a√±adir/quitar. Debe contener { name, price }.
         * @param {string} actionType - 'add' para a√±adir/incrementar, 'remove_all' para quitar todas las unidades, 'toggle' para alternar (usado en no-repetibles).
         */
        function handleCartAction(item, actionType) {
            const existingItemIndex = appState.selectedItems.findIndex(selected => selected.name === item.name);

            if (actionType === 'add') {
                if (existingItemIndex > -1) {
                    appState.selectedItems[existingItemIndex].quantity++;
                } else {
                    // Si el √≠tem no existe, lo a√±ade con cantidad 1.
                    appState.selectedItems.push({ ...item, quantity: 1 });
                }
            } else if (actionType === 'remove_all') {
                // Filtra el √≠tem para eliminar todas sus unidades.
                appState.selectedItems = appState.selectedItems.filter(selected => selected.name !== item.name);
            } else if (actionType === 'toggle') { // Para servicios no repetibles (ej: paquetes).
                if (existingItemIndex > -1) {
                    // Si ya est√° seleccionado, lo quita.
                    appState.selectedItems = appState.selectedItems.filter(selected => selected.name !== item.name);
                } else {
                    // Si no est√° seleccionado, lo a√±ade con cantidad 1.
                    appState.selectedItems.push({ ...item, quantity: 1 });
                }
            }

            // Volver a renderizar la secci√≥n activa para actualizar los botones y precios.
            if (appState.activeSection === 'services') {
                renderServicesSection();
            } else if (appState.activeSection === 'packages') {
                renderPackagesSection();
            } else if (appState.activeSection === 'booking') {
                renderBookingSection();
            }
            updateCartSummary(); // Actualiza la barra flotante del carrito.
        }

        /**
         * Maneja la adici√≥n o el cambio de un personaje tem√°tico en el carrito.
         * Permite a√±adir m√∫ltiples personajes, incrementando la cantidad si ya est√° en el carrito.
         * @param {object} service - El objeto de servicio "Personajes Tem√°ticos" (base).
         * @param {object} character - El objeto del personaje seleccionado ({ id, name }).
         * @param {string} action - 'add' para a√±adir o 'remove_all' para eliminar.
         */
        function updateCharacterInCart(service, character, action) {
            const fullCharacterName = `${service.name}: ${character.name}`;
            const existingItemIndex = appState.selectedItems.findIndex(selected => selected.name === fullCharacterName);

            if (action === 'add') {
                if (existingItemIndex > -1) {
                    // Si el personaje ya existe, incrementa su cantidad
                    appState.selectedItems[existingItemIndex].quantity++;
                } else {
                    // A√±ade un nuevo personaje con el precio base del servicio
                    appState.selectedItems.push({
                        id: `${service.id}-${character.id}`,
                        name: fullCharacterName,
                        price: service.price, // Usa el precio base del servicio de personajes
                        quantity: 1
                    });
                }
            } else if (action === 'remove_all') {
                // Elimina todas las instancias de un personaje espec√≠fico del carrito
                appState.selectedItems = appState.selectedItems.filter(item => item.name !== fullCharacterName);
            }
            // Re-renderiza la secci√≥n de servicios y actualiza el resumen del carrito
            renderServicesSection();
            updateCartSummary();
        }

        /**
         * Maneja la adici√≥n o el cambio de una tem√°tica en el carrito.
         * Permite a√±adir m√∫ltiples tem√°ticas, incrementando la cantidad si ya est√° en el carrito.
         * @param {object} service - El objeto de servicio "Decoraciones Tem√°ticas" (base).
         * @param {string} themeName - El nombre de la tem√°tica seleccionada.
         * @param {string} action - 'add' para a√±adir o 'remove_all' para eliminar.
         */
        function updateThemeInCart(service, themeName, action) {
            const fullThemeName = `${service.name}: ${themeName}`;
            const existingItemIndex = appState.selectedItems.findIndex(selected => selected.name === fullThemeName);

            if (action === 'add') {
                if (existingItemIndex > -1) {
                    appState.selectedItems[existingItemIndex].quantity++;
                } else {
                    appState.selectedItems.push({
                        id: `${service.id}-${themeName.replace(/\s+/g, '-')}`, // Genera un ID simple
                        name: fullThemeName,
                        price: service.price, // Usa el precio base del servicio de decoraciones
                        quantity: 1
                    });
                }
            } else if (action === 'remove_all') {
                appState.selectedItems = appState.selectedItems.filter(item => item.name !== fullThemeName);
            }
            renderServicesSection();
            updateCartSummary();
        }


        // --- Funciones de Modales (Ventanas Emergentes) ---
        /**
         * Muestra un modal de informaci√≥n gen√©rico.
         * @param {string} message - El mensaje a mostrar en el modal.
         * @param {function} [callback] - Funci√≥n a ejecutar cuando se cierra el modal.
         */
        function showInfoModal(message, callback = null) {
            document.getElementById('modalMessage').textContent = message;
            const modal = document.getElementById('infoModal');
            const modalContent = document.getElementById('infoModalContent');
            modal.classList.remove('hidden');
            // Animar el modal para que aparezca suavemente
            setTimeout(() => {
                modalContent.classList.remove('scale-95', 'opacity-0');
                modalContent.classList.add('scale-100', 'opacity-100');
            }, 10); // Peque√±o retraso para permitir que la clase 'hidden' se remueva primero
            appState.infoModalCallback = callback; // Almacena el callback en el estado global.
        }

        /**
         * Oculta el modal de informaci√≥n gen√©rico y ejecuta el callback si existe.
         */
        function closeModal() {
            const modal = document.getElementById('infoModal');
            const modalContent = document.getElementById('infoModalContent');
            modalContent.classList.remove('scale-100', 'opacity-100');
            modalContent.classList.add('scale-95', 'opacity-0');
            // Esperar a que la animaci√≥n termine antes de ocultar completamente
            setTimeout(() => {
                modal.classList.add('hidden');
                document.getElementById('modalMessage').textContent = '';
                if (appState.infoModalCallback) {
                    appState.infoModalCallback(); // Ejecuta el callback.
                    appState.infoModalCallback = null; // Limpia el callback despu√©s de usarlo.
                }
            }, 300); // Duraci√≥n de la transici√≥n CSS
        }

        /**
         * Muestra el modal de promoci√≥n y activa el descuento mensual.
         * @param {string} message - El mensaje de la promoci√≥n.
         */
        function showPromoInfoModal(message) {
            document.getElementById('promoMessage').textContent = message;
            const modal = document.getElementById('promoModal');
            const modalContent = document.getElementById('promoModalContent');
            modal.classList.remove('hidden');
            setTimeout(() => {
                modalContent.classList.remove('scale-95', 'opacity-0');
                modalContent.classList.add('scale-100', 'opacity-100');
            }, 10);
            
            // Set specific packages for promotion
            appState.promotedPackages = ['Plan Magic ‚ú®']; // Solo el Plan Magic est√° en promoci√≥n

            updateCartSummary();
            // Re-renderiza las secciones si est√°n activas para mostrar el descuento.
            if (appState.activeSection === 'services') renderServicesSection();
            if (appState.activeSection === 'packages') renderPackagesSection();
            if (appState.activeSection === 'booking') renderBookingSection();
        }

        /**
         * Oculta el modal de promoci√≥n.
         */
        function closePromoModal() {
            const modal = document.getElementById('promoModal');
            const modalContent = document.getElementById('promoModalContent');
            modalContent.classList.remove('scale-100', 'opacity-100');
            modalContent.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                modal.classList.add('hidden');
                document.getElementById('promoMessage').textContent = '';
                // No se limpian los paquetes promocionados para que el descuento persista durante la sesi√≥n.
                updateCartSummary();
                if (appState.activeSection === 'packages') renderPackagesSection(); // Se refresca para asegurar la visualizaci√≥n del descuento.
            }, 300);
        }

        /**
         * Muestra el modal de advertencia de reserva.
         */
        function showBookingWarningModal() {
            const modal = document.getElementById('bookingWarningModal');
            const modalContent = document.getElementById('bookingWarningModalContent');
            modal.classList.remove('hidden');
            setTimeout(() => {
                modalContent.classList.remove('scale-95', 'opacity-0');
                modalContent.classList.add('scale-100', 'opacity-100');
            }, 10);
        }

        /**
         * Oculta el modal de advertencia de reserva.
         */
        function closeBookingWarningModal() {
            const modal = document.getElementById('bookingWarningModal');
            const modalContent = document.getElementById('bookingWarningModalContent');
            modalContent.classList.remove('scale-100', 'opacity-100');
            modalContent.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                modal.classList.add('hidden');
            }, 300);
        }

        // --- Funciones de Renderizado de Secciones ---

        /**
         * Renderiza la secci√≥n de Inicio.
         */
        function renderHomeSection() {
            const html = `
                <section class="bg-white rounded-3xl shadow-2xl p-4 sm:p-8 my-8 border-8 border-yellow-400 flex items-center justify-center min-h-[60vh] animate-fade-in">
                    <div class="bg-yellow-50 p-6 sm:p-10 rounded-2xl shadow-inner border-4 border-yellow-300 max-w-3xl mx-auto text-center">
                        
                        <h2 class="text-3xl sm:text-4xl lg:text-5xl font-extrabold text-purple-800 mb-4 leading-tight text-center">
                            ¬°La Magia Comienza Aqu√≠! ‚ú®
                        </h2>
                        <p class="text-base sm:text-lg lg:text-xl text-gray-700 mb-8 px-2">
                            Diverty Eventos: <strong>fiestas infantiles inolvidables en Panam√°</strong>. Animaci√≥n, shows de burbujas, pintacaritas, globoflexia. ¬°Hacemos tu fiesta so√±ada realidad!
                        </p>
                        <div class="flex flex-col sm:flex-row justify-center space-y-4 sm:space-y-0 sm:space-x-4 mt-8">
                            <button id="homeExploreServices" class="bg-pink-500 hover:bg-pink-600 text-white font-bold py-3 px-8 rounded-full shadow-lg text-base sm:text-lg transition duration-300 transform hover:scale-105">
                                ¬°Explora Nuestros Servicios! üéâ
                            </button>
                            <button id="homeExplorePackages" class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-3 px-8 rounded-full shadow-lg text-base sm:text-lg transition duration-300 transform hover:scale-105">
                                ¬°Explora Nuestros Paquetes! üì¶
                            </button>
                        </div>
                        <div class="flex flex-col sm:flex-row justify-center space-y-4 sm:space-y-0 sm:space-x-4 mt-8">
                            <button id="homePromoButton" class="bg-gradient-to-r from-yellow-400 to-orange-500 hover:from-yellow-500 hover:to-orange-600 text-white font-bold py-3 px-8 rounded-full shadow-lg text-base sm:text-lg transition duration-300 transform hover:scale-105">
                                üéâ Promoci√≥n del Mes üéâ
                            </button>
                        </div>
                    </div>
                </section>
            `;
            renderSection(html);

            // Asigna los event listeners a los botones de la secci√≥n de Inicio.
            document.getElementById('homeExploreServices').onclick = () => { setActiveSection('services'); };
            document.getElementById('homeExplorePackages').onclick = () => { setActiveSection('packages'); };
            document.getElementById('homePromoButton').onclick = () => {
                showPromoInfoModal('¬°Este mes, disfruta de un 10% de descuento EXCLUSIVO en nuestro Plan Magic! ‚ú®');
            };
        }

        /**
         * Renderiza la secci√≥n de Servicios Individuales.
         */
        function renderServicesSection() {
            // Servicios que pueden tener cantidades m√∫ltiples y, por lo tanto, botones de "A√±adir" y "Quitar Todo".
            const repeatableServices = ['Pintacaritas üé®üëßüë¶', 'Globoflexia üéàüí´', 'Show de Burbujas Gigantes ü´ß', 'M√°quinas de Snack Algod√≥n y Pop Corn üçøüç≠'];

            const cardsHtml = servicesData.map(service => {
                // L√≥gica espec√≠fica para el servicio de selecci√≥n de personaje
                if (service.type === 'character_selection') {
                    // Encuentra el personaje actualmente seleccionado en el carrito (si existe alguno de este tipo)
                    const selectedCharacterItems = appState.selectedItems.filter(item => item.name.startsWith(service.name + ':'));

                    const optionsHtml = service.characters.map(char => {
                        const fullCharName = `${service.name}: ${char.name}`;
                        const isCharacterAlreadyAdded = selectedCharacterItems.some(item => item.name === fullCharName);
                        // Deshabilita la opci√≥n en el select si ya est√° en el carrito
                        return `<option value="${char.id}" ${isCharacterAlreadyAdded ? 'disabled' : ''}>${char.name} ${isCharacterAlreadyAdded ? '(A√±adido)' : ''}</option>`;
                    }).join('');

                    return `
                        <div class="${service.color} rounded-2xl shadow-lg p-4 sm:p-6 flex flex-col justify-between border-4 border-dashed border-opacity-50 transition duration-300 hover:scale-[1.02] hover:shadow-xl">
                            <div>
                                <h2 class="text-xl sm:text-2xl font-bold mb-2 sm:mb-3 text-indigo-700">${service.name}</h2>
                                <p class="text-sm sm:text-base text-gray-700 mb-3 sm:mb-4">${service.description}</p>
                                <p class="text-3xl sm:text-4xl font-extrabold text-pink-600 mb-3 sm:mb-4">
                                    $${service.price.toFixed(2)}
                                </p>
                                <div class="mb-4">
                                    <label for="characterSelect-${service.id}" class="block text-gray-700 font-bold mb-2">Elige tu personaje: ‚ú®</label>
                                    <select id="characterSelect-${service.id}" class="w-full p-2 border-2 border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 text-sm sm:text-base">
                                        <option value="">Selecciona un personaje</option>
                                        ${optionsHtml}
                                    </select>
                                </div>
                            </div>
                            <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2 mt-auto">
                                <button
                                    data-service-id="${service.id}"
                                    data-action="add_character"
                                    class="character-action-button flex-grow bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded-full shadow-md text-sm transition duration-300 disabled:opacity-50 disabled:cursor-not-allowed"
                                    disabled
                                >
                                    A√±adir Seleccionado ‚ûï
                                </button>
                            </div>
                            <div id="selectedCharactersList-${service.id}" class="mt-4">
                                ${selectedCharacterItems.length > 0 ? `<p class="font-semibold text-gray-700 mb-2">Personajes en tu carrito:</p>` : ''}
                                ${selectedCharacterItems.map(item => `
                                    <div class="flex justify-between items-center bg-blue-50 p-2 rounded-lg mb-2 shadow-sm">
                                        <span>${item.name.replace(service.name + ': ', '')} (x${item.quantity})</span>
                                        <button class="remove-specific-character-button text-red-500 hover:text-red-700 font-bold ml-2 transition duration-200"
                                                data-full-name="${item.name}" aria-label="Quitar ${item.name}">üóëÔ∏è</button>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                } else if (service.type === 'theme_selection') {
                    const selectedThemeItems = appState.selectedItems.filter(item => item.name.startsWith(service.name + ':'));

                    let themeOptionsHtml = '<option value="">Selecciona una tem√°tica</option>';
                    themeOptionsHtml += '<optgroup label="Ni√±a">';
                    service.themes.ninas.forEach(theme => {
                        const fullThemeName = `${service.name}: ${theme}`;
                        const isThemeAlreadyAdded = selectedThemeItems.some(item => item.name === fullThemeName);
                        themeOptionsHtml += `<option value="${theme}" ${isThemeAlreadyAdded ? 'disabled' : ''}>${theme} ${isThemeAlreadyAdded ? '(A√±adida)' : ''}</option>`;
                    });
                    themeOptionsHtml += '</optgroup>';
                    themeOptionsHtml += '<optgroup label="Ni√±o">';
                    service.themes.ninos.forEach(theme => {
                        const fullThemeName = `${service.name}: ${theme}`;
                        const isThemeAlreadyAdded = selectedThemeItems.some(item => item.name === fullThemeName);
                        themeOptionsHtml += `<option value="${theme}" ${isThemeAlreadyAdded ? 'disabled' : ''}>${theme} ${isThemeAlreadyAdded ? '(A√±adida)' : ''}</option>`;
                    });
                    themeOptionsHtml += '</optgroup>';

                    return `
                        <div class="${service.color} rounded-2xl shadow-lg p-4 sm:p-6 flex flex-col justify-between border-4 border-dashed border-opacity-50 transition duration-300 hover:scale-[1.02] hover:shadow-xl">
                            <div>
                                <h2 class="text-xl sm:text-2xl font-bold mb-2 sm:mb-3 text-fuchsia-700">${service.name}</h2>
                                <p class="text-sm sm:text-base text-gray-700 mb-3 sm:mb-4">${service.description}</p>
                                <p class="text-3xl sm:text-4xl font-extrabold text-pink-600 mb-3 sm:mb-4">
                                    $${service.price.toFixed(2)}
                                </p>
                                <div class="mb-4">
                                    <label for="themeSelect-${service.id}" class="block text-gray-700 font-bold mb-2">Elige tu tem√°tica: üé®</label>
                                    <select id="themeSelect-${service.id}" class="w-full p-2 border-2 border-gray-300 rounded-lg focus:ring-fuchsia-500 focus:border-fuchsia-500 text-sm sm:text-base">
                                        ${themeOptionsHtml}
                                    </select>
                                </div>
                            </div>
                            <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2 mt-auto">
                                <button
                                    data-service-id="${service.id}"
                                    data-action="add_theme"
                                    class="theme-action-button flex-grow bg-fuchsia-500 hover:bg-fuchsia-600 text-white font-bold py-2 px-4 rounded-full shadow-md text-sm transition duration-300 disabled:opacity-50 disabled:cursor-not-allowed"
                                    disabled
                                >
                                    A√±adir Seleccionado ‚ûï
                                </button>
                            </div>
                            <div id="selectedThemesList-${service.id}" class="mt-4">
                                ${selectedThemeItems.length > 0 ? `<p class="font-semibold text-gray-700 mb-2">Tem√°ticas en tu carrito:</p>` : ''}
                                ${selectedThemeItems.map(item => `
                                    <div class="flex justify-between items-center bg-fuchsia-50 p-2 rounded-lg mb-2 shadow-sm">
                                        <span>${item.name.replace(service.name + ': ', '')} (x${item.quantity})</span>
                                        <button class="remove-specific-theme-button text-red-500 hover:text-red-700 font-bold ml-2 transition duration-200"
                                                data-full-name="${item.name}" aria-label="Quitar ${item.name}">üóëÔ∏è</button>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                } else {
                    const isRepeatableService = repeatableServices.includes(service.name);
                    const selectedItemInCart = appState.selectedItems.find(selected => selected.name === service.name);
                    const currentQuantity = selectedItemInCart ? selectedItemInCart.quantity : 0;
                    
                    let displayPriceForCard = getAdjustedItemPrice({ ...service, quantity: currentQuantity });
                    let originalPriceHtmlForCard = '';

                    // Si el precio ajustado es diferente al precio original, muestra el precio original tachado.
                    if (displayPriceForCard !== service.price) {
                        originalPriceHtmlForCard = `<span class="line-through text-gray-500 text-2xl">$${service.price.toFixed(2)}</span> `;
                    }

                    let buttonsHtml;
                    if (isRepeatableService) {
                        // Botones para servicios que se pueden a√±adir varias veces.
                        buttonsHtml = `
                            <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2 mt-auto">
                                <button
                                    data-item-name="${service.name}"
                                    data-item-price="${service.price}"
                                    data-action-type="add"
                                    class="add-remove-button flex-grow bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded-full shadow-md text-sm transition duration-300 transform hover:scale-105">
                                    A√±adir ‚ûï ${currentQuantity > 0 ? `(x${currentQuantity})` : ''}
                                </button>
                                ${currentQuantity > 0 ? `
                                <button
                                    data-item-name="${service.name}"
                                    data-item-price="${service.price}"
                                    data-action-type="remove_all"
                                    class="add-remove-button flex-grow bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-full shadow-md text-sm transition duration-300 transform hover:scale-105">
                                    Quitar Todo üóëÔ∏è
                                </button>
                                ` : ''}
                            </div>
                        `;
                    } else {
                        // Bot√≥n para servicios no repetibles (a√±adir/quitar).
                        const isSelected = selectedItemInCart ? true : false;
                        const buttonText = isSelected ? 'Quitar del Carrito ‚ûñ' : 'A√±adir al Carrito ‚ûï';
                        const buttonClassColor = isSelected ? 'bg-red-500 hover:bg-red-600' : 'bg-purple-500 hover:bg-purple-600';
                        buttonsHtml = `
                            <button
                                data-item-name="${service.name}"
                                data-item-price="${service.price}"
                                data-action-type="toggle"
                                class="add-remove-button mt-auto font-bold py-2 px-4 rounded-full shadow-md text-sm sm:text-base transition duration-300 ${buttonClassColor} text-white transform hover:scale-105">
                                ${buttonText}
                            </button>
                        `;
                    }

                    return `
                        <div class="${service.color} rounded-2xl shadow-lg p-4 sm:p-6 flex flex-col justify-between border-4 border-dashed border-opacity-50 transition duration-300 hover:scale-[1.02] hover:shadow-xl">
                            <div>
                                <h2 class="text-xl sm:text-2xl font-bold mb-2 sm:mb-3 text-purple-700">${service.name}</h2>
                                <p class="text-sm sm:text-base text-gray-700 mb-3 sm:mb-4">${service.description}</p>
                                <p class="text-3xl sm:text-4xl font-extrabold text-pink-600 mb-3 sm:mb-4">
                                    ${originalPriceHtmlForCard}$${displayPriceForCard.toFixed(2)}
                                </p>
                            </div>
                            ${buttonsHtml}
                        </div>
                    `;
                }
            }).join('');

            const html = `
                <section class="bg-white rounded-3xl shadow-2xl p-4 sm:p-8 my-8 border-8 border-green-400 animate-fade-in">
                    <h2 class="text-3xl sm:text-4xl font-extrabold text-purple-700 text-center mb-8 sm:mb-10">Nuestros Servicios üéâ</h2>
                    <p class="text-lg text-gray-700 text-center mb-8">
                        Servicios de animaci√≥n para fiestas infantiles en Panam√°. ¬°Hacemos tu evento m√°gico e inolvidable!
                    </p>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-8">
                        ${cardsHtml}
                    </div>
                </section>
            `;
            renderSection(html);

            // Asigna event listeners a todos los botones de a√±adir/quitar para servicios regulares.
            document.querySelectorAll('#mainContent .add-remove-button').forEach(button => {
                button.onclick = (event) => {
                    const itemName = event.target.dataset.itemName;
                    const itemPrice = parseFloat(event.target.dataset.itemPrice);
                    const actionType = event.target.dataset.actionType;
                    handleCartAction({ name: itemName, price: itemPrice }, actionType);
                };
            });

            // Asigna event listeners para el bot√≥n de a√±adir/cambiar personaje
            document.querySelectorAll('#mainContent .character-action-button').forEach(button => {
                button.onclick = (event) => {
                    const serviceId = event.target.dataset.serviceId;
                    const selectElement = document.getElementById(`characterSelect-${serviceId}`);
                    const selectedCharacterId = selectElement.value;

                    if (selectedCharacterId) {
                        const characterService = servicesData.find(s => s.id === serviceId);
                        const selectedChar = characterService.characters.find(c => c.id === selectedCharacterId);
                        if (selectedChar) {
                            updateCharacterInCart(characterService, selectedChar, 'add');
                            selectElement.value = ""; // Resetea el select despu√©s de a√±adir
                        }
                    } else {
                        showInfoModal('Por favor, selecciona un personaje antes de a√±adirlo.');
                    }
                };
            });

            // Asigna event listeners para los botones de quitar personaje espec√≠fico
            document.querySelectorAll('#mainContent .remove-specific-character-button').forEach(button => {
                button.onclick = (event) => {
                    const fullCharacterName = event.target.dataset.fullName;
                    // Encuentra el servicio base de personajes
                    const characterService = servicesData.find(s => s.type === 'character_selection');
                    // Extrae solo el nombre del personaje para buscarlo en la lista original
                    const charNameOnly = fullCharacterName.replace(characterService.name + ': ', '');
                    const characterToRemove = characterService.characters.find(c => c.name === charNameOnly);

                    if (characterService && characterToRemove) {
                        updateCharacterInCart(characterService, characterToRemove, 'remove_all');
                    }
                };
            });

            // L√≥gica para habilitar/deshabilitar el bot√≥n "A√±adir Seleccionado" y actualizar su texto (para personajes)
            document.querySelectorAll('#mainContent select[id^="characterSelect-"]').forEach(select => {
                select.onchange = (event) => {
                    const serviceId = event.target.id.split('-')[1];
                    const selectedCharacterId = event.target.value;
                    const addButton = document.querySelector(`.character-action-button[data-service-id="${serviceId}"]`);
                    
                    if (selectedCharacterId) {
                        const characterService = servicesData.find(s => s.id === serviceId);
                        const selectedChar = characterService.characters.find(c => c.id === selectedCharacterId);
                        const fullCharName = `${characterService.name}: ${selectedChar.name}`;
                        const existingInCart = appState.selectedItems.find(item => item.name === fullCharName);

                        if (existingInCart) {
                            addButton.textContent = `A√±adir uno m√°s de ${selectedChar.name} (x${existingInCart.quantity + 1})`;
                            addButton.disabled = false;
                        } else {
                            addButton.textContent = `A√±adir ${selectedChar.name} al Carrito ‚ûï`;
                            addButton.disabled = false;
                        }
                    } else {
                        addButton.textContent = `A√±adir Seleccionado ‚ûï`;
                        addButton.disabled = true;
                    }
                };
            });

            // Asigna event listeners para el bot√≥n de a√±adir tem√°tica
            document.querySelectorAll('#mainContent .theme-action-button').forEach(button => {
                button.onclick = (event) => {
                    const serviceId = event.target.dataset.serviceId;
                    const selectElement = document.getElementById(`themeSelect-${serviceId}`);
                    const selectedThemeName = selectElement.value;

                    if (selectedThemeName) {
                        const themeService = servicesData.find(s => s.id === serviceId);
                        updateThemeInCart(themeService, selectedThemeName, 'add');
                        selectElement.value = ""; // Resetea el select despu√©s de a√±adir
                    } else {
                        showInfoModal('Por favor, selecciona una tem√°tica antes de a√±adirla.');
                    }
                };
            });

            // Asigna event listeners para los botones de quitar tem√°tica espec√≠fica
            document.querySelectorAll('#mainContent .remove-specific-theme-button').forEach(button => {
                button.onclick = (event) => {
                    const fullThemeName = event.target.dataset.fullName;
                    const themeService = servicesData.find(s => s.type === 'theme_selection');
                    // Extrae solo el nombre de la tem√°tica
                    const themeNameOnly = fullThemeName.replace(themeService.name + ': ', '');
                    updateThemeInCart(themeService, themeNameOnly, 'remove_all');
                };
            });

            // L√≥gica para habilitar/deshabilitar el bot√≥n "A√±adir Seleccionado" y actualizar su texto (para tem√°ticas)
            document.querySelectorAll('#mainContent select[id^="themeSelect-"]').forEach(select => {
                select.onchange = (event) => {
                    const serviceId = event.target.id.split('-')[1];
                    const selectedThemeName = event.target.value;
                    const addButton = document.querySelector(`.theme-action-button[data-service-id="${serviceId}"]`);
                    
                    if (selectedThemeName) {
                        const themeService = servicesData.find(s => s.id === serviceId);
                        const fullThemeName = `${themeService.name}: ${selectedThemeName}`;
                        const existingInCart = appState.selectedItems.find(item => item.name === fullThemeName);

                        if (existingInCart) {
                            addButton.textContent = `A√±adir una m√°s de ${selectedThemeName} (x${existingInCart.quantity + 1})`;
                            addButton.disabled = false;
                        } else {
                            addButton.textContent = `A√±adir ${selectedThemeName} al Carrito ‚ûï`;
                            addButton.disabled = false;
                        }
                    } else {
                        addButton.textContent = `A√±adir Seleccionado ‚ûï`;
                        addButton.disabled = true;
                    }
                };
            });
        }

        /**
         * Renderiza la secci√≥n de Paquetes.
         */
        function renderPackagesSection() {
            const cardsHtml = packagesData.map(pkg => {
                const selectedItemInCart = appState.selectedItems.find(item => item.name === pkg.name);
                const isSelected = selectedItemInCart ? true : false;

                let buttonText;
                let buttonClassColor;

                if (isSelected) {
                    buttonText = 'Quitar del Carrito ‚ûñ';
                    buttonClassColor = 'bg-red-500 hover:bg-red-600';
                } else {
                    buttonText = 'A√±adir al Carrito ‚ûï';
                    buttonClassColor = 'bg-indigo-500 hover:bg-indigo-600';
                }

                let displayPrice = getAdjustedItemPrice({ ...pkg, quantity: 1 }); // Paquetes siempre tienen cantidad 1 para c√°lculo de precio en tarjeta.
                let originalPriceHtml = '';
                
                // Si el precio ajustado es diferente al precio original, muestra el precio original tachado.
                if (displayPrice !== pkg.price) {
                    originalPriceHtml = `<span class="line-through text-gray-500 text-2xl">$${pkg.price.toFixed(2)}</span> `;
                }

                return `
                    <div class="${pkg.color} rounded-2xl shadow-lg p-4 sm:p-6 flex flex-col justify-between border-4 border-dashed border-opacity-50 transition duration-300 hover:scale-[1.02] hover:shadow-xl">
                        <div>
                            <h2 class="text-xl sm:text-2xl font-bold mb-2 sm:mb-3 text-indigo-700">${pkg.name}</h2>
                            <p class="text-sm sm:text-base text-gray-700 mb-3 sm:mb-4">${pkg.description}</p>
                            <ul class="list-disc list-inside text-gray-600 mb-3 sm:mb-4 text-sm sm:text-base">
                                ${pkg.services.map(service => `<li>${service}</li>`).join('')}
                            </ul>
                            <p class="text-3xl sm:text-4xl font-extrabold text-purple-600 mb-3 sm:mb-4">
                                ${originalPriceHtml}$${displayPrice.toFixed(2)}
                            </p>
                        </div>
                        <button
                            data-item-name="${pkg.name}"
                            data-item-price="${pkg.price}"
                            data-action-type="toggle"
                            class="add-remove-button mt-auto font-bold py-2 px-4 rounded-full shadow-md text-sm sm:text-base transition duration-300 ${buttonClassColor} text-white transform hover:scale-105">
                            ${buttonText}
                        </button>
                    </div>
                `;
            }).join('');

            const html = `
                <section class="bg-white rounded-3xl shadow-2xl p-4 sm:p-8 my-8 border-8 border-pink-400 animate-fade-in">
                    <h2 class="text-3xl sm:text-4xl font-extrabold text-purple-700 text-center mb-8 sm:mb-10">Nuestros Paquetes üì¶</h2>
                    <p class="text-lg text-gray-700 text-center mb-8">
                        Descubre nuestros paquetes de <strong>animaci√≥n para fiestas infantiles en Panam√°</strong>. ¬°La opci√≥n perfecta para tu evento!
                    </p>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-8">
                        ${cardsHtml}
                    </div>
                </section>
            `;
            renderSection(html);

            // Asigna event listeners a todos los botones de a√±adir/quitar en la secci√≥n de paquetes.
            document.querySelectorAll('#mainContent .add-remove-button').forEach(button => {
                button.onclick = (event) => {
                    const itemName = event.target.dataset.itemName;
                    const itemPrice = parseFloat(event.target.dataset.itemPrice);
                    const actionType = event.target.dataset.actionType;
                    handleCartAction({ name: itemName, price: itemPrice }, actionType);
                };
            });
        }

        /**
         * Renderiza la secci√≥n de Reservas, mostrando los √≠tems seleccionados y el formulario.
         * Calcula y muestra el precio total, incluyendo descuentos y recargos por transporte.
         */
        function renderBookingSection() {
            // Genera la lista de √≠tems seleccionados para mostrar en la secci√≥n de reserva.
            const selectedItemsListHtml = appState.selectedItems.length === 0
                ? `<p class="text-red-600 text-sm sm:text-base">No has seleccionado ning√∫n servicio. Por favor, vuelve a la secci√≥n de Servicios o Paquetes.</p>`
                : `<ul class="list-disc list-inside text-gray-800 text-sm sm:text-base bg-blue-50 p-3 rounded-md border border-blue-200">
                    ${appState.selectedItems.map((item) => {
                        const originalPrice = item.price;
                        const displayItemPrice = getAdjustedItemPrice(item);
                        
                        return `
                            <li>
                                ${item.name} ${item.quantity > 1 ? `(x${item.quantity})` : ''} -
                                ${displayItemPrice !== originalPrice ? `
                                    <span class="line-through text-gray-500">$${originalPrice.toFixed(2)}</span>{' '}
                                    <span class="text-green-700 font-semibold">$${displayItemPrice.toFixed(2)}</span>
                                ` : `$${displayItemPrice.toFixed(2)}`}
                            </li>
                        `;
                    }).join('')}
                </ul>`;

            // Calcula y muestra el recargo por transporte.
            const currentTransportFee = transportFeesByLocation[appState.selectedLocation] || 0;
            const transportFeeDisplayHtml = currentTransportFee > 0
                ? `<p class="text-lg font-bold text-gray-700 mt-2">Recargo por Transporte (${appState.selectedLocation}): <span class="text-orange-600">$${currentTransportFee.toFixed(2)}</span></p>`
                : `<p class="text-lg font-bold text-gray-700 mt-2">Recargo por Transporte: <span class="text-green-600">¬°Gratis en Panam√° Centro!</span></p>`;

            // Calcula el precio total final incluyendo descuentos y recargos.
            const totalItemsPrice = appState.selectedItems.reduce((sum, item) => {
                return sum + (getAdjustedItemPrice(item) * item.quantity);
            }, 0);
            const finalTotalPrice = totalItemsPrice + currentTransportFee;

            const html = `
                <section class="bg-white rounded-3xl shadow-2xl p-4 sm:p-8 my-8 border-8 border-blue-400 animate-fade-in">
                    <h2 class="text-3xl sm:text-4xl font-extrabold text-purple-700 text-center mb-8 sm:mb-10">Reserva tu Evento üóìÔ∏è</h2>
                    <p class="text-lg text-gray-700 text-center mb-8">
                        ¬°Reserva tu <strong>fiesta infantil en Panam√°</strong>! Completa este formulario para asegurar la magia de tu evento.
                    </p>
                    <div class="grid grid-cols-1 lg:grid-cols-1 gap-4 sm:gap-12">
                        <h3 class="text-xl sm:text-2xl font-bold text-blue-700 mb-4 sm:mb-6">Completa los Detalles de Tu Reserva üìù</h3>
                        <div class="bg-blue-100 p-4 sm:p-8 rounded-2xl shadow-lg border-4 border-blue-300">
                            <form id="bookingForm" class="space-y-4">
                                <div>
                                    <label for="selectedItemsDisplay" class="block text-gray-700 font-bold mb-1 sm:mb-2 text-sm sm:text-base">Servicios/Paquetes Seleccionados:üéÅ</label>
                                    ${selectedItemsListHtml}
                                    ${transportFeeDisplayHtml}
                                    <p class="text-lg font-bold text-purple-700 mt-3">Total a Pagar: <span class="text-pink-600">$${finalTotalPrice.toFixed(2)}</span></p>
                                </div>
                                
                                <div>
                                    <label for="locationSelect" class="block text-gray-700 font-bold mb-1 sm:mb-2 text-sm sm:text-base">Ubicaci√≥n del Evento (Provincia/Zona):üìç</label>
                                    <select
                                        id="locationSelect"
                                        name="ubicacionEvento"
                                        class="w-full p-2 sm:p-3 border-2 border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-sm sm:text-base"
                                    >
                                        <option value="Panam√° Centro" ${appState.bookingFormData.selectedLocation === 'Panam√° Centro' ? 'selected' : ''}>Panam√° Centro</option>
                                        <option value="Arraij√°n" ${appState.bookingFormData.selectedLocation === 'Arraij√°n' ? 'selected' : ''}>Arraij√°n ($10 adicional)</option>
                                        <option value="La Chorrera" ${appState.bookingFormData.selectedLocation === 'La Chorrera' ? 'selected' : ''}>La Chorrera ($15 adicional)</option>
                                        <option value="Pacora" ${appState.bookingFormData.selectedLocation === 'Pacora' ? 'selected' : ''}>Pacora ($10 adicional)</option>
                                        <option value="Panam√° Norte" ${appState.bookingFormData.selectedLocation === 'Panam√° Norte' ? 'selected' : ''}>Panam√° Norte ($10 adicional)</option>
                                    </select>
                                </div>

                                <div>
                                    <label for="exactLocation" class="block text-gray-700 font-bold mb-1 sm:mb-2 text-sm sm:text-base">Direcci√≥n Exacta del Evento: üó∫Ô∏è</label>
                                    <input
                                        type="text"
                                        id="exactLocation"
                                        name="direccionExacta"
                                        class="w-full p-2 sm:p-3 border-2 border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-sm sm:text-base"
                                        placeholder="Ej: Calle Principal, Casa #15, Cerca de la escuela..."
                                        value="${appState.bookingFormData.exactLocation || ''}"
                                        required
                                    />
                                    <span id="error-exactLocation" class="error-message hidden">Este campo es obligatorio.</span>
                                </div>

                                <div>
                                    <label for="bookingDate" class="block text-gray-700 font-bold mb-1 sm:mb-2 text-sm sm:text-base">Fecha del Evento: üìÜ</label>
                                    <input
                                        type="date"
                                        id="bookingDate"
                                        name="fechaEvento"
                                        class="w-full p-2 sm:p-3 border-2 border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-sm sm:text-base"
                                        min="${new Date().toISOString().split('T')[0]}"
                                        value="${appState.bookingFormData.bookingDate || ''}"
                                        required
                                    />
                                    <span id="error-bookingDate" class="error-message hidden">Este campo es obligatorio.</span>
                                </div>
                                <div>
                                    <label for="bookingTime" class="block text-gray-700 font-bold mb-1 sm:mb-2 text-sm sm:text-base">Hora del Evento: ‚è∞</label>
                                    <input
                                        type="time"
                                        id="bookingTime"
                                        name="horaEvento"
                                        class="w-full p-2 sm:p-3 border-2 border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-sm sm:text-base"
                                        value="${appState.bookingFormData.bookingTime || ''}"
                                        required
                                    />
                                    <span id="error-bookingTime" class="error-message hidden">Este campo es obligatorio.</span>
                                </div>
                                <div>
                                    <label for="customerName" class="block text-gray-700 font-bold mb-1 sm:mb-2 text-sm sm:text-base">Tu Nombre: üë§</label>
                                    <input
                                        type="text"
                                        id="customerName"
                                        name="nombreCliente"
                                        class="w-full p-2 sm:p-3 border-2 border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-sm sm:text-base"
                                        placeholder="Ej: Juan P√©rez"
                                        value="${appState.bookingFormData.customerName || ''}"
                                        required
                                    />
                                    <span id="error-customerName" class="error-message hidden">Este campo es obligatorio.</span>
                                </div>
                                <div>
                                    <label for="customerEmail" class="block text-gray-700 font-bold mb-1 sm:mb-2 text-sm sm:text-base">Tu Email: üìß</label>
                                    <input
                                        type="email"
                                        id="customerEmail"
                                        name="emailCliente"
                                        class="w-full p-2 sm:p-3 border-2 border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-sm sm:text-base"
                                        placeholder="Ej: tu.email@example.com"
                                        value="${appState.bookingFormData.customerEmail || ''}"
                                        required
                                    />
                                    <span id="error-customerEmail" class="error-message hidden">Este campo es obligatorio.</span>
                                </div>
                                <div>
                                    <label for="customerPhone" class="block text-gray-700 font-bold mb-1 sm:mb-2 text-sm sm:text-base">Tu Tel√©fono:üìû</label>
                                    <input
                                        type="tel"
                                        id="customerPhone"
                                        name="telefonoCliente"
                                        class="w-full p-2 sm:p-3 border-2 border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-sm sm:text-base"
                                        placeholder="Ej: 555-1234567"
                                        value="${appState.bookingFormData.customerPhone || ''}"
                                        required
                                    />
                                    <span id="error-customerPhone" class="error-message hidden">Este campo es obligatorio.</span>
                                </div>
                                <div>
                                    <label for="eventType" class="block text-gray-700 font-bold mb-1 sm:mb-2 text-sm sm:text-base">Tipo de Evento: üéâ</label>
                                    <input
                                        type="text"
                                        id="eventType"
                                        name="tipoEvento"
                                        class="w-full p-2 sm:p-3 border-2 border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-sm sm:text-base"
                                        placeholder="Ej: Cumplea√±os, Graduaci√≥n"
                                        value="${appState.bookingFormData.eventType || ''}"
                                        required
                                    />
                                    <span id="error-eventType" class="error-message hidden">Este campo es obligatorio.</span>
                                </div>
                                <div>
                                    <label for="numKids" class="block text-gray-700 font-bold mb-1 sm:mb-2 text-sm sm:text-base">N√∫mero Estimado de Ni√±os: üëßüë¶</label>
                                    <input
                                        type="number"
                                        id="numKids"
                                        name="numeroNinos"
                                        class="w-full p-2 sm:p-3 border-2 border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-sm sm:text-base"
                                        placeholder="Ej: 20"
                                        min="1"
                                        value="${appState.bookingFormData.numKids || ''}"
                                        required
                                    />
                                    <span id="error-numKids" class="error-message hidden">Este campo es obligatorio.</span>
                                </div>
                                <button type="submit" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 sm:py-3 px-4 sm:px-6 rounded-full shadow-lg text-base sm:text-lg mt-4 transition duration-300 transform hover:scale-105">
                                    ¬°Confirmar Reserva M√°gica! ‚ú®
                                </button>
                            </form>
                        </div>
                    </div>
                </section>
            `;
            renderSection(html);

            const bookingForm = document.getElementById('bookingForm');
            if (bookingForm) {
                bookingForm.onsubmit = handleBookingSubmit;
                // Manejador de cambio para la selecci√≥n de ubicaci√≥n, actualiza el estado y el resumen del carrito.
                document.getElementById('locationSelect').onchange = (e) => {
                    appState.bookingFormData.selectedLocation = e.target.value; // Actualiza el estado al cambiar ubicaci√≥n.
                    appState.selectedLocation = e.target.value; // Tambi√©n actualiza el estado general de la ubicaci√≥n.
                    updateCartSummary(); 
                    renderBookingSection(); // Re-renderiza la secci√≥n para mostrar el recargo actualizado.
                };
            }
        }

        // --- Funciones para guardar y cargar los datos del formulario de reserva ---
        /**
         * Guarda los datos actuales del formulario de reserva en appState y localStorage.
         */
        function saveBookingFormData() {
            const bookingForm = document.getElementById('bookingForm');
            if (bookingForm) {
                appState.bookingFormData.bookingDate = bookingForm.elements.bookingDate.value;
                appState.bookingFormData.bookingTime = bookingForm.elements.bookingTime.value;
                appState.bookingFormData.customerName = bookingForm.elements.customerName.value;
                appState.bookingFormData.customerEmail = bookingForm.elements.customerEmail.value;
                appState.bookingFormData.customerPhone = bookingForm.elements.customerPhone.value;
                appState.bookingFormData.eventType = bookingForm.elements.eventType.value;
                appState.bookingFormData.numKids = bookingForm.elements.numKids.value;
                appState.bookingFormData.exactLocation = bookingForm.elements.exactLocation.value;
                appState.bookingFormData.selectedLocation = bookingForm.elements.locationSelect.value;
                
                // Guardar tambi√©n los √≠tems seleccionados del carrito.
                localStorage.setItem('selectedItems', JSON.stringify(appState.selectedItems));
                localStorage.setItem('bookingFormData', JSON.stringify(appState.bookingFormData));
                console.log('Datos del formulario guardados:', appState.bookingFormData); // Para depuraci√≥n.
            }
        }

        /**
         * Carga los datos del formulario de reserva desde localStorage a appState.
         */
        function loadBookingFormData() {
            try {
                const savedFormData = localStorage.getItem('bookingFormData');
                if (savedFormData) {
                    appState.bookingFormData = JSON.parse(savedFormData);
                    // Aseg√∫rate de que selectedLocation tambi√©n se actualice en el estado general si se cargan datos.
                    appState.selectedLocation = appState.bookingFormData.selectedLocation;
                    console.log('Datos del formulario cargados:', appState.bookingFormData); // Para depuraci√≥n.
                }
                const savedSelectedItems = localStorage.getItem('selectedItems');
                if (savedSelectedItems) {
                    appState.selectedItems = JSON.parse(savedSelectedItems);
                    console.log('√çtems del carrito cargados:', appState.selectedItems); // Para depuraci√≥n.
                }
            } catch (e) {
                console.error("Error al cargar datos de localStorage:", e);
                // Limpiar localStorage si hay un error de parseo para evitar bucles
                localStorage.removeItem('bookingFormData');
                localStorage.removeItem('selectedItems');
            }
        }


        // --- L√≥gica Principal de la Aplicaci√≥n ---

        /**
         * Establece la secci√≥n activa y actualiza la navegaci√≥n, enviando un page_view a Google Analytics.
         * @param {string} sectionName - El nombre de la secci√≥n a activar ('home', 'services', 'packages', 'booking').
         */
        function setActiveSection(sectionName) {
            // Si la secci√≥n actual es 'booking' y vamos a otra secci√≥n, guarda los datos.
            if (appState.activeSection === 'booking') {
                saveBookingFormData();
            }

            appState.activeSection = sectionName;
            // Actualiza los estilos de los botones de navegaci√≥n para indicar la secci√≥n activa.
            document.querySelectorAll('header nav button').forEach(button => {
                const buttonId = button.id;
                if ((buttonId === 'navHome' && sectionName === 'home') ||
                    (buttonId === 'navServices' && sectionName === 'services') ||
                    (buttonId === 'navPackages' && sectionName === 'packages') ||
                    (buttonId === 'navBooking' && sectionName === 'booking')) {
                    button.classList.add('bg-purple-500', 'text-white', 'shadow-md');
                    button.classList.remove('text-gray-700', 'hover:bg-purple-100');
                } else {
                    button.classList.remove('bg-purple-500', 'text-white', 'shadow-md');
                    button.classList.add('text-gray-700', 'hover:bg-purple-100');
                }
            });

            let pagePath = '/'; // Ruta por defecto para la p√°gina de inicio.
            let pageTitle = 'Diverty Eventos'; // T√≠tulo por defecto (modificado).

            // Determina la ruta y el t√≠tulo de la p√°gina virtual para Google Analytics.
            switch (sectionName) {
                case 'home':
                    pagePath = '/inicio';
                    pageTitle = 'Diverty Eventos | Inicio'; 
                    break;
                case 'services':
                    pagePath = '/servicios';
                    pageTitle = 'Diverty Eventos | Servicios'; 
                    break;
                case 'packages':
                    pagePath = '/paquetes';
                    pageTitle = 'Diverty Eventos | Paquetes'; 
                    break;
                case 'booking':
                    pagePath = '/reservar';
                    pageTitle = 'Diverty Eventos | Reservar'; 
                    // Muestra el modal de advertencia de reserva solo si no se ha mostrado antes.
                    if (!appState.hasShownBookingWarning) {
                        showBookingWarningModal();
                        appState.hasShownBookingWarning = true;
                    }
                    break;
            }

            // Env√≠a el evento de vista de p√°gina virtual a Google Analytics.
            if (typeof gtag === 'function') {
                gtag('event', 'page_view', {
                    page_path: pagePath,
                    page_title: pageTitle
                });
            } else {
                console.warn('gtag is not defined. Google Analytics might not be loaded.');
            }

            // Renderiza la secci√≥n correspondiente.
            switch (sectionName) {
                case 'home':
                    renderHomeSection();
                    break;
                case 'services':
                    renderServicesSection();
                    break;
                case 'packages':
                    renderPackagesSection();
                    break;
                case 'booking':
                    renderBookingSection();
                    break;
                default:
                    renderHomeSection(); // Fallback por defecto.
            }
            updateCartSummary(); // Siempre actualiza el resumen del carrito al cambiar de secci√≥n.
        }

        // --- Evento para la advertencia al intentar salir de la p√°gina ---
        // Este mensaje suele ser gen√©rico en navegadores modernos por motivos de seguridad.
        window.onbeforeunload = function() {
            // No se devuelve un string para evitar el mensaje de confirmaci√≥n intrusivo en navegadores modernos.
            // Si quieres guardar el estado antes de salir, hazlo aqu√≠ sin devolver nada.
        };

        /**
         * Limpia los mensajes de error y los estilos de los campos del formulario.
         */
        function clearFormErrors() {
            const errorMessages = document.querySelectorAll('.error-message');
            errorMessages.forEach(span => {
                span.classList.add('hidden');
                span.textContent = ''; // Limpiar el texto del error
            });
            const errorInputs = document.querySelectorAll('.input-error');
            errorInputs.forEach(input => {
                input.classList.remove('input-error');
            });
        }

        /**
         * Muestra un mensaje de error para un campo espec√≠fico.
         * @param {string} fieldId - El ID del campo que tiene el error.
         * @param {string} message - El mensaje de error a mostrar.
         */
        function showFieldError(fieldId, message) {
            const errorSpan = document.getElementById(`error-${fieldId}`);
            const inputElement = document.getElementById(fieldId);
            if (errorSpan && inputElement) {
                errorSpan.textContent = message;
                errorSpan.classList.remove('hidden');
                inputElement.classList.add('input-error');
            }
        }


        // --- Env√≠o del Formulario a JotForm ---
        /**
         * Maneja el env√≠o del formulario de reserva.
         * Realiza validaciones b√°sicas y luego redirige a JotForm con los datos precargados.
         * @param {Event} event - El evento de env√≠o del formulario.
         */
        async function handleBookingSubmit(event) {
            event.preventDefault(); // Evita el env√≠o por defecto del formulario.

            clearFormErrors(); // Limpia cualquier error anterior.

            // *** Validaciones se realizan primero ***
            if (appState.selectedItems.length === 0) {
                showInfoModal('¬°Por favor, a√±ade al menos un servicio o paquete a tu reserva! üõí');
                return;
            }
            const requiredFields = [
                'bookingDate', 'bookingTime', 'customerName', 'customerEmail',
                'customerPhone', 'eventType', 'numKids', 'exactLocation'
            ];
            let formIsValid = true;
            for (const fieldId of requiredFields) {
                const inputElement = document.getElementById(fieldId);
                // Trim para eliminar espacios en blanco y asegurar que no sea solo espacios
                if (!inputElement.value.trim()) {
                    showFieldError(fieldId, 'Este campo es obligatorio.');
                    formIsValid = false;
                }
            }

            // Validaci√≥n espec√≠fica para el formato de email
            const emailInput = document.getElementById('customerEmail');
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (emailInput && !emailRegex.test(emailInput.value.trim())) {
                showFieldError('customerEmail', 'Por favor, introduce un email v√°lido.');
                formIsValid = false;
            }

            if (!formIsValid) {
                showInfoModal('¬°Oops! Por favor, completa todos los campos requeridos correctamente para realizar la reserva. üìù');
                return;
            }

            // Si todas las validaciones pasan, se guarda el formulario y se muestra el modal.
            saveBookingFormData(); // Guarda los datos antes de la redirecci√≥n.
            showInfoModal('¬°Redirigiendo a JotForm para finalizar tu reserva! üéâ Haz clic en "¬°Entendido!" para continuar.', () => {
                // Esto es lo que se ejecutar√° cuando el usuario haga clic en "¬°Entendido!" en el modal.

                // --- Recopilaci√≥n de Datos para JotForm (se re-obtiene para asegurar los √∫ltimos valores) ---
                const bookingDate = document.getElementById('bookingDate').value; 
                const bookingTime = document.getElementById('bookingTime').value; 

                const [year, month, day] = bookingDate.split('-'); 

                const customerName = document.getElementById('customerName').value;
                const customerEmail = document.getElementById('customerEmail').value;
                const customerPhone = document.getElementById('customerPhone').value;
                const eventType = document.getElementById('eventType').value;
                const numKids = document.getElementById('numKids').value;
                const exactLocation = document.getElementById('exactLocation').value;
                const selectedLocationName = appState.selectedLocation;
                const currentTransportFee = transportFeesByLocation[selectedLocationName] || 0;

                const selectedItemsString = appState.selectedItems.map(item => {
                    const itemPriceForJotForm = getAdjustedItemPrice(item);
                    return `${item.name} ${item.quantity > 1 ? `(x${item.quantity})` : ''} ($${itemPriceForJotForm.toFixed(2)})`; 
                }).join(', ');
                
                const totalItemsPrice = appState.selectedItems.reduce((sum, item) => {
                    return sum + (getAdjustedItemPrice(item) * item.quantity);
                }, 0);
                const finalTotalPrice = totalItemsPrice + currentTransportFee;

                // --- Construcci√≥n de la URL de JotForm con Par√°metros ---
                // Los par√°metros se codifican en la URL para precargar el formulario de JotForm.
                const jotformBaseUrl = 'https://form.jotform.com/251611549526054'; 
                const params = new URLSearchParams();

                params.append('fechaDelEvento[year]', year);   
                params.append('fechaDelEvento[month]', month); 
                params.append('fechaDelEvento[day]', day);     
                
                params.append('horaDelEvento', bookingTime); 
                params.append('nombreDelCliente', customerName);
                params.append('emailDelCliente', customerEmail);
                params.append('telefonoDelCliente', customerPhone);
                params.append('tipoDeEvento', eventType);
                params.append('numeroEstimadoDeNinos', numKids);
                params.append('ubicacionSeleccionada', selectedLocationName);
                params.append('recargoPorTransporte', `$${currentTransportFee.toFixed(2)}`);
                params.append('direccionExactaDelEvento', exactLocation);
                params.append('serviciosPaquetesSeleccionados', selectedItemsString);
                params.append('precioTotalEstimado', `$${finalTotalPrice.toFixed(2)}`);
                params.append('idDeSesionVisitante', appState.userId);

                const jotformUrl = `${jotformBaseUrl}?${params.toString()}`;

                // Abrir en una nueva pesta√±a cuando el usuario haga clic en "¬°Entendido!".
                // Se incluye un fallback para redirecci√≥n en la misma pesta√±a si la nueva ventana es bloqueada.
                const newWindow = window.open(jotformUrl, '_blank');
                if (newWindow) {
                    newWindow.focus(); 
                } else {
                    console.warn('La nueva ventana no pudo abrirse (bloqueador de pop-ups). Intentando redirecci√≥n en la misma pesta√±a como fallback.');
                    window.location.href = jotformUrl; 
                }
            });
        }

        // --- Inicializaci√≥n de la Aplicaci√≥n ---
        // Se ejecuta cuando el DOM est√° completamente cargado.
        document.addEventListener('DOMContentLoaded', () => {
            try {
                // Ocultar el mensaje de carga si JavaScript se est√° ejecutando
                const loadingMessage = document.getElementById('loadingMessage');
                if (loadingMessage) {
                    loadingMessage.remove(); // Eliminar el mensaje de carga
                }

                // Carga los datos del formulario y del carrito al iniciar la p√°gina.
                loadBookingFormData(); 

                // Asigna event listeners para los botones de cerrar los modales.
                document.getElementById('closeModalButton').onclick = closeModal;
                document.getElementById('closePromoModalButton').onclick = closePromoModal;
                document.getElementById('closeBookingWarningModalButton').onclick = closeBookingWarningModal;

                // Asigna event listeners para los botones de navegaci√≥n principal.
                document.getElementById('navHome').onclick = () => setActiveSection('home');
                document.getElementById('navServices').onclick = () => setActiveSection('services');
                document.getElementById('navPackages').onclick = () => setActiveSection('packages');
                document.getElementById('navBooking').onclick = () => setActiveSection('booking');
                document.getElementById('proceedToBookButton').onclick = () => setActiveSection('booking');

                // Establece la secci√≥n de inicio por defecto al cargar la p√°gina.
                setActiveSection('home');
                updateCartSummary(); // Asegura que el resumen del carrito se muestre correctamente al inicio.
            } catch (error) {
                // Si ocurre un error cr√≠tico durante la inicializaci√≥n de JS
                console.error("Error cr√≠tico al inicializar la aplicaci√≥n:", error);
                // Mostrar un mensaje de error visible al usuario si la p√°gina est√° en blanco
                const mainContent = document.getElementById('mainContent');
                if (mainContent) {
                    mainContent.innerHTML = `
                        <div class="text-center text-red-600 bg-red-100 p-4 rounded-lg shadow-md mt-8">
                            <p class="font-bold text-xl">¬°Lo sentimos, ha ocurrido un error!</p>
                            <p>No pudimos cargar el contenido de la p√°gina. Por favor, intenta de nuevo o contacta al soporte.</p>
                            <p class="text-sm mt-2">Detalles t√©cnicos: ${error.message}</p>
                        </div>
                    `;
                }
            }
        });
    </script>
</body>
</html>

