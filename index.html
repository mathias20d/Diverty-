<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Título optimizado para SEO: Incluye palabras clave principales y ubicación para mejorar la visibilidad en buscadores. -->
    <title>Diverty Eventos</title>
    <!-- Descripción meta optimizada para SEO: Proporciona un resumen conciso y atractivo del contenido, con palabras clave relevantes y una llamada de acción. -->
    <meta name="description" content="Organizamos las mejores fiestas infantiles en Panamá Centro, Arraiján, La Chorrera, Pacora y Panamá Norte. Expertos en animación, shows de burbujas, pintacaritas, globoflexia y paquetes de diversión. ¡Haz que la fiesta de tus hijos sea inolvidable con Diverty Eventos en todo Panamá!">
    
    <!-- Open Graph Tags para compartir en redes sociales y apps de mensajería (Facebook, WhatsApp, etc.). -->
    <meta property="og:title" content="Diverty Eventos | Fiestas Infantiles en Panamá">
    <meta property="og:description" content="Organizamos las mejores fiestas infantiles en Panamá. Animación, shows de burbujas, pintacaritas y más. ¡Haz la fiesta soñada de tus hijos con Diverty Eventos!">
    <meta property="og:image" content="https://i.imgur.com/vR2Ipuv.png"> <!-- URL de la imagen que se mostrará al compartir. -->
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">
    <meta property="og:image:alt" content="Logo de Diverty Eventos, para fiestas infantiles en Panamá">
    <meta property="og:url" content="https://divertypanama.netlify.app/"> <!-- ¡IMPORTANTE! Reemplaza con la URL real de tu sitio web. -->
    <meta property="og:type" content="website">

    <!-- Google tag (gtag.js) para Google Analytics: Permite el seguimiento de visitas y comportamiento de los usuarios. -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-R3G3Y0FLVN"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-R3G3Y0FLVN');
    </script>

    <!-- Schema Markup (Datos Estructurados) para LocalBusiness y Organization - SEO: Ayuda a los motores de búsqueda a entender el contenido de tu negocio. -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": ["LocalBusiness", "Organization"],
      "name": "Diverty Eventos",
      "image": "https://i.imgur.com/vR2Ipuv.png", <!-- URL de la imagen principal para Schema Markup. -->
      "url": "https://divertypanama.netlify.app/", <!-- ¡IMPORTANT! Reemplaza con la URL real de tu sitio. -->
      "telephone": "+50766677965",
      "address": {
        "@type": "PostalAddress",
        "streetAddress": "Tu Dirección Exacta Aquí (Ej: Calle 50, Edificio XYZ)", <!-- ¡IMPORTANT! Reemplaza con tu dirección física. -->
        "addressLocality": "Panamá Centro",
        "addressRegion": "Panamá",
        "postalCode": "Tu Código Postal Aquí", <!-- Opcional, pero recomendado si lo tienes. -->
        "addressCountry": "PA"
      },
      "priceRange": "$$",
      "openingHoursSpecification": [
        {
          "@type": "OpeningHoursSpecification",
          "dayOfWeek": [
            "Monday",
            "Tuesday",
            "Wednesday",
            "Thursday",
            "Friday"
          ],
          "opens": "09:00",
          "closes": "18:00"
        },
        {
          "@type": "OpeningHoursSpecification",
          "dayOfWeek": [
            "Saturday",
            "Sunday"
          ],
          "opens": "10:00",
          "closes": "17:00"
        }
      ],
      "hasOfferCatalog": {
        "@type": "OfferCatalog",
        "name": "Catálogo de Servicios y Paquetes de Fiestas Infantiles en Panamá",
        "itemListElement": [
          {
            "@type": "Offer",
            "itemOffered": {
              "@type": "Service",
              "name": "Pintacaritas para fiestas infantiles",
              "description": "Transforma a los niños en sus personajes favoritos con pinturas hipoalergénicas, un servicio ideal para fiestas infantiles en Panamá."
            }
          },
          {
            "@type": "Offer",
            "itemOffered": {
              "@type": "Service",
              "name": "Globoflexia para cumpleaños y eventos infantiles",
              "description": "Figuras divertidas y creativas hechas con globos para cada invitado, perfectas para cumpleaños y eventos infantiles en Panamá."
            }
          },
          {
            "@type": "Offer",
            "itemOffered": {
              "@type": "Service",
              "name": "Show de Burbujas Gigantes en Panamá",
              "description": "¡Burbujas enormes que los niños pueden atrapar y explotar! Un súper show único en Panamá para cualquier fiesta infantil."
            }
          },
          {
            "@type": "Offer",
            "itemOffered": {
              "@type": "Service",
              "name": "Paquete Fiesta Mágica Express para fiestas infantiles en Panamá",
              "description": "Diversión con animador, juegos, globos y piñata. Ideal para fiestas rápidas y cumpleaños en Panamá."
            }
          },
          {
            "@type": "Offer",
            "itemOffered": {
              "@type": "Service",
              "name": "Paquete Aventura de Ensueño para fiestas infantiles en Panamá",
              "description": "Servicio completo con payaso, pintacaritas, animación, juegos y piñata para una celebración inolvidable en Panamá."
            }
          },
          {
            "@type": "Offer",
            "itemOffered": {
              "@type": "Service",
              "name": "Paquete Celebración Personalizada para eventos infantiles en Panamá",
              "description": "Servicio premium con payaso, animación, pintacaritas, show de magia cómica y asistencia para piñata, diseñado para tu fiesta perfecta en Panamá."
            }
          }
        ]
      },
      "slogan": "¡Hacemos magia en tu fiesta infantil en Panamá!",
      "description": "Diverty Eventos ofrece la mejor animación y shows para fiestas infantiles en Panamá Centro, Arraiján, La Chorrera, Pacora y Panamá Norte. Especialistas en shows de burbujas, pintacaritas y paquetes de diversión inolvidable. ¡Organiza la fiesta soñada de tus hijos!"
    }
    </script>
    <!-- Tailwind CSS CDN para estilos: Permite un desarrollo rápido y un diseño responsivo. -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Inter para la tipografía: Proporciona una fuente moderna y legible. -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* Estilos base para el cuerpo de la página */
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
        }
        /* Estilos personalizados para el hover de botones para consistencia visual. */
        .hover\:bg-purple-600:hover { background-color: #7c3aed; }
        .hover\:bg-pink-600:hover { background-color: #db2777; }
        .hover\:bg-blue-600:hover { background-color: #2563eb; }
        .hover\:bg-green-600:hover { background-color: #16a34a; }
        .hover\:bg-indigo-600:hover { background-color: #4f46e5; }
        /* Estilo para tachar texto (precios anteriores), útil para mostrar descuentos. */
        .line-through { text-decoration: line-through; }

        /* Estilo para el botón flotante de WhatsApp: Permite un acceso rápido al contacto. */
        .whatsapp-float-button {
            position: fixed;
            bottom: 80px; /* Ajusta la posición vertical del botón. */
            right: 20px;
            z-index: 1000; /* Asegura que el botón esté por encima de otros elementos. */
            width: 56px; /* Ajuste para que el botón sea cuadrado. */
            height: 56px;
            display: flex; /* Usar flexbox para centrar contenido. */
            justify-content: center; /* Centra el icono horizontalmente. */
            align-items: center; /* Centra el icono verticalmente. */
            border-radius: 9999px; /* Redondo completo. */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); /* Sombra más pronunciada. */
            transition: all 0.3s ease; /* Transiciones suaves para hover. */
            background-color: #25D366; /* Color de fondo de WhatsApp. */
        }
        .whatsapp-float-button:hover {
            transform: scale(1.1); /* Ligero aumento de tamaño al pasar el ratón. */
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); /* Sombra aún más pronunciada en hover. */
        }

        /* Estilos para el FAQ (Aunque no se usan directamente en el HTML actual, se mantienen por si se añaden). */
        .faq-question {
            cursor: pointer;
            padding: 1rem;
            background-color: #f3f4f6; /* bg-gray-100 */
            border-bottom: 1px solid #e5e7eb; /* border-gray-200 */
            font-weight: 600; /* font-semibold */
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .faq-answer {
            padding: 1rem;
            background-color: #ffffff; /* bg-white */
            border-bottom: 1px solid #e5e7eb; /* border-gray-200 */
            display: none; /* Oculto por defecto */
        }
        .faq-arrow {
            transition: transform 0.3s ease;
        }
        .faq-question.active .faq-arrow {
            transform: rotate(180deg);
        }
    </style>
</head>
<body class="min-h-screen bg-gradient-to-br from-purple-200 via-pink-200 to-yellow-200 text-gray-800 flex flex-col">

    <!-- Modal de Información General: Se usa para mensajes al usuario (ej. éxito, error). -->
    <div id="infoModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 p-4 hidden">
        <div class="bg-white rounded-xl shadow-2xl p-6 max-w-sm w-full text-center border-4 border-purple-400">
            <p id="modalMessage" class="text-xl font-bold mb-4 text-purple-700"></p>
            <button id="closeModalButton" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-5 rounded-full shadow-lg transition duration-300">
                ¡Entendido! 🎉
            </button>
        </div>
    </div>

    <!-- Modal de Promoción: Se usa para anunciar ofertas especiales. -->
    <div id="promoModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 p-4 hidden">
        <div class="bg-white rounded-xl shadow-2xl p-6 max-w-md w-full text-center border-4 border-green-400">
            <h2 class="text-3xl font-extrabold text-green-700 mb-4">¡Promoción del Mes! 🌟</h2>
            <p id="promoMessage" class="text-lg text-gray-800 mb-4"></p>
            <button id="closePromoModalButton" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-5 rounded-full shadow-lg transition duration-300">
                ¡Genial! 🎉
            </button>
        </div>
    </div>

    <!-- Nuevo Modal de Advertencia de Reserva: Se muestra antes de rellenar el formulario de reserva. -->
    <div id="bookingWarningModal" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 p-4 hidden">
        <div class="bg-white rounded-xl shadow-2xl p-6 max-w-md w-full text-center border-4 border-red-400">
            <h2 class="text-3xl font-extrabold text-red-700 mb-4">¡Importante antes de Reservar! 🚨</h2>
            <p class="text-lg text-gray-800 mb-6">
                Para asegurar la disponibilidad de la fecha y hora de tu evento, te recomendamos
                <span class="font-bold text-red-600">verificar primero con nosotros vía WhatsApp</span>.
                ¡Así garantizamos la magia de tu día! ✨
            </p>
            <div class="flex flex-col sm:flex-row justify-center space-y-4 sm:space-y-0 sm:space-x-4">
                <a href="https://wa.me/50766677965?text=¡Hola! Quiero consultar la disponibilidad de una fecha para un evento."
                   target="_blank"
                   class="bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-full shadow-lg transition duration-300 flex items-center justify-center">
                    <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/6/6b/WhatsApp.svg/1200px-WhatsApp.svg.png" alt="WhatsApp Icon" class="w-6 h-6 mr-2">
                    Contactar por WhatsApp
                </a>
                <button id="closeBookingWarningModalButton" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-3 px-6 rounded-full shadow-lg transition duration-300">
                    Continuar con el Formulario
                </button>
            </div>
        </div>
    </div>

    <!-- Encabezado (Menú de Navegación Principal): Contiene el logo, el título y los botones de navegación. -->
    <header class="bg-white bg-opacity-95 shadow-xl p-4 w-full rounded-b-xl">
        <nav class="container mx-auto flex flex-col sm:flex-row justify-between items-center">
            <!-- Contenedor para el logo y el título en dispositivos móviles y de escritorio. -->
            <div class="flex items-center mb-4 sm:mb-0">
                <!-- LOGO DE DIVERTY EVENTOS -->
                <!-- Asegúrate de que la URL de 'src' es la dirección directa de tu imagen. -->
                <!-- El atributo 'alt' es importante para la accesibilidad y el SEO. -->
                <img src="https://i.ibb.co/zVqr5yPB/android-chrome-512x512.png" alt="Logo de Diverty Eventos" class="w-16 h-16 mr-4 rounded-full object-cover border-2 border-pink-400 shadow-md">
                
                <!-- Título principal simplificado: Muestra el nombre de la marca. -->
                <h1 class="text-3xl sm:text-4xl font-extrabold text-purple-700 text-center sm:text-left">
                    Diverty Eventos 
                </h1>
            </div>
            <ul class="flex flex-wrap justify-center sm:space-x-4 space-x-2">
                <li><button id="navHome" class="text-base font-bold py-1 px-3 rounded-full text-gray-700 hover:bg-purple-100">Inicio 🏠</button></li>
                <li><button id="navServices" class="text-base font-bold py-1 px-3 rounded-full text-gray-700 hover:bg-purple-100">Servicios 📋</button></li>
                <li><button id="navPackages" class="text-base font-bold py-1 px-3 rounded-full text-gray-700 hover:bg-purple-100">Paquetes 📦</button></li>
                <li><button id="navBooking" class="text-base font-bold py-1 px-3 rounded-full text-gray-700 hover:bg-purple-100">Reservar 🗓️</button></li>
            </ul>
        </nav>
    </header>

    <!-- Resumen del Carrito de Compra (Barra Flotante): Muestra la cantidad de ítems y el total seleccionado. -->
    <div id="cartSummary" class="bg-yellow-200 text-purple-800 font-extrabold p-6 text-center rounded-b-lg shadow-lg border-4 border-yellow-400 hidden">
        <p class="text-2xl sm:text-3xl mb-3">
            🛒 Ítems seleccionados: <span id="selectedItemsCount" class="text-purple-700">0</span> | Total: <span id="totalPriceDisplay" class="text-pink-700">$0.00</span>
        </p>
        <button id="proceedToBookButton" class="mt-2 bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 px-8 rounded-full shadow-md text-base sm:text-lg">
            Proceder a Reservar Ahora! ✨
        </button>
    </div>

    <!-- Área de Contenido Principal: Aquí se cargará dinámicamente el contenido de cada sección (Inicio, Servicios, etc.). -->
    <main id="mainContent" class="container mx-auto p-4 flex-grow">
        <!-- El contenido de las secciones (Inicio, Servicios, etc.) será inyectado aquí por JavaScript. -->
    </main>

    <!-- Botón Flotante de WhatsApp: Acceso rápido para contactar por WhatsApp. -->
    <a href="https://wa.me/50766677965?text=¡Hola! Tengo una consulta sobre Diverty Eventos." class="whatsapp-float-button" target="_blank">
        <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/6/6b/WhatsApp.svg/1200px-WhatsApp.svg.png" alt="WhatsApp Icon" class="w-6 h-6 mr-2">
    </a>

    <!-- Pie de Página: Información de derechos de autor y eslogan. -->
    <footer class="bg-purple-700 text-white py-8 px-4 text-center mt-8 rounded-t-xl shadow-inner w-full">
        <p class="text-lg font-semibold">&copy; 2023 Diverty Eventos. ¡Hacemos magia en cada fiesta infantil en Panamá! ✨</p>
        <p class="text-sm">Todos los derechos reservados. Servicios de <strong>animación infantil</strong> y <strong>shows para fiestas</strong> en todo Panamá.</p>
    </footer>

    <!-- Script de JavaScript para la funcionalidad de la página. -->
    <script>
        // --- Gestión del Estado Global de la Aplicación ---
        // 'appState' contiene todas las variables de estado que controlan el comportamiento de la aplicación.
        let appState = {
            activeSection: 'home', // Sección actualmente visible ('home', 'services', 'packages', 'trivia', 'booking').
            userId: 'guest_user_' + Math.random().toString(36).substring(2, 9), // ID único para el usuario visitante.
            selectedItems: [], // Array para almacenar los servicios/paquetes seleccionados en el carrito.
            triviaBubbleDiscountActive: false, // Flag para el descuento del show de burbujas por la trivia.
            promotedPackages: [], // Array to hold names of packages currently under promotion
            selectedLocation: 'Panamá Centro', // Ubicación seleccionada para calcular el recargo de transporte.
            triviaQuestionsShuffled: [], // Preguntas de la trivia mezcladas.
            currentTriviaQuestionIndex: 0, // Índice de la pregunta actual de la trivia.
            currentTriviaTimer: null, // ID del temporizador de la trivia.
            currentQuestionTimeout: null, // ID del timeout para la pregunta de la trivia.
            hasPlayedTrivia: false, // Indica si el usuario ya jugó la trivia (para evitar múltiples intentos).
            hasShownBookingWarning: false, // Indica si el modal de advertencia de reserva ya se mostró en la sesión.
            infoModalCallback: null, // Callback para ejecutar una función al cerrar el modal de info.
            bookingFormData: { // Objeto para almacenar los datos del formulario de reservas, útil para persistencia.
                bookingDate: '',
                bookingTime: '',
                customerName: '',
                customerEmail: '',
                customerPhone: '',
                eventType: '',
                numKids: '',
                exactLocation: '',
                selectedLocation: 'Panamá Centro' 
            },
        };

        // --- Definición de Datos (Servicios y Paquetes) ---
        // Arrays de objetos que definen los servicios y paquetes disponibles, incluyendo precios y descripciones.
        const servicesData = [
            { id: '2', name: 'Pintacaritas 🎨👧👦', price: 40, description: 'Transforma a los niños en sus personajes favoritos con pinturas hipoalergénicas. Servicio por 1 hora.', color: 'bg-blue-100 border-blue-300 text-blue-800' },
            { id: '3', name: 'Globoflexia 🎈💫', price: 40, description: 'Figuras divertidas y creativas hechas con globos para cada invitado. Servicio por 1 hora.', color: 'bg-green-100 border-green-300 text-green-800' },
            { id: '6', name: 'Show de Burbujas Gigantes 🫧', price: 135, description: '¡Burbujas enormes que los niños pueden atrapar y explotar! Servicio por 1 hora. ¡Un súper show único en Panamá!', color: 'bg-teal-100 border-teal-300 text-teal-800' },
            { 
                id: '7', 
                name: 'Decoraciones Temáticas', 
                price: 100, // Precio actualizado a 100
                description: 'Transforma cualquier espacio en un mundo mágico con nuestras decoraciones personalizadas. ¡Elige tu temática favorita!', 
                color: 'bg-fuchsia-100 border-fuchsia-300 text-fuchsia-800',
                type: 'theme_selection', // Nuevo tipo para manejar la selección de temática
                themes: {
                    ninas: [
                        'Barbie', 'Sirenita', 'Cenicienta', 'Moana grande', 'Moana bebé', 'Abejita',
                        'Luly Pampin', 'Stitch', 'Stitch y Ángela', 'Capivara', 'Minnie roja',
                        'Plim Plim rosa', 'Sirenita otro modelo nuevo', 'Rosita fresita', 'Masha y el oso',
                        'Unicornio', 'Frozen', 'Monster In', 'Granja rosa', 'Skay', 'Princesas bebé',
                        'Princesa grande', 'Bluey', 'Minnie bebé', 'Mariposas', 'Bebé Llorones',
                        'Minnie rosada', 'Gatita Marie', 'Pebells', 'Pollo Party', 'Abeja Maya',
                        'Bely y Beto', 'La Bella y la Bestia', 'Hello Kitty', 'Peppa', 'Harley Kuin',
                        'Merlina', 'Minnie Poll Party', 'Princesa Pich'
                    ],
                    ninos: [
                        'Real Madrid', 'Plaza Sésamo', 'Hot Wheels', 'Bebe Fin', 'Sonic', 'Bomberos',
                        'Legos', 'Dinosaurios', 'Dinosaurios animados', 'Plim Plim Safary',
                        'Inter de Miami', 'Batman', 'Granja', 'Fútbol', 'Mickey Safary', 'Chuchugua',
                        'Blippi', 'Minicraft', 'Plim Plim', 'Cars', 'Spiderman', 'Paw Patrol',
                        'Jefes en Pañales', 'Bam Bam', 'Safary', 'La Granja de Zenón', 'Mario Bros',
                        'Mickey Principe', 'Avengers', 'Cristiano', 'Coco Melón', 'Messi',
                        'Plim Plim piscina', 'Carritos', 'Aeroman', 'Constructor', 'Free Fires',
                        'Caballito', 'Rugrats', 'Barca'
                    ]
                }
            },
            { id: '8', name: 'Máquinas de Snack Algodón y Pop Corn 🍿🍭', price: 100, description: 'Máquinas de algodón de azúcar y palomitas de maíz para endulzar tu evento. Servicio por 3 horas.', color: 'bg-lime-100 border-lime-300 text-lime-800' },
            // Servicio de personajes temáticos (precio actualizado a 65)
            {
                id: '9',
                name: 'Personajes Temáticos',
                price: 65, // Precio base para un personaje, actualizado a $65
                description: '¡Sorprende a todos con la visita de tu personaje favorito! Elige entre Mickey, Minnie y Mario Bros. Servicio por 1 hora.',
                color: 'bg-indigo-100 border-indigo-300 text-indigo-800',
                type: 'character_selection', // Tipo especial para manejar la selección de personaje
                characters: [
                    { id: 'mickey', name: 'Mickey Mouse 🐭', image: 'https://i.imgur.com/CjWJdUO.png' },
                    { id: 'minnie', name: 'Minnie Mouse 🎀', image: 'https://placehold.co/100x100/FF00FF/FFFFFF?text=Minnie' },
                    { id: 'mario', name: 'Mario Bros. 🍄', image: 'https://placehold.co/100x100/FF0000/FFFFFF?text=Mario' }
                ]
            }
        ];

        const packagesData = [
            { id: 'P1', name: 'Plan Básico 🚀', price: 75, services: [ // Renombrado
                'Payas@ o animad@r 🤡🎤',
                'Animación infantil 🥳💃',
                'Juegos y concursos 🎲🏆',
                'Figuras con globos 🎈🐶',
                'Romper la piñata 🍬🎉'
            ], description: '1.5h de diversión: Animador, juegos, globos, piñata. ¡Rápido y alegre!', color: 'bg-pink-100 border-pink-300 text-pink-800' },
            { id: 'P2', name: 'Plan Recreativo 🌈', price: 100, services: [ // Renombrado
                'Payas@ o animad@r 🤡🎤',
                'Pintacaritas 🎨👧👦',
                'Animación infantil 🥳💃',
                'Juegos y concursos 🎲🏆',
                'Figuras con globos 🎈🐶',
                'Romper la piñata 🍬🎉'
            ], description: '2h de aventura: Payaso/animador, pintacaritas, animación, juegos, globos, piñata. ¡Inolvidable!', color: 'bg-indigo-100 border-indigo-300 text-indigo-800' },
            { id: 'P3', name: 'Plan Magic ✨', price: 135, services: [ // Renombrado
                'Payasit@ o animad@r 🤡🎤',
                'Animación, juegos y concursos 🥳🎲',
                'Pintacaritas 🎨👧👦',
                'Show de magia cómica ✨🤣',
                'Asistencia para la piñata 🍬🎉'
            ], description: '2.5h premium: Payaso/animador, juegos, pintacaritas, magia cómica, asistencia de piñata. ¡Tu fiesta perfecta!', color: 'bg-orange-100 border-orange-300 text-orange-800' },
            { // Nuevo paquete "Plan Diverty"
                id: 'P4', 
                name: 'Plan Diverty 🥳', 
                price: 165, 
                services: [
                    'Payasito o Animador 🤡🎤',
                    'Juegos y concursos 🎲🏆',
                    'Pintacaritas 🎨👧👦',
                    'Globoflexia 🎈🐶',
                    'Show de Burbujas o Magia Cómica 🫧✨',
                    'Asistencia en la piñata 🍬🎉'
                ], 
                description: '3h de diversión completa: Payaso/animador, juegos, pintacaritas, globoflexia, show de burbujas o magia, y asistencia piñata. ¡La magia garantizada!', 
                color: 'bg-purple-100 border-purple-300 text-purple-800' 
            },
        ];

        // Recargos por transporte según la ubicación del evento.
        const transportFeesByLocation = {
            'Panamá Centro': 0,
            'Arraiján': 10,
            'La Chorrera': 15,
            'Pacora': 10,
            'Panamá Norte': 10,
        };

        // Preguntas de la Trivia: Un array de objetos con preguntas, opciones y la respuesta correcta.
        const triviaQuestions = [
            {
                question: "Soy una perrita azul, me encanta jugar con mi hermana Bingo y mis padres. ¿Quién soy?",
                options: ["Bingo", "Chilli", "Bluey", "Bandit"],
                answer: "Bluey"
            },
            {
                question: "Uso lentes y un sombrero naranja, y me encanta explorar lugares divertidos para niños. ¿Quién soy?",
                options: ["Elmo", "Mickey Mouse", "Blippi", "El Pato Donald"],
                answer: "Blippi"
            },
            {
                question: "Soy un payaso héroe con una nariz roja y un corazón grande, que siempre ayuda a los niños. ¿Quién soy?",
                options: ["Bob Esponja", "Plim Plim", "Peppa Pig", "Pocoyó"],
                answer: "Plim Plim"
            },
            {
                question: "Soy la hermana de Bluey, y juntas hacemos muchas aventuras imaginarias. Mi color es naranja. ¿Quién soy?",
                options: ["Bluey", "Chilli", "Bingo", "Bandit"],
                answer: "Bingo"
            },
            {
                question: "Me llamo Bandit, soy el papá de Bluey y Bingo. ¿Qué animal soy?",
                options: ["Perro", "Gato", "Oso", "Conejo"],
                answer: "Perro"
            },
            {
                question: "Visto de naranja y azul, me encanta bailar y enseñar sobre el mundo. ¿Quién soy?",
                options: ["Blippi", "Elmo", "JJ de Cocomelon", "Peppa Pig"],
                answer: "Blippi"
            },
            {
                question: "Mi canción es 'Un mundo mágico, un mundo de amor'. Soy un payaso que hace sonreír a todos. ¿Quién soy?",
                options: ["Plim Plim", "Patylu", "El Chavo del 8", "Cantinflas"],
                answer: "Plim Plim"
            },
            {
                question: "Soy la mamá de Bluey y Bingo, y me llamo Chilli. ¿Qué animal soy?",
                options: ["Perro", "Gato", "Pato", "Caballo"],
                answer: "Perro"
            },
            {
                question: "En el mundo de Blippi, soy un amigo peludo con una nariz de payaso. ¿Quién soy?",
                options: ["Buddy", "Gilly", "Squeaky", "Pebbles"],
                answer: "Squeaky"
            },
            {
                question: "Siempre digo '¡Es hora de la aventura!' y tengo una mochila mágica. ¿Quién soy?",
                options: ["Dora la Exploradora", "Mickey Mouse", "Blippi", "Paw Patrol"],
                answer: "Blippi"
            }
        ];

        // --- Funciones de Ayuda ---

        /**
         * Baraja un array de forma aleatoria (Fisher-Yates shuffle).
         * Utilizado para mezclar las preguntas de la trivia.
         * @param {Array} array - El array a barajar.
         * @returns {Array} El array barajado.
         */
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        /**
         * Inyecta el HTML de una sección en el área de contenido principal.
         * @param {string} sectionHtml - El HTML de la sección a renderizar.
         */
        function renderSection(sectionHtml) {
            document.getElementById('mainContent').innerHTML = sectionHtml;
        }

        /**
         * Actualiza el resumen del carrito flotante con el número de ítems y el precio total.
         * Aplica lógicas de descuento si están activas.
         */
        function updateCartSummary() {
            let currentTotalPrice = appState.selectedItems.reduce((sum, item) => {
                let itemPriceAdjusted = item.price;
                // Determina si el ítem es un paquete comparando con los nombres en packagesData.
                const isPackage = packagesData.some(p => p.name === item.name);

                // Lógica de descuento para "Pintacaritas" si se añaden más de 1.
                if (item.name === 'Pintacaritas 🎨👧👦' && item.quantity > 1) {
                    itemPriceAdjusted = 35; // Precio con descuento por unidad.
                }
                // Lógica de descuento de trivia para "Show de Burbujas Gigantes".
                if (appState.triviaBubbleDiscountActive && item.name === 'Show de Burbujas Gigantes 🫧') {
                    itemPriceAdjusted = item.price * 0.90; // 10% de descuento.
                }
                // Lógica de descuento mensual para paquetes.
                else if (isPackage && appState.promotedPackages.includes(item.name)) {
                    itemPriceAdjusted = item.price * 0.90; // 10% de descuento.
                }
                
                return sum + (itemPriceAdjusted * item.quantity);
            }, 0);

            // Añadir recargo por transporte basado en la ubicación seleccionada.
            currentTotalPrice += transportFeesByLocation[appState.selectedLocation] || 0;

            const cartSummaryDiv = document.getElementById('cartSummary');
            const selectedItemsCountSpan = document.getElementById('selectedItemsCount');
            const totalPriceDisplaySpan = document.getElementById('totalPriceDisplay');

            const totalItemsInCart = appState.selectedItems.reduce((total, item) => total + item.quantity, 0);

            if (totalItemsInCart > 0 || currentTotalPrice > 0) {
                cartSummaryDiv.classList.remove('hidden');
                selectedItemsCountSpan.textContent = totalItemsInCart;
                totalPriceDisplaySpan.textContent = `$${currentTotalPrice.toFixed(2)}`;
            } else {
                cartSummaryDiv.classList.add('hidden');
            }
        }

        /**
         * Maneja la adición/eliminación/decremento de ítems en el carrito.
         * @param {object} item - El objeto del servicio/paquete a añadir/quitar. Debe contener { name, price }.
         * @param {string} actionType - 'add' para añadir/incrementar, 'remove_all' para quitar todas las unidades, 'toggle' para alternar (usado en no-repetibles).
         */
        function handleCartAction(item, actionType) {
            const existingItemIndex = appState.selectedItems.findIndex(selected => selected.name === item.name);

            if (actionType === 'add') {
                if (existingItemIndex > -1) {
                    appState.selectedItems[existingItemIndex].quantity++;
                } else {
                    // Si el ítem no existe, lo añade con cantidad 1.
                    appState.selectedItems.push({ ...item, quantity: 1 });
                }
            } else if (actionType === 'remove_all') {
                // Filtra el ítem para eliminar todas sus unidades.
                appState.selectedItems = appState.selectedItems.filter(selected => selected.name !== item.name);
            } else if (actionType === 'toggle') { // Para servicios no repetibles (ej: paquetes).
                if (existingItemIndex > -1) {
                    // Si ya está seleccionado, lo quita.
                    appState.selectedItems = appState.selectedItems.filter(selected => selected.name !== item.name);
                } else {
                    // Si no está seleccionado, lo añade con cantidad 1.
                    appState.selectedItems.push({ ...item, quantity: 1 });
                }
            }

            // Volver a renderizar la sección activa para actualizar los botones y precios.
            if (appState.activeSection === 'services') {
                renderServicesSection();
            } else if (appState.activeSection === 'packages') {
                renderPackagesSection();
            } else if (appState.activeSection === 'booking') {
                renderBookingSection();
            }
            updateCartSummary(); // Actualiza la barra flotante del carrito.
        }

        /**
         * Maneja la adición o el cambio de un personaje temático en el carrito.
         * Permite añadir múltiples personajes, incrementando la cantidad si ya está en el carrito.
         * @param {object} service - El objeto de servicio "Personajes Temáticos" (base).
         * @param {object} character - El objeto del personaje seleccionado ({ id, name, image }).
         * @param {string} action - 'add' para añadir o 'remove_all' para eliminar.
         */
        function updateCharacterInCart(service, character, action) {
            const fullCharacterName = `${service.name}: ${character.name}`;
            const existingItemIndex = appState.selectedItems.findIndex(selected => selected.name === fullCharacterName);

            if (action === 'add') {
                if (existingItemIndex > -1) {
                    // Si el personaje ya existe, incrementa su cantidad
                    appState.selectedItems[existingItemIndex].quantity++;
                } else {
                    // Añade un nuevo personaje con el precio base del servicio
                    appState.selectedItems.push({
                        id: `${service.id}-${character.id}`,
                        name: fullCharacterName,
                        price: service.price, // Usa el precio base del servicio de personajes
                        quantity: 1
                    });
                }
            } else if (action === 'remove_all') {
                // Elimina todas las instancias de un personaje específico del carrito
                appState.selectedItems = appState.selectedItems.filter(item => item.name !== fullCharacterName);
            }
            // Re-renderiza la sección de servicios y actualiza el resumen del carrito
            renderServicesSection();
            updateCartSummary();
        }

        /**
         * Maneja la adición o el cambio de una temática en el carrito.
         * Permite añadir múltiples temáticas, incrementando la cantidad si ya está en el carrito.
         * @param {object} service - El objeto de servicio "Decoraciones Temáticas" (base).
         * @param {string} themeName - El nombre de la temática seleccionada.
         * @param {string} action - 'add' para añadir o 'remove_all' para eliminar.
         */
        function updateThemeInCart(service, themeName, action) {
            const fullThemeName = `${service.name}: ${themeName}`;
            const existingItemIndex = appState.selectedItems.findIndex(selected => selected.name === fullThemeName);

            if (action === 'add') {
                if (existingItemIndex > -1) {
                    appState.selectedItems[existingItemIndex].quantity++;
                } else {
                    appState.selectedItems.push({
                        id: `${service.id}-${themeName.replace(/\s+/g, '-')}`, // Genera un ID simple
                        name: fullThemeName,
                        price: service.price, // Usa el precio base del servicio de decoraciones
                        quantity: 1
                    });
                }
            } else if (action === 'remove_all') {
                appState.selectedItems = appState.selectedItems.filter(item => item.name !== fullThemeName);
            }
            renderServicesSection();
            updateCartSummary();
        }


        // --- Funciones de Modales (Ventanas Emergentes) ---
        /**
         * Muestra un modal de información genérico.
         * @param {string} message - El mensaje a mostrar en el modal.
         * @param {function} [callback] - Función a ejecutar cuando se cierra el modal.
         */
        function showInfoModal(message, callback = null) {
            document.getElementById('modalMessage').textContent = message;
            document.getElementById('infoModal').classList.remove('hidden');
            appState.infoModalCallback = callback; // Almacena el callback en el estado global.
        }

        /**
         * Oculta el modal de información genérico y ejecuta el callback si existe.
         */
        function closeModal() {
            document.getElementById('infoModal').classList.add('hidden');
            document.getElementById('modalMessage').textContent = '';
            if (appState.infoModalCallback) {
                appState.infoModalCallback(); // Ejecuta el callback.
                appState.infoModalCallback = null; // Limpia el callback después de usarlo.
            }
        }

        /**
         * Muestra el modal de promoción y activa el descuento mensual.
         * @param {string} message - El mensaje de la promoción.
         */
        function showPromoInfoModal(message) {
            document.getElementById('promoMessage').textContent = message;
            document.getElementById('promoModal').classList.remove('hidden');
            
            // Set specific packages for promotion
            appState.promotedPackages = ['Plan Básico 🚀', 'Plan Recreativo 🌈', 'Plan Magic ✨'];

            updateCartSummary();
            // Re-renderiza las secciones si están activas para mostrar el descuento.
            if (appState.activeSection === 'services') renderServicesSection();
            if (appState.activeSection === 'packages') renderPackagesSection();
            if (appState.activeSection === 'booking') renderBookingSection();
        }

        /**
         * Oculta el modal de promoción.
         */
        function closePromoModal() {
            document.getElementById('promoModal').classList.add('hidden');
            document.getElementById('promoMessage').textContent = '';
            // No se limpian los paquetes promocionados para que el descuento persista durante la sesión.
            updateCartSummary();
            if (appState.activeSection === 'packages') renderPackagesSection(); // Se refresca para asegurar la visualización del descuento.
        }

        /**
         * Muestra el modal de advertencia de reserva.
         */
        function showBookingWarningModal() {
            document.getElementById('bookingWarningModal').classList.remove('hidden');
        }

        /**
         * Oculta el modal de advertencia de reserva.
         */
        function closeBookingWarningModal() {
            document.getElementById('bookingWarningModal').classList.add('hidden');
        }

        // --- Funciones de Renderizado de Secciones ---

        /**
         * Renderiza la sección de Inicio.
         */
        function renderHomeSection() {
            const html = `
                <section class="bg-white rounded-3xl shadow-2xl p-4 sm:p-8 my-8 border-8 border-yellow-400 flex items-center justify-center min-h-[60vh]">
                    <div class="bg-yellow-50 p-6 sm:p-10 rounded-2xl shadow-inner border-4 border-yellow-300 max-w-3xl mx-auto text-center">
                        
                        <h2 class="text-3xl sm:text-4xl lg:text-5xl font-extrabold text-purple-800 mb-4 leading-tight text-center">
                            ¡La Magia Comienza Aquí! ✨
                        </h2>
                        <p class="text-base sm:text-lg lg:text-xl text-gray-700 mb-8 px-2">
                            Diverty Eventos: <strong>fiestas infantiles inolvidables en Panamá</strong>. Animación, shows de burbujas, pintacaritas, globoflexia. ¡Hacemos tu fiesta soñada realidad!
                        </p>
                        <div class="flex flex-col sm:flex-row justify-center space-y-4 sm:space-y-0 sm:space-x-4 mt-8">
                            <button id="homeExploreServices" class="bg-pink-500 hover:bg-pink-600 text-white font-bold py-3 px-8 rounded-full shadow-lg text-base sm:text-lg">
                                ¡Explora Nuestros Servicios! 🎉
                            </button>
                            <button id="homeExplorePackages" class="bg-purple-500 hover:bg-purple-600 text-white font-bold py-3 px-8 rounded-full shadow-lg text-base sm:text-lg">
                                ¡Explora Nuestros Paquetes! 📦
                            </button>
                        </div>
                        <div class="flex flex-col sm:flex-row justify-center space-y-4 sm:space-y-0 sm:space-x-4 mt-8">
                            <button id="homePromoButton" class="bg-gradient-to-r from-yellow-400 to-orange-500 hover:from-yellow-500 hover:to-orange-600 text-white font-bold py-3 px-8 rounded-full shadow-lg text-base sm:text-lg">
                                🎉 Promoción del Mes 🎉
                            </button>
                            <button id="homeTriviaButton" 
                                class="bg-gradient-to-r from-green-400 to-teal-500 hover:from-green-500 hover:to-teal-600 text-white font-bold py-3 px-8 rounded-full shadow-lg text-base sm:text-lg ${appState.hasPlayedTrivia ? 'opacity-50 cursor-not-allowed' : ''}"
                                ${appState.hasPlayedTrivia ? 'disabled' : ''}>
                                ${appState.hasPlayedTrivia ? '¡Trivia Completada! 🏆' : '🚀 ¡Juega la Trivia y Gana un Descuento! 🧠'}
                            </button>
                        </div>
                    </div>
                </section>
            `;
            renderSection(html);

            // Asigna los event listeners a los botones de la sección de Inicio.
            document.getElementById('homeExploreServices').onclick = () => { setActiveSection('services'); };
            document.getElementById('homeExplorePackages').onclick = () => { setActiveSection('packages'); };
            document.getElementById('homePromoButton').onclick = () => {
                showPromoInfoModal('¡Este mes, disfruta de un 10% de descuento EXCLUSIVO en nuestros Planes Básico, Recreativo y Magic! 📦');
            };
            document.getElementById('homeTriviaButton').onclick = () => { setActiveSection('trivia'); };
        }

        /**
         * Renderiza la sección de Servicios Individuales.
         */
        function renderServicesSection() {
            // Servicios que pueden tener cantidades múltiples y, por lo tanto, botones de "Añadir" y "Quitar Todo".
            const repeatableServices = ['Pintacaritas 🎨👧👦', 'Globoflexia 🎈💫', 'Show de Burbujas Gigantes 🫧'];

            const cardsHtml = servicesData.map(service => {
                // Modified imageHtml structure for centering and consistent rounding
                let imageHtml = service.image ? `
                    <div class="text-center mb-4">
                        <img src="${service.image}" alt="[attachment_0](attachment)" class="mx-auto h-32 object-cover rounded-xl">
                    </div>
                ` : '';
                // Remove imageHtml from the service cards
                imageHtml = ''; // Set to empty string to effectively remove the image

                // Lógica específica para el servicio de selección de personaje
                if (service.type === 'character_selection') {
                    // Encuentra el personaje actualmente seleccionado en el carrito (si existe alguno de este tipo)
                    const selectedCharacterItems = appState.selectedItems.filter(item => item.name.startsWith(service.name + ':'));

                    const optionsHtml = service.characters.map(char => {
                        const fullCharName = `${service.name}: ${char.name}`;
                        const isCharacterAlreadyAdded = selectedCharacterItems.some(item => item.name === fullCharName);
                        // Deshabilita la opción en el select si ya está en el carrito
                        return `<option value="${char.id}" ${isCharacterAlreadyAdded ? 'disabled' : ''}>${char.name} ${isCharacterAlreadyAdded ? '(Añadido)' : ''}</option>`;
                    }).join('');

                    return `
                        <div class="${service.color} rounded-2xl shadow-lg p-4 sm:p-6 flex flex-col justify-between border-4 border-dashed border-opacity-50">
                            ${imageHtml}
                            <div>
                                <h2 class="text-xl sm:text-2xl font-bold mb-2 sm:mb-3 text-indigo-700">${service.name}</h2>
                                <p class="text-sm sm:text-base text-gray-700 mb-3 sm:mb-4">${service.description}</p>
                                <p class="text-3xl sm:text-4xl font-extrabold text-pink-600 mb-3 sm:mb-4">
                                    $${service.price.toFixed(2)}
                                </p>
                                <div class="mb-4">
                                    <label for="characterSelect-${service.id}" class="block text-gray-700 font-bold mb-2">Elige tu personaje: ✨</label>
                                    <select id="characterSelect-${service.id}" class="w-full p-2 border-2 border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 text-sm sm:text-base">
                                        <option value="">Selecciona un personaje</option>
                                        ${optionsHtml}
                                    </select>
                                </div>
                            </div>
                            <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2 mt-auto">
                                <button
                                    data-service-id="${service.id}"
                                    data-action="add_character"
                                    class="character-action-button flex-grow bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded-full shadow-md text-sm transition duration-300"
                                    disabled
                                >
                                    Añadir Seleccionado ➕
                                </button>
                            </div>
                            <div id="selectedCharactersList-${service.id}" class="mt-4">
                                ${selectedCharacterItems.length > 0 ? `<p class="font-semibold text-gray-700 mb-2">Personajes en tu carrito:</p>` : ''}
                                ${selectedCharacterItems.map(item => `
                                    <div class="flex justify-between items-center bg-blue-50 p-2 rounded-lg mb-2">
                                        <span>${item.name.replace(service.name + ': ', '')} (x${item.quantity})</span>
                                        <button class="remove-specific-character-button text-red-500 hover:text-red-700 font-bold ml-2"
                                                data-full-name="${item.name}">🗑️</button>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                } else if (service.type === 'theme_selection') {
                    const selectedThemeItems = appState.selectedItems.filter(item => item.name.startsWith(service.name + ':'));

                    let themeOptionsHtml = '<option value="">Selecciona una temática</option>';
                    themeOptionsHtml += '<optgroup label="Niña">';
                    service.themes.ninas.forEach(theme => {
                        const fullThemeName = `${service.name}: ${theme}`;
                        const isThemeAlreadyAdded = selectedThemeItems.some(item => item.name === fullThemeName);
                        themeOptionsHtml += `<option value="${theme}" ${isThemeAlreadyAdded ? 'disabled' : ''}>${theme} ${isThemeAlreadyAdded ? '(Añadida)' : ''}</option>`;
                    });
                    themeOptionsHtml += '</optgroup>';
                    themeOptionsHtml += '<optgroup label="Niño">';
                    service.themes.ninos.forEach(theme => {
                        const fullThemeName = `${service.name}: ${theme}`;
                        const isThemeAlreadyAdded = selectedThemeItems.some(item => item.name === fullThemeName);
                        themeOptionsHtml += `<option value="${theme}" ${isThemeAlreadyAdded ? 'disabled' : ''}>${theme} ${isThemeAlreadyAdded ? '(Añadida)' : ''}</option>`;
                    });
                    themeOptionsHtml += '</optgroup>';

                    return `
                        <div class="${service.color} rounded-2xl shadow-lg p-4 sm:p-6 flex flex-col justify-between border-4 border-dashed border-opacity-50">
                            ${imageHtml}
                            <div>
                                <h2 class="text-xl sm:text-2xl font-bold mb-2 sm:mb-3 text-fuchsia-700">${service.name}</h2>
                                <p class="text-sm sm:text-base text-gray-700 mb-3 sm:mb-4">${service.description}</p>
                                <p class="text-3xl sm:text-4xl font-extrabold text-pink-600 mb-3 sm:mb-4">
                                    $${service.price.toFixed(2)}
                                </p>
                                <div class="mb-4">
                                    <label for="themeSelect-${service.id}" class="block text-gray-700 font-bold mb-2">Elige tu temática: 🎨</label>
                                    <select id="themeSelect-${service.id}" class="w-full p-2 border-2 border-gray-300 rounded-lg focus:ring-fuchsia-500 focus:border-fuchsia-500 text-sm sm:text-base">
                                        ${themeOptionsHtml}
                                    </select>
                                </div>
                            </div>
                            <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2 mt-auto">
                                <button
                                    data-service-id="${service.id}"
                                    data-action="add_theme"
                                    class="theme-action-button flex-grow bg-fuchsia-500 hover:bg-fuchsia-600 text-white font-bold py-2 px-4 rounded-full shadow-md text-sm transition duration-300"
                                    disabled
                                >
                                    Añadir Seleccionado ➕
                                </button>
                            </div>
                            <div id="selectedThemesList-${service.id}" class="mt-4">
                                ${selectedThemeItems.length > 0 ? `<p class="font-semibold text-gray-700 mb-2">Temáticas en tu carrito:</p>` : ''}
                                ${selectedThemeItems.map(item => `
                                    <div class="flex justify-between items-center bg-fuchsia-50 p-2 rounded-lg mb-2">
                                        <span>${item.name.replace(service.name + ': ', '')} (x${item.quantity})</span>
                                        <button class="remove-specific-theme-button text-red-500 hover:text-red-700 font-bold ml-2"
                                                data-full-name="${item.name}">🗑️</button>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                } else {
                    const isRepeatableService = repeatableServices.includes(service.name);
                    const selectedItemInCart = appState.selectedItems.find(selected => selected.name === service.name);
                    const currentQuantity = selectedItemInCart ? selectedItemInCart.quantity : 0;
                    
                    let displayPriceForCard = service.price;
                    let originalPriceHtmlForCard = '';

                    // Lógica de descuento para "Pintacaritas" si se añaden más de 1.
                    if (service.name === 'Pintacaritas 🎨👧👦' && currentQuantity > 1) {
                        originalPriceHtmlForCard = `<span class="line-through text-gray-500 text-2xl">$${service.price.toFixed(2)}</span> `;
                        displayPriceForCard = 35; // Precio con descuento por unidad si se añade más de 1.
                    } else if (appState.triviaBubbleDiscountActive && item.name === 'Show de Burbujas Gigantes 🫧') {
                        originalPriceHtmlForCard = `<span class="line-through text-gray-500 text-2xl">$${service.price.toFixed(2)}</span> `;
                        displayPriceForCard = service.price * 0.90; // 10% de descuento por trivia.
                    }

                    let buttonsHtml;
                    if (isRepeatableService) {
                        // Botones para servicios que se pueden añadir varias veces.
                        buttonsHtml = `
                            <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2 mt-auto">
                                <button
                                    data-item-name="${service.name}"
                                    data-item-price="${service.price}"
                                    data-action-type="add"
                                    class="add-remove-button flex-grow bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded-full shadow-md text-sm transition duration-300">
                                    Añadir ➕ ${currentQuantity > 0 ? `(x${currentQuantity})` : ''}
                                </button>
                                ${currentQuantity > 0 ? `
                                <button
                                    data-item-name="${service.name}"
                                    data-item-price="${service.price}"
                                    data-action-type="remove_all"
                                    class="add-remove-button flex-grow bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-full shadow-md text-sm transition duration-300">
                                    Quitar Todo 🗑️
                                </button>
                                ` : ''}
                            </div>
                        `;
                    } else {
                        // Botón para servicios no repetibles (añadir/quitar).
                        const isSelected = selectedItemInCart ? true : false;
                        const buttonText = isSelected ? 'Quitar del Carrito ➖' : 'Añadir al Carrito ➕';
                        const buttonClassColor = isSelected ? 'bg-red-500 hover:bg-red-600' : 'bg-purple-500 hover:bg-purple-600';
                        buttonsHtml = `
                            <button
                                data-item-name="${service.name}"
                                data-item-price="${service.price}"
                                data-action-type="toggle"
                                class="add-remove-button mt-auto font-bold py-2 px-4 rounded-full shadow-md text-sm sm:text-base transition duration-300 ${buttonClassColor} text-white">
                                ${buttonText}
                            </button>
                        `;
                    }

                    return `
                        <div class="${service.color} rounded-2xl shadow-lg p-4 sm:p-6 flex flex-col justify-between border-4 border-dashed border-opacity-50">
                            ${imageHtml}
                            <div>
                                <h2 class="text-xl sm:text-2xl font-bold mb-2 sm:mb-3 text-purple-700">${service.name}</h2>
                                <p class="text-sm sm:text-base text-gray-700 mb-3 sm:mb-4">${service.description}</p>
                                <p class="text-3xl sm:text-4xl font-extrabold text-pink-600 mb-3 sm:mb-4">
                                    ${originalPriceHtmlForCard}$${displayPriceForCard.toFixed(2)}
                                </p>
                            </div>
                            ${buttonsHtml}
                        </div>
                    `;
                }
            }).join('');

            const html = `
                <section class="bg-white rounded-3xl shadow-2xl p-4 sm:p-8 my-8 border-8 border-green-400">
                    <h2 class="text-3xl sm:text-4xl font-extrabold text-purple-700 text-center mb-8 sm:mb-10">Nuestros Servicios 🎉</h2>
                    <p class="text-lg text-gray-700 text-center mb-8">
                        Servicios de animación para fiestas infantiles en Panamá. ¡Hacemos tu evento mágico e inolvidable!
                    </p>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-8">
                        ${cardsHtml}
                    </div>
                </section>
            `;
            renderSection(html);

            // Asigna event listeners a todos los botones de añadir/quitar para servicios regulares.
            document.querySelectorAll('#mainContent .add-remove-button').forEach(button => {
                button.onclick = (event) => {
                    const itemName = event.target.dataset.itemName;
                    const itemPrice = parseFloat(event.target.dataset.itemPrice);
                    const actionType = event.target.dataset.actionType;
                    handleCartAction({ name: itemName, price: itemPrice }, actionType);
                };
            });

            // Asigna event listeners para el botón de añadir/cambiar personaje
            document.querySelectorAll('#mainContent .character-action-button').forEach(button => {
                button.onclick = (event) => {
                    const serviceId = event.target.dataset.serviceId;
                    const selectElement = document.getElementById(`characterSelect-${serviceId}`);
                    const selectedCharacterId = selectElement.value;

                    if (selectedCharacterId) {
                        const characterService = servicesData.find(s => s.id === serviceId);
                        const selectedChar = characterService.characters.find(c => c.id === selectedCharacterId);
                        if (selectedChar) {
                            updateCharacterInCart(characterService, selectedChar, 'add');
                            selectElement.value = ""; // Resetea el select después de añadir
                        }
                    } else {
                        showInfoModal('Por favor, selecciona un personaje antes de añadirlo.');
                    }
                };
            });

            // Asigna event listeners para los botones de quitar personaje específico
            document.querySelectorAll('#mainContent .remove-specific-character-button').forEach(button => {
                button.onclick = (event) => {
                    const fullCharacterName = event.target.dataset.fullName;
                    // Encuentra el servicio base de personajes
                    const characterService = servicesData.find(s => s.type === 'character_selection');
                    // Extrae solo el nombre del personaje para buscarlo en la lista original
                    const charNameOnly = fullCharacterName.replace(characterService.name + ': ', '');
                    const characterToRemove = characterService.characters.find(c => c.name === charNameOnly);

                    if (characterService && characterToRemove) {
                        updateCharacterInCart(characterService, characterToRemove, 'remove_all');
                    }
                };
            });

            // Lógica para habilitar/deshabilitar el botón "Añadir Seleccionado" y actualizar su texto (para personajes)
            document.querySelectorAll('#mainContent select[id^="characterSelect-"]').forEach(select => {
                select.onchange = (event) => {
                    const serviceId = event.target.id.split('-')[1];
                    const selectedCharacterId = event.target.value;
                    const addButton = document.querySelector(`.character-action-button[data-service-id="${serviceId}"]`);
                    
                    if (selectedCharacterId) {
                        const characterService = servicesData.find(s => s.id === serviceId);
                        const selectedChar = characterService.characters.find(c => c.id === selectedCharacterId);
                        const fullCharName = `${characterService.name}: ${selectedChar.name}`;
                        const existingInCart = appState.selectedItems.find(item => item.name === fullCharName);

                        if (existingInCart) {
                            addButton.textContent = `Añadir uno más de ${selectedChar.name} (x${existingInCart.quantity + 1})`;
                            addButton.disabled = false;
                        } else {
                            addButton.textContent = `Añadir ${selectedChar.name} al Carrito ➕`;
                            addButton.disabled = false;
                        }
                    } else {
                        addButton.textContent = `Añadir Seleccionado ➕`;
                        addButton.disabled = true;
                    }
                };
            });

            // Asigna event listeners para el botón de añadir temática
            document.querySelectorAll('#mainContent .theme-action-button').forEach(button => {
                button.onclick = (event) => {
                    const serviceId = event.target.dataset.serviceId;
                    const selectElement = document.getElementById(`themeSelect-${serviceId}`);
                    const selectedThemeName = selectElement.value;

                    if (selectedThemeName) {
                        const themeService = servicesData.find(s => s.id === serviceId);
                        updateThemeInCart(themeService, selectedThemeName, 'add');
                        selectElement.value = ""; // Resetea el select después de añadir
                    } else {
                        showInfoModal('Por favor, selecciona una temática antes de añadirla.');
                    }
                };
            });

            // Asigna event listeners para los botones de quitar temática específica
            document.querySelectorAll('#mainContent .remove-specific-theme-button').forEach(button => {
                button.onclick = (event) => {
                    const fullThemeName = event.target.dataset.fullName;
                    const themeService = servicesData.find(s => s.type === 'theme_selection');
                    // Extrae solo el nombre de la temática
                    const themeNameOnly = fullThemeName.replace(themeService.name + ': ', '');
                    updateThemeInCart(themeService, themeNameOnly, 'remove_all');
                };
            });

            // Lógica para habilitar/deshabilitar el botón "Añadir Seleccionado" y actualizar su texto (para temáticas)
            document.querySelectorAll('#mainContent select[id^="themeSelect-"]').forEach(select => {
                select.onchange = (event) => {
                    const serviceId = event.target.id.split('-')[1];
                    const selectedThemeName = event.target.value;
                    const addButton = document.querySelector(`.theme-action-button[data-service-id="${serviceId}"]`);
                    
                    if (selectedThemeName) {
                        const themeService = servicesData.find(s => s.id === serviceId);
                        const fullThemeName = `${themeService.name}: ${selectedThemeName}`;
                        const existingInCart = appState.selectedItems.find(item => item.name === fullThemeName);

                        if (existingInCart) {
                            addButton.textContent = `Añadir una más de ${selectedThemeName} (x${existingInCart.quantity + 1})`;
                            addButton.disabled = false;
                        } else {
                            addButton.textContent = `Añadir ${selectedThemeName} al Carrito ➕`;
                            addButton.disabled = false;
                        }
                    } else {
                        addButton.textContent = `Añadir Seleccionado ➕`;
                        addButton.disabled = true;
                    }
                };
            });
        }

        /**
         * Renderiza la sección de Paquetes.
         */
        function renderPackagesSection() {
            const cardsHtml = packagesData.map(pkg => {
                const selectedItemInCart = appState.selectedItems.find(item => item.name === pkg.name);
                const isSelected = selectedItemInCart ? true : false;

                let buttonText;
                let buttonClassColor;

                if (isSelected) {
                    buttonText = 'Quitar del Carrito ➖';
                    buttonClassColor = 'bg-red-500 hover:bg-red-600';
                } else {
                    buttonText = 'Añadir al Carrito ➕';
                    buttonClassColor = 'bg-indigo-500 hover:bg-indigo-600';
                }

                let displayPrice = pkg.price;
                let originalPriceHtml = '';
                
                // Lógica de descuento mensual para paquetes.
                if (appState.promotedPackages.includes(pkg.name)) {
                    originalPriceHtml = `<span class="line-through text-gray-500 text-2xl">$${pkg.price.toFixed(2)}</span> `;
                    displayPrice = pkg.price * 0.90; // 10% de descuento.
                }

                return `
                    <div class="${pkg.color} rounded-2xl shadow-lg p-4 sm:p-6 flex flex-col justify-between border-4 border-dashed border-opacity-50">
                        <!-- Removed image from package cards -->
                        <div>
                            <h2 class="text-xl sm:text-2xl font-bold mb-2 sm:mb-3 text-indigo-700">${pkg.name}</h2>
                            <p class="text-sm sm:text-base text-gray-700 mb-3 sm:mb-4">${pkg.description}</p>
                            <ul class="list-disc list-inside text-gray-600 mb-3 sm:mb-4 text-sm sm:text-base">
                                ${pkg.services.map(service => `<li>${service}</li>`).join('')}
                            </ul>
                            <p class="text-3xl sm:text-4xl font-extrabold text-purple-600 mb-3 sm:mb-4">
                                ${originalPriceHtml}$${displayPrice.toFixed(2)}
                            </p>
                        </div>
                        <button
                            data-item-name="${pkg.name}"
                            data-item-price="${pkg.price}"
                            data-action-type="toggle"
                            class="add-remove-button mt-auto font-bold py-2 px-4 rounded-full shadow-md text-sm sm:text-base transition duration-300 ${buttonClassColor} text-white">
                            ${buttonText}
                        </button>
                    </div>
                `;
            }).join('');

            const html = `
                <section class="bg-white rounded-3xl shadow-2xl p-4 sm:p-8 my-8 border-8 border-pink-400">
                    <h2 class="text-3xl sm:text-4xl font-extrabold text-purple-700 text-center mb-8 sm:mb-10">Nuestros Paquetes 📦</h2>
                    <p class="text-lg text-gray-700 text-center mb-8">
                        Descubre nuestros paquetes de <strong>animación para fiestas infantiles en Panamá</strong>. ¡La opción perfecta para tu evento!
                    </p>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-8">
                        ${cardsHtml}
                    </div>
                </section>
            `;
            renderSection(html);

            // Asigna event listeners a todos los botones de añadir/quitar en la sección de paquetes.
            document.querySelectorAll('#mainContent .add-remove-button').forEach(button => {
                button.onclick = (event) => {
                    const itemName = event.target.dataset.itemName;
                    const itemPrice = parseFloat(event.target.dataset.itemPrice);
                    const actionType = event.target.dataset.actionType;
                    handleCartAction({ name: itemName, price: itemPrice }, actionType);
                };
            });
        }

        /**
         * Renderiza la sección de Reservas, mostrando los ítems seleccionados y el formulario.
         * Calcula y muestra el precio total, incluyendo descuentos y recargos por transporte.
         */
        function renderBookingSection() {
            // Genera la lista de ítems seleccionados para mostrar en la sección de reserva.
            const selectedItemsListHtml = appState.selectedItems.length === 0
                ? `<p class="text-red-600 text-sm sm:text-base">No has seleccionado ningún servicio. Por favor, vuelve a la sección de Servicios o Paquetes.</p>`
                : `<ul class="list-disc list-inside text-gray-800 text-sm sm:text-base bg-blue-50 p-3 rounded-md border border-blue-200">
                    ${appState.selectedItems.map((item) => {
                        let displayItemPrice = item.price;
                        let originalItemPrice = null;
                        const isPackage = packagesData.some(p => p.name === item.name); // Verifica si es un paquete.

                        // Aplica lógicas de descuento para mostrar el precio en la lista.
                        if (item.name === 'Pintacaritas 🎨👧👦' && item.quantity > 1) {
                            originalItemPrice = item.price;
                            displayItemPrice = 35; // Precio con descuento por unidad.
                        } else if (appState.triviaBubbleDiscountActive && item.name === 'Show de Burbujas Gigantes 🫧') {
                            originalItemPrice = item.price;
                            displayItemPrice = item.price * 0.90; // Descuento de trivia.
                        } else if (isPackage && appState.promotedPackages.includes(item.name)) {
                            originalItemPrice = item.price;
                            displayItemPrice = item.price * 0.90; // Descuento mensual de paquete.
                        }

                        return `
                            <li>
                                ${item.name} ${item.quantity > 1 ? `(x${item.quantity})` : ''} -
                                ${originalItemPrice !== null ? `
                                    <span class="line-through text-gray-500">$${item.price.toFixed(2)}</span>{' '}
                                    <span class="text-green-700">$${displayItemPrice.toFixed(2)}</span>
                                ` : `$${item.price.toFixed(2)}`}
                            </li>
                        `;
                    }).join('')}
                </ul>`;

            // Calcula y muestra el recargo por transporte.
            const currentTransportFee = transportFeesByLocation[appState.selectedLocation] || 0;
            const transportFeeDisplayHtml = currentTransportFee > 0
                ? `<p class="text-lg font-bold text-gray-700 mt-2">Recargo por Transporte (${appState.selectedLocation}): <span class="text-orange-600">$${currentTransportFee.toFixed(2)}</span></p>`
                : `<p class="text-lg font-bold text-gray-700 mt-2">Recargo por Transporte: <span class="text-green-600">¡Gratis en Panamá Centro!</span></p>`;

            // Calcula el precio total final incluyendo descuentos y recargos.
            const totalItemsPrice = appState.selectedItems.reduce((sum, item) => {
                let itemPriceForCalculation = item.price;

                if (item.name === 'Pintacaritas 🎨👧👦' && item.quantity > 1) {
                    itemPriceForCalculation = 35;
                } else if (appState.triviaBubbleDiscountActive && item.name === 'Show de Burbujas Gigantes 🫧') {
                    itemPriceForCalculation = item.price * 0.90;
                } else if (packagesData.some(p => p.name === item.name) && appState.promotedPackages.includes(item.name)) {
                    itemPriceForCalculation = item.price * 0.90;
                }
                return sum + (itemPriceForCalculation * item.quantity);
            }, 0);
            const finalTotalPrice = totalItemsPrice + currentTransportFee;

            const html = `
                <section class="bg-white rounded-3xl shadow-2xl p-4 sm:p-8 my-8 border-8 border-blue-400">
                    <h2 class="text-3xl sm:text-4xl font-extrabold text-purple-700 text-center mb-8 sm:mb-10">Reserva tu Evento 🗓️</h2>
                    <p class="text-lg text-gray-700 text-center mb-8">
                        ¡Reserva tu <strong>fiesta infantil en Panamá</strong>! Completa este formulario para asegurar la magia de tu evento.
                    </p>
                    <div class="grid grid-cols-1 lg:grid-cols-1 gap-4 sm:gap-12">
                        <h3 class="text-xl sm:text-2xl font-bold text-blue-700 mb-4 sm:mb-6">Completa los Detalles de Tu Reserva 📝</h3>
                        <div class="bg-blue-100 p-4 sm:p-8 rounded-2xl shadow-lg border-4 border-blue-300">
                            <form id="bookingForm" class="space-y-4">
                                <div>
                                    <label htmlFor="selectedItemsDisplay" class="block text-gray-700 font-bold mb-1 sm:mb-2 text-sm sm:text-base">Servicios/Paquetes Seleccionados:🎁</label>
                                    ${selectedItemsListHtml}
                                    ${transportFeeDisplayHtml}
                                    <p class="text-lg font-bold text-purple-700 mt-3">Total a Pagar: <span class="text-pink-600">$${finalTotalPrice.toFixed(2)}</span></p>
                                </div>

                                <div class="bg-yellow-50 p-3 rounded-md border border-yellow-300 text-sm sm:text-base text-gray-700 font-semibold mt-4">
                                    <p class="text-orange-700 font-bold mb-2">¡Importante! Se requiere un abono de $10.</p>
                                    <p>Por favor, realiza un abono de $10 vía Yappy Panamá a <span class="font-bold">Ailen Camarena</span> al número <span class="font-bold">6667-7965</span>. Nos pondremos en contacto para confirmar tu abono.</p>
                                </div>
                                
                                <div>
                                    <label htmlFor="locationSelect" class="block text-gray-700 font-bold mb-1 sm:mb-2 text-sm sm:text-base">Ubicación del Evento (Provincia/Zona):📍</label>
                                    <select
                                        id="locationSelect"
                                        name="ubicacionEvento"
                                        class="w-full p-2 sm:p-3 border-2 border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-sm sm:text-base"
                                    >
                                        <option value="Panamá Centro" ${appState.bookingFormData.selectedLocation === 'Panamá Centro' ? 'selected' : ''}>Panamá Centro</option>
                                        <option value="Arraiján" ${appState.bookingFormData.selectedLocation === 'Arraiján' ? 'selected' : ''}>Arraiján ($10 adicional)</option>
                                        <option value="La Chorrera" ${appState.bookingFormData.selectedLocation === 'La Chorrera' ? 'selected' : ''}>La Chorrera ($15 adicional)</option>
                                        <option value="Pacora" ${appState.bookingFormData.selectedLocation === 'Pacora' ? 'selected' : ''}>Pacora ($10 adicional)</option>
                                        <option value="Panamá Norte" ${appState.bookingFormData.selectedLocation === 'Panamá Norte' ? 'selected' : ''}>Panamá Norte ($10 adicional)</option>
                                    </select>
                                </div>

                                <div>
                                    <label htmlFor="exactLocation" class="block text-gray-700 font-bold mb-1 sm:mb-2 text-sm sm:text-base">Dirección Exacta del Evento: 🗺️</label>
                                    <input
                                        type="text"
                                        id="exactLocation"
                                        name="direccionExacta"
                                        class="w-full p-2 sm:p-3 border-2 border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-sm sm:text-base"
                                        placeholder="Ej: Calle Principal, Casa #15, Cerca de la escuela..."
                                        value="${appState.bookingFormData.exactLocation || ''}"
                                        required
                                    />
                                </div>

                                <div>
                                    <label htmlFor="bookingDate" class="block text-gray-700 font-bold mb-1 sm:mb-2 text-sm sm:text-base">Fecha del Evento: 📆</label>
                                    <input
                                        type="date"
                                        id="bookingDate"
                                        name="fechaEvento"
                                        class="w-full p-2 sm:p-3 border-2 border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-sm sm:text-base"
                                        min="${new Date().toISOString().split('T')[0]}"
                                        value="${appState.bookingFormData.bookingDate || ''}"
                                        required
                                    />
                                </div>
                                <div>
                                    <label htmlFor="bookingTime" class="block text-gray-700 font-bold mb-1 sm:mb-2 text-sm sm:text-base">Hora del Evento: ⏰</label>
                                    <input
                                        type="time"
                                        id="bookingTime"
                                        name="horaEvento"
                                        class="w-full p-2 sm:p-3 border-2 border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-sm sm:text-base"
                                        value="${appState.bookingFormData.bookingTime || ''}"
                                        required
                                    />
                                </div>
                                <div>
                                    <label htmlFor="customerName" class="block text-gray-700 font-bold mb-1 sm:mb-2 text-sm sm:text-base">Tu Nombre: 👤</label>
                                    <input
                                        type="text"
                                        id="customerName"
                                        name="nombreCliente"
                                        class="w-full p-2 sm:p-3 border-2 border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-sm sm:text-base"
                                        placeholder="Ej: Juan Pérez"
                                        value="${appState.bookingFormData.customerName || ''}"
                                        required
                                    />
                                </div>
                                <div>
                                    <label htmlFor="customerEmail" class="block text-gray-700 font-bold mb-1 sm:mb-2 text-sm sm:text-base">Tu Email: 📧</label>
                                    <input
                                        type="email"
                                        id="customerEmail"
                                        name="emailCliente"
                                        class="w-full p-2 sm:p-3 border-2 border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-sm sm:text-base"
                                        placeholder="Ej: tu.email@example.com"
                                        value="${appState.bookingFormData.customerEmail || ''}"
                                        required
                                    />
                                </div>
                                <div>
                                    <label htmlFor="customerPhone" class="block text-gray-700 font-bold mb-1 sm:mb-2 text-sm sm:text-base">Tu Teléfono:📞</label>
                                    <input
                                        type="tel"
                                        id="customerPhone"
                                        name="telefonoCliente"
                                        class="w-full p-2 sm:p-3 border-2 border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-sm sm:text-base"
                                        placeholder="Ej: 555-1234567"
                                        value="${appState.bookingFormData.customerPhone || ''}"
                                        required
                                    />
                                </div>
                                <div>
                                    <label htmlFor="eventType" class="block text-gray-700 font-bold mb-1 sm:mb-2 text-sm sm:text-base">Tipo de Evento: 🎉</label>
                                    <input
                                        type="text"
                                        id="eventType"
                                        name="tipoEvento"
                                        class="w-full p-2 sm:p-3 border-2 border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-sm sm:text-base"
                                        placeholder="Ej: Cumpleaños, Graduación"
                                        value="${appState.bookingFormData.eventType || ''}"
                                        required
                                    />
                                </div>
                                <div>
                                    <label htmlFor="numKids" class="block text-gray-700 font-bold mb-1 sm:mb-2 text-sm sm:text-base">Número Estimado de Niños: 👧👦</label>
                                    <input
                                        type="number"
                                        id="numKids"
                                        name="numeroNinos"
                                        class="w-full p-2 sm:p-3 border-2 border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 text-sm sm:text-base"
                                        placeholder="Ej: 20"
                                        min="1"
                                        value="${appState.bookingFormData.numKids || ''}"
                                        required
                                    />
                                </div>
                                <button type="submit" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 sm:py-3 px-4 sm:px-6 rounded-full shadow-lg text-base sm:text-lg mt-4">
                                    ¡Confirmar Reserva Mágica! ✨
                                </button>
                            </form>
                        </div>
                    </div>
                </section>
            `;
            renderSection(html);

            const bookingForm = document.getElementById('bookingForm');
            if (bookingForm) {
                bookingForm.onsubmit = handleBookingSubmit;
                // Manejador de cambio para la selección de ubicación, actualiza el estado y el resumen del carrito.
                document.getElementById('locationSelect').onchange = (e) => {
                    appState.bookingFormData.selectedLocation = e.target.value; // Actualiza el estado al cambiar ubicación.
                    appState.selectedLocation = e.target.value; // También actualiza el estado general de la ubicación.
                    updateCartSummary(); 
                    renderBookingSection(); // Re-renderiza la sección para mostrar el recargo actualizado.
                };
            }
        }

        // --- Funciones de Trivia ---

        /**
         * Inicia el juego de trivia.
         * Verifica si el usuario ya jugó la trivia usando localStorage para evitar reintentos.
         */
        function startTrivia() {
            // Limpia cualquier temporizador o timeout anterior para evitar solapamientos.
            if (appState.currentTriviaTimer) clearInterval(appState.currentTriviaTimer);
            if (appState.currentQuestionTimeout) clearTimeout(appState.currentQuestionTimeout);

            const triviaPlayedStatus = localStorage.getItem('triviaPlayed');
            if (triviaPlayedStatus === 'true') {
                appState.hasPlayedTrivia = true;
                showInfoModal('¡Ya has participado en la trivia! Solo se permite una participación por cliente. 😊');
                setActiveSection('home');
                return;
            }

            // Marca la trivia como jugada en localStorage.
            localStorage.setItem('triviaPlayed', 'true');
            appState.hasPlayedTrivia = true; // Actualiza el estado local de la app.

            // Baraja las preguntas y selecciona las primeras 10 (o menos si hay menos).
            appState.triviaQuestionsShuffled = shuffleArray([...triviaQuestions]).slice(0, 10); 
            appState.currentTriviaQuestionIndex = 0; // Reinicia el índice de la pregunta actual.
            appState.triviaCorrectAnswers = 0; // Reinicia el contador de respuestas correctas.

            showInfoModal('¡Completa 5 respuestas correctas y gana un 10% de descuento EXCLUSIVO en el Show de Burbujas Gigantes! 🫧');
            
            // Retrasa la visualización de la primera pregunta para que el usuario lea el modal.
            setTimeout(() => {
                displayTriviaQuestion();
            }, 3000);
        }

        /**
         * Muestra la pregunta de trivia actual en la pantalla.
         * Configura un temporizador para cada pregunta.
         */
        function displayTriviaQuestion() {
            // Limpia cualquier temporizador o timeout anterior al mostrar una nueva pregunta.
            if (appState.currentTriviaTimer) clearInterval(appState.currentTriviaTimer);
            if (appState.currentQuestionTimeout) clearTimeout(appState.currentQuestionTimeout);

            const currentQuestion = appState.triviaQuestionsShuffled[appState.currentTriviaQuestionIndex];
            if (!currentQuestion) {
                // Si no hay más preguntas, termina la trivia.
                endTrivia(true);
                return;
            }

            const optionsHtml = currentQuestion.options.map((option) => `
                <button
                    class="trivia-option-button bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-full shadow-md text-lg transition duration-300 w-full sm:w-auto flex-grow"
                    data-option="${option}"
                >
                    ${option}
                </button>
            `).join('');

            const html = `
                <section class="bg-white rounded-3xl shadow-2xl p-4 sm:p-8 my-8 border-8 border-purple-400">
                    <h2 class="text-3xl sm:text-4xl font-extrabold text-purple-700 text-center mb-6 sm:mb-8">
                        Trivia de Programas Infantiles 🧠
                    </h2>
                    <div class="bg-purple-50 p-6 rounded-2xl shadow-inner border-4 border-purple-300 text-center">
                        <p class="text-xl sm:text-2xl font-semibold text-gray-800 mb-4">
                            Pregunta ${appState.currentTriviaQuestionIndex + 1} para ganar el descuento:
                        </p>
                        <p class="text-2xl sm:text-3xl font-extrabold text-indigo-700 mb-8">
                            ${currentQuestion.question}
                        </p>
                        <div id="triviaOptions" class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            ${optionsHtml}
                        </div>
                        <p id="triviaFeedback" class="text-lg font-bold mt-6 hidden"></p>
                        <p id="triviaTimer" class="text-xl font-bold text-red-600 mt-4">Tiempo restante: 20s</p>
                    </div>
                </section>
            `;
            renderSection(html);

            // Asigna los event listeners a los botones de opción de la trivia.
            document.querySelectorAll('#mainContent .trivia-option-button').forEach(button => {
                button.onclick = (event) => checkTriviaAnswer(event.target.dataset.option);
            });

            // Inicia el temporizador de la pregunta.
            let timeLeft = 20;
            const timerDisplay = document.getElementById('triviaTimer');
            timerDisplay.textContent = `Tiempo restante: ${timeLeft}s`;

            appState.currentTriviaTimer = setInterval(() => {
                timeLeft--;
                timerDisplay.textContent = `Tiempo restante: ${timeLeft}s`;
                if (timeLeft <= 0) {
                    clearInterval(appState.currentTriviaTimer);
                    handleTimeUp(); // Llama a la función de tiempo agotado.
                }
            }, 1000);

            // Establece un timeout para la pregunta en caso de que el temporizador no se limpie (seguridad).
            appState.currentQuestionTimeout = setTimeout(() => {
                if (timeLeft > 0) { // Solo if el tiempo no se ha agotado ya por el intervalo.
                     handleTimeUp();
                }
            }, 20000);
        }

        /**
         * Maneja el evento de tiempo agotado en una pregunta de trivia.
         * Finaliza la trivia si se acaba el tiempo.
         */
        function handleTimeUp() {
            // Limpia ambos temporizadores para asegurar que no haya ejecuciones duplicadas.
            if (appState.currentTriviaTimer) clearInterval(appState.currentTriviaTimer);
            if (appState.currentQuestionTimeout) clearTimeout(appState.currentQuestionTimeout);

            document.getElementById('triviaFeedback').textContent = '¡Tiempo agotado! ⌛';
            document.getElementById('triviaFeedback').classList.add('text-red-600');
            document.getElementById('triviaFeedback').classList.remove('hidden');

            // Deshabilita los botones de opción para evitar más interacciones.
            document.querySelectorAll('.trivia-option-button').forEach(button => {
                button.disabled = true;
            });

            // Después de un breve retraso, termina la trivia.
            setTimeout(() => {
                endTrivia(false); // Indica que no se ganó el descuento.
            }, 2000);
        }

        /**
         * Verifica la respuesta seleccionada por el usuario en la trivia.
         * @param {string} selectedOption - La opción seleccionada por el usuario.
         */
        function checkTriviaAnswer(selectedOption) {
            // Limpia ambos temporizadores al recibir una respuesta para evitar problemas.
            if (appState.currentTriviaTimer) clearInterval(appState.currentTriviaTimer);
            if (appState.currentQuestionTimeout) clearTimeout(appState.currentQuestionTimeout);

            const currentQuestion = appState.triviaQuestionsShuffled[appState.currentTriviaQuestionIndex];
            const triviaFeedback = document.getElementById('triviaFeedback');
            triviaFeedback.classList.remove('hidden', 'text-green-600', 'text-red-600');

            // Deshabilita todos los botones de opción.
            document.querySelectorAll('.trivia-option-button').forEach(button => {
                button.disabled = true;
                // Resalta la respuesta correcta en verde.
                if (button.dataset.option === currentQuestion.answer) {
                    button.classList.add('bg-green-600');
                    button.classList.remove('bg-blue-500', 'hover:bg-blue-600');
                }
            });

            if (selectedOption === currentQuestion.answer) {
                appState.triviaCorrectAnswers++;
                triviaFeedback.textContent = '¡Correcto! ✅';
                triviaFeedback.classList.add('text-green-600');

                // Verifica si ha ganado el descuento o si hay más preguntas.
                if (appState.currentTriviaQuestionIndex + 1 === appState.triviaQuestionsShuffled.length || appState.triviaCorrectAnswers >= 5) {
                    setTimeout(() => {
                        endTrivia(true); // Termina la trivia, indicando que se pudo haber ganado.
                    }, 2000);
                } else {
                    setTimeout(() => {
                        appState.currentTriviaQuestionIndex++;
                        displayTriviaQuestion(); // Muestra la siguiente pregunta.
                    }, 2000);
                }

            } else {
                triviaFeedback.textContent = `¡Incorrecto! ❌ La respuesta correcta era: ${currentQuestion.answer}`;
                triviaFeedback.classList.add('text-red-600');
                
                // Resalta la opción incorrecta seleccionada por el usuario en rojo.
                document.querySelectorAll('.trivia-option-button').forEach(button => {
                    if (button.dataset.option === selectedOption) {
                        button.classList.add('bg-red-600');
                        button.classList.remove('bg-blue-500', 'hover:bg-blue-600');
                    }
                });

                setTimeout(() => {
                    endTrivia(false); // Termina la trivia, indicando que no se ganó el descuento.
                }, 2000);
            }
            triviaFeedback.classList.remove('hidden'); // Asegura que el feedback sea visible.
        }

        /**
         * Finaliza la trivia y muestra el resultado.
         * @param {boolean} won - True si el usuario ganó el descuento, False de lo contrario.
         */
        function endTrivia(won = false) {
            // Asegura que los temporizadores se limpien al finalizar.
            if (appState.currentTriviaTimer) clearInterval(appState.currentTriviaTimer);
            if (appState.currentQuestionTimeout) clearTimeout(appState.currentQuestionTimeout);

            let message = '';
            // Aplica el descuento si se cumplen las condiciones de victoria.
            if (won && appState.triviaCorrectAnswers >= 5) { 
                appState.triviaBubbleDiscountActive = true; 
                message = `¡Felicidades! 🎉 Respondiste ${appState.triviaCorrectAnswers} preguntas correctamente. ¡Has ganado un 10% de descuento EXCLUSIVO en el Show de Burbujas Gigantes! Este descuento se aplicará automáticamente en tu carrito. 🥳`;
            } else {
                message = `¡Fin del juego! Respondiste ${appState.triviaCorrectAnswers} preguntas correctamente. Necesitas 5 aciertos para ganar. Sigue practicando para la próxima vez. No te preocupes, aún puedes aprovechar nuestras otras promociones. 😊`;
                appState.triviaBubbleDiscountActive = false; // Asegura que el descuento no esté activo si no se ganó.
            }
            showInfoModal(message); // Muestra el resultado al usuario.
            
            // Reinicia el estado de la trivia para futuras sesiones (aunque localStorage evita re-jugar).
            appState.currentTriviaQuestionIndex = 0;
            appState.triviaCorrectAnswers = 0;
            
            setActiveSection('home'); // Regresa a la sección de inicio.
        }

        // --- Funciones para guardar y cargar los datos del formulario de reserva ---
        /**
         * Guarda los datos actuales del formulario de reserva en appState y localStorage.
         */
        function saveBookingFormData() {
            const bookingForm = document.getElementById('bookingForm');
            if (bookingForm) {
                appState.bookingFormData.bookingDate = bookingForm.elements.bookingDate.value;
                appState.bookingFormData.bookingTime = bookingForm.elements.bookingTime.value;
                appState.bookingFormData.customerName = bookingForm.elements.customerName.value;
                appState.bookingFormData.customerEmail = bookingForm.elements.customerEmail.value;
                appState.bookingFormData.customerPhone = bookingForm.elements.customerPhone.value;
                appState.bookingFormData.eventType = bookingForm.elements.eventType.value;
                appState.bookingFormData.numKids = bookingForm.elements.numKids.value;
                appState.bookingFormData.exactLocation = bookingForm.elements.exactLocation.value;
                appState.bookingFormData.selectedLocation = bookingForm.elements.locationSelect.value;
                
                // Guardar también los ítems seleccionados del carrito.
                localStorage.setItem('selectedItems', JSON.stringify(appState.selectedItems));
                localStorage.setItem('bookingFormData', JSON.stringify(appState.bookingFormData));
                console.log('Datos del formulario guardados:', appState.bookingFormData); // Para depuración.
            }
        }

        /**
         * Carga los datos del formulario de reserva desde localStorage a appState.
         */
        function loadBookingFormData() {
            const savedFormData = localStorage.getItem('bookingFormData');
            if (savedFormData) {
                appState.bookingFormData = JSON.parse(savedFormData);
                // Asegúrate de que selectedLocation también se actualice en el estado general si se cargan datos.
                appState.selectedLocation = appState.bookingFormData.selectedLocation;
                console.log('Datos del formulario cargados:', appState.bookingFormData); // Para depuración.
            }
            const savedSelectedItems = localStorage.getItem('selectedItems');
            if (savedSelectedItems) {
                appState.selectedItems = JSON.parse(savedSelectedItems);
                console.log('Ítems del carrito cargados:', appState.selectedItems); // Para depuración.
            }
        }


        // --- Lógica Principal de la Aplicación ---

        /**
         * Establece la sección activa y actualiza la navegación, enviando un page_view a Google Analytics.
         * @param {string} sectionName - El nombre de la sección a activar ('home', 'services', 'packages', 'trivia', 'booking').
         */
        function setActiveSection(sectionName) {
            // Si la sección actual es 'booking' y vamos a otra sección, guarda los datos.
            if (appState.activeSection === 'booking') {
                saveBookingFormData();
            }

            appState.activeSection = sectionName;
            // Actualiza los estilos de los botones de navegación para indicar la sección activa.
            document.querySelectorAll('header nav button').forEach(button => {
                const buttonId = button.id;
                if ((buttonId === 'navHome' && sectionName === 'home') ||
                    (buttonId === 'navServices' && sectionName === 'services') ||
                    (buttonId === 'navPackages' && sectionName === 'packages') ||
                    (buttonId === 'navBooking' && sectionName === 'booking')) {
                    button.classList.add('bg-purple-500', 'text-white', 'shadow-md');
                    button.classList.remove('text-gray-700', 'hover:bg-purple-100');
                } else {
                    button.classList.remove('bg-purple-500', 'text-white', 'shadow-md');
                    button.classList.add('text-gray-700', 'hover:bg-purple-100');
                }
            });

            let pagePath = '/'; // Ruta por defecto para la página de inicio.
            let pageTitle = 'Diverty Eventos'; // Título por defecto (modificado).

            // Determina la ruta y el título de la página virtual para Google Analytics.
            switch (sectionName) {
                case 'home':
                    pagePath = '/inicio';
                    pageTitle = 'Diverty Eventos'; // Título optimizado (modificado).
                    break;
                case 'services':
                    pagePath = '/servicios';
                    pageTitle = 'Diverty Eventos | Servicios'; // Título optimizado (más corto).
                    break;
                case 'packages':
                    pagePath = '/paquetes';
                    pageTitle = 'Diverty Eventos | Paquetes'; // Título optimizado (más corto).
                    break;
                case 'trivia':
                    pagePath = '/trivia';
                    pageTitle = 'Diverty Eventos | Trivia para Descuentos'; // Título optimizado.
                    break;
                case 'booking':
                    pagePath = '/reservar';
                    pageTitle = 'Diverty Eventos | Reservar'; // Título optimizado (más corto).
                    // Muestra el modal de advertencia de reserva solo si no se ha mostrado antes.
                    if (!appState.hasShownBookingWarning) {
                        showBookingWarningModal();
                        appState.hasShownBookingWarning = true;
                    }
                    break;
            }

            // Envía el evento de vista de página virtual a Google Analytics.
            if (typeof gtag === 'function') {
                gtag('event', 'page_view', {
                    page_path: pagePath,
                    page_title: pageTitle
                });
            } else {
                console.warn('gtag is not defined. Google Analytics might not be loaded.');
            }

            // Renderiza la sección correspondiente.
            switch (sectionName) {
                case 'home':
                    renderHomeSection();
                    break;
                case 'services':
                    renderServicesSection();
                    break;
                case 'packages':
                    renderPackagesSection();
                    break;
                case 'trivia':
                    startTrivia(); 
                    break;
                case 'booking':
                    renderBookingSection();
                    break;
                default:
                    renderHomeSection(); // Fallback por defecto.
            }
            updateCartSummary(); // Siempre actualiza el resumen del carrito al cambiar de sección.
        }

        // --- Evento para la advertencia al intentar salir de la página ---
        // Este mensaje suele ser genérico en navegadores modernos por motivos de seguridad.
        window.onbeforeunload = function() {
            return "¡Espera! ¿Estás seguro de que quieres salir de la página? Tu información podría no guardarse.";
        };


        // --- Envío del Formulario a JotForm ---
        /**
         * Maneja el envío del formulario de reserva.
         * Realiza validaciones básicas y luego redirige a JotForm con los datos precargados.
         * @param {Event} event - El evento de envío del formulario.
         */
        async function handleBookingSubmit(event) {
            event.preventDefault(); // Evita el envío por defecto del formulario.

            // *** Validaciones se realizan primero ***
            if (appState.selectedItems.length === 0) {
                showInfoModal('¡Por favor, añade al menos un servicio o paquete a tu reserva! 🛒');
                return;
            }
            const requiredFields = [
                'bookingDate', 'bookingTime', 'customerName', 'customerEmail',
                'customerPhone', 'eventType', 'numKids', 'exactLocation'
            ];
            for (const fieldId of requiredFields) {
                if (!document.getElementById(fieldId).value) {
                    showInfoModal('¡Oops! Por favor, completa todos los campos para realizar la reserva. 📝');
                    return;
                }
            }

            // Si todas las validaciones pasan, se guarda el formulario y se muestra el modal.
            saveBookingFormData(); // Guarda los datos antes de la redirección.
            showInfoModal('¡Redirigiendo a JotForm para finalizar tu reserva! 🎉 Haz clic en "¡Entendido!" para continuar.', () => {
                // Esto es lo que se ejecutará cuando el usuario haga clic en "¡Entendido!" en el modal.

                // --- Recopilación de Datos para JotForm (se re-obtiene para asegurar los últimos valores) ---
                const bookingDate = document.getElementById('bookingDate').value; 
                const bookingTime = document.getElementById('bookingTime').value; 

                const [year, month, day] = bookingDate.split('-'); 

                const customerName = document.getElementById('customerName').value;
                const customerEmail = document.getElementById('customerEmail').value;
                const customerPhone = document.getElementById('customerPhone').value;
                const eventType = document.getElementById('eventType').value;
                const numKids = document.getElementById('numKids').value;
                const exactLocation = document.getElementById('exactLocation').value;
                const selectedLocationName = appState.selectedLocation;
                const currentTransportFee = transportFeesByLocation[selectedLocationName] || 0;

                const selectedItemsString = appState.selectedItems.map(item => {
                    let itemPriceForJotForm = item.price;
                    const isPackage = packagesData.some(p => p.name === item.name);

                    if (item.name === 'Pintacaritas 🎨👧👦' && item.quantity > 1) {
                        itemPriceForJotForm = 35;
                    } else if (appState.triviaBubbleDiscountActive && item.name === 'Show de Burbujas Gigantes 🫧') {
                        itemPriceForJotForm = item.price * 0.90;
                    } else if (isPackage && appState.promotedPackages.includes(item.name)) {
                        itemPriceForJotForm = item.price * 0.90;
                    }
                    
                    return `${item.name} ${item.quantity > 1 ? `(x${item.quantity})` : ''} ($${itemPriceForJotForm.toFixed(2)})`; 
                }).join(', ');
                
                const totalItemsPrice = appState.selectedItems.reduce((sum, item) => {
                    let itemPriceForCalculation = item.price;
                    if (item.name === 'Pintacaritas 🎨👧👦' && item.quantity > 1) {
                        itemPriceForCalculation = 35;
                    } else if (appState.triviaBubbleDiscountActive && item.name === 'Show de Burbujas Gigantes 🫧') {
                        itemPriceForCalculation = item.price * 0.90;
                    } else if (packagesData.some(p => p.name === item.name) && appState.promotedPackages.includes(item.name)) {
                        itemPriceForCalculation = item.price * 0.90;
                    }
                    return sum + (itemPriceForCalculation * item.quantity);
                }, 0);
                const finalTotalPrice = totalItemsPrice + currentTransportFee;

                // --- Construcción de la URL de JotForm con Parámetros ---
                // Los parámetros se codifican en la URL para precargar el formulario de JotForm.
                const jotformBaseUrl = 'https://form.jotform.com/251611549526054'; 
                const params = new URLSearchParams();

                params.append('fechaDelEvento[year]', year);   
                params.append('fechaDelEvento[month]', month); 
                params.append('fechaDelEvento[day]', day);     
                
                params.append('horaDelEvento', bookingTime); 
                params.append('nombreDelCliente', customerName);
                params.append('emailDelCliente', customerEmail);
                params.append('telefonoDelCliente', customerPhone);
                params.append('tipoDeEvento', eventType);
                params.append('numeroEstimadoDeNinos', numKids);
                params.append('ubicacionSeleccionada', selectedLocationName);
                params.append('recargoPorTransporte', `$${currentTransportFee.toFixed(2)}`);
                params.append('direccionExactaDelEvento', exactLocation);
                params.append('serviciosPaquetesSeleccionados', selectedItemsString);
                params.append('precioTotalEstimado', `$${finalTotalPrice.toFixed(2)}`);
                params.append('idDeSesionVisitante', appState.userId);

                const jotformUrl = `${jotformBaseUrl}?${params.toString()}`;

                // Abrir en una nueva pestaña cuando el usuario haga clic en "¡Entendido!".
                // Se incluye un fallback para redirección en la misma pestaña si la nueva ventana es bloqueada.
                const newWindow = window.open(jotformUrl, '_blank');
                if (newWindow) {
                    newWindow.focus(); 
                } else {
                    console.warn('La nueva ventana no pudo abrirse (bloqueador de pop-ups). Intentando redirección en la misma pestaña como fallback.');
                    window.location.href = jotformUrl; 
                }
            });
        }

        // --- Inicialización de la Aplicación ---
        // Se ejecuta cuando el DOM está completamente cargado.
        document.addEventListener('DOMContentLoaded', () => {
            // Carga el estado de la trivia desde localStorage al iniciar la página.
            if (localStorage.getItem('triviaPlayed') === 'true') {
                appState.hasPlayedTrivia = true; 
            }

            // Carga los datos del formulario y del carrito al iniciar la página.
            loadBookingFormData(); 

            // Asigna event listeners para los botones de cerrar los modales.
            document.getElementById('closeModalButton').onclick = closeModal;
            document.getElementById('closePromoModalButton').onclick = closePromoModal;
            document.getElementById('closeBookingWarningModalButton').onclick = closeBookingWarningModal;

            // Asigna event listeners para los botones de navegación principal.
            document.getElementById('navHome').onclick = () => setActiveSection('home');
            document.getElementById('navServices').onclick = () => setActiveSection('services');
            document.getElementById('navPackages').onclick = () => setActiveSection('packages');
            document.getElementById('navBooking').onclick = () => setActiveSection('booking');
            document.getElementById('proceedToBookButton').onclick = () => setActiveSection('booking');

            // Establece la sección de inicio por defecto al cargar la página.
            setActiveSection('home');
            updateCartSummary(); // Asegura que el resumen del carrito se muestre correctamente al inicio.
        });
    </script>
</body>
</html>

